<!DOCTYPE html>
<html>

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>OES Standard Operating Procedures for The Design and Statistical Analysis of Experiments.</title>
  <meta name="description" content="These are the current standard operating procedures for statistical analysis of the Office of Evaluation Sciences in the GSA">
  <meta name="generator" content="bookdown &lt;!--bookdown:version--&gt; and GitBook 2.6.7">

  <meta property="og:title" content="OES Standard Operating Procedures for The Design and Statistical Analysis of Experiments.">
  <meta property="og:type" content="book">
  
  
  <meta property="og:description" content="These are the current standard operating procedures for statistical analysis of the Office of Evaluation Sciences in the GSA">
  <meta name="github-repo" content="gsa-oes/sop">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="OES Standard Operating Procedures for The Design and Statistical Analysis of Experiments.">
  
  <meta name="twitter:description" content="These are the current standard operating procedures for statistical analysis of the Office of Evaluation Sciences in the GSA">
  

<meta name="author" content="Jake Bowers, Ryan T. Moore, Lula Chen, Paul Testa, Nate Higgins, Oliver McClellan, Miles Williams, Tyler Simko, Bill Schultz">


<meta name="date" content="2023-09-05">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="randomization-and-design.html">
<link rel="next" href="poweranalysis.html">
<script src="libs/jquery/jquery.min.js"></script>
<link href="libs/gitbook/css/style.css" rel="stylesheet">
<link href="libs/gitbook/css/plugin-bookdown.css" rel="stylesheet">
<link href="libs/gitbook/css/plugin-highlight.css" rel="stylesheet">
<link href="libs/gitbook/css/plugin-search.css" rel="stylesheet">
<link href="libs/gitbook/css/plugin-fontsettings.css" rel="stylesheet">







<script src="libs/kePrint/kePrint.js"></script>
<link href="libs/lightable/lightable.css" rel="stylesheet">

<script>
/* ========================================================================
 * Bootstrap: transition.js v3.3.7
 * http://getbootstrap.com/javascript/#transitions
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */


+function ($) {
  'use strict';

  // CSS TRANSITION SUPPORT (Shoutout: http://www.modernizr.com/)
  // ============================================================

  function transitionEnd() {
    var el = document.createElement('bootstrap')

    var transEndEventNames = {
      WebkitTransition : 'webkitTransitionEnd',
      MozTransition    : 'transitionend',
      OTransition      : 'oTransitionEnd otransitionend',
      transition       : 'transitionend'
    }

    for (var name in transEndEventNames) {
      if (el.style[name] !== undefined) {
        return { end: transEndEventNames[name] }
      }
    }

    return false // explicit for ie8 (  ._.)
  }

  // http://blog.alexmaccaw.com/css-transitions
  $.fn.emulateTransitionEnd = function (duration) {
    var called = false
    var $el = this
    $(this).one('bsTransitionEnd', function () { called = true })
    var callback = function () { if (!called) $($el).trigger($.support.transition.end) }
    setTimeout(callback, duration)
    return this
  }

  $(function () {
    $.support.transition = transitionEnd()

    if (!$.support.transition) return

    $.event.special.bsTransitionEnd = {
      bindType: $.support.transition.end,
      delegateType: $.support.transition.end,
      handle: function (e) {
        if ($(e.target).is(this)) return e.handleObj.handler.apply(this, arguments)
      }
    }
  })

}(jQuery);
</script>
<script>
/* ========================================================================
 * Bootstrap: collapse.js v3.3.7
 * http://getbootstrap.com/javascript/#collapse
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */

/* jshint latedef: false */

+function ($) {
  'use strict';

  // COLLAPSE PUBLIC CLASS DEFINITION
  // ================================

  var Collapse = function (element, options) {
    this.$element      = $(element)
    this.options       = $.extend({}, Collapse.DEFAULTS, options)
    this.$trigger      = $('[data-toggle="collapse"][href="#' + element.id + '"],' +
                           '[data-toggle="collapse"][data-target="#' + element.id + '"]')
    this.transitioning = null

    if (this.options.parent) {
      this.$parent = this.getParent()
    } else {
      this.addAriaAndCollapsedClass(this.$element, this.$trigger)
    }

    if (this.options.toggle) this.toggle()
  }

  Collapse.VERSION  = '3.3.7'

  Collapse.TRANSITION_DURATION = 350

  Collapse.DEFAULTS = {
    toggle: true
  }

  Collapse.prototype.dimension = function () {
    var hasWidth = this.$element.hasClass('width')
    return hasWidth ? 'width' : 'height'
  }

  Collapse.prototype.show = function () {
    if (this.transitioning || this.$element.hasClass('in')) return

    var activesData
    var actives = this.$parent && this.$parent.children('.panel').children('.in, .collapsing')

    if (actives && actives.length) {
      activesData = actives.data('bs.collapse')
      if (activesData && activesData.transitioning) return
    }

    var startEvent = $.Event('show.bs.collapse')
    this.$element.trigger(startEvent)
    if (startEvent.isDefaultPrevented()) return

    if (actives && actives.length) {
      Plugin.call(actives, 'hide')
      activesData || actives.data('bs.collapse', null)
    }

    var dimension = this.dimension()

    this.$element
      .removeClass('collapse')
      .addClass('collapsing')[dimension](0)
      .attr('aria-expanded', true)

    this.$trigger
      .removeClass('collapsed')
      .attr('aria-expanded', true)

    this.transitioning = 1

    var complete = function () {
      this.$element
        .removeClass('collapsing')
        .addClass('collapse in')[dimension]('')
      this.transitioning = 0
      this.$element
        .trigger('shown.bs.collapse')
    }

    if (!$.support.transition) return complete.call(this)

    var scrollSize = $.camelCase(['scroll', dimension].join('-'))

    this.$element
      .one('bsTransitionEnd', $.proxy(complete, this))
      .emulateTransitionEnd(Collapse.TRANSITION_DURATION)[dimension](this.$element[0][scrollSize])
  }

  Collapse.prototype.hide = function () {
    if (this.transitioning || !this.$element.hasClass('in')) return

    var startEvent = $.Event('hide.bs.collapse')
    this.$element.trigger(startEvent)
    if (startEvent.isDefaultPrevented()) return

    var dimension = this.dimension()

    this.$element[dimension](this.$element[dimension]())[0].offsetHeight

    this.$element
      .addClass('collapsing')
      .removeClass('collapse in')
      .attr('aria-expanded', false)

    this.$trigger
      .addClass('collapsed')
      .attr('aria-expanded', false)

    this.transitioning = 1

    var complete = function () {
      this.transitioning = 0
      this.$element
        .removeClass('collapsing')
        .addClass('collapse')
        .trigger('hidden.bs.collapse')
    }

    if (!$.support.transition) return complete.call(this)

    this.$element
      [dimension](0)
      .one('bsTransitionEnd', $.proxy(complete, this))
      .emulateTransitionEnd(Collapse.TRANSITION_DURATION)
  }

  Collapse.prototype.toggle = function () {
    this[this.$element.hasClass('in') ? 'hide' : 'show']()
  }

  Collapse.prototype.getParent = function () {
    return $(this.options.parent)
      .find('[data-toggle="collapse"][data-parent="' + this.options.parent + '"]')
      .each($.proxy(function (i, element) {
        var $element = $(element)
        this.addAriaAndCollapsedClass(getTargetFromTrigger($element), $element)
      }, this))
      .end()
  }

  Collapse.prototype.addAriaAndCollapsedClass = function ($element, $trigger) {
    var isOpen = $element.hasClass('in')

    $element.attr('aria-expanded', isOpen)
    $trigger
      .toggleClass('collapsed', !isOpen)
      .attr('aria-expanded', isOpen)
  }

  function getTargetFromTrigger($trigger) {
    var href
    var target = $trigger.attr('data-target')
      || (href = $trigger.attr('href')) && href.replace(/.*(?=#[^\s]+$)/, '') // strip for ie7

    return $(target)
  }


  // COLLAPSE PLUGIN DEFINITION
  // ==========================

  function Plugin(option) {
    return this.each(function () {
      var $this   = $(this)
      var data    = $this.data('bs.collapse')
      var options = $.extend({}, Collapse.DEFAULTS, $this.data(), typeof option == 'object' && option)

      if (!data && options.toggle && /show|hide/.test(option)) options.toggle = false
      if (!data) $this.data('bs.collapse', (data = new Collapse(this, options)))
      if (typeof option == 'string') data[option]()
    })
  }

  var old = $.fn.collapse

  $.fn.collapse             = Plugin
  $.fn.collapse.Constructor = Collapse


  // COLLAPSE NO CONFLICT
  // ====================

  $.fn.collapse.noConflict = function () {
    $.fn.collapse = old
    return this
  }


  // COLLAPSE DATA-API
  // =================

  $(document).on('click.bs.collapse.data-api', '[data-toggle="collapse"]', function (e) {
    var $this   = $(this)

    if (!$this.attr('data-target')) e.preventDefault()

    var $target = getTargetFromTrigger($this)
    var data    = $target.data('bs.collapse')
    var option  = data ? 'toggle' : $this.data()

    Plugin.call($target, option)
  })

}(jQuery);
</script>
<script>
window.initializeCodeFolding = function(show) {

  // handlers for show-all and hide all
  $("#rmd-show-all-code").click(function() {
    $('div.r-code-collapse').each(function() {
      $(this).collapse('show');
    });
  });
  $("#rmd-hide-all-code").click(function() {
    $('div.r-code-collapse').each(function() {
      $(this).collapse('hide');
    });
  });

  // index for unique code element ids
  var currentIndex = 1;

  // select all R code blocks
  var rCodeBlocks = $('pre.sourceCode, pre.r, pre.python, pre.bash, pre.sql, pre.cpp, pre.stan');
  rCodeBlocks.each(function() {

    // create a collapsable div to wrap the code in
    var div = $('<div class="collapse r-code-collapse"></div>');
    if (show)
      div.addClass('in');
    var id = 'rcode-643E0F36' + currentIndex++;
    div.attr('id', id);
    $(this).before(div);
    $(this).detach().appendTo(div);

    // add a show code button right above
    var showCodeText = $('<span>' + (show ? 'Hide' : 'Code') + '</span>');
    var showCodeButton = $('<button type="button" class="btn btn-default btn-xs code-folding-btn pull-right"></button>');
    showCodeButton.append(showCodeText);
    showCodeButton
        .attr('data-toggle', 'collapse')
        .attr('data-target', '#' + id)
        .attr('aria-expanded', show)
        .attr('aria-controls', id);

    var buttonRow = $('<div class="row"></div>');
    var buttonCol = $('<div class="col-md-12"></div>');

    buttonCol.append(showCodeButton);
    buttonRow.append(buttonCol);

    div.before(buttonRow);

    // update state of button on show/hide
    div.on('hidden.bs.collapse', function () {
      showCodeText.text('Code');
    });
    div.on('show.bs.collapse', function () {
      showCodeText.text('Hide');
    });
  });

}
</script>
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
.row { display: flex; }
.collapse { display: none; }
.in { display:block }
</style>
<script>
$(document).ready(function () {
  window.initializeCodeFolding("show" === "hide");
});
</script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css">
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@0.16.3/dist/katex.min.css" data-external="1"></head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">The OES SOP</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Overview</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#purposes-of-this-document"><i class="fa fa-check"></i>Purposes of this document</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#nature-and-limitations-of-this-document"><i class="fa fa-check"></i>Nature and limitations of this document</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#we-mostly-focus-on-randomized-field-experiments."><i class="fa fa-check"></i>We (mostly) focus on randomized field experiments.</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#we-present-examples-using-r"><i class="fa fa-check"></i>We present examples using R</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#structure-of-the-document"><i class="fa fa-check"></i>Structure of the document</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#help-us-improve-our-work"><i class="fa fa-check"></i>Help us improve our work!</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#about-this-document"><i class="fa fa-check"></i>About this document</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="statistical-and-causal-inference-for-policy-change.html"><a href="statistical-and-causal-inference-for-policy-change.html"><i class="fa fa-check"></i><b>1</b> Statistical and causal inference for policy change</a></li>
<li class="chapter" data-level="2" data-path="basics-of-experimental-design-and-analysis.html"><a href="basics-of-experimental-design-and-analysis.html"><i class="fa fa-check"></i><b>2</b> Basics of Experimental Design and Analysis</a><ul>
<li class="chapter" data-level="2.1" data-path="basics-of-experimental-design-and-analysis.html"><a href="basics-of-experimental-design-and-analysis.html#statistical-power-designing-studies-that-effectively-distinguish-signal-from-noise"><i class="fa fa-check"></i><b>2.1</b> Statistical Power: Designing Studies that effectively distinguish signal from noise</a></li>
<li class="chapter" data-level="2.2" data-path="basics-of-experimental-design-and-analysis.html"><a href="basics-of-experimental-design-and-analysis.html#error-rates-of-tests"><i class="fa fa-check"></i><b>2.2</b> Error Rates of Tests</a></li>
<li class="chapter" data-level="2.3" data-path="basics-of-experimental-design-and-analysis.html"><a href="basics-of-experimental-design-and-analysis.html#bias-in-estimators"><i class="fa fa-check"></i><b>2.3</b> Bias in Estimators</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="design-based-principles-of-statistical-inference.html"><a href="design-based-principles-of-statistical-inference.html"><i class="fa fa-check"></i><b>3</b> Design-Based Principles of Statistical Inference</a><ul>
<li class="chapter" data-level="3.1" data-path="design-based-principles-of-statistical-inference.html"><a href="design-based-principles-of-statistical-inference.html#randinfex"><i class="fa fa-check"></i><b>3.1</b> An example using simulated data</a><ul>
<li class="chapter" data-level="3.1.1" data-path="design-based-principles-of-statistical-inference.html"><a href="design-based-principles-of-statistical-inference.html#how-do-we-calculate-randomization-based-standard-errors"><i class="fa fa-check"></i><b>3.1.1</b> How do we calculate randomization-based standard errors?</a></li>
<li class="chapter" data-level="3.1.2" data-path="design-based-principles-of-statistical-inference.html"><a href="design-based-principles-of-statistical-inference.html#how-do-we-calculate-randomization-based-confidence-intervals"><i class="fa fa-check"></i><b>3.1.2</b> How do we calculate randomization-based confidence intervals?</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="design-based-principles-of-statistical-inference.html"><a href="design-based-principles-of-statistical-inference.html#summary-what-does-a-design-based-approach-mean-for-policy-evaluation"><i class="fa fa-check"></i><b>3.2</b> Summary: What does a design based approach mean for policy evaluation?</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="randomization-and-design.html"><a href="randomization-and-design.html"><i class="fa fa-check"></i><b>4</b> Randomization and Design</a><ul>
<li class="chapter" data-level="4.1" data-path="randomization-and-design.html"><a href="randomization-and-design.html#coin-flipping-randomization-versus-urn-drawing-randomization"><i class="fa fa-check"></i><b>4.1</b> Coin flipping randomization versus Urn-drawing randomization</a></li>
<li class="chapter" data-level="4.2" data-path="randomization-and-design.html"><a href="randomization-and-design.html#urn-drawing-or-complete-randomization-into-2-or-more-groups"><i class="fa fa-check"></i><b>4.2</b> Urn-Drawing or Complete Randomization into 2 or more groups</a></li>
<li class="chapter" data-level="4.3" data-path="randomization-and-design.html"><a href="randomization-and-design.html#factorial-designs"><i class="fa fa-check"></i><b>4.3</b> Factorial Designs</a></li>
<li class="chapter" data-level="4.4" data-path="randomization-and-design.html"><a href="randomization-and-design.html#block-random-assignment"><i class="fa fa-check"></i><b>4.4</b> Block Random Assignment</a><ul>
<li class="chapter" data-level="4.4.1" data-path="randomization-and-design.html"><a href="randomization-and-design.html#using-only-a-few-covariates-to-create-blocks"><i class="fa fa-check"></i><b>4.4.1</b> Using only a few covariates to create blocks</a></li>
<li class="chapter" data-level="4.4.2" data-path="randomization-and-design.html"><a href="randomization-and-design.html#multivariate-blocking-using-many-covariates"><i class="fa fa-check"></i><b>4.4.2</b> Multivariate blocking using many covariates</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="randomization-and-design.html"><a href="randomization-and-design.html#cluster-random-assignment"><i class="fa fa-check"></i><b>4.5</b> Cluster random assignment</a></li>
<li class="chapter" data-level="4.6" data-path="randomization-and-design.html"><a href="randomization-and-design.html#other-designs"><i class="fa fa-check"></i><b>4.6</b> Other designs</a></li>
<li class="chapter" data-level="4.7" data-path="randomization-and-design.html"><a href="randomization-and-design.html#assessing-randomization-balance-testing"><i class="fa fa-check"></i><b>4.7</b> Assessing randomization (balance testing)</a><ul>
<li class="chapter" data-level="4.7.1" data-path="randomization-and-design.html"><a href="randomization-and-design.html#what-to-do-with-failed-randomization-assessments"><i class="fa fa-check"></i><b>4.7.1</b> What to do with &#x201C;failed&#x201D; randomization assessments?</a></li>
<li class="chapter" data-level="4.7.2" data-path="randomization-and-design.html"><a href="randomization-and-design.html#minimizing-the-chances-of-failed-randomization"><i class="fa fa-check"></i><b>4.7.2</b> Minimizing the chances of &#x201C;failed&#x201D; randomization</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="analysis-choices.html"><a href="analysis-choices.html"><i class="fa fa-check"></i><b>5</b> Analysis Choices</a><ul>
<li class="chapter" data-level="5.1" data-path="analysis-choices.html"><a href="analysis-choices.html#completely-or-urn-draw-randomized-trials"><i class="fa fa-check"></i><b>5.1</b> Completely or Urn-Draw Randomized Trials</a><ul>
<li class="chapter" data-level="5.1.1" data-path="analysis-choices.html"><a href="analysis-choices.html#two-arms"><i class="fa fa-check"></i><b>5.1.1</b> Two arms</a></li>
<li class="chapter" data-level="5.1.2" data-path="analysis-choices.html"><a href="analysis-choices.html#multiple-arms"><i class="fa fa-check"></i><b>5.1.2</b> Multiple arms</a></li>
<li class="chapter" data-level="5.1.3" data-path="analysis-choices.html"><a href="analysis-choices.html#multiple-outcomes"><i class="fa fa-check"></i><b>5.1.3</b> Multiple Outcomes</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="analysis-choices.html"><a href="analysis-choices.html#covariance-adjustment-the-use-of-background-information-to-increase-precision"><i class="fa fa-check"></i><b>5.2</b> Covariance Adjustment (the use of background information to increase precision)</a><ul>
<li class="chapter" data-level="5.2.1" data-path="analysis-choices.html"><a href="analysis-choices.html#intuition-about-bias-in-the-least-squares-estimator-of-the-ate-with-covariates"><i class="fa fa-check"></i><b>5.2.1</b> Intuition about bias in the least squares estimator of the ATE with covariates</a></li>
<li class="chapter" data-level="5.2.2" data-path="analysis-choices.html"><a href="analysis-choices.html#the-lin-approach-to-covariance-adjustment"><i class="fa fa-check"></i><b>5.2.2</b> The Lin Approach to Covariance Adjustment</a></li>
<li class="chapter" data-level="5.2.3" data-path="analysis-choices.html"><a href="analysis-choices.html#the-rosenbaum-approach-the-covariance-adjustment"><i class="fa fa-check"></i><b>5.2.3</b> The Rosenbaum Approach The Covariance Adjustment</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="analysis-choices.html"><a href="analysis-choices.html#how-to-choose-covariates-for-covariance-adjustment"><i class="fa fa-check"></i><b>5.3</b> How to choose covariates for covariance adjustment?</a></li>
<li class="chapter" data-level="5.4" data-path="analysis-choices.html"><a href="analysis-choices.html#blockrandanalysis"><i class="fa fa-check"></i><b>5.4</b> Block-randomized trials</a><ul>
<li class="chapter" data-level="5.4.1" data-path="analysis-choices.html"><a href="analysis-choices.html#testing-the-null-of-no-effects-with-binary-outcomes-and-block-randomization-cochran-mantel-haenszel-cmh-test-for-k-x-2-x-2-tables"><i class="fa fa-check"></i><b>5.4.1</b> Testing the null of no effects with binary outcomes and block randomization: Cochran-Mantel-Haenszel (CMH) test for K X 2 X 2 tables</a></li>
<li class="chapter" data-level="5.4.2" data-path="analysis-choices.html"><a href="analysis-choices.html#blockrandate"><i class="fa fa-check"></i><b>5.4.2</b> Estimating an overall Average Treatment Effect</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="analysis-choices.html"><a href="analysis-choices.html#clusterrandanalysis"><i class="fa fa-check"></i><b>5.5</b> Cluster-randomized trials</a><ul>
<li class="chapter" data-level="5.5.1" data-path="analysis-choices.html"><a href="analysis-choices.html#bias-when-cluster-size-is-correlated-with-potential-outcomes"><i class="fa fa-check"></i><b>5.5.1</b> Bias when cluster size is correlated with potential outcomes</a></li>
<li class="chapter" data-level="5.5.2" data-path="analysis-choices.html"><a href="analysis-choices.html#incorrect-false-positive-rates-from-tests-and-confidence-intervals"><i class="fa fa-check"></i><b>5.5.2</b> Incorrect false positive rates from tests and confidence intervals</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="poweranalysis.html"><a href="poweranalysis.html"><i class="fa fa-check"></i><b>6</b> Power Analysis</a><ul>
<li class="chapter" data-level="6.1" data-path="poweranalysis.html"><a href="poweranalysis.html#an-example-of-the-off-the-shelf-approach"><i class="fa fa-check"></i><b>6.1</b> An example of the off-the-shelf approach</a></li>
<li class="chapter" data-level="6.2" data-path="poweranalysis.html"><a href="poweranalysis.html#an-example-of-the-simulation-approach"><i class="fa fa-check"></i><b>6.2</b> An example of the simulation approach</a></li>
<li class="chapter" data-level="6.3" data-path="poweranalysis.html"><a href="poweranalysis.html#when-to-use-which-approach"><i class="fa fa-check"></i><b>6.3</b> When to use which approach</a></li>
<li class="chapter" data-level="6.4" data-path="poweranalysis.html"><a href="poweranalysis.html#additional-examples-of-the-simulation-approach"><i class="fa fa-check"></i><b>6.4</b> Additional examples of the simulation approach</a><ul>
<li class="chapter" data-level="6.4.1" data-path="poweranalysis.html"><a href="poweranalysis.html#a-two-by-two-design-with-interaction"><i class="fa fa-check"></i><b>6.4.1</b> A two-by-two design with interaction</a></li>
<li class="chapter" data-level="6.4.2" data-path="poweranalysis.html"><a href="poweranalysis.html#covariate-adjustment-with-the-lin-estimator"><i class="fa fa-check"></i><b>6.4.2</b> Covariate adjustment with the Lin estimator</a></li>
<li class="chapter" data-level="6.4.3" data-path="poweranalysis.html"><a href="poweranalysis.html#incorporating-declaredesign-into-oes-power-tools"><i class="fa fa-check"></i><b>6.4.3</b> Incorporating DeclareDesign into OES Power Tools</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="working-with-data.html"><a href="working-with-data.html"><i class="fa fa-check"></i><b>7</b> Working with data</a><ul>
<li class="chapter" data-level="7.1" data-path="working-with-data.html"><a href="working-with-data.html#general-questions-we-ask-of-a-data-set"><i class="fa fa-check"></i><b>7.1</b> General questions we ask of a data set</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="glossary-of-terms.html"><a href="glossary-of-terms.html"><i class="fa fa-check"></i><b>8</b> <span>Glossary of Terms</span></a></li>
<li class="chapter" data-level="9" data-path="appendix.html"><a href="appendix.html"><i class="fa fa-check"></i><b>9</b> <span>Appendix</span></a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://oes.gsa.gov" target="blank">Published by the OES</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">OES Standard Operating Procedures for The Design and Statistical Analysis of Experiments.</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="analysis-choices" class="section level1">
<h1><span class="header-section-number">Chapter 5</span> Analysis Choices</h1>
<p>We organize our discussion of analysis tactics by a study&#x2019;s design. Different study designs require different analyses. But there are a few general tactics that we use to pursue the strategy of transparent, valid, and statistically precise statements about the results of our experiments.</p>
<p>The nature of the data that we expect to see from a given experiment also informs our analysis plans. For example, we may make some choices based on on the nature of the measured outcome &#x2014; a binary outcome, a symmetrically distributed continuous outcome, and a heavily skewed continuous outcome each might each call for different analytical approaches.</p>
<p>We tend to ask three questions of each of our studies, and we answer each with a different statistical procedure:</p>
<ol style="list-style-type: decimal">
<li>Can we <em>detect an effect</em> in our experiment? (We use hypothesis tests to answer this question).</li>
<li>What is our best guess about the <em>size of the effect</em> of the experiment? (We estimate the average treatment effect of our interventions to answer this question.)</li>
<li><em>How precise</em> is our guess? (We report confidence intervals and standard errors to answer this question.)</li>
</ol>
<p>Each procedure below describes methods of answering those three questions for different categories of experiments. In our <a href="https://oes.gsa.gov/methodsdetail/#analysis-plans">Analysis Plans</a>, we try to anticipate many of the common decisions involved in data analysis &#x2014; including how we will treat missing data, how we will rescale, recode, and combine columns of raw data, etc. We touch on some of these topics below in general terms.</p>
<div id="completely-or-urn-draw-randomized-trials" class="section level2">
<h2><span class="header-section-number">5.1</span> Completely or Urn-Draw Randomized Trials</h2>
<div id="two-arms" class="section level3">
<h3><span class="header-section-number">5.1.1</span> Two arms</h3>
<div id="continuous-outcomes" class="section level4">
<h4><span class="header-section-number">5.1.1.1</span> Continuous outcomes</h4>
<p>In a completely randomized trial where outcomes take on many levels (units
like times, counts of events, dollars, percentages, etc.), we assess the <em>weak null hypothesis</em> of no average effects, we estimate an average treatment effect, and we often also assess the <em>sharp null hypothesis</em> of no effect for any unit using some test statistic other than a difference of means.<a href="references.html#fn7" class="footnote-ref" id="fnref7"><sup>7</sup></a> This last assessment allows us to check on whether our choice to focus on mean differences matters for our substantive interpretation of the study.</p>
<div id="estimating-the-average-treatment-effect-and-testing-the-weak-null-of-no-average-effects" class="section level5">
<h5><span class="header-section-number">5.1.1.1.1</span> Estimating the average treatment effect and testing the weak null of no average effects</h5>
<p>We show the kind of code we use for these purposes here. Below, <code>Y</code> is the outcome variable and <code>Z</code> is an indicator of the assignment to treatment.</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb75-1" title="1"><span class="co">## This function comes from the estimatr package</span></a>
<a class="sourceLine" id="cb75-2" title="2">estAndSE1 &lt;-<span class="st"> </span><span class="kw">difference_in_means</span>(Y <span class="op">~</span><span class="st"> </span>Z,<span class="dt">data =</span> dat1)</a>
<a class="sourceLine" id="cb75-3" title="3"><span class="kw">print</span>(estAndSE1)</a></code></pre></div>
<pre><code>Design:  Standard 
  Estimate Std. Error t value  Pr(&gt;|t|) CI Lower CI Upper    DF
Z    4.637      1.039   4.465 8.792e-05    2.524     6.75 33.12</code></pre>
<p>Notice that the standard errors that we use are not the same as those produced by OLS by default:</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb77-1" title="1">estAndSE1OLS &lt;-<span class="st"> </span><span class="kw">lm</span>(Y<span class="op">~</span>Z,<span class="dt">data=</span>dat1)</a>
<a class="sourceLine" id="cb77-2" title="2"><span class="kw">summary</span>(estAndSE1OLS)<span class="op">$</span>coef</a></code></pre></div>
<pre><code>            Estimate Std. Error t value  Pr(&gt;|t|)
(Intercept)    2.132     0.4465   4.775 6.283e-06
Z              4.637     0.8930   5.193 1.123e-06</code></pre>
<p>The standard errors we prefer reflect repeated randomization from a fixed experimental pool. This is known as the HC2 standard error. Specifically, <span class="citation">Lin (<a href="#ref-lin_agnostic_2013">2013</a>)</span> and <span class="citation">Samii and Aronow (<a href="#ref-samii_equivalencies_2012">2012</a>)</span> show that the standard error estimator derived for an unbiased average treatment effect within a &#x201C;finite-sample&#x201D; or design-based framework (i.e., the Neyman standard error) is equivalent to the HC2 standard error. These SEs are produced by default from the <code>estimatr</code> package&#x2019;s function <code>difference_in_means()</code> and the <code>lmtest</code> package&#x2019;s functions <code>coeftest()</code> and <code>coefci()</code>. They can also be produced using the <code>vcovHC()</code> function from the <code>sandwich</code> package.</p>
<p>While our preference for HC2 errors follows from their design-based justification, many researchers instead encounter them as one of several methods of correcting OLS standard errors for a problem called <em>heteroscedasticity</em>. Essentially, this means that the variance of the regression model&#x2019;s error term is not constant across observations.<a href="references.html#fn8" class="footnote-ref" id="fnref8"><sup>8</sup></a> When using OLS to analyze data from a two-arm randomized trial, for instance, this might occur because the variance of the outcome is different in the treatment and control groups. This is quite common in practice.</p>
</div>
<div id="testing-the-sharp-null-of-no-effects" class="section level5">
<h5><span class="header-section-number">5.1.1.1.2</span> Testing the sharp null of no effects</h5>
<p>We often assess the sharp null of no effects via direct permutation as a check on the assumptions underlying the calculations and statistical inferences above. We tend to use a <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span>-statistic as our test statistic in this case to parallel the above tests. But we might use a rank-based test statistic instead if we are concerned about long-tails (i.e., skew) reducing statistical power.</p>
<p>Below, we show how to perform these tests using two different R packages: <code>coin</code>, and <code>ri2</code>. First the <code>coin</code> package <span class="citation">(Hothorn et al. <a href="#ref-R-coin">2021</a>)</span>:</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb79-1" title="1"><span class="co">## The coin package</span></a>
<a class="sourceLine" id="cb79-2" title="2">test1coinT &lt;-<span class="st"> </span><span class="kw">oneway_test</span>(Y<span class="op">~</span><span class="kw">factor</span>(Z),<span class="dt">data=</span>dat1,<span class="dt">distribution=</span><span class="kw">approximate</span>(<span class="dt">nresample=</span><span class="dv">1000</span>))</a>
<a class="sourceLine" id="cb79-3" title="3">test1coinT</a></code></pre></div>
<pre><code>
    Approximative Two-Sample Fisher-Pitman Permutation Test

data:  Y by factor(Z) (0, 1)
Z = -4.6, p-value &lt;0.001
alternative hypothesis: true mu is not equal to 0</code></pre>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb81-1" title="1">test1coinR&lt;-<span class="st"> </span><span class="kw">oneway_test</span>(rankY<span class="op">~</span><span class="kw">factor</span>(Z),<span class="dt">data=</span>dat1,<span class="dt">distribution=</span><span class="kw">approximate</span>(<span class="dt">nresample=</span><span class="dv">1000</span>))</a>
<a class="sourceLine" id="cb81-2" title="2">test1coinR</a></code></pre></div>
<pre><code>
    Approximative Two-Sample Fisher-Pitman Permutation Test

data:  rankY by factor(Z) (0, 1)
Z = -4.9, p-value &lt;0.001
alternative hypothesis: true mu is not equal to 0</code></pre>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb83-1" title="1">test1coinWR &lt;-<span class="st"> </span><span class="kw">wilcox_test</span>(Y<span class="op">~</span><span class="kw">factor</span>(Z),<span class="dt">data=</span>dat1,<span class="dt">distribution=</span><span class="kw">approximate</span>(<span class="dt">nresample=</span><span class="dv">1000</span>))</a>
<a class="sourceLine" id="cb83-2" title="2">test1coinWR</a></code></pre></div>
<pre><code>
    Approximative Wilcoxon-Mann-Whitney Test

data:  Y by factor(Z) (0, 1)
Z = -4.9, p-value &lt;0.001
alternative hypothesis: true mu is not equal to 0</code></pre>
<p>Next, the ri2 package <span class="citation">(Coppock <a href="#ref-R-ri2">2022</a><a href="#ref-R-ri2">b</a>)</span>:</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb85-1" title="1"><span class="co">## The ri2 package</span></a>
<a class="sourceLine" id="cb85-2" title="2">thedesign1 &lt;-<span class="st"> </span>randomizr<span class="op">:::</span><span class="kw">declare_ra</span>(<span class="dt">N=</span>ndat1,<span class="dt">m=</span><span class="kw">sum</span>(dat1<span class="op">$</span>Z))</a>
<a class="sourceLine" id="cb85-3" title="3">thedesign1</a></code></pre></div>
<pre><code>Random assignment procedure: Complete random assignment 
Number of units: 100 
Number of treatment arms: 2 
The possible treatment categories are 0 and 1.
The number of possible random assignments is approximately infinite. 
The probabilities of assignment are constant across units: 
prob_0 prob_1 
  0.75   0.25 </code></pre>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb87-1" title="1">test1riT &lt;-<span class="st"> </span><span class="kw">conduct_ri</span>(Y <span class="op">~</span><span class="st"> </span>Z, <span class="dt">declaration =</span> thedesign1,</a>
<a class="sourceLine" id="cb87-2" title="2">                       <span class="dt">sharp_hypothesis =</span> <span class="dv">0</span>, <span class="dt">data =</span> dat1, <span class="dt">sims =</span> <span class="dv">1000</span>)</a>
<a class="sourceLine" id="cb87-3" title="3"><span class="kw">tidy</span>(test1riT)</a></code></pre></div>
<pre><code>  term estimate p.value
1    Z    4.637       0</code></pre>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb89-1" title="1">test1riR &lt;-<span class="st"> </span><span class="kw">conduct_ri</span>(rankY <span class="op">~</span><span class="st"> </span>Z, <span class="dt">declaration =</span> thedesign1,</a>
<a class="sourceLine" id="cb89-2" title="2">                       <span class="dt">sharp_hypothesis =</span> <span class="dv">0</span>, <span class="dt">data =</span> dat1, <span class="dt">sims =</span> <span class="dv">1000</span>)</a>
<a class="sourceLine" id="cb89-3" title="3"><span class="kw">tidy</span>(test1riR)</a></code></pre></div>
<pre><code>  term estimate p.value
1    Z     30.8       0</code></pre>
</div>
</div>
<div id="binary-outcomes" class="section level4">
<h4><span class="header-section-number">5.1.1.2</span> Binary outcomes</h4>
<p>We tend to focus on differences in proportions when we are working with binary outcomes. A statement such as &#x201C;The effect was 5 percentage points.&#x201D; has tended to make communication with our policy partners easier than a discussion in terms of log odds or odds ratios. Our tests of the hypothesis of no difference may change in the case of binary outcomes, however, in order to increase statistical power. In addition to difficulties in interpretation and communication, we avoid logistic regression coefficients because of the bias problem noticed by <span class="citation">Freedman (<a href="#ref-freedman2008randomization">2008</a><a href="#ref-freedman2008randomization">b</a>)</span> in the case of covariance adjustment or more complicated research designs.</p>
<div id="estimating-the-average-treatment-effect-and-testing-the-weak-null-of-no-average-effects-1" class="section level5">
<h5><span class="header-section-number">5.1.1.2.1</span> Estimating the average treatment effect and testing the weak null of no average effects</h5>
<p>We can estimate effects and produce standard errors for differences of proportions using the same process as above. The average treatment effect estimate here represents the difference in the proportions of positive responses (i.e., <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">Y=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>) between the treatment conditions. The standard error is still valid because it is based on the design of the study and not the distribution of the outcomes.</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb91-1" title="1"><span class="co">## Make some binary outcomes</span></a>
<a class="sourceLine" id="cb91-2" title="2">dat1<span class="op">$</span>u &lt;-<span class="st"> </span><span class="kw">runif</span>(ndat1)</a>
<a class="sourceLine" id="cb91-3" title="3">dat1<span class="op">$</span>v &lt;-<span class="st"> </span><span class="kw">runif</span>(ndat1)</a>
<a class="sourceLine" id="cb91-4" title="4">dat1<span class="op">$</span>y0bin &lt;-<span class="st"> </span><span class="kw">ifelse</span>(dat1<span class="op">$</span>u<span class="op">&gt;</span>.<span class="dv">5</span>, <span class="dv">1</span>, <span class="dv">0</span>) <span class="co"># control potential outcome</span></a>
<a class="sourceLine" id="cb91-5" title="5">dat1<span class="op">$</span>y1bin &lt;-<span class="st"> </span><span class="kw">ifelse</span>((dat1<span class="op">$</span>u<span class="op">+</span>dat1<span class="op">$</span>v) <span class="op">&gt;</span>.<span class="dv">75</span>, <span class="dv">1</span>, <span class="dv">0</span>) <span class="co"># treated potential outcomes</span></a>
<a class="sourceLine" id="cb91-6" title="6">dat1<span class="op">$</span>Ybin &lt;-<span class="st"> </span><span class="kw">with</span>(dat1, Z<span class="op">*</span>y1bin <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span><span class="op">-</span>Z)<span class="op">*</span>y0bin)</a>
<a class="sourceLine" id="cb91-7" title="7">truePropDiff &lt;-<span class="st"> </span><span class="kw">mean</span>(dat1<span class="op">$</span>y1bin) <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>(dat1<span class="op">$</span>y0bin)</a></code></pre></div>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb92-1" title="1">estAndSE2 &lt;-<span class="st"> </span><span class="kw">difference_in_means</span>(Ybin<span class="op">~</span>Z,<span class="dt">data=</span>dat1)</a>
<a class="sourceLine" id="cb92-2" title="2"><span class="kw">print</span>(estAndSE2)</a></code></pre></div>
<pre><code>Design:  Standard 
  Estimate Std. Error t value Pr(&gt;|t|) CI Lower CI Upper    DF
Z     0.04     0.1168  0.3425   0.7337  -0.1959   0.2759 40.93</code></pre>
<p>When we have an experiment that includes a treatment and control group with binary outcomes, and when we are estimating the ATE, the standard error from a difference in proportions test is the same as the Neyman standard error (and therefore the HC2 error). In contrast, the standard error from a regular OLS regression with a binary outcome &#x2014; sometimes called a <em>linear probability model</em> &#x2014; will be at least slightly incorrect due to inherent heteroscecdasticity in such models <span class="citation">(Angrist and Pischke <a href="#ref-angrist2009mostly">2009</a>)</span>.</p>
<p>To see some logic for this, first consider that difference-in-proportion standard errors are estimated with the following equation:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mover accent="true"><mrow><mi>S</mi><mi>E</mi></mrow><mo stretchy="true">^</mo></mover><mrow><mi>p</mi><mi>r</mi><mi>o</mi><mi>p</mi></mrow></msub><mo>=</mo><msqrt><mrow><mfrac><mrow><msub><mi>p</mi><mn>1</mn></msub><mo stretchy="false">(</mo><mn>1</mn><mo>&#x2212;</mo><msub><mi>p</mi><mn>1</mn></msub><mo stretchy="false">)</mo></mrow><msub><mi>n</mi><mn>1</mn></msub></mfrac><mo>+</mo><mfrac><mrow><msub><mi>p</mi><mn>2</mn></msub><mo stretchy="false">(</mo><mn>1</mn><mo>&#x2212;</mo><msub><mi>p</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow><msub><mi>n</mi><mn>2</mn></msub></mfrac></mrow></msqrt></mrow><annotation encoding="application/x-tex">\widehat{SE}_{prop} = \sqrt{\frac{p_{1}(1-p_{1})}{n_{1}}+\frac{p_{2}(1-p_{2})}{n_{2}}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9833em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">SE</span></span></span><span class="svg-align" style="top:-3.6833em;"><span class="pstrut" style="height:3em;"></span><span style="height:0.3em;"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="0.3em" viewbox="0 0 2364 300" preserveaspectratio="none"><path d="M1181 0h2l1171 176c6 0 10 5 10 11l-2 23c-1 6-5 10
-11 10h-1L1182 67 15 220h-1c-6 0-10-4-11-10l-2-23c-1-6 4-11 10-11z"/></svg></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">ro</span><span class="mord mathnormal mtight">p</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.04em;vertical-align:-1.1106em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.9294em;"><span class="svg-align" style="top:-5em;"><span class="pstrut" style="height:5em;"></span><span class="mord" style="padding-left:1em;"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-3.8894em;"><span class="pstrut" style="height:5em;"></span><span class="hide-tail" style="min-width:1.02em;height:3.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="3.08em" viewbox="0 0 400000 3240" preserveaspectratio="xMinYMin slice"><path d="M473,2793
c339.3,-1799.3,509.3,-2700,510,-2702 l0 -0
c3.3,-7.3,9.3,-11,18,-11 H400000v40H1017.7
s-90.5,478,-276.2,1466c-185.7,988,-279.5,1483,-281.5,1485c-2,6,-10,9,-24,9
c-8,0,-12,-0.7,-12,-2c0,-1.3,-5.3,-32,-16,-92c-50.7,-293.3,-119.7,-693.3,-207,-1200
c0,-1.3,-5.3,8.7,-16,30c-10.7,21.3,-21.3,42.7,-32,64s-16,33,-16,33s-26,-26,-26,-26
s76,-153,76,-153s77,-151,77,-151c0.7,0.7,35.7,202,105,604c67.3,400.7,102,602.7,104,
606zM1001 80h400000v40H1017.7z"/></svg></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:1.1106em;"><span></span></span></span></span></span></span></span></span></span></p>
<p>We can think of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">n_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> as the size of the group assigned treatment, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">n_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> as the size of the group assigned control, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">p_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> as the proportion of &#x201C;successes&#x201D; in the group assigned treatment, and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">p_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> as the proportion of &#x201C;successes&#x201D; in the group assigned control. Note that <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>i</mi></msub><mo stretchy="false">(</mo><mn>1</mn><mo>&#x2212;</mo><msub><mi>p</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p_{i}(1 - p_{i})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> &#x2014; the numerator in the fractions above &#x2014; represents the variance of a given proportion, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">p_{i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>.</p>
<p>Now, compare this with the Neyman standard error equation <span class="citation">(Lin <a href="#ref-lin_agnostic_2013">2013</a>)</span>:<a href="references.html#fn9" class="footnote-ref" id="fnref9"><sup>9</sup></a></p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mover accent="true"><mrow><mi>S</mi><mi>E</mi></mrow><mo stretchy="true">^</mo></mover><mrow><mi>N</mi><mi>e</mi><mi>y</mi><mi>m</mi><mi>a</mi><mi>n</mi></mrow></msub><mo>=</mo><msqrt><mrow><mfrac><mrow><mi>V</mi><mi>A</mi><mi>R</mi><mo stretchy="false">(</mo><msub><mi>Y</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><msub><mi>n</mi><mn>1</mn></msub></mfrac><mo>+</mo><mfrac><mrow><mi>V</mi><mi>A</mi><mi>R</mi><mo stretchy="false">(</mo><msub><mi>Y</mi><mi>c</mi></msub><mo stretchy="false">)</mo></mrow><msub><mi>n</mi><mn>2</mn></msub></mfrac></mrow></msqrt></mrow><annotation encoding="application/x-tex">\widehat{SE}_{Neyman} = \sqrt{\frac{VAR(Y_{t})}{n_1}+\frac{VAR(Y_{c})}{n_2}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9833em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">SE</span></span></span><span class="svg-align" style="top:-3.6833em;"><span class="pstrut" style="height:3em;"></span><span style="height:0.3em;"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="0.3em" viewbox="0 0 2364 300" preserveaspectratio="none"><path d="M1181 0h2l1171 176c6 0 10 5 10 11l-2 23c-1 6-5 10
-11 10h-1L1182 67 15 220h-1c-6 0-10-4-11-10l-2-23c-1-6 4-11 10-11z"/></svg></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">ey</span><span class="mord mathnormal mtight">man</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.04em;vertical-align:-1.1106em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.9294em;"><span class="svg-align" style="top:-5em;"><span class="pstrut" style="height:5em;"></span><span class="mord" style="padding-left:1em;"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-3.8894em;"><span class="pstrut" style="height:5em;"></span><span class="hide-tail" style="min-width:1.02em;height:3.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="3.08em" viewbox="0 0 400000 3240" preserveaspectratio="xMinYMin slice"><path d="M473,2793
c339.3,-1799.3,509.3,-2700,510,-2702 l0 -0
c3.3,-7.3,9.3,-11,18,-11 H400000v40H1017.7
s-90.5,478,-276.2,1466c-185.7,988,-279.5,1483,-281.5,1485c-2,6,-10,9,-24,9
c-8,0,-12,-0.7,-12,-2c0,-1.3,-5.3,-32,-16,-92c-50.7,-293.3,-119.7,-693.3,-207,-1200
c0,-1.3,-5.3,8.7,-16,30c-10.7,21.3,-21.3,42.7,-32,64s-16,33,-16,33s-26,-26,-26,-26
s76,-153,76,-153s77,-151,77,-151c0.7,0.7,35.7,202,105,604c67.3,400.7,102,602.7,104,
606zM1001 80h400000v40H1017.7z"/></svg></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:1.1106em;"><span></span></span></span></span></span></span></span></span></span></p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">Y_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is the vector of observed outcomes under control, and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">Y_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is the vector of observed outcomes under treatment. This equation indicates that we use the observed variances in each treatment group to estimate the Neyman standard error for a difference in means.</p>
<p>The code below compares the various standard error estimators discussed here.</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb94-1" title="1">nt &lt;-<span class="st"> </span><span class="kw">sum</span>(dat1<span class="op">$</span>Z)</a>
<a class="sourceLine" id="cb94-2" title="2">nc &lt;-<span class="st"> </span><span class="kw">sum</span>(<span class="dv">1</span><span class="op">-</span>dat1<span class="op">$</span>Z)</a>
<a class="sourceLine" id="cb94-3" title="3"></a>
<a class="sourceLine" id="cb94-4" title="4"><span class="co">## 2. Find SE for difference of proportions.</span></a>
<a class="sourceLine" id="cb94-5" title="5">p1 &lt;-<span class="st"> </span><span class="kw">mean</span>(dat1<span class="op">$</span>Ybin[dat1<span class="op">$</span>Z<span class="op">==</span><span class="dv">1</span>])</a>
<a class="sourceLine" id="cb94-6" title="6">p0 &lt;-<span class="st"> </span><span class="kw">mean</span>(dat1<span class="op">$</span>Ybin[dat1<span class="op">$</span>Z<span class="op">==</span><span class="dv">0</span>])</a>
<a class="sourceLine" id="cb94-7" title="7">se1 &lt;-<span class="st"> </span>(p1<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>p1))<span class="op">/</span>nt</a>
<a class="sourceLine" id="cb94-8" title="8">se0 &lt;-<span class="st"> </span>(p0<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>p0))<span class="op">/</span>nc</a>
<a class="sourceLine" id="cb94-9" title="9">se_prop &lt;-<span class="st"> </span><span class="kw">round</span>(<span class="kw">sqrt</span>(se1 <span class="op">+</span><span class="st"> </span>se0), <span class="dv">4</span>)</a>
<a class="sourceLine" id="cb94-10" title="10"></a>
<a class="sourceLine" id="cb94-11" title="11"><span class="co">## 3. Find Neyman SE</span></a>
<a class="sourceLine" id="cb94-12" title="12">varc_s &lt;-<span class="st"> </span><span class="kw">var</span>(dat1<span class="op">$</span>Ybin[dat1<span class="op">$</span>Z <span class="op">==</span><span class="st"> </span><span class="dv">0</span>])</a>
<a class="sourceLine" id="cb94-13" title="13">vart_s &lt;-<span class="st"> </span><span class="kw">var</span>(dat1<span class="op">$</span>Ybin[dat1<span class="op">$</span>Z <span class="op">==</span><span class="st"> </span><span class="dv">1</span>])</a>
<a class="sourceLine" id="cb94-14" title="14">se_neyman &lt;-<span class="st"> </span><span class="kw">round</span>(<span class="kw">sqrt</span>((vart_s<span class="op">/</span>nt) <span class="op">+</span><span class="st"> </span>(varc_s<span class="op">/</span>nc)), <span class="dv">4</span>)</a>
<a class="sourceLine" id="cb94-15" title="15"></a>
<a class="sourceLine" id="cb94-16" title="16"><span class="co">## 4. Find OLS SE</span></a>
<a class="sourceLine" id="cb94-17" title="17">simpOLS &lt;-<span class="st"> </span><span class="kw">lm</span>(Ybin<span class="op">~</span>Z,dat1)</a>
<a class="sourceLine" id="cb94-18" title="18">se_ols &lt;-<span class="st"> </span><span class="kw">round</span>(<span class="kw">coef</span>(<span class="kw">summary</span>(simpOLS))[<span class="st">&quot;Z&quot;</span>, <span class="st">&quot;Std. Error&quot;</span>], <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb94-19" title="19"></a>
<a class="sourceLine" id="cb94-20" title="20"><span class="co">## 5. Find Neyman SE (which are the HC2 SEs)</span></a>
<a class="sourceLine" id="cb94-21" title="21">se_neyman2 &lt;-<span class="st"> </span><span class="kw">coeftest</span>(simpOLS,<span class="dt">vcov =</span> <span class="kw">vcovHC</span>(simpOLS,<span class="dt">type=</span><span class="st">&quot;HC2&quot;</span>))[<span class="dv">2</span>,<span class="dv">2</span>]</a>
<a class="sourceLine" id="cb94-22" title="22">se_neyman3 &lt;-<span class="st"> </span>estAndSE2<span class="op">$</span>std.error</a></code></pre></div>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb95-1" title="1"><span class="co">## 5. Show SEs</span></a>
<a class="sourceLine" id="cb95-2" title="2">se_compare &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">cbind</span>(se_prop, se_neyman, se_neyman2, se_neyman3, se_ols))</a>
<a class="sourceLine" id="cb95-3" title="3"><span class="kw">rownames</span>(se_compare) &lt;-<span class="st"> &quot;SE(ATE)&quot;</span></a>
<a class="sourceLine" id="cb95-4" title="4"><span class="kw">colnames</span>(se_compare) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;diff in prop&quot;</span>, <span class="st">&quot;neyman1&quot;</span>,<span class="st">&quot;neyman2&quot;</span>,<span class="st">&quot;neyman3&quot;</span>, <span class="st">&quot;ols&quot;</span>)</a>
<a class="sourceLine" id="cb95-5" title="5"><span class="kw">print</span>(se_compare)</a></code></pre></div>
<pre><code>        diff in prop neyman1 neyman2 neyman3  ols
SE(ATE)       0.1148  0.1168  0.1168  0.1168 0.12</code></pre>
</div>
<div id="testing-the-sharp-null-of-no-effects-1" class="section level5">
<h5><span class="header-section-number">5.1.1.2.2</span> Testing the sharp null of no effects</h5>
<p>In this case, with a binary treatment and a binary outcome, we could perform a simple test of the hypothesis that outcomes are independent of treatment assignment using what is called <em>Fisher&#x2019;s exact test</em>. We can also use the permutation-based approaches above to produce results that do not rely on asymptotic assumptions. Below we show how Fisher&#x2019;s exact test, the Exact Cochran-Mantel-Haenszel test, and the Exact <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>&#x3C7;</mi></mrow><annotation encoding="application/x-tex">\chi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">&#x3C7;</span></span></span></span>-squared test produce the same answers.</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb97-1" title="1">test2fisher &lt;-<span class="st"> </span><span class="kw">fisher.test</span>(<span class="dt">x=</span>dat1<span class="op">$</span>Z,<span class="dt">y=</span>dat1<span class="op">$</span>Ybin)</a>
<a class="sourceLine" id="cb97-2" title="2"><span class="kw">print</span>(test2fisher)</a></code></pre></div>
<pre><code>
    Fisher&apos;s Exact Test for Count Data

data:  dat1$Z and dat1$Ybin
p-value = 0.8
alternative hypothesis: true odds ratio is not equal to 1
95 percent confidence interval:
 0.4304 3.2617
sample estimates:
odds ratio 
     1.173 </code></pre>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb99-1" title="1">test2chisq &lt;-<span class="st"> </span><span class="kw">chisq_test</span>(<span class="kw">factor</span>(Ybin)<span class="op">~</span><span class="kw">factor</span>(Z),<span class="dt">data=</span>dat1,<span class="dt">distribution=</span><span class="kw">exact</span>())</a>
<a class="sourceLine" id="cb99-2" title="2"><span class="kw">print</span>(test2chisq)</a></code></pre></div>
<pre><code>
    Exact Pearson Chi-Squared Test

data:  factor(Ybin) by factor(Z) (0, 1)
chi-squared = 0.12, p-value = 0.8</code></pre>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb101-1" title="1">test2cmh &lt;-<span class="st"> </span><span class="kw">cmh_test</span>(<span class="kw">factor</span>(Ybin)<span class="op">~</span><span class="kw">factor</span>(Z),<span class="dt">data=</span>dat1,<span class="dt">distribution=</span><span class="kw">exact</span>())</a>
<a class="sourceLine" id="cb101-2" title="2"><span class="kw">print</span>(test2cmh)</a></code></pre></div>
<pre><code>
    Exact Generalized Cochran-Mantel-Haenszel Test

data:  factor(Ybin) by factor(Z) (0, 1)
chi-squared = 0.12, p-value = 0.8</code></pre>
<p>Notice that a difference of proportions test can also be done directly (rather than through OLS). Here, the null hypothesis is tested while using a binomial distribution rather than a Normal distribution to approximate the underlying randomization distribution. In reasonably-sized samples, both approximations perform well.</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb103-1" title="1">mat &lt;-<span class="st"> </span><span class="kw">with</span>(dat1,<span class="kw">table</span>(Z,Ybin))</a>
<a class="sourceLine" id="cb103-2" title="2">matpt&lt;-<span class="kw">prop.test</span>(mat[,<span class="dv">2</span><span class="op">:</span><span class="dv">1</span>])</a>
<a class="sourceLine" id="cb103-3" title="3">matpt</a></code></pre></div>
<pre><code>
    2-sample test for equality of proportions with continuity correction

data:  mat[, 2:1]
X-squared = 0.013, df = 1, p-value = 0.9
alternative hypothesis: two.sided
95 percent confidence interval:
 -0.2917  0.2117
sample estimates:
prop 1 prop 2 
  0.52   0.56 </code></pre>
</div>
</div>
</div>
<div id="multiple-arms" class="section level3">
<h3><span class="header-section-number">5.1.2</span> Multiple arms</h3>
<p>Multiple treatment arms can be analyzed as above, except that we now have
more than one comparison between a treated group and a control group. Such studies raise both substantive and statistical questions about multiple
testing (or &#x201C;multiple comparisons&#x201D;). For example, the <code>difference_in_means</code>
function asks which average treatment effect it should estimate &#x2014; and it
only presents one comparison at a time: here we compare the treatment <code>T2</code>
with the baseline outcome of <code>T1</code>. We can also compare both of <code>T2</code> and <code>T3</code> with <code>T1</code> at the same time, as in the second set of results (<code>lm_robust</code> implements the same standard errors as <code>difference_in_means</code> but allows for more flexibility).</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb105-1" title="1">estAndSE3 &lt;-<span class="st"> </span><span class="kw">difference_in_means</span>(Y<span class="op">~</span>Z4arms,<span class="dt">data=</span>dat1,<span class="dt">condition1=</span><span class="st">&quot;T1&quot;</span>,<span class="dt">condition2=</span><span class="st">&quot;T2&quot;</span>)</a>
<a class="sourceLine" id="cb105-2" title="2"><span class="kw">print</span>(estAndSE3)</a></code></pre></div>
<pre><code>Design:  Standard 
         Estimate Std. Error t value Pr(&gt;|t|) CI Lower CI Upper    DF
Z4armsT2   0.7329      1.298  0.5647   0.5749   -1.877    3.343 47.67</code></pre>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb107-1" title="1">estAndSE3multarms &lt;-<span class="st"> </span><span class="kw">lm_robust</span>(Y<span class="op">~</span>Z4arms,<span class="dt">data=</span>dat1)</a>
<a class="sourceLine" id="cb107-2" title="2"><span class="kw">print</span>(estAndSE3multarms)</a></code></pre></div>
<pre><code>            Estimate Std. Error t value Pr(&gt;|t|) CI Lower CI Upper DF
(Intercept)   2.5541     0.8786  2.9070 0.004532   0.8101    4.298 96
Z4armsT2      0.7329     1.2979  0.5647 0.573593  -1.8433    3.309 96
Z4armsT3      0.1798     1.1582  0.1552 0.876956  -2.1192    2.479 96
Z4armsT4      2.0372     1.2353  1.6491 0.102393  -0.4149    4.489 96</code></pre>
<p>In this case, we could make <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mo stretchy="false">(</mo><mn>4</mn><mo>&#xD7;</mo><mn>4</mn><mo stretchy="false">)</mo><mo>&#x2212;</mo><mn>4</mn><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mn>2</mn><mo stretchy="false">)</mo><mo>=</mo><mn>6</mn></mrow><annotation encoding="application/x-tex">((4 \times 4)-4)/2)=6</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">((</span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#xD7;</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">4</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">4</span><span class="mclose">)</span><span class="mord">/2</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">6</span></span></span></span> different possible comparisons between pairs of treatment groups. If there were really no effects of any treatment, and if we chose to reject the null at the standard significance threshold of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>&#x3B1;</mi><mo>=</mo><mi mathvariant="normal">.</mi><mn>05</mn></mrow><annotation encoding="application/x-tex">\alpha=.05</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">&#x3B1;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">.05</span></span></span></span>, we would actually claim that there was at least one effect <em>more than 5% of the time</em>. <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>&#x2212;</mo><mo stretchy="false">(</mo><mn>1</mn><mo>&#x2212;</mo><mi mathvariant="normal">.</mi><mn>05</mn><msup><mo stretchy="false">)</mo><mn>6</mn></msup><mo>=</mo><mi mathvariant="normal">.</mi><mn>27</mn></mrow><annotation encoding="application/x-tex">1 - ( 1 - .05)^6 = .27</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord">.05</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">6</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">.27</span></span></span></span>, or 27% of the time, we would make a false positive error, claiming an effect existed when it did not.</p>
<p>In general, our analyses of studies with multiple arms should reflect the fact that we are making multiple comparisons. Two points are worth emphasizing here. First, the family-wise error rate (FWER) of these tests will differ from the individual error rate of single test. In short, testing more than one hypothesis increases the chance of making at least one Type I error (i.e., incorrectly rejecting a true null hypothesis). Suppose instead of testing a single hypothesis at a conventional significance level of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>&#x3B1;</mi><mo>=</mo><mn>0.05</mn></mrow><annotation encoding="application/x-tex">\alpha = 0.05</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">&#x3B1;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.05</span></span></span></span> we tested two hypothesis at <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>&#x3B1;</mi><mo>=</mo><mn>0.05</mn></mrow><annotation encoding="application/x-tex">\alpha = 0.05</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">&#x3B1;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.05</span></span></span></span>. The probability of retaining both hypotheses is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>1</mn><mo>&#x2212;</mo><mi>&#x3B1;</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>=</mo><mi mathvariant="normal">.</mi><mn>9025</mn></mrow><annotation encoding="application/x-tex">(1-\alpha)^2 = .9025</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">&#x3B1;</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">.9025</span></span></span></span> and the probability of rejecting at least one of these hypotheses is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>&#x2212;</mo><mo stretchy="false">(</mo><mn>1</mn><mo>&#x2212;</mo><mi>&#x3B1;</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>=</mo><mi mathvariant="normal">.</mi><mn>0975</mn></mrow><annotation encoding="application/x-tex">1-(1-\alpha)^2 = .0975</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">&#x3B1;</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">.0975</span></span></span></span> &#x2014; almost double our stated significance threshold of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>&#x3B1;</mi><mo>=</mo><mn>0.05</mn></mrow><annotation encoding="application/x-tex">\alpha = 0.05</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">&#x3B1;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.05</span></span></span></span>.</p>
<p>Second, multiple tests will often be correlated, and our corrections for multiple testing should recognize these relationships (which will penalize the multiple testing less). When tests are correlated, this means that there is some relationship between the test statistics (e.g., student&#x2019;s t-statistic, or a <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>&#x3C7;</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\chi^{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0085em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">&#x3C7;</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span> statistic) used to perform inference in each case (e.g., calculating p-values). In other words, the test statistics are jointly distributed &#x2014; when one test statistic is higher, the other will tend to be higher as well.<a href="references.html#fn10" class="footnote-ref" id="fnref10"><sup>10</sup></a></p>
<p>This in mind, our standard practice in multi-arm trials is the following:</p>
<ul>
<li><p>First, decide on a focal, <strong>confirmatory</strong> comparison for the entire evaluation: say, control/status quo <em>versus</em> receiving any version of the treatment. This test should have more statistical power, and will also have a correctly controlled false positive rate. This will serve as the primary test on which our conclusions are based.</p></li>
<li><p>Next, either perform the rest of the comparisons as <strong>exploratory analyses</strong> &#x2014; i.e., as analyses that may inform future projects and give hints about where we might be seeing more or less of an effect, but which cannot serve as a foundation for overall conclusions on their own &#x2014; <em>OR</em> perform a series of additional confirmatory comparisons that adjusts for the collective false positive rate (generally to control the FWER, though we have sometimes consider adjustments to control the false discovery rate, or FDR).<a href="references.html#fn11" class="footnote-ref" id="fnref11"><sup>11</sup></a> We may use the Tukey HSD procedure for pairwise comparisons in a case like our example above <em>OR</em> test the hypotheses in a particular order to preserve statistical power <span class="citation">(Rosenbaum <a href="#ref-rosenbaum2008a">2008</a>)</span>.</p></li>
</ul>
<div id="adjusting-p-values-and-confidence-intervals-for-multiple-comparisons-using-tukey-hsd-in-r" class="section level4">
<h4><span class="header-section-number">5.1.2.1</span> Adjusting p-values and confidence intervals for multiple comparisons using Tukey HSD in R</h4>
<p>Here is an illustration of how we might adjust for multiple comparisons.</p>
<p>To reflect that fact that we are making multiple comparisons, we can adjust
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span>-values from (uncorrelated) tests to control the familywise error rate at <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>&#x3B1;</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">&#x3B1;</span></span></span></span> through either a single step procedure (e.g.&#xA0;<a href="https://en.wikipedia.org/wiki/Bonferroni_correction">Bonferroni correction</a>) or a stepwise stepwise procedure (such as the <a href="https://en.wikipedia.org/wiki/Holm%E2%80%93Bonferroni_method">Holm correction</a>). We might also control the false discovery rate (e.g., using the <a href="https://en.wikipedia.org/wiki/False_discovery_rate#Benjamini.E2.80.93Hochberg_procedure">Benjamini-Hochberg correction</a>).</p>
<p>Our standard practice is to adjust the FWER using what we often refer to as Holm correction/adjustment. For more on such adjustments and multiple comparisons see EGAP&#x2019;s <a href="https://egap.org/resource/10-things-to-know-about-multiple-comparisons/">10 Things you need to know about multiple comparisons</a>.</p>
<!-- Explain
here about what constitutes a family and how we choose. Also why Holm. And
when FDR.-->
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb109-1" title="1"><span class="co"># Get p-values but exclude intercept</span></a>
<a class="sourceLine" id="cb109-2" title="2">pvals &lt;-<span class="st"> </span><span class="kw">summary</span>(estAndSE3multarms)<span class="op">$</span>coef[<span class="dv">2</span><span class="op">:</span><span class="dv">4</span>,<span class="dv">4</span>]</a>
<a class="sourceLine" id="cb109-3" title="3"><span class="kw">round</span>(<span class="kw">p.adjust</span>(pvals, <span class="st">&quot;none&quot;</span>), <span class="dv">3</span>)</a></code></pre></div>
<pre><code>Z4armsT2 Z4armsT3 Z4armsT4 
   0.574    0.877    0.102 </code></pre>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb111-1" title="1"><span class="kw">round</span>(<span class="kw">p.adjust</span>(pvals, <span class="st">&quot;bonferroni&quot;</span>), <span class="dv">3</span>)</a></code></pre></div>
<pre><code>Z4armsT2 Z4armsT3 Z4armsT4 
   1.000    1.000    0.307 </code></pre>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb113-1" title="1"><span class="kw">round</span>(<span class="kw">p.adjust</span>(pvals, <span class="st">&quot;holm&quot;</span>), <span class="dv">3</span>)</a></code></pre></div>
<pre><code>Z4armsT2 Z4armsT3 Z4armsT4 
   1.000    1.000    0.307 </code></pre>
<div class="sourceCode" id="cb115"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb115-1" title="1"><span class="kw">round</span>(<span class="kw">p.adjust</span>(pvals, <span class="st">&quot;hochberg&quot;</span>), <span class="dv">3</span>) <span class="co">## The  FDR Correction</span></a></code></pre></div>
<pre><code>Z4armsT2 Z4armsT3 Z4armsT4 
   0.877    0.877    0.307 </code></pre>
<p>Simply adjusting <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span>-values from this linear model, however, would ignore the fact that we may be interested in other pairwise comparisons, such as the difference in effects between receiving <code>T3</code> vs <code>T4</code>. It also ignores potential correlations in the distribution of test statistics.</p>
<p>Below we demonstrate how to implement a <a href="https://en.wikipedia.org/wiki/Tukey%27s_range_test">Tukey Honestly Signficant Differences (HSD) test</a>. The Tukey HSD test (sometimes called a Tukey range test or just a
Tukey test) calculates multiple-comparison-adjusted <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span>-values and simultaneous confidence intervals <em>for all pairwise comparisons</em> in a model, while taking into account possible correlations between test statistics. It is similar to a two-sample t-test, but with built in adjustment for multiple comparisons.</p>
<p>The test statistic for any comparison between two equally-sized groups <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span> is:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>t</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mfrac><mrow><mover accent="true"><msub><mi>y</mi><mi>i</mi></msub><mo>&#x2C9;</mo></mover><mo>&#x2212;</mo><mover accent="true"><msub><mi>y</mi><mi>j</mi></msub><mo>&#x2C9;</mo></mover></mrow><mrow><mi>s</mi><msqrt><mfrac><mn>2</mn><mi>n</mi></mfrac></msqrt></mrow></mfrac></mrow><annotation encoding="application/x-tex">t_{ij} = \frac{\bar{y_i}-\bar{y_j}}{s\sqrt{\frac{2}{n}}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9012em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.9903em;vertical-align:-1.73em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.2603em;"><span style="top:-2.11em;"><span class="pstrut" style="height:3.2351em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.2351em;"><span class="svg-align" style="top:-3.8em;"><span class="pstrut" style="height:3.8em;"></span><span class="mord" style="padding-left:1em;"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-3.1951em;"><span class="pstrut" style="height:3.8em;"></span><span class="hide-tail" style="min-width:1.02em;height:1.88em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.88em" viewbox="0 0 400000 1944" preserveaspectratio="xMinYMin slice"><path d="M983 90
l0 -0
c4,-6.7,10,-10,18,-10 H400000v40
H1013.1s-83.4,268,-264.1,840c-180.7,572,-277,876.3,-289,913c-4.7,4.7,-12.7,7,-24,7
s-12,0,-12,0c-1.3,-3.3,-3.7,-11.7,-7,-25c-35.3,-125.3,-106.7,-373.3,-214,-744
c-10,12,-21,25,-33,39s-32,39,-32,39c-6,-5.3,-15,-14,-27,-26s25,-30,25,-30
c26.7,-32.7,52,-63,76,-91s52,-60,52,-60s208,722,208,722
c56,-175.3,126.3,-397.3,211,-666c84.7,-268.7,153.8,-488.2,207.5,-658.5
c53.7,-170.3,84.5,-266.8,92.5,-289.5z
M1001 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.6049em;"><span></span></span></span></span></span></span></span><span style="top:-3.4651em;"><span class="pstrut" style="height:3.2351em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.9121em;"><span class="pstrut" style="height:3.2351em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">&#x2C9;</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">&#x2C9;</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:1.73em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><msub><mi>y</mi><mi>i</mi></msub><mo>&#x2C9;</mo></mover></mrow><annotation encoding="application/x-tex">\bar{y_i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7622em;vertical-align:-0.1944em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">&#x2C9;</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><msub><mi>y</mi><mi>j</mi></msub><mo>&#x2C9;</mo></mover></mrow><annotation encoding="application/x-tex">\bar{y_j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8539em;vertical-align:-0.2861em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">&#x2C9;</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span> are the means in groups <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> and
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span>, respectively. The means are generally listed in descending order based on their size in each comparison. <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">s</span></span></span></span> is the pooled standard deviation of the outcome, and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> is the common sample size. A critical value is then chosen for <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">t_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9012em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> given the desired significance level, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>&#x3B1;</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">&#x3B1;</span></span></span></span>, the number of groups being compared, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span>, and the degrees of freedom, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>&#x2212;</mo><mi>k</mi></mrow><annotation encoding="application/x-tex">n-k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span>: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mrow><mi>&#x3B1;</mi><mo separator="true">,</mo><mi>k</mi><mo separator="true">,</mo><mi>n</mi></mrow></msub></mrow><annotation encoding="application/x-tex">t_{\alpha,k,n}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9012em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.0037em;">&#x3B1;</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>.</p>
<p>The confidence interval for any difference between equally-sized groups would then be:<a href="references.html#fn12" class="footnote-ref" id="fnref12"><sup>12</sup></a></p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo fence="true">[</mo><mover accent="true"><msub><mi>y</mi><mi>i</mi></msub><mo>&#x2C9;</mo></mover><mo>&#x2212;</mo><mover accent="true"><msub><mi>y</mi><mi>j</mi></msub><mo>&#x2C9;</mo></mover><mo>&#x2212;</mo><msub><mi>t</mi><mrow><mi>&#x3B1;</mi><mo separator="true">,</mo><mi>k</mi><mo separator="true">,</mo><mi>n</mi></mrow></msub><mi>s</mi><msqrt><mfrac><mn>2</mn><mi>n</mi></mfrac></msqrt><mspace width="0.5691em"></mspace><mo separator="true">,</mo><mspace width="0.5691em"></mspace><mover accent="true"><msub><mi>y</mi><mi>i</mi></msub><mo>&#x2C9;</mo></mover><mo>&#x2212;</mo><mover accent="true"><msub><mi>y</mi><mi>j</mi></msub><mo>&#x2C9;</mo></mover><mo>+</mo><msub><mi>t</mi><mrow><mi>&#x3B1;</mi><mo separator="true">,</mo><mi>k</mi><mo separator="true">,</mo><mi>n</mi></mrow></msub><mi>s</mi><msqrt><mfrac><mn>2</mn><mi>n</mi></mfrac></msqrt><mo fence="true">]</mo></mrow><annotation encoding="application/x-tex">\left[\bar{y_i}-\bar{y_j}-t_{\alpha,k,n}s\sqrt{\frac{2}{n}}\hspace{2mm},\hspace{2mm} \bar{y_i}-\bar{y_j}+t_{\alpha,k,n}s\sqrt{\frac{2}{n}}\right]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">[</span></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">&#x2C9;</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">&#x2C9;</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.0037em;">&#x3B1;</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord mathnormal">s</span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6516em;"><span class="svg-align" style="top:-4.4em;"><span class="pstrut" style="height:4.4em;"></span><span class="mord" style="padding-left:1em;"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">n</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-3.6116em;"><span class="pstrut" style="height:4.4em;"></span><span class="hide-tail" style="min-width:1.02em;height:2.48em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="2.48em" viewbox="0 0 400000 2592" preserveaspectratio="xMinYMin slice"><path d="M424,2478
c-1.3,-0.7,-38.5,-172,-111.5,-514c-73,-342,-109.8,-513.3,-110.5,-514
c0,-2,-10.7,14.3,-32,49c-4.7,7.3,-9.8,15.7,-15.5,25c-5.7,9.3,-9.8,16,-12.5,20
s-5,7,-5,7c-4,-3.3,-8.3,-7.7,-13,-13s-13,-13,-13,-13s76,-122,76,-122s77,-121,77,-121
s209,968,209,968c0,-2,84.7,-361.7,254,-1079c169.3,-717.3,254.7,-1077.7,256,-1081
l0 -0c4,-6.7,10,-10,18,-10 H400000
v40H1014.6
s-87.3,378.7,-272.6,1166c-185.3,787.3,-279.3,1182.3,-282,1185
c-2,6,-10,9,-24,9
c-8,0,-12,-0.7,-12,-2z M1001 80
h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.7884em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.5691em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.5691em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">&#x2C9;</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">&#x2C9;</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.0037em;">&#x3B1;</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord mathnormal">s</span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6516em;"><span class="svg-align" style="top:-4.4em;"><span class="pstrut" style="height:4.4em;"></span><span class="mord" style="padding-left:1em;"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">n</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-3.6116em;"><span class="pstrut" style="height:4.4em;"></span><span class="hide-tail" style="min-width:1.02em;height:2.48em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="2.48em" viewbox="0 0 400000 2592" preserveaspectratio="xMinYMin slice"><path d="M424,2478
c-1.3,-0.7,-38.5,-172,-111.5,-514c-73,-342,-109.8,-513.3,-110.5,-514
c0,-2,-10.7,14.3,-32,49c-4.7,7.3,-9.8,15.7,-15.5,25c-5.7,9.3,-9.8,16,-12.5,20
s-5,7,-5,7c-4,-3.3,-8.3,-7.7,-13,-13s-13,-13,-13,-13s76,-122,76,-122s77,-121,77,-121
s209,968,209,968c0,-2,84.7,-361.7,254,-1079c169.3,-717.3,254.7,-1077.7,256,-1081
l0 -0c4,-6.7,10,-10,18,-10 H400000
v40H1014.6
s-87.3,378.7,-272.6,1166c-185.3,787.3,-279.3,1182.3,-282,1185
c-2,6,-10,9,-24,9
c-8,0,-12,-0.7,-12,-2z M1001 80
h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.7884em;"><span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size4">]</span></span></span></span></span></span></span></p>
<p>We present an implementation of the Tukey HSD test using the <code>glht()</code> function from the <code>multcomp</code> package, which offers more flexiblity than the
<code>TukeyHSD</code> in the base <code>stats</code> package at the price of a slightly more complicated syntax.</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb117-1" title="1"><span class="co">## We can use aov() or lm()</span></a>
<a class="sourceLine" id="cb117-2" title="2"><span class="co">## aovmod &lt;- aov(Y~Z4arms, dat1)</span></a>
<a class="sourceLine" id="cb117-3" title="3">lmmod &lt;-<span class="st"> </span><span class="kw">lm</span>(Y<span class="op">~</span>Z4arms, dat1)</a></code></pre></div>
<p>Using the <code>glht()</code> function&#x2019;s <code>linfcnt</code> argument, we tell the function to
conduct a Tukey test of all pairwise comparisons for our treatment indicator, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Z</mi></mrow><annotation encoding="application/x-tex">Z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span></span></span></span>.</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb118-1" title="1">tukey_mc &lt;-<span class="st"> </span><span class="kw">glht</span>(lmmod, <span class="dt">linfct =</span> <span class="kw">mcp</span>(<span class="dt">Z4arms =</span> <span class="st">&quot;Tukey&quot;</span>))</a></code></pre></div>
<div class="sourceCode" id="cb119"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb119-1" title="1"><span class="kw">summary</span>(tukey_mc)</a></code></pre></div>
<pre><code>
     Simultaneous Tests for General Linear Hypotheses

Multiple Comparisons of Means: Tukey Contrasts


Fit: lm(formula = Y ~ Z4arms, data = dat1)

Linear Hypotheses:
             Estimate Std. Error t value Pr(&gt;|t|)
T2 - T1 == 0    0.733      1.226    0.60     0.93
T3 - T1 == 0    0.180      1.226    0.15     1.00
T4 - T1 == 0    2.037      1.226    1.66     0.35
T3 - T2 == 0   -0.553      1.226   -0.45     0.97
T4 - T2 == 0    1.304      1.226    1.06     0.71
T4 - T3 == 0    1.857      1.226    1.51     0.43
(Adjusted p values reported -- single-step method)</code></pre>
<p>We can plot the 95% family wise confidence intervals from these comparisons</p>
<div class="sourceCode" id="cb121"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb121-1" title="1"><span class="co">## Save dfault ploting parameters</span></a>
<a class="sourceLine" id="cb121-2" title="2">op &lt;-<span class="st"> </span><span class="kw">par</span>()</a>
<a class="sourceLine" id="cb121-3" title="3"><span class="co">## Add space to left-hand outer margin</span></a>
<a class="sourceLine" id="cb121-4" title="4"><span class="kw">par</span>(<span class="dt">oma =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">0</span>, <span class="dv">0</span>))</a>
<a class="sourceLine" id="cb121-5" title="5"><span class="kw">plot</span>(tukey_mc)</a></code></pre></div>
<p><img src="OES_SOP_files/figure-html/tukeyplot-1.png" width=".9\textwidth"></p>
<p>We can also obtain simultaneous confidence intervals at other levels of statistical significance using the <code>confint()</code> function.</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb122-1" title="1"><span class="co">## Generate and plot 90% confidence intervals</span></a>
<a class="sourceLine" id="cb122-2" title="2">tukey_mc_90ci &lt;-<span class="st"> </span><span class="kw">confint</span>(tukey_mc, <span class="dt">level =</span> <span class="fl">.90</span>)</a>
<a class="sourceLine" id="cb122-3" title="3"><span class="kw">plot</span>(tukey_mc_90ci)</a></code></pre></div>
<p><img src="OES_SOP_files/figure-html/plot_tukey_ci-1.png" width=".9\textwidth"></p>
<div class="sourceCode" id="cb123"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb123-1" title="1"><span class="co">## Restore plotting defaults, now</span></a>
<a class="sourceLine" id="cb123-2" title="2"><span class="kw">par</span>(op)</a></code></pre></div>
<p>See also: <code>pairwise.prop.test</code> for binary outcomes.</p>
</div>
</div>
<div id="multiple-outcomes" class="section level3">
<h3><span class="header-section-number">5.1.3</span> Multiple Outcomes</h3>
<p>Our studies often involve more than one outcome measure. Assessing the effect of even a simple two-arm treatment on 10 different outcomes raises the same kinds of questions that come up in the context of multi-arm trials, generally requiring applications of the methods discussed above.</p>
<!-- Insert examples here? Or not?-->
</div>
</div>
<div id="covariance-adjustment-the-use-of-background-information-to-increase-precision" class="section level2">
<h2><span class="header-section-number">5.2</span> Covariance Adjustment (the use of background information to increase precision)</h2>
<p>When we have background or baseline information about experimental units, we
can use this to increase the precision with which we estimate our treatment
effects (or, equivalently, increase the statistical power of our tests). We
prefer to use this information during the design phase to create block
randomized designs, but we sometimes have access to such background information
after the study has been fielded, and so we will pre-specify use of this
information to increase our statistical power.</p>
<p>We tend to avoid the practice of adjusting for the covariates
in a linear and additive fashion because of this estimator of the average
treatment effect is biased <span class="citation">(Freedman <a href="#ref-freedman2008rae">2008</a><a href="#ref-freedman2008rae">a</a>)</span> whereas a version of the
estimator that we call the &#x201C;Lin estimator&#x201D; is not <span class="citation">(Lin <a href="#ref-lin_agnostic_2013">2013</a>)</span>. Note
that the bias in the commonly used linear covariance adjustment estimator tends to
be quite small, and especially small when sample sizes are large
<span class="citation">(Lin <a href="#ref-lin_agnostic_2013">2013</a>)</span>. Yet, because it is basically costless to use the Lin
estimator, this is our standard practice (see also
<a href="https://declaredesign.org/blog/2018-09-11-controlling-pretreatment-covariates.html" class="uri">https://declaredesign.org/blog/2018-09-11-controlling-pretreatment-covariates.html</a>)</p>
<div id="intuition-about-bias-in-the-least-squares-estimator-of-the-ate-with-covariates" class="section level3">
<h3><span class="header-section-number">5.2.1</span> Intuition about bias in the least squares estimator of the ATE with covariates</h3>
<p>When we estimate the average treatment effect by using a least squares we tend
to say that we &#x201C;regress&#x201D; some outcome for each unit <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">Y_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, on (often
binary) treatment assignment, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Z</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">Z_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Z</mi><mi>i</mi></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">Z_i=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> if a unit is assigned to
treatment and 0 if assigned to control. And we write a linear model relating
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Z</mi></mrow><annotation encoding="application/x-tex">Z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi></mrow><annotation encoding="application/x-tex">Y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span></span></span></span> as below, where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>&#x3B2;</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">\beta_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">&#x3B2;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> represents the difference in means of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi></mrow><annotation encoding="application/x-tex">Y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span></span></span></span> between units with <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Z</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">Z=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Z</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">Z=0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span>:</p>
<p></p>
<p>This is a common practice because, we know that the formula to estimate <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>&#x3B2;</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">\beta_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">&#x3B2;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> in equation <a href="#eq:olsbiv">(<strong>??</strong>)</a> is the same as the difference of means in <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi></mrow><annotation encoding="application/x-tex">Y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span></span></span></span> between treatment and control groups:</p>
<p></p>
<p>This last term, expressed with covariances and variances, is the expression for the least squares coefficient in a bivariate linear least squares model. And we also know that this estimator of the average treatment effect has no systematic error (i.e.&#xA0;is unbiased), so we can write <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>E</mi><mi>R</mi></msub><mo stretchy="false">(</mo><msub><mover accent="true"><mi>&#x3B2;</mi><mo>^</mo></mover><mn>1</mn></msub><mo stretchy="false">)</mo><mo>=</mo><msub><mi>&#x3B2;</mi><mn>1</mn></msub><mo>&#x2261;</mo><mtext>ATE</mtext></mrow><annotation encoding="application/x-tex">E_R(\hat{\beta}_1)=\beta_1 \equiv \text{ATE}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2079em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.00773em;">R</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9579em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.05278em;">&#x3B2;</span></span><span style="top:-3.2634em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1667em;"><span class="mord">^</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">&#x3B2;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&#x2261;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord text"><span class="mord">ATE</span></span></span></span></span> where we take the expectation across randomizations consistent with the experimental design.</p>
<p>Now, sometimes we have a covariate <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">X_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> and we use it as would be common in the analysis of non-experimental data:</p>
<p></p>
<p>What is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>&#x3B2;</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">\beta_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">&#x3B2;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> in this case? We know the matrix representation here <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msup><mi mathvariant="bold">X</mi><mi>T</mi></msup><mi mathvariant="bold">X</mi><msup><mo stretchy="false">)</mo><mrow><mo>&#x2212;</mo><mn>1</mn></mrow></msup><msup><mi mathvariant="bold">X</mi><mi>T</mi></msup><mi mathvariant="bold">y</mi></mrow><annotation encoding="application/x-tex">(\mathbf{X}^{T}\mathbf{X})^{-1}\mathbf{X}^{T}\mathbf{y}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0913em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathbf">X</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span><span class="mord mathbf">X</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">&#x2212;</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathbf">X</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span><span class="mord mathbf" style="margin-right:0.01597em;">y</span></span></span></span>, but here is the scalar formula for this particular case in <a href="#eq:olsbiv">(<strong>??</strong>)</a>:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mover accent="true"><mi>&#x3B2;</mi><mo>^</mo></mover><mn>1</mn></msub><mo>=</mo><mfrac><mrow><mrow><mi mathvariant="normal">V</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">r</mi></mrow><mo stretchy="false">(</mo><mi>X</mi><mo stretchy="false">)</mo><mrow><mi mathvariant="normal">C</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">v</mi></mrow><mo stretchy="false">(</mo><mi>Z</mi><mo separator="true">,</mo><mi>Y</mi><mo stretchy="false">)</mo><mo>&#x2212;</mo><mrow><mi mathvariant="normal">C</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">v</mi></mrow><mo stretchy="false">(</mo><mi>X</mi><mo separator="true">,</mo><mi>Z</mi><mo stretchy="false">)</mo><mrow><mi mathvariant="normal">C</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">v</mi></mrow><mo stretchy="false">(</mo><mi>X</mi><mo separator="true">,</mo><mi>Y</mi><mo stretchy="false">)</mo></mrow><mrow><mrow><mi mathvariant="normal">V</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">r</mi></mrow><mo stretchy="false">(</mo><mi>Z</mi><mo stretchy="false">)</mo><mrow><mi mathvariant="normal">V</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">r</mi></mrow><mo stretchy="false">(</mo><mi>X</mi><mo stretchy="false">)</mo><mo>&#x2212;</mo><mrow><mi mathvariant="normal">C</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">v</mi></mrow><mo stretchy="false">(</mo><mi>Z</mi><mo separator="true">,</mo><mi>X</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">\hat{\beta}_1 = \frac{\mathrm{Var}(X)\mathrm{Cov}(Z,Y) - \mathrm{Cov}(X,Z)\mathrm{Cov}(X,Y)}{\mathrm{Var}(Z)\mathrm{Var}(X) - \mathrm{Cov}(Z,X)^2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1523em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9579em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.05278em;">&#x3B2;</span></span><span style="top:-3.2634em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1667em;"><span class="mord">^</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.363em;vertical-align:-0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">Var</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mclose">)</span><span class="mord"><span class="mord mathrm">Var</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">Cov</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">Var</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mclose">)</span><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">Cov</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">Cov</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mclose">)</span><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">Cov</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>In very large experiments <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">C</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">v</mi></mrow><mo stretchy="false">(</mo><mi>X</mi><mo separator="true">,</mo><mi>Z</mi><mo stretchy="false">)</mo><mo>&#x2248;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\mathrm{Cov}(X,Z) \approx 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">Cov</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&#x2248;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span> &#x2014; because <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Z</mi></mrow><annotation encoding="application/x-tex">Z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span></span></span></span> is randomly
assigned and is thus independent of background variables like <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span> &#x2014; however
in any given finite sized experiment <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>o</mi><mi>v</mi><mo stretchy="false">(</mo><mi>X</mi><mo separator="true">,</mo><mi>Z</mi><mo stretchy="false">)</mo><mo mathvariant="normal">&#x2260;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">cov(X,Z) \ne 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">co</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel"><span class="mrel"><span class="mord vbox"><span class="thinbox"><span class="rlap"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="inner"><span class="mord"><span class="mrel">&#xE020;</span></span></span><span class="fix"></span></span></span></span></span><span class="mrel">=</span></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span> so this does not reduce
to the unbiased estimator of the bivariate case. Thus, <span class="citation">Freedman (<a href="#ref-freedman2008rae">2008</a><a href="#ref-freedman2008rae">a</a>)</span> showed
that there is a small amount of bias in using equation <a href="#eq:olscov">(<strong>??</strong>)</a> to
estimate the average treatment effect.</p>
<p>As a way to engage with this problem, <span class="citation">Lin (<a href="#ref-lin_agnostic_2013">2013</a>)</span> suggested using the
following least squares approach &#x2014; regressing the outcome on binary treatment
assignment <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Z</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">Z_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> and its interaction with mean-centered covariates.</p>
<p></p>
<p>See the <a href="https://alexandercoppock.com/Green-Lab-SOP/Green_Lab_SOP.html#using-covariates-in-analysis">Green-Lin-Coppock
SOP</a>
for more examples of this approach to covariance adjustment.</p>
</div>
<div id="the-lin-approach-to-covariance-adjustment" class="section level3">
<h3><span class="header-section-number">5.2.2</span> The Lin Approach to Covariance Adjustment</h3>
<p>Here we show how covariance adjustment can create bias in estimation of the
average treatment effect &#x2014; and how to reduce this bias while using the Lin
procedure as well as by increasing the size of the experiment. In this case, we
compare an experiment with 20 units to an experiement with 100 units, in each
case with half of the units assigned to treatment by complete random
assignment.</p>
<p>We use the <a href="https://declaredesign.org/">DeclareDesign</a> package for R to make
this process of assessing bias easier. So, much of the code that follows
provides input to the <code>diagnose_design</code> command which repeats the design of the
experiment many times, each time estimating an average treatment effect, and
comparing the mean of those estimate to the truth (labeled &#x201C;Mean Estimand&#x201D;
below).</p>
<p>The true potential outcomes (<code>y1</code> and <code>y0</code>) are generated using one covariate,
called <code>cov2</code>. In what follows we compare the performance of the simple
estimator using OLS, to estimators that use Lin&#x2019;s procedure involving just the
correct covariate, to estimators that use incorrect covariates (since we rarely
know exactly the covariates that help generate any given behavioral outcome).</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb124-1" title="1"><span class="co">##summary(lm(y0~cov2,data=dat1))$r.squared</span></a>
<a class="sourceLine" id="cb124-2" title="2"><span class="co">##summary(lm(y1~cov2,data=dat1))$r.squared</span></a>
<a class="sourceLine" id="cb124-3" title="3"></a>
<a class="sourceLine" id="cb124-4" title="4">wrkdat1 &lt;-<span class="st"> </span>dat1 <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">select</span>(id,y1,y0,<span class="kw">contains</span>(<span class="st">&quot;cov&quot;</span>))</a>
<a class="sourceLine" id="cb124-5" title="5">popbigdat1 &lt;-<span class="st"> </span><span class="kw">declare_population</span>(wrkdat1)</a>
<a class="sourceLine" id="cb124-6" title="6"></a>
<a class="sourceLine" id="cb124-7" title="7"><span class="co">## Make a small dataset to represent a small experiment or a cluster randomized experiment with few clusters</span></a>
<a class="sourceLine" id="cb124-8" title="8"><span class="kw">set.seed</span>(<span class="dv">12345</span>)</a>
<a class="sourceLine" id="cb124-9" title="9">smalldat1 &lt;-<span class="st"> </span>dat1 <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">select</span>(id,y1,y0,<span class="kw">contains</span>(<span class="st">&quot;cov&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">sample_n</span>(<span class="dv">20</span>)</a>
<a class="sourceLine" id="cb124-10" title="10"><span class="co">## The relevant covariate is a reasonably strong predictor of the outcome</span></a>
<a class="sourceLine" id="cb124-11" title="11"><span class="kw">summary</span>(<span class="kw">lm</span>(y0<span class="op">~</span>cov2,<span class="dt">data=</span>smalldat1))<span class="op">$</span>r.squared</a>
<a class="sourceLine" id="cb124-12" title="12"></a>
<a class="sourceLine" id="cb124-13" title="13"><span class="co">### Now declare the differeent inputs for DeclareDesign</span></a>
<a class="sourceLine" id="cb124-14" title="14">popsmalldat1 &lt;-<span class="st"> </span><span class="kw">declare_population</span>(smalldat1)</a>
<a class="sourceLine" id="cb124-15" title="15"></a>
<a class="sourceLine" id="cb124-16" title="16">assignsmalldat1  &lt;-<span class="st"> </span><span class="kw">declare_assignment</span>(<span class="dt">Znew=</span><span class="kw">complete_ra</span>(N,<span class="dt">m=</span><span class="dv">10</span>))</a>
<a class="sourceLine" id="cb124-17" title="17">assignbigdat1  &lt;-<span class="st"> </span><span class="kw">declare_assignment</span>(<span class="dt">Znew=</span><span class="kw">complete_ra</span>(N,<span class="dt">m=</span><span class="dv">50</span>))</a>
<a class="sourceLine" id="cb124-18" title="18"></a>
<a class="sourceLine" id="cb124-19" title="19"><span class="co">## No additional treatment effects other than those created when we made y0 and y1 earlier</span></a>
<a class="sourceLine" id="cb124-20" title="20">po_functionNull &lt;-<span class="st"> </span><span class="cf">function</span>(data){</a>
<a class="sourceLine" id="cb124-21" title="21">    data<span class="op">$</span>Y_Znew_<span class="dv">0</span> &lt;-<span class="st"> </span>data<span class="op">$</span>y0</a>
<a class="sourceLine" id="cb124-22" title="22">    data<span class="op">$</span>Y_Znew_<span class="dv">1</span> &lt;-<span class="st"> </span>data<span class="op">$</span>y1</a>
<a class="sourceLine" id="cb124-23" title="23">    data</a>
<a class="sourceLine" id="cb124-24" title="24">}</a>
<a class="sourceLine" id="cb124-25" title="25"></a>
<a class="sourceLine" id="cb124-26" title="26">ysdat1  &lt;-<span class="st"> </span><span class="kw">declare_potential_outcomes</span>(<span class="dt">handler =</span> po_functionNull)</a>
<a class="sourceLine" id="cb124-27" title="27">theestimanddat1 &lt;-<span class="st"> </span><span class="kw">declare_inquiry</span>(<span class="dt">ATE =</span> <span class="kw">mean</span>(Y_Znew_<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>Y_Znew_<span class="dv">0</span>))</a>
<a class="sourceLine" id="cb124-28" title="28">theobsidentdat1 &lt;-<span class="st"> </span><span class="kw">declare_reveal</span>(Y, Znew)</a>
<a class="sourceLine" id="cb124-29" title="29"></a>
<a class="sourceLine" id="cb124-30" title="30">thedesignsmalldat1 &lt;-<span class="st"> </span>popsmalldat1 <span class="op">+</span><span class="st"> </span>assignsmalldat1 <span class="op">+</span><span class="st"> </span>ysdat1 <span class="op">+</span><span class="st"> </span>theestimanddat1 <span class="op">+</span></a>
<a class="sourceLine" id="cb124-31" title="31"><span class="st">    </span>theobsidentdat1</a>
<a class="sourceLine" id="cb124-32" title="32"></a>
<a class="sourceLine" id="cb124-33" title="33">thedesignbigdat1 &lt;-<span class="st"> </span>popbigdat1 <span class="op">+</span><span class="st"> </span>assignbigdat1 <span class="op">+</span><span class="st"> </span>ysdat1 <span class="op">+</span><span class="st"> </span>theestimanddat1 <span class="op">+</span></a>
<a class="sourceLine" id="cb124-34" title="34"><span class="st">    </span>theobsidentdat1</a></code></pre></div>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb125-1" title="1">estCov0 &lt;-<span class="st"> </span><span class="kw">declare_estimator</span>(Y<span class="op">~</span>Znew, <span class="dt">inquiry=</span>theestimanddat1, <span class="dt">model=</span>lm_robust, <span class="dt">label=</span><span class="st">&quot;CovAdj0: Lm, No covariates&quot;</span>)</a>
<a class="sourceLine" id="cb125-2" title="2">estCov1 &lt;-<span class="st"> </span><span class="kw">declare_estimator</span>(Y<span class="op">~</span>Znew<span class="op">+</span>cov2, <span class="dt">inquiry=</span>theestimanddat1, <span class="dt">model=</span>lm_robust, <span class="dt">label=</span><span class="st">&quot;CovAdj1: Lm,Correct Covariate&quot;</span>)</a>
<a class="sourceLine" id="cb125-3" title="3">estCov2 &lt;-<span class="st"> </span><span class="kw">declare_estimator</span>(Y<span class="op">~</span>Znew<span class="op">+</span>cov1<span class="op">+</span>cov2<span class="op">+</span>cov3<span class="op">+</span>cov4<span class="op">+</span>cov5<span class="op">+</span>cov6<span class="op">+</span>cov7<span class="op">+</span>cov8, <span class="dt">inquiry=</span>theestimanddat1, <span class="dt">model=</span>lm_robust, <span class="dt">label=</span><span class="st">&quot;CovAdj2: Lm,  Mixed Covariates&quot;</span>)</a>
<a class="sourceLine" id="cb125-4" title="4">estCov3 &lt;-<span class="st"> </span><span class="kw">declare_estimator</span>(Y<span class="op">~</span>Znew<span class="op">+</span>cov1<span class="op">+</span>cov3<span class="op">+</span>cov4<span class="op">+</span>cov5<span class="op">+</span>cov6, <span class="dt">inquiry=</span>theestimanddat1, <span class="dt">model=</span>lm_robust, <span class="dt">label=</span><span class="st">&quot;CovAdj3: Lm, Wrong Covariates&quot;</span>)</a>
<a class="sourceLine" id="cb125-5" title="5">estCov4 &lt;-<span class="st"> </span><span class="kw">declare_estimator</span>(Y<span class="op">~</span>Znew,<span class="dt">covariates=</span><span class="op">~</span>cov1<span class="op">+</span>cov2<span class="op">+</span>cov3<span class="op">+</span>cov4<span class="op">+</span>cov5<span class="op">+</span>cov6<span class="op">+</span>cov7<span class="op">+</span>cov8, <span class="dt">inquiry=</span>theestimanddat1, <span class="dt">model=</span>lm_lin, <span class="dt">label=</span><span class="st">&quot;CovAdj4: Lin, Mixed Covariates&quot;</span>)</a>
<a class="sourceLine" id="cb125-6" title="6">estCov5 &lt;-<span class="st"> </span><span class="kw">declare_estimator</span>(Y<span class="op">~</span>Znew,<span class="dt">covariates=</span><span class="op">~</span>cov2, <span class="dt">inquiry=</span>theestimanddat1, <span class="dt">model=</span>lm_lin, <span class="dt">label=</span><span class="st">&quot;CovAdj5: Lin, Correct Covariate&quot;</span>)</a></code></pre></div>
<div class="sourceCode" id="cb126"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb126-1" title="1">thedesignsmalldat1PlusEstimators &lt;-<span class="st"> </span>thedesignsmalldat1 <span class="op">+</span><span class="st"> </span>estCov0 <span class="op">+</span><span class="st"> </span>estCov1 <span class="op">+</span><span class="st"> </span>estCov2 <span class="op">+</span></a>
<a class="sourceLine" id="cb126-2" title="2"><span class="st">    </span>estCov3 <span class="op">+</span><span class="st"> </span>estCov4 <span class="op">+</span><span class="st"> </span>estCov5</a>
<a class="sourceLine" id="cb126-3" title="3"></a>
<a class="sourceLine" id="cb126-4" title="4">thedesignbigdat1PlusEstimators &lt;-<span class="st"> </span>thedesignbigdat1 <span class="op">+</span><span class="st"> </span>estCov0 <span class="op">+</span><span class="st"> </span>estCov1 <span class="op">+</span><span class="st"> </span>estCov2 <span class="op">+</span></a>
<a class="sourceLine" id="cb126-5" title="5"><span class="st">    </span>estCov3 <span class="op">+</span><span class="st"> </span>estCov4 <span class="op">+</span><span class="st"> </span>estCov5</a></code></pre></div>
<div class="sourceCode" id="cb127"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb127-1" title="1">sims &lt;-<span class="st"> </span><span class="dv">200</span></a>
<a class="sourceLine" id="cb127-2" title="2"><span class="kw">set.seed</span>(<span class="dv">12345</span>)</a>
<a class="sourceLine" id="cb127-3" title="3">thediagnosisCovAdj1 &lt;-<span class="st"> </span><span class="kw">diagnose_design</span>(thedesignsmalldat1PlusEstimators, <span class="dt">sims =</span> sims, <span class="dt">bootstrap_sims =</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb127-4" title="4">thediagnosisCovAdj1</a></code></pre></div>
<div class="sourceCode" id="cb128"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb128-1" title="1"><span class="kw">set.seed</span>(<span class="dv">12345</span>)</a>
<a class="sourceLine" id="cb128-2" title="2">thediagnosisCovAdj2 &lt;-<span class="st"> </span><span class="kw">diagnose_design</span>(thedesignbigdat1PlusEstimators, <span class="dt">sims =</span> sims, <span class="dt">bootstrap_sims =</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb128-3" title="3">thediagnosisCovAdj2</a></code></pre></div>
<p>After 1000 simulations using the small experiment (N=20) we can see that the
&#x201C;CovAdj1: Lm, Correct Covariate&#x201D; lines show fairly large bias compared to the
estimator using no covariates at all. The Lin approach using only the known to
be correct covariate reduces the bias, but does not erase it. However, the
unadjusted estimator has fairly low power where as the Lin approach with the
correct covariate &#x201C;CovAdj5: Lin, Correct Covariate&#x201D; has excellent power to
detect the 1 SD effect built into this experiment. One interesting result here
is that the Lin approach is worst (in power and even false positive rate
(called &#x201C;Coverage&#x201D; below) when a mixture or correct and incorrect covariates
are added to the linear model following the interaction-and-centering based
approach.</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb129-1" title="1">diagcols &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">5</span>,<span class="dv">6</span>,<span class="dv">7</span>,<span class="dv">8</span>,<span class="dv">9</span>,<span class="dv">10</span>,<span class="dv">11</span>)</a>
<a class="sourceLine" id="cb129-2" title="2"><span class="co">## See https://haozhu233.github.io/kableExtra/awesome_table_in_html.html</span></a>
<a class="sourceLine" id="cb129-3" title="3"><span class="kw">kable</span>(<span class="kw">reshape_diagnosis</span>(thediagnosisCovAdj1)[,diagcols] ) <span class="co"># %&gt;% kable_styling() %&gt;% scroll_box(width = &quot;100%&quot;, height = &quot;400px&quot;)</span></a></code></pre></div>
<table>
<thead>
<tr>
<th style="text-align:left;">
Estimator
</th>
<th style="text-align:left;">
Term
</th>
<th style="text-align:left;">
Mean Estimand
</th>
<th style="text-align:left;">
Mean Estimate
</th>
<th style="text-align:left;">
Bias
</th>
<th style="text-align:left;">
SD Estimate
</th>
<th style="text-align:left;">
RMSE
</th>
<th style="text-align:left;">
Power
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
CovAdj0: Lm, No covariates
</td>
<td style="text-align:left;">
Znew
</td>
<td style="text-align:left;">
5.03
</td>
<td style="text-align:left;">
5.08
</td>
<td style="text-align:left;">
0.05
</td>
<td style="text-align:left;">
1.78
</td>
<td style="text-align:left;">
1.78
</td>
<td style="text-align:left;">
0.65
</td>
</tr>
<tr>
<td style="text-align:left;">
CovAdj1: Lm,Correct Covariate
</td>
<td style="text-align:left;">
Znew
</td>
<td style="text-align:left;">
5.03
</td>
<td style="text-align:left;">
5.32
</td>
<td style="text-align:left;">
0.29
</td>
<td style="text-align:left;">
1.08
</td>
<td style="text-align:left;">
1.11
</td>
<td style="text-align:left;">
0.98
</td>
</tr>
<tr>
<td style="text-align:left;">
CovAdj2: Lm, Mixed Covariates
</td>
<td style="text-align:left;">
Znew
</td>
<td style="text-align:left;">
5.03
</td>
<td style="text-align:left;">
5.12
</td>
<td style="text-align:left;">
0.09
</td>
<td style="text-align:left;">
1.39
</td>
<td style="text-align:left;">
1.39
</td>
<td style="text-align:left;">
0.89
</td>
</tr>
<tr>
<td style="text-align:left;">
CovAdj3: Lm, Wrong Covariates
</td>
<td style="text-align:left;">
Znew
</td>
<td style="text-align:left;">
5.03
</td>
<td style="text-align:left;">
5.21
</td>
<td style="text-align:left;">
0.18
</td>
<td style="text-align:left;">
1.64
</td>
<td style="text-align:left;">
1.65
</td>
<td style="text-align:left;">
0.78
</td>
</tr>
<tr>
<td style="text-align:left;">
CovAdj4: Lin, Mixed Covariates
</td>
<td style="text-align:left;">
Znew
</td>
<td style="text-align:left;">
5.03
</td>
<td style="text-align:left;">
4.58
</td>
<td style="text-align:left;">
-0.45
</td>
<td style="text-align:left;">
8.07
</td>
<td style="text-align:left;">
8.06
</td>
<td style="text-align:left;">
0.35
</td>
</tr>
<tr>
<td style="text-align:left;">
CovAdj5: Lin, Correct Covariate
</td>
<td style="text-align:left;">
Znew
</td>
<td style="text-align:left;">
5.03
</td>
<td style="text-align:left;">
5.13
</td>
<td style="text-align:left;">
0.10
</td>
<td style="text-align:left;">
1.05
</td>
<td style="text-align:left;">
1.05
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
</tbody>
</table>
<p>The experiment with <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>=</mo><mn>100</mn></mrow><annotation encoding="application/x-tex">N=100</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">100</span></span></span></span> shows much smaller bias than the small experiment
above. Since all estimators allow us to detect the 1 SD effect (Power=1), the
RMSE (Root Mean Squared Error) column or &#x201C;Mean Se&#x201D; columns tell us about the
precision of the estimators. Again, the unadjusted approach has low bias, but
has the largest standard error. While the Lin approach with a mixture of
correct and incorrect covariates has low bias, it shows slightly worse coverage
(or false positive error rate) even it has most precision.</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb130-1" title="1"><span class="co">## See https://haozhu233.github.io/kableExtra/awesome_table_in_html.html</span></a>
<a class="sourceLine" id="cb130-2" title="2"><span class="kw">kable</span>(<span class="kw">reshape_diagnosis</span>(thediagnosisCovAdj2)[,diagcols] ) <span class="co"># %&gt;% kable_styling() %&gt;% scroll_box(width = &quot;100%&quot;, height = &quot;400px&quot;)</span></a></code></pre></div>
<table>
<thead>
<tr>
<th style="text-align:left;">
Estimator
</th>
<th style="text-align:left;">
Term
</th>
<th style="text-align:left;">
Mean Estimand
</th>
<th style="text-align:left;">
Mean Estimate
</th>
<th style="text-align:left;">
Bias
</th>
<th style="text-align:left;">
SD Estimate
</th>
<th style="text-align:left;">
RMSE
</th>
<th style="text-align:left;">
Power
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
CovAdj0: Lm, No covariates
</td>
<td style="text-align:left;">
Znew
</td>
<td style="text-align:left;">
5.45
</td>
<td style="text-align:left;">
5.45
</td>
<td style="text-align:left;">
-0.01
</td>
<td style="text-align:left;">
0.76
</td>
<td style="text-align:left;">
0.76
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
CovAdj1: Lm,Correct Covariate
</td>
<td style="text-align:left;">
Znew
</td>
<td style="text-align:left;">
5.45
</td>
<td style="text-align:left;">
5.47
</td>
<td style="text-align:left;">
0.02
</td>
<td style="text-align:left;">
0.50
</td>
<td style="text-align:left;">
0.50
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
CovAdj2: Lm, Mixed Covariates
</td>
<td style="text-align:left;">
Znew
</td>
<td style="text-align:left;">
5.45
</td>
<td style="text-align:left;">
5.48
</td>
<td style="text-align:left;">
0.03
</td>
<td style="text-align:left;">
0.53
</td>
<td style="text-align:left;">
0.53
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
CovAdj3: Lm, Wrong Covariates
</td>
<td style="text-align:left;">
Znew
</td>
<td style="text-align:left;">
5.45
</td>
<td style="text-align:left;">
5.44
</td>
<td style="text-align:left;">
-0.01
</td>
<td style="text-align:left;">
0.63
</td>
<td style="text-align:left;">
0.63
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
CovAdj4: Lin, Mixed Covariates
</td>
<td style="text-align:left;">
Znew
</td>
<td style="text-align:left;">
5.45
</td>
<td style="text-align:left;">
5.47
</td>
<td style="text-align:left;">
0.02
</td>
<td style="text-align:left;">
0.53
</td>
<td style="text-align:left;">
0.53
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
CovAdj5: Lin, Correct Covariate
</td>
<td style="text-align:left;">
Znew
</td>
<td style="text-align:left;">
5.45
</td>
<td style="text-align:left;">
5.47
</td>
<td style="text-align:left;">
0.01
</td>
<td style="text-align:left;">
0.50
</td>
<td style="text-align:left;">
0.50
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb131-1" title="1">simdesignsCovAdj1 &lt;-<span class="st"> </span><span class="kw">get_simulations</span>(thediagnosisCovAdj1)</a>
<a class="sourceLine" id="cb131-2" title="2">trueATE1covadj &lt;-<span class="st"> </span><span class="kw">with</span>(dat1,<span class="kw">mean</span>(y1<span class="op">-</span>y0))</a>
<a class="sourceLine" id="cb131-3" title="3"></a>
<a class="sourceLine" id="cb131-4" title="4"><span class="co">## simdesigns &lt;- simulate_design(thedesign,sims=sims)</span></a>
<a class="sourceLine" id="cb131-5" title="5">simmeansCovAdj1 &lt;-<span class="st"> </span>simdesignsCovAdj1 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(estimator) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarize</span>(<span class="dt">expest=</span><span class="kw">mean</span>(estimate))</a></code></pre></div>
<p>Although the Lin approach works well when covariates are few and sample sizes
are large, these simulations show where the approach is weak: when covariates
are many. In this case the estimator involving both correct and irrelevant
covariates used 18 terms. Fitting a model with 18 terms with N=20 allows nearly
any observation to exert undue influence, increases the risk of serious
multicollinearity, and leads to overfitting problems in general.</p>
<p>So far, our team has not run into this problem because our studies have tended
to involve many thousands of units and relatively few covariates. However, we
are considering a few alternative approaches should we confront this situation
in the future such as (1) collapsing the covariates into fewer dimensions
(using a Mahalanobis distance or principal components based distance) or
working with a residualized version of the outcome as described below.</p>
</div>
<div id="the-rosenbaum-approach-the-covariance-adjustment" class="section level3">
<h3><span class="header-section-number">5.2.3</span> The Rosenbaum Approach The Covariance Adjustment</h3>
<p>When we have many covariates, sometimes the Lin style approach prevents us from
calculating appropriate standard errors and/or can have inflated bias due to
overfitting. <span class="citation">Rosenbaum (<a href="#ref-rosenbaum:2002a">2002</a>)</span> showed an approach in which the outcomes are
regressed on covariates, ignoring treatment assignment, and then the residuals
from that regression are used to estimate an average treatment effect.</p>
<p>We do a similar evaluation of that approach here.</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb132-1" title="1">make_est_fun&lt;-<span class="cf">function</span>(covs){</a>
<a class="sourceLine" id="cb132-2" title="2">    <span class="co">## covs is a vector of character names of covariates</span></a>
<a class="sourceLine" id="cb132-3" title="3">        <span class="kw">force</span>(covs)</a>
<a class="sourceLine" id="cb132-4" title="4">        covfmla &lt;-<span class="st"> </span><span class="kw">reformulate</span>(covs,<span class="dt">response=</span><span class="st">&quot;Y&quot;</span>)</a>
<a class="sourceLine" id="cb132-5" title="5">        <span class="cf">function</span>(data){</a>
<a class="sourceLine" id="cb132-6" title="6">        data<span class="op">$</span>e_y &lt;-<span class="st"> </span><span class="kw">residuals</span>(<span class="kw">lm</span>(covfmla,<span class="dt">data=</span>data))</a>
<a class="sourceLine" id="cb132-7" title="7">                obj &lt;-<span class="kw">lm_robust</span>(e_y<span class="op">~</span>Znew,<span class="dt">data=</span>data)</a>
<a class="sourceLine" id="cb132-8" title="8">                res &lt;-<span class="st"> </span><span class="kw">tidy</span>(obj) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(term<span class="op">==</span><span class="st">&quot;Znew&quot;</span>)</a>
<a class="sourceLine" id="cb132-9" title="9">                <span class="kw">return</span>(res)</a>
<a class="sourceLine" id="cb132-10" title="10">        }</a>
<a class="sourceLine" id="cb132-11" title="11">}</a>
<a class="sourceLine" id="cb132-12" title="12"></a>
<a class="sourceLine" id="cb132-13" title="13">est_fun_correct &lt;-<span class="st"> </span><span class="kw">make_est_fun</span>(<span class="st">&quot;cov2&quot;</span>)</a>
<a class="sourceLine" id="cb132-14" title="14">est_fun_mixed&lt;-<span class="st"> </span><span class="kw">make_est_fun</span>(<span class="kw">c</span>(<span class="st">&quot;cov1&quot;</span>,<span class="st">&quot;cov2&quot;</span>,<span class="st">&quot;cov3&quot;</span>,<span class="st">&quot;cov4&quot;</span>,<span class="st">&quot;cov5&quot;</span>,<span class="st">&quot;cov6&quot;</span>,<span class="st">&quot;cov7&quot;</span>,<span class="st">&quot;cov8&quot;</span>))</a>
<a class="sourceLine" id="cb132-15" title="15">est_fun_incorrect &lt;-<span class="st"> </span><span class="kw">make_est_fun</span>(<span class="kw">c</span>(<span class="st">&quot;cov1&quot;</span>,<span class="st">&quot;cov2&quot;</span>,<span class="st">&quot;cov3&quot;</span>,<span class="st">&quot;cov4&quot;</span>,<span class="st">&quot;cov5&quot;</span>,<span class="st">&quot;cov6&quot;</span>))</a>
<a class="sourceLine" id="cb132-16" title="16"></a>
<a class="sourceLine" id="cb132-17" title="17"><span class="co">## est_fun_correct(blah)</span></a>
<a class="sourceLine" id="cb132-18" title="18"></a>
<a class="sourceLine" id="cb132-19" title="19">estCov6 &lt;-<span class="st"> </span><span class="kw">declare_estimator</span>(<span class="dt">handler =</span> <span class="kw">tidy_estimator</span>(est_fun_correct), <span class="dt">inquiry=</span>theestimanddat1, <span class="dt">label=</span><span class="st">&quot;CovAdj6: Resid, Correct&quot;</span>)</a>
<a class="sourceLine" id="cb132-20" title="20">estCov7 &lt;-<span class="st"> </span><span class="kw">declare_estimator</span>(<span class="dt">handler =</span> <span class="kw">tidy_estimator</span>(est_fun_mixed), <span class="dt">inquiry=</span>theestimanddat1, <span class="dt">label=</span><span class="st">&quot;CovAdj7: Resid, Mixed&quot;</span>)</a>
<a class="sourceLine" id="cb132-21" title="21">estCov8 &lt;-<span class="st"> </span><span class="kw">declare_estimator</span>(<span class="dt">handler =</span> <span class="kw">tidy_estimator</span>(est_fun_incorrect), <span class="dt">inquiry=</span>theestimanddat1, <span class="dt">label=</span><span class="st">&quot;CovAdj8: Resid, InCorrect&quot;</span>)</a>
<a class="sourceLine" id="cb132-22" title="22"></a>
<a class="sourceLine" id="cb132-23" title="23">thedesignsmalldat1PlusRoseEstimators &lt;-<span class="st"> </span>thedesignsmalldat1 <span class="op">+</span><span class="st"> </span>estCov0 <span class="op">+</span><span class="st"> </span>estCov1 <span class="op">+</span><span class="st"> </span>estCov2 <span class="op">+</span></a>
<a class="sourceLine" id="cb132-24" title="24"><span class="st">    </span>estCov3 <span class="op">+</span><span class="st"> </span>estCov4 <span class="op">+</span><span class="st"> </span>estCov5 <span class="op">+</span><span class="st"> </span>estCov6 <span class="op">+</span><span class="st"> </span>estCov7 <span class="op">+</span><span class="st"> </span>estCov8</a>
<a class="sourceLine" id="cb132-25" title="25"></a>
<a class="sourceLine" id="cb132-26" title="26">thedesignbigdat1PlusRoseEstimators &lt;-<span class="st"> </span>thedesignbigdat1 <span class="op">+</span><span class="st"> </span>estCov0 <span class="op">+</span><span class="st"> </span>estCov1 <span class="op">+</span><span class="st"> </span>estCov2 <span class="op">+</span></a>
<a class="sourceLine" id="cb132-27" title="27"><span class="st">    </span>estCov3 <span class="op">+</span><span class="st"> </span>estCov4 <span class="op">+</span><span class="st"> </span>estCov5 <span class="op">+</span><span class="st"> </span>estCov6 <span class="op">+</span><span class="st"> </span>estCov7 <span class="op">+</span><span class="st"> </span>estCov8</a></code></pre></div>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb133-1" title="1"><span class="kw">set.seed</span>(<span class="dv">12345</span>)</a>
<a class="sourceLine" id="cb133-2" title="2">thediagnosisCovAdj3 &lt;-<span class="st"> </span><span class="kw">diagnose_design</span>(thedesignsmalldat1PlusRoseEstimators, <span class="dt">sims =</span> sims, <span class="dt">bootstrap_sims =</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb133-3" title="3">thediagnosisCovAdj3</a></code></pre></div>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb134-1" title="1"><span class="kw">set.seed</span>(<span class="dv">12345</span>)</a>
<a class="sourceLine" id="cb134-2" title="2">thediagnosisCovAdj4 &lt;-<span class="st"> </span><span class="kw">diagnose_design</span>(thedesignbigdat1PlusRoseEstimators, <span class="dt">sims =</span> sims, <span class="dt">bootstrap_sims =</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb134-3" title="3">thediagnosisCovAdj3</a></code></pre></div>
<p>With a small sample (N=20), the Rosenbaum-style approach yields very little
bias and quite high power using the correct covariate (&#x201C;CovAdj6: Resid,
Correct&#x201D;), but poor performance in terms of bias and coverage with incorrect
covariates &#x2014; recall that coverage here uses the t-test that in turn relies
on asymptotic approximations, and we are challenging this approximation with a
small experiment and overfitting problems.</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb135-1" title="1"><span class="co">## See https://haozhu233.github.io/kableExtra/awesome_table_in_html.html</span></a>
<a class="sourceLine" id="cb135-2" title="2"><span class="kw">kable</span>(<span class="kw">reshape_diagnosis</span>(thediagnosisCovAdj3)[<span class="dv">7</span><span class="op">:</span><span class="dv">9</span>,diagcols] ) <span class="co">#%&gt;% kable_styling() %&gt;% scroll_box(width = &quot;100%&quot;, height = &quot;400px&quot;)</span></a></code></pre></div>
<table>
<thead>
<tr>
<th style="text-align:left;">
</th>
<th style="text-align:left;">
Estimator
</th>
<th style="text-align:left;">
Term
</th>
<th style="text-align:left;">
Mean Estimand
</th>
<th style="text-align:left;">
Mean Estimate
</th>
<th style="text-align:left;">
Bias
</th>
<th style="text-align:left;">
SD Estimate
</th>
<th style="text-align:left;">
RMSE
</th>
<th style="text-align:left;">
Power
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
7
</td>
<td style="text-align:left;">
CovAdj6: Resid, Correct
</td>
<td style="text-align:left;">
Znew
</td>
<td style="text-align:left;">
5.03
</td>
<td style="text-align:left;">
5.00
</td>
<td style="text-align:left;">
-0.03
</td>
<td style="text-align:left;">
1.02
</td>
<td style="text-align:left;">
1.02
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
8
</td>
<td style="text-align:left;">
CovAdj7: Resid, Mixed
</td>
<td style="text-align:left;">
Znew
</td>
<td style="text-align:left;">
5.03
</td>
<td style="text-align:left;">
2.95
</td>
<td style="text-align:left;">
-2.08
</td>
<td style="text-align:left;">
1.11
</td>
<td style="text-align:left;">
2.35
</td>
<td style="text-align:left;">
0.80
</td>
</tr>
<tr>
<td style="text-align:left;">
9
</td>
<td style="text-align:left;">
CovAdj8: Resid, InCorrect
</td>
<td style="text-align:left;">
Znew
</td>
<td style="text-align:left;">
5.03
</td>
<td style="text-align:left;">
3.53
</td>
<td style="text-align:left;">
-1.50
</td>
<td style="text-align:left;">
1.20
</td>
<td style="text-align:left;">
1.92
</td>
<td style="text-align:left;">
0.85
</td>
</tr>
</tbody>
</table>
<p>With a larger experiment, the bias goes down, but coverage is poor with
incorrect covariates in this approach as well. We speculate that performance
might improve if we fit the covariance adjustment models that produce residuals
separately for the treated and control groups.</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb136-1" title="1"><span class="co">## See https://haozhu233.github.io/kableExtra/awesome_table_in_html.html</span></a>
<a class="sourceLine" id="cb136-2" title="2"><span class="kw">kable</span>(<span class="kw">reshape_diagnosis</span>(thediagnosisCovAdj4)[<span class="dv">7</span><span class="op">:</span><span class="dv">9</span>,diagcols] ) <span class="co"># %&gt;% kable_styling() %&gt;% scroll_box(width = &quot;100%&quot;, height = &quot;400px&quot;)</span></a></code></pre></div>
<table>
<thead>
<tr>
<th style="text-align:left;">
</th>
<th style="text-align:left;">
Estimator
</th>
<th style="text-align:left;">
Term
</th>
<th style="text-align:left;">
Mean Estimand
</th>
<th style="text-align:left;">
Mean Estimate
</th>
<th style="text-align:left;">
Bias
</th>
<th style="text-align:left;">
SD Estimate
</th>
<th style="text-align:left;">
RMSE
</th>
<th style="text-align:left;">
Power
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
7
</td>
<td style="text-align:left;">
CovAdj6: Resid, Correct
</td>
<td style="text-align:left;">
Znew
</td>
<td style="text-align:left;">
5.45
</td>
<td style="text-align:left;">
5.42
</td>
<td style="text-align:left;">
-0.03
</td>
<td style="text-align:left;">
0.49
</td>
<td style="text-align:left;">
0.49
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
8
</td>
<td style="text-align:left;">
CovAdj7: Resid, Mixed
</td>
<td style="text-align:left;">
Znew
</td>
<td style="text-align:left;">
5.45
</td>
<td style="text-align:left;">
5.05
</td>
<td style="text-align:left;">
-0.40
</td>
<td style="text-align:left;">
0.53
</td>
<td style="text-align:left;">
0.67
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
9
</td>
<td style="text-align:left;">
CovAdj8: Resid, InCorrect
</td>
<td style="text-align:left;">
Znew
</td>
<td style="text-align:left;">
5.45
</td>
<td style="text-align:left;">
5.14
</td>
<td style="text-align:left;">
-0.31
</td>
<td style="text-align:left;">
0.52
</td>
<td style="text-align:left;">
0.61
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="how-to-choose-covariates-for-covariance-adjustment" class="section level2">
<h2><span class="header-section-number">5.3</span> How to choose covariates for covariance adjustment?</h2>
<p>Our analysis plans commonly specify a few covariates based on what we know about the
mechanisms and context of the study. In general, if we have a measurement of
the outcome <em>before the treatment was assigned</em>, the baseline outcome, we try
to use it via blocking and/or via covariance adjustment.</p>
<p>When we have access to many covariates, we sometimes use simple machine
learning methods to select variables that strongly predict the outcome.</p>
<div id="example-of-using-the-adaptive-lasso-for-variable-selection" class="section level4">
<h4><span class="header-section-number">5.3.0.1</span> Example of using the adaptive lasso for variable selection</h4>
<p>Here we show how we use baseline data, data collected before the treatment was
assigned or new policy implemented, to choose covariates that we then use as
we have described above.</p>
<p>We tend to use the adaptive lasso rather than the simple lasso because the
adaptive lasso has better theoretical properties (insert citation to Zhou) but
also because the adaptive lasso tends to produce sparser results &#x2014; and the
bias from covariance adjustment can be severe if we add many many covariates to
a covriance adjustment procedure.</p>
<p><strong>TO DO</strong></p>
</div>
</div>
<div id="blockrandanalysis" class="section level2">
<h2><span class="header-section-number">5.4</span> Block-randomized trials</h2>
<p>We design block-randomized trials by splitting units into groups based on
predefined characteristics &#x2014; covariates that cannot be changed by the
experimental treatment &#x2014; and then randomly assigning treatment within each
group. We use this procedure when we want to increase our ability to detect
signal from noise and we think that the noise, or variation in the outcome of
the experiment, is driven in part by the covariates that we use for blocking.
For example, if we imagine the patterns of energy use will tend to differ
according to size of family, we may create blocks or strata of different family
sizes and randomly assign an energy saving intervention separately within those
blocks. We also design block-randomized experiments when we want to assess
effects within and across subgroups (for example, if we want to ensure that we
have enough statistical power to detect a <em>difference in effects</em> between
veterans and non-veterans). If we have complete random assignment, it is likely
that the proportion of veterans assigned treatment will not be exactly same as
the proportion of non-veterans receiving treatment. However, if we stratify or
block the group on military status, and randomly assign treatment and control
within each group, we can then ensure that equal proportions (or numbers) or
veterans and non-veterans receive the treatment and control.</p>
<p>Most of the general ideas that we demonstrated in the context of completely
randomized trials have direct analogues in the case of block randomized trials.
The only additional question that arises with block randomized trials is about
how to weight the contributions of each individual block when calculating an
overall average treatment effect or testing an overall hypothesis about
treatment effects.</p>
<p>We begin here with the simple case of testing the sharp null of no effects when
we have a binary outcome &#x2014; in the case of the Cochran-Mantel-Haenszel test
the weighting of the different blocks is automatic.</p>
<div id="testing-the-null-of-no-effects-with-binary-outcomes-and-block-randomization-cochran-mantel-haenszel-cmh-test-for-k-x-2-x-2-tables" class="section level3">
<h3><span class="header-section-number">5.4.1</span> Testing the null of no effects with binary outcomes and block randomization: Cochran-Mantel-Haenszel (CMH) test for K X 2 X 2 tables</h3>
<p>We use the CMH test as a test of no effect for block-randomized trials with
binary outcome.<a href="references.html#fn13" class="footnote-ref" id="fnref13"><sup>13</sup></a> Because the blocks or strata are
important to the experiment and outcomes, we want to keep the outcomes for each
strata intact rather than pooling the outcomes together. Since we repeat the
same experiment across each stratum, the CMH test tells us if the odds
ratio in the experiments indicate that there is an association
between outcomes and treatment/control across strata <span class="citation">(Cochran <a href="#ref-cochran_methods_1954">1954</a>; Mantel and Haenszel <a href="#ref-mantel_statistical_1959">1959</a>)</span>.</p>
<p>To set up the CMH test, we need <em>k</em> sets of 2x2 contingency tables. Suppose
the table below represents outcomes from stratum <em>i</em> where A,B,C, and D are
counts of observations:</p>
<table>
<thead>
<tr class="header">
<th>Assignment</th>
<th>Response</th>
<th>No response</th>
<th>Total</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Treatment</td>
<td>A</td>
<td>B</td>
<td>A+B</td>
</tr>
<tr class="even">
<td>Control</td>
<td>C</td>
<td>D</td>
<td>C+D</td>
</tr>
<tr class="odd">
<td>Total</td>
<td>A+C</td>
<td>B+D</td>
<td>A+B+C+D = T</td>
</tr>
</tbody>
</table>
<p>The CMH test statistic compares the sum of squared deviation between observed
and expected outcomes of an experiment within one stratum to the variance of
those outcomes, conditional on marginal totals.</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>C</mi><mi>M</mi><mi>H</mi><mo>=</mo><mfrac><mrow><munderover><mo>&#x2211;</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>k</mi></munderover><mo stretchy="false">(</mo><msub><mi>A</mi><mi>i</mi></msub><mo>&#x2212;</mo><mi mathvariant="normal">E</mi><mo stretchy="false">[</mo><msub><mi>A</mi><mi>i</mi></msub><mo stretchy="false">]</mo><mo stretchy="false">)</mo></mrow><mrow><mo>&#x2211;</mo><mrow><mrow><mi mathvariant="normal">V</mi><mi mathvariant="normal">A</mi><mi mathvariant="normal">R</mi></mrow><mo stretchy="false">[</mo><msub><mi>A</mi><mi>i</mi></msub><mo stretchy="false">]</mo></mrow></mrow></mfrac></mrow><annotation encoding="application/x-tex">CMH = \frac{\sum_{i=1}^{k} (A_{i} -
\mathrm{E}[{A_{i}}])}{\sum{\mathrm{VAR}[{A_i}]}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">CM</span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.6147em;vertical-align:-0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6787em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop op-symbol small-op" style="position:relative;top:0em;">&#x2211;</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">VAR</span></span><span class="mopen">[</span><span class="mord"><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.6897em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">&#x2211;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.989em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathrm">E</span><span class="mopen">[</span><span class="mord"><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mclose">])</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>where <span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="normal">E</mi><mo stretchy="false">[</mo><msub><mi>A</mi><mi>i</mi></msub><mo stretchy="false">]</mo><mo>=</mo><mfrac><mrow><mo stretchy="false">(</mo><msub><mi>A</mi><mi>i</mi></msub><mo>+</mo><msub><mi>B</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><msub><mi>A</mi><mi>i</mi></msub><mo>+</mo><msub><mi>C</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><msub><mi>T</mi><mi>i</mi></msub></mfrac></mrow><annotation encoding="application/x-tex">\mathrm{E}[A_{i}] =  \frac{(A_i+B_i)(A_i+C_i)}{T_i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathrm">E</span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.263em;vertical-align:-0.836em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>and <span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mrow><mi mathvariant="normal">V</mi><mi mathvariant="normal">A</mi><mi mathvariant="normal">R</mi></mrow><mo stretchy="false">[</mo><msub><mi>A</mi><mi>i</mi></msub><mo stretchy="false">]</mo><mo>=</mo><mfrac><mrow><mo stretchy="false">(</mo><msub><mi>A</mi><mi>i</mi></msub><mo>+</mo><msub><mi>B</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><msub><mi>A</mi><mi>i</mi></msub><mo>+</mo><msub><mi>C</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><msub><mi>B</mi><mi>i</mi></msub><mo>+</mo><msub><mi>D</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><msub><mi>C</mi><mi>i</mi></msub><mo>+</mo><msub><mi>D</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><mrow><msup><msub><mi>T</mi><mi>i</mi></msub><mn>2</mn></msup><mo stretchy="false">(</mo><msub><mi>T</mi><mi>i</mi></msub><mo>&#x2212;</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">\mathrm{VAR}[A_{i}] =
\frac{(A_i+B_i)(A_i+C_i)(B_i+D_i)(C_i+D_i)}{{T_i}^2(T_i-1)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathrm">VAR</span></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4543em;vertical-align:-1.0273em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.2227em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8873em;"><span style="top:-3.1362em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:1.0273em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>In large enough samples, if there are no associations between Treatment and
Reponse across strata, we would expect to see an odds ratio which is equal to
1, and, across randomizations and in large samples, this test statistic would
have an asymptotic <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>&#x3C7;</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\chi^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0085em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">&#x3C7;</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span> distribution with degrees of freedom = 1.</p>
<p>The odds ratio in this scenario is the combined weighted odds ratio of each
two-armed trial with binary outcomes within one block or stratum.</p>
<p>The odds ratio for a given stratum is</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>O</mi><mi>R</mi><mo>=</mo><mfrac><mfrac><mi>A</mi><mi>B</mi></mfrac><mfrac><mi>C</mi><mi>D</mi></mfrac></mfrac><mo>=</mo><mfrac><mrow><mi>A</mi><mi>D</mi></mrow><mrow><mi>B</mi><mi>C</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">OR = \frac{\frac{A}{B}}{\frac{C}{D}} = \frac{AD}{BC}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">OR</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.7147em;vertical-align:-1.1073em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6073em;"><span style="top:-2.2377em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8723em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.735em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8723em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:1.1073em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0463em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3603em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">BC</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>With many strata, we can find a common odds ratio</p>
<p></p>
<p>That is, we add the odds ratios of each stratum and weigh it by the total in
that stratum. If the odds ratio is greater than 1 then we
suspect that there may be an association between the outcome and treatment
across all strata and the CMH test statistic will be large. If
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><msub><mi>R</mi><mrow><mi>C</mi><mi>M</mi><mi>H</mi></mrow></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">OR_{CMH} = 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">CM</span><span class="mord mathnormal mtight" style="margin-right:0.08125em;">H</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>, then this supports the null hypothesis that there is
no association between treatment and outcome and the CMH test statistic will be small.</p>
<p>We can also use the CMH test to compare odds ratios between experiments, rather
than compare against the null that the odds ratio = 1.</p>
</div>
<div id="blockrandate" class="section level3">
<h3><span class="header-section-number">5.4.2</span> Estimating an overall Average Treatment Effect</h3>
<p>Our team nearly always reports a single estimate of the average treatment effect whether or not we randomly assign a policy intervention within blocks or strata. We randomly assign the intervention within each block independently and we tend to <strong>define</strong> our overall ATE (the estimand) as a simple average of the individual additive treatment effects (for two treatments, remember that we tend to write this unobserved causal effect as <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>&#x3C4;</mi><mi>i</mi></msub><mo>=</mo><msub><mi>y</mi><mrow><mi>i</mi><mo separator="true">,</mo><mn>0</mn></mrow></msub><mo>&#x2212;</mo><msub><mi>y</mi><mrow><mi>i</mi><mo separator="true">,</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">\tau_i = y_{i,0} - y_{i,1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>). So we tend to define the overall ATE as <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>&#x3C4;</mi><mo>&#x2C9;</mo></mover><mo>=</mo><mo stretchy="false">(</mo><mn>1</mn><mi mathvariant="normal">/</mi><mi>n</mi><mo stretchy="false">)</mo><msubsup><mo>&#x2211;</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></msubsup><msub><mi>&#x3C4;</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\bar{\tau}=(1/n) \sum_{i=1}^n \tau_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5678em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">&#x2C9;</span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.104em;vertical-align:-0.2997em;"></span><span class="mopen">(</span><span class="mord">1/</span><span class="mord mathnormal">n</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">&#x2211;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>. Now, we have randomly assigned within blocks in order to (1) increase precision and (2) enable subgroup analysis. How can we &#x201C;analyze as we have randomized&#x201D; if we want to learn about <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>&#x3C4;</mi><mo>&#x2C9;</mo></mover></mrow><annotation encoding="application/x-tex">\bar{\tau}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5678em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">&#x2C9;</span></span></span></span></span></span></span></span></span></span> using what we observe? Our approach is to build up from the block-level (see <span class="citation">Gerber and Green (<a href="#ref-gerber_field_2012">2012</a>)</span> for more on this approach). Say, for example, we imagine that the unobserved ATE within a given block, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">b</span></span></span></span>, was <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mtext>ATE</mtext><mi>b</mi></msub><mo>=</mo><msub><mover accent="true"><mi>&#x3C4;</mi><mo>&#x2C9;</mo></mover><mi>b</mi></msub><mo>=</mo><mo stretchy="false">(</mo><mn>1</mn><mi mathvariant="normal">/</mi><msub><mi>n</mi><mi>b</mi></msub><mo stretchy="false">)</mo><msubsup><mo>&#x2211;</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><msub><mi>n</mi><mi>b</mi></msub></msubsup><msub><mi>&#x3C4;</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\text{ATE}_{b}=\bar{\tau}_b=(1/n_b)\sum_{i=1}^{n_b} \tau_{i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord text"><span class="mord">ATE</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7178em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">&#x2C9;</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.104em;vertical-align:-0.2997em;"></span><span class="mopen">(</span><span class="mord">1/</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">&#x2211;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> where we are averaging the individual level treatment effects (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>&#x3C4;</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\tau_{i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>) across all <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mi>b</mi></msub></mrow><annotation encoding="application/x-tex">n_b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> people in block <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">b</span></span></span></span>. And now, imagine that we had an experiment with blocks of different sizes (and perhaps with different proportions assigned to treatment within block &#x2014; perhaps certain blocks are more expensive places in which to run an experiment). We could learn about <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>&#x3C4;</mi><mo>&#x2C9;</mo></mover></mrow><annotation encoding="application/x-tex">\bar{\tau}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5678em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">&#x2C9;</span></span></span></span></span></span></span></span></span></span> with a block-size weighted average of the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>&#x3C4;</mi><mo>&#x2C9;</mo></mover><mi>b</mi></msub></mrow><annotation encoding="application/x-tex">\bar{\tau}_b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7178em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">&#x2C9;</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> such that <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>&#x3C4;</mi><mo>&#x2C9;</mo></mover><mtext>nbwt</mtext></msub><mo>=</mo><mo stretchy="false">(</mo><mn>1</mn><mi mathvariant="normal">/</mi><mi>B</mi><mo stretchy="false">)</mo><msubsup><mo>&#x2211;</mo><mrow><mi>b</mi><mo>=</mo><mn>1</mn></mrow><mi>B</mi></msubsup><mo stretchy="false">(</mo><msub><mi>n</mi><mi>b</mi></msub><mi mathvariant="normal">/</mi><mi>n</mi><mo stretchy="false">)</mo><msub><mover accent="true"><mi>&#x3C4;</mi><mo>&#x2C9;</mo></mover><mi>b</mi></msub></mrow><annotation encoding="application/x-tex">\bar{\tau}_{\text{nbwt}}= (1/B) \sum_{b=1}^B (n_b/n) \bar{\tau}_b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7178em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">&#x2C9;</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">nbwt</span></span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2809em;vertical-align:-0.2997em;"></span><span class="mopen">(</span><span class="mord">1/</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">&#x2211;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">/</span><span class="mord mathnormal">n</span><span class="mclose">)</span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">&#x2C9;</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>. We can estimate <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>&#x3C4;</mi><mo>&#x2C9;</mo></mover><mtext>nbwt</mtext></msub></mrow><annotation encoding="application/x-tex">\bar{\tau}_{\text{nbwt}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7178em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">&#x2C9;</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">nbwt</span></span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> with the observed analogue just as we have with the completely randomized experiment (after all, each block is a small completely randomized experiment in this example, and so we can estimate <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>&#x3C4;</mi><mo>&#x2C9;</mo></mover><mi>b</mi></msub></mrow><annotation encoding="application/x-tex">\bar{\tau}_b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7178em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">&#x2C9;</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> using the unbiased estimator where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>&#x2208;</mo><mi>t</mi></mrow><annotation encoding="application/x-tex">i \in t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6986em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&#x2208;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span> means &#x201C;for <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> in the treatment group&#x201D;, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>&#x3C4;</mi><mo>^</mo></mover><mi>b</mi></msub><mo>=</mo><msub><mo>&#x2211;</mo><mrow><mi>i</mi><mo>&#x2208;</mo><mi>t</mi></mrow></msub><msub><mi>Y</mi><mrow><mi>i</mi><mi>b</mi></mrow></msub><mi mathvariant="normal">/</mi><msub><mi>m</mi><mi>b</mi></msub><mo>&#x2212;</mo><msub><mo>&#x2211;</mo><mrow><mi>i</mi><mo>&#x2208;</mo><mi>c</mi></mrow></msub><msub><mi>Y</mi><mrow><mi>i</mi><mi>b</mi></mrow></msub><mi mathvariant="normal">/</mi><mo stretchy="false">(</mo><msub><mi>n</mi><mi>b</mi></msub><mo>&#x2212;</mo><msub><mi>m</mi><mi>b</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\hat{\tau}_b=\sum_{i \in t} Y_{ib}/m_b - \sum_{i \in c} Y_{ib}/(n_b - m_b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0771em;vertical-align:-0.3271em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">&#x2211;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.162em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">&#x2208;</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.3271em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ib</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">/</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0771em;vertical-align:-0.3271em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">&#x2211;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.162em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">&#x2208;</span><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.3271em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ib</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">/</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>m</mi><mi>b</mi></msub></mrow><annotation encoding="application/x-tex">m_b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is the number of units assigned to treatment in block <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">b</span></span></span></span>.</p>
<p><strong>Note that many people do not use this unbiased estimator because the precision of tests based on this estimator are worse that those of another estimator that is slightly biased.</strong> We will demonstrate both methods &#x2014; the block-size weighted estimator and what we call the precision-weighted estimator &#x2014; here and offer some reflections on when a biased estimator that tends to produce answers closer to the truth might be preferred over an unbiased estimator where any given estimate may be farther from the truth. This estimator uses harmonic-weights. We have tended to call it a &#x201C;precision-weighted average&#x201D; and the weights on the blocks combine both the block size <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mi>b</mi></msub></mrow><annotation encoding="application/x-tex">n_b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> and the proportion of the block assigned to treatment <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>b</mi></msub><mo>=</mo><mo stretchy="false">(</mo><mn>1</mn><mi mathvariant="normal">/</mi><msub><mi>n</mi><mi>b</mi></msub><mo stretchy="false">)</mo><msubsup><mo>&#x2211;</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><msub><mi>n</mi><mi>b</mi></msub></msubsup><msub><mi>Z</mi><mrow><mi>i</mi><mi>b</mi></mrow></msub></mrow><annotation encoding="application/x-tex">p_b = (1/n_b) \sum_{i=1}^{n_b} Z_{ib}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.104em;vertical-align:-0.2997em;"></span><span class="mopen">(</span><span class="mord">1/</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">&#x2211;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ib</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> for a binary treatment, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Z</mi><mrow><mi>i</mi><mi>b</mi></mrow></msub></mrow><annotation encoding="application/x-tex">Z_{ib}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ib</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> so that the weight is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>h</mi><mi>b</mi></msub><mo>=</mo><msub><mi>n</mi><mi>b</mi></msub><msub><mi>p</mi><mi>b</mi></msub><mo stretchy="false">(</mo><mn>1</mn><mo>&#x2212;</mo><msub><mi>p</mi><mi>b</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">h_b = n_b p_b (1 - p_b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> and the estimator is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>&#x3C4;</mi><mo>&#x2C9;</mo></mover><mtext>hbwt</mtext></msub><mo>=</mo><mo stretchy="false">(</mo><mn>1</mn><mi mathvariant="normal">/</mi><mi>B</mi><mo stretchy="false">)</mo><msubsup><mo>&#x2211;</mo><mrow><mi>b</mi><mo>=</mo><mn>1</mn></mrow><mi>B</mi></msubsup><mo stretchy="false">(</mo><mn>1</mn><mi mathvariant="normal">/</mi><msub><mi>h</mi><mi>b</mi></msub><mo stretchy="false">)</mo><msub><mover accent="true"><mi>&#x3C4;</mi><mo>&#x2C9;</mo></mover><mi>b</mi></msub></mrow><annotation encoding="application/x-tex">\bar{\tau}_{\text{hbwt}}= (1/B) \sum_{b=1}^B (1/h_b) \bar{\tau}_b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7178em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">&#x2C9;</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">hbwt</span></span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2809em;vertical-align:-0.2997em;"></span><span class="mopen">(</span><span class="mord">1/</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">&#x2211;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord">1/</span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">&#x2C9;</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>.</p>
<p>First we show multiple approaches to producing estimates using these
estimators. And then we demonstrate how (1) ignoring the blocks when estimating
can produce problems in both estimation and testing, (2) how the block-size
weighted approaches are unbiased but possibly less precise than the precision
weighted approaches.</p>
<div class="sourceCode" id="cb137"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb137-1" title="1"><span class="co">## Create block sizes and create block weights</span></a>
<a class="sourceLine" id="cb137-2" title="2">B &lt;-<span class="st"> </span><span class="dv">10</span> <span class="co"># Number of blocks</span></a>
<a class="sourceLine" id="cb137-3" title="3">dat &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">b=</span><span class="kw">rep</span>(<span class="dv">1</span><span class="op">:</span>B,<span class="kw">c</span>(<span class="dv">8</span>,<span class="dv">20</span>,<span class="dv">30</span>,<span class="dv">40</span>,<span class="dv">50</span>,<span class="dv">60</span>,<span class="dv">70</span>,<span class="dv">80</span>,<span class="dv">100</span>,<span class="dv">800</span>)))</a>
<a class="sourceLine" id="cb137-4" title="4">dat<span class="op">$</span>bF &lt;-<span class="st"> </span><span class="kw">factor</span>(dat<span class="op">$</span>b)</a>
<a class="sourceLine" id="cb137-5" title="5"></a>
<a class="sourceLine" id="cb137-6" title="6"><span class="kw">set.seed</span>(<span class="dv">2201</span>)</a>
<a class="sourceLine" id="cb137-7" title="7"><span class="co">## x1 is a covariate that strongly predicts the outcome without treatment</span></a>
<a class="sourceLine" id="cb137-8" title="8">dat &lt;-<span class="st"> </span><span class="kw">group_by</span>(dat,b) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">nb=</span><span class="kw">n</span>(),</a>
<a class="sourceLine" id="cb137-9" title="9">                  <span class="dt">x1=</span><span class="kw">rpois</span>(<span class="dt">n =</span> nb,<span class="dt">lambda=</span><span class="kw">runif</span>(<span class="dv">1</span>,<span class="dt">min=</span><span class="dv">1</span>,<span class="dt">max=</span><span class="dv">2000</span>)))</a>
<a class="sourceLine" id="cb137-10" title="10"></a>
<a class="sourceLine" id="cb137-11" title="11"><span class="co">## The treatment effect varies by size of block (using sqrt(nb) because nb has such a large range.)</span></a>
<a class="sourceLine" id="cb137-12" title="12">dat &lt;-<span class="st"> </span><span class="kw">group_by</span>(dat,b) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">y0=</span><span class="kw">sd</span>(x1)<span class="op">*</span>x1<span class="op">+</span><span class="kw">rchisq</span>(<span class="dt">n=</span>nb,<span class="dt">df=</span><span class="dv">1</span>),</a>
<a class="sourceLine" id="cb137-13" title="13">                  <span class="dt">y0=</span>y0<span class="op">*</span>(y0<span class="op">&gt;</span><span class="kw">quantile</span>(y0,.<span class="dv">05</span>)),</a>
<a class="sourceLine" id="cb137-14" title="14">                                  <span class="dt">tauib =</span> <span class="op">-</span>(<span class="kw">sd</span>(y0))<span class="op">*</span><span class="kw">sqrt</span>(nb)  <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(<span class="kw">n</span>(),<span class="dt">mean=</span><span class="dv">0</span>,<span class="dt">sd=</span><span class="kw">sd</span>(y0)),</a>
<a class="sourceLine" id="cb137-15" title="15">                  <span class="dt">y1=</span>y0<span class="op">+</span>tauib,</a>
<a class="sourceLine" id="cb137-16" title="16">                  <span class="dt">y1=</span>y1<span class="op">*</span>(y1<span class="op">&gt;</span><span class="dv">0</span>))</a>
<a class="sourceLine" id="cb137-17" title="17">blockpredpower &lt;-<span class="st"> </span><span class="kw">summary</span>(<span class="kw">lm</span>(y0<span class="op">~</span>bF,<span class="dt">data=</span>dat))<span class="op">$</span>r.squared</a></code></pre></div>
<p>To make the differences between the approaches to estimation most vivid,
we create a dataset with blocks of widely varying sizes, half of the blocks
have half of the units assigned to treatment and the other half 10% of the
units assigned to treatment. The baseline outcomes are strongly predicted by
the blocks (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>R</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">R^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span> around <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.87</mn></mrow><annotation encoding="application/x-tex">0.87</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.87</span></span></span></span>).</p>
<p>We will use the <code>DeclareDesign</code> approach to assess bias, coverage and power (or
precision) of the different estimators here. The next code block sets up the
simulation and also demonstrates different approaches to calculating the same
numbers to represent the true underlying ATE (we can only do this because we
are using simulation here to learn about different statistical techniques.)</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb138-1" title="1"><span class="co">## Using the Declare Design Machinery to ensure that the data here  and the</span></a>
<a class="sourceLine" id="cb138-2" title="2"><span class="co">## simulations below match</span></a>
<a class="sourceLine" id="cb138-3" title="3"></a>
<a class="sourceLine" id="cb138-4" title="4"><span class="co">## Setting up Declare Design:</span></a>
<a class="sourceLine" id="cb138-5" title="5">thepop &lt;-<span class="st"> </span><span class="kw">declare_population</span>(dat)</a>
<a class="sourceLine" id="cb138-6" title="6"></a>
<a class="sourceLine" id="cb138-7" title="7">po_function &lt;-<span class="st"> </span><span class="cf">function</span>(data){</a>
<a class="sourceLine" id="cb138-8" title="8">    data<span class="op">$</span>Y_Z_<span class="dv">0</span> &lt;-<span class="st"> </span>data<span class="op">$</span>y0</a>
<a class="sourceLine" id="cb138-9" title="9">    data<span class="op">$</span>Y_Z_<span class="dv">1</span> &lt;-<span class="st"> </span>data<span class="op">$</span>y1</a>
<a class="sourceLine" id="cb138-10" title="10">    data</a>
<a class="sourceLine" id="cb138-11" title="11">}</a>
<a class="sourceLine" id="cb138-12" title="12"></a>
<a class="sourceLine" id="cb138-13" title="13">theys  &lt;-<span class="st"> </span><span class="kw">declare_potential_outcomes</span>(<span class="dt">handler =</span> po_function)</a>
<a class="sourceLine" id="cb138-14" title="14">theestimand &lt;-<span class="st"> </span><span class="kw">declare_inquiry</span>(<span class="dt">ATE =</span> <span class="kw">mean</span>(Y_Z_<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>Y_Z_<span class="dv">0</span>))</a>
<a class="sourceLine" id="cb138-15" title="15"></a>
<a class="sourceLine" id="cb138-16" title="16">numtreated &lt;-<span class="st"> </span><span class="kw">sort</span>(<span class="kw">unique</span>(dat<span class="op">$</span>nb))<span class="op">/</span><span class="kw">rep</span>(<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">10</span>),B<span class="op">/</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb138-17" title="17"></a>
<a class="sourceLine" id="cb138-18" title="18">theassign &lt;-<span class="st"> </span><span class="kw">declare_assignment</span>(<span class="dt">Z=</span><span class="kw">block_ra</span>(<span class="dt">blocks =</span> bF, </a>
<a class="sourceLine" id="cb138-19" title="19">            <span class="dt">block_m=</span>numtreated))</a>
<a class="sourceLine" id="cb138-20" title="20"></a>
<a class="sourceLine" id="cb138-21" title="21">theobsident &lt;-<span class="st"> </span><span class="kw">declare_reveal</span>(Y, Z)</a>
<a class="sourceLine" id="cb138-22" title="22"></a>
<a class="sourceLine" id="cb138-23" title="23">thedesign &lt;-<span class="st"> </span>thepop <span class="op">+</span><span class="st"> </span>theys <span class="op">+</span><span class="st"> </span>theestimand <span class="op">+</span><span class="st"> </span>theassign <span class="op">+</span><span class="st"> </span>theobsident</a>
<a class="sourceLine" id="cb138-24" title="24"></a>
<a class="sourceLine" id="cb138-25" title="25"><span class="kw">set.seed</span>(<span class="dv">2201</span>)</a>
<a class="sourceLine" id="cb138-26" title="26">dat2 &lt;-<span class="st"> </span><span class="kw">draw_data</span>(thedesign)</a>
<a class="sourceLine" id="cb138-27" title="27"></a>
<a class="sourceLine" id="cb138-28" title="28"><span class="co">## Adding rank transformed outcomes for use later.</span></a>
<a class="sourceLine" id="cb138-29" title="29">dat2 &lt;-<span class="st"> </span>dat2 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(b) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">y0md =</span> y0 <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>(y0),</a>
<a class="sourceLine" id="cb138-30" title="30">                    <span class="dt">y1md =</span> y1 <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>(y1),</a>
<a class="sourceLine" id="cb138-31" title="31">                    <span class="dt">alignedY =</span> Y <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>(Y),</a>
<a class="sourceLine" id="cb138-32" title="32">                      <span class="dt">rankalignedY =</span> <span class="kw">rank</span>(alignedY)</a>
<a class="sourceLine" id="cb138-33" title="33">)</a>
<a class="sourceLine" id="cb138-34" title="34"><span class="co">## Now add individual level weights to the data. Different textbooks and algebra yield different expressions. We show that they are all the same.</span></a>
<a class="sourceLine" id="cb138-35" title="35">dat2 &lt;-<span class="st"> </span>dat2 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(b) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">nb =</span> <span class="kw">n</span>(), <span class="co">## Size of block</span></a>
<a class="sourceLine" id="cb138-36" title="36">                      <span class="dt">pib=</span><span class="kw">mean</span>(Z), <span class="co">## prob of treatment assignment</span></a>
<a class="sourceLine" id="cb138-37" title="37">                      <span class="dt">nTb=</span><span class="kw">sum</span>(Z), <span class="co">## Number treated</span></a>
<a class="sourceLine" id="cb138-38" title="38">                      <span class="dt">nCb=</span>nb <span class="op">-</span><span class="st"> </span>nTb, <span class="co">## Number control</span></a>
<a class="sourceLine" id="cb138-39" title="39">                      <span class="dt">nbwt =</span>  ( Z<span class="op">/</span>pib ) <span class="op">+</span><span class="st"> </span>( (<span class="dv">1</span><span class="op">-</span>Z)<span class="op">/</span>(<span class="dv">1</span><span class="op">-</span>pib) ),</a>
<a class="sourceLine" id="cb138-40" title="40">                      <span class="dt">nbwt2 =</span> nb<span class="op">/</span><span class="kw">nrow</span>(dat2),</a>
<a class="sourceLine" id="cb138-41" title="41">                      <span class="co">#hbwt = 2 * (nCb * nTb )  / (nTb + nCb), ## Precision weight/Harmonic</span></a>
<a class="sourceLine" id="cb138-42" title="42">                      <span class="co">#hbwt2 = 2 * ( nbwt2 )*(pib*(1-pib)),</span></a>
<a class="sourceLine" id="cb138-43" title="43">                                      <span class="dt">hbwt3 =</span>  nbwt <span class="op">*</span><span class="st"> </span>( pib <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>pib) ) )</a>
<a class="sourceLine" id="cb138-44" title="44"></a>
<a class="sourceLine" id="cb138-45" title="45">dat2<span class="op">$</span>nbwt3 &lt;-<span class="st"> </span>dat2<span class="op">$</span>nbwt2<span class="op">/</span>dat2<span class="op">$</span>nb</a>
<a class="sourceLine" id="cb138-46" title="46"></a>
<a class="sourceLine" id="cb138-47" title="47">thepop2 &lt;-<span class="st"> </span><span class="kw">declare_population</span>(dat2)</a>
<a class="sourceLine" id="cb138-48" title="48">thedesign2 &lt;-<span class="st"> </span>thepop2 <span class="op">+</span><span class="st"> </span>theys <span class="op">+</span><span class="st"> </span>theestimand <span class="op">+</span><span class="st"> </span>theassign <span class="op">+</span><span class="st"> </span>theobsident</a>
<a class="sourceLine" id="cb138-49" title="49"></a>
<a class="sourceLine" id="cb138-50" title="50"><span class="co">## And create the block level dataset, with block level weights.</span></a>
<a class="sourceLine" id="cb138-51" title="51">datB &lt;-<span class="st"> </span><span class="kw">group_by</span>(dat2,b) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarize</span>(<span class="dt">taub =</span> <span class="kw">mean</span>(Y[Z<span class="op">==</span><span class="dv">1</span>]) <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>(Y[Z<span class="op">==</span><span class="dv">0</span>]),</a>
<a class="sourceLine" id="cb138-52" title="52">                      <span class="dt">truetaub =</span> <span class="kw">mean</span>(y1) <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>(y0),</a>
<a class="sourceLine" id="cb138-53" title="53">                      <span class="dt">nb =</span> <span class="kw">n</span>(),</a>
<a class="sourceLine" id="cb138-54" title="54">                      <span class="dt">nTb =</span> <span class="kw">sum</span>(Z),</a>
<a class="sourceLine" id="cb138-55" title="55">                      <span class="dt">nCb =</span> nb <span class="op">-</span><span class="st"> </span>nTb,</a>
<a class="sourceLine" id="cb138-56" title="56">                      <span class="dt">estvartaub =</span>  (nb<span class="op">/</span>(nb<span class="dv">-1</span>)) <span class="op">*</span><span class="st"> </span>( <span class="kw">var</span>(Y[Z<span class="op">==</span><span class="dv">1</span>]) <span class="op">/</span><span class="st"> </span>nTb )  <span class="op">+</span><span class="st"> </span>( <span class="kw">var</span>(Y[Z<span class="op">==</span><span class="dv">0</span>])<span class="op">/</span>nCb ) ,</a>
<a class="sourceLine" id="cb138-57" title="57">                      <span class="dt">pb=</span><span class="kw">mean</span>(Z),</a>
<a class="sourceLine" id="cb138-58" title="58">                      <span class="dt">nbwt =</span> <span class="kw">unique</span>(nb<span class="op">/</span><span class="kw">nrow</span>(dat2)),</a>
<a class="sourceLine" id="cb138-59" title="59">                      <span class="dt">pbwt =</span> pb <span class="op">*</span><span class="st"> </span>( <span class="dv">1</span> <span class="op">-</span><span class="st"> </span>pb),</a>
<a class="sourceLine" id="cb138-60" title="60">                      <span class="dt">hbwt2 =</span> nbwt <span class="op">*</span><span class="st"> </span>pbwt,</a>
<a class="sourceLine" id="cb138-61" title="61">                      <span class="dt">hbwt5 =</span> pbwt <span class="op">*</span><span class="st"> </span>nb,</a>
<a class="sourceLine" id="cb138-62" title="62">                      <span class="dt">hbwt=</span> ( <span class="dv">2</span><span class="op">*</span>( nCb <span class="op">*</span><span class="st"> </span>nTb ) <span class="op">/</span><span class="st"> </span>(nTb <span class="op">+</span><span class="st"> </span>nCb)))</a>
<a class="sourceLine" id="cb138-63" title="63">datB<span class="op">$</span>greenlabrule &lt;-<span class="st"> </span><span class="dv">20</span><span class="op">*</span>datB<span class="op">$</span>hbwt5<span class="op">/</span><span class="kw">sum</span>(datB<span class="op">$</span>hbwt5)</a>
<a class="sourceLine" id="cb138-64" title="64"></a>
<a class="sourceLine" id="cb138-65" title="65"><span class="co">## Notice that all of these different ways to express the harmonic mean weight are the same.</span></a>
<a class="sourceLine" id="cb138-66" title="66">datB<span class="op">$</span>hbwt01 &lt;-<span class="st"> </span>datB<span class="op">$</span>hbwt<span class="op">/</span><span class="kw">sum</span>(datB<span class="op">$</span>hbwt)</a>
<a class="sourceLine" id="cb138-67" title="67">datB<span class="op">$</span>hbwt201 &lt;-<span class="st"> </span>datB<span class="op">$</span>hbwt2<span class="op">/</span><span class="kw">sum</span>(datB<span class="op">$</span>hbwt2)</a>
<a class="sourceLine" id="cb138-68" title="68">datB<span class="op">$</span>hbwt501 &lt;-<span class="st"> </span>datB<span class="op">$</span>hbwt5<span class="op">/</span><span class="kw">sum</span>(datB<span class="op">$</span>hbwt5)</a>
<a class="sourceLine" id="cb138-69" title="69"><span class="kw">stopifnot</span>(<span class="kw">all.equal</span>(datB<span class="op">$</span>hbwt01,datB<span class="op">$</span>hbwt201))</a>
<a class="sourceLine" id="cb138-70" title="70"><span class="kw">stopifnot</span>(<span class="kw">all.equal</span>(datB<span class="op">$</span>hbwt01,datB<span class="op">$</span>hbwt501))</a>
<a class="sourceLine" id="cb138-71" title="71"></a>
<a class="sourceLine" id="cb138-72" title="72"><span class="co">## What is the &quot;true&quot; ATE?</span></a>
<a class="sourceLine" id="cb138-73" title="73">trueATE1 &lt;-<span class="st"> </span><span class="kw">with</span>(dat2,<span class="kw">mean</span>(y1) <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>(y0))</a>
<a class="sourceLine" id="cb138-74" title="74">trueATE2 &lt;-<span class="st"> </span><span class="kw">with</span>(datB, <span class="kw">sum</span>(truetaub<span class="op">*</span>nbwt))</a>
<a class="sourceLine" id="cb138-75" title="75"><span class="kw">stopifnot</span>(<span class="kw">all.equal</span>(trueATE1,trueATE2))</a>
<a class="sourceLine" id="cb138-76" title="76"><span class="co">## We could define the following as an estimand, too. But it is a bit weird.</span></a>
<a class="sourceLine" id="cb138-77" title="77"><span class="co">## trueATE3 &lt;- with(datB, sum(truetaub*hbwt01))</span></a>
<a class="sourceLine" id="cb138-78" title="78"></a>
<a class="sourceLine" id="cb138-79" title="79"><span class="co">## c(trueATE1,trueATE2,trueATE3)</span></a>
<a class="sourceLine" id="cb138-80" title="80"></a>
<a class="sourceLine" id="cb138-81" title="81"><span class="co">## We can get the same answer using R&apos;s weighted.mean command</span></a>
<a class="sourceLine" id="cb138-82" title="82">trueATE2b &lt;-<span class="st"> </span><span class="kw">weighted.mean</span>(datB<span class="op">$</span>truetaub,<span class="dt">w=</span>datB<span class="op">$</span>nbwt)</a>
<a class="sourceLine" id="cb138-83" title="83"><span class="kw">stopifnot</span>(<span class="kw">all.equal</span>(trueATE2b,trueATE2))</a></code></pre></div>
<p>Here we can see the design:</p>
<div class="sourceCode" id="cb139"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb139-1" title="1"><span class="kw">with</span>(dat2,<span class="kw">table</span>(<span class="dt">treatment=</span>Z,<span class="dt">blocknumber=</span>b))</a></code></pre></div>
<pre><code>         blocknumber
treatment   1   2   3   4   5   6   7   8   9  10
        0   4  18  15  36  25  54  35  72  50 720
        1   4   2  15   4  25   6  35   8  50  80</code></pre>
<p>Now, we will show multiple ways to get the same answer and later show evidence
about bias and precision. Notice that we do not use fixed effects on their own
in any of these approaches. There are two approaches that do use fixed
effects/indicator variables but they only include them in interaction with the
treatment assignment. Below we will show that all of these approaches are
unbiased estimators of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>&#x3C4;</mi><mo>&#x2C9;</mo></mover><mtext>nbwt</mtext></msub></mrow><annotation encoding="application/x-tex">\bar{\tau}_{\text{nbwt}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7178em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">&#x2C9;</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">nbwt</span></span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> (the ATE treating all
individuals equally although randomizing within block).</p>
<p>For example, below we see 6 different ways to estimate the average treatment
effect using block-size weights: <code>simple_block</code> refers to calculating meaen
differences within blocks and then taking the block-size weighted averagee of
them; diffmeans uses the <code>difference_in_means</code> function from the <code>estimatr</code>
package <span class="citation">(Blair et al. <a href="#ref-R-estimatr">2022</a>)</span>; <code>lmlin</code> uses the Lin approach to covariance adjustment
but uses block indicators instead of other covariates using the <code>lm_lin</code>
function; <code>lmlinbyhand</code> verifies that function using matrix operations;
<code>intereactionBFE</code> uses the <code>EstimateIWE</code> function from the <code>bfe</code> package
<span class="citation">(Gibbons <a href="#ref-R-bfe">2018</a>)</span>; and <code>regwts</code> uses the basic OLS function from R <code>lm</code> with appropriate
weights.</p>
<div class="sourceCode" id="cb141"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb141-1" title="1"><span class="co">### Block size weighting</span></a>
<a class="sourceLine" id="cb141-2" title="2">ate_nbwt1 &lt;-<span class="st"> </span><span class="kw">with</span>(datB,<span class="kw">sum</span>(taub<span class="op">*</span>nbwt))</a>
<a class="sourceLine" id="cb141-3" title="3">ate_nbwt2 &lt;-<span class="st"> </span><span class="kw">difference_in_means</span>(Y<span class="op">~</span>Z,<span class="dt">blocks =</span> b,<span class="dt">data=</span>dat2)</a>
<a class="sourceLine" id="cb141-4" title="4">ate_nbwt3 &lt;-<span class="st"> </span><span class="kw">lm_lin</span>(Y<span class="op">~</span>Z,<span class="dt">covariates=</span><span class="op">~</span>bF,<span class="dt">data=</span>dat2)</a>
<a class="sourceLine" id="cb141-5" title="5">ate_nbwt5 &lt;-<span class="st"> </span><span class="kw">EstimateIWE</span>(<span class="dt">y=</span><span class="st">&quot;Y&quot;</span>,<span class="dt">treatment=</span><span class="st">&quot;Z&quot;</span>,<span class="dt">group=</span><span class="st">&quot;bF&quot;</span>,<span class="dt">controls=</span><span class="ot">NULL</span>,<span class="dt">data=</span><span class="kw">as.data.frame</span>(dat2))</a>
<a class="sourceLine" id="cb141-6" title="6">ate_nbwt6 &lt;-<span class="st"> </span><span class="kw">lm_robust</span>(Y<span class="op">~</span>Z,<span class="dt">data=</span>dat2,<span class="dt">weights=</span>nbwt)</a>
<a class="sourceLine" id="cb141-7" title="7">ate_nbwt6a &lt;-<span class="st"> </span><span class="kw">lm</span>(Y<span class="op">~</span>Z,<span class="dt">data=</span>dat2,<span class="dt">weights=</span>nbwt)</a>
<a class="sourceLine" id="cb141-8" title="8">ate_nbwt6ase &lt;-<span class="st"> </span><span class="kw">coeftest</span>(ate_nbwt6a,<span class="dt">vcov=</span><span class="kw">vcovHC</span>(ate_nbwt6a,<span class="dt">type=</span><span class="st">&quot;HC2&quot;</span>))</a>
<a class="sourceLine" id="cb141-9" title="9"></a>
<a class="sourceLine" id="cb141-10" title="10"><span class="co">## This next implements the lm_lin method from Lin 2013 by hand:</span></a>
<a class="sourceLine" id="cb141-11" title="11"><span class="co">## Implementing Lin&apos;s method from https://alexandercoppock.com/Green-Lab-SOP/Green_Lab_SOP.html#taking-block-randomization-into-account-in-ses-and-cis.</span></a>
<a class="sourceLine" id="cb141-12" title="12"></a>
<a class="sourceLine" id="cb141-13" title="13">X &lt;-<span class="st"> </span><span class="kw">model.matrix</span>(<span class="op">~</span>bF<span class="dv">-1</span>,<span class="dt">data=</span>dat2)</a>
<a class="sourceLine" id="cb141-14" title="14">barX &lt;-<span class="st"> </span><span class="kw">colMeans</span>(X)</a>
<a class="sourceLine" id="cb141-15" title="15">Xmd &lt;-<span class="st"> </span><span class="kw">sweep</span>(X,<span class="dv">2</span>,barX)</a>
<a class="sourceLine" id="cb141-16" title="16"><span class="kw">stopifnot</span>( <span class="kw">all.equal</span>( (X[,<span class="dv">3</span>]<span class="op">-</span><span class="kw">mean</span>(X[,<span class="dv">3</span>])), Xmd[,<span class="dv">3</span>] ) )</a>
<a class="sourceLine" id="cb141-17" title="17">ZXmd &lt;-<span class="st"> </span><span class="kw">sweep</span>(Xmd,<span class="dv">1</span>,dat2<span class="op">$</span>Z,<span class="dt">FUN=</span><span class="st">&quot;*&quot;</span>)</a>
<a class="sourceLine" id="cb141-18" title="18"><span class="kw">stopifnot</span>( <span class="kw">all.equal</span>( dat2<span class="op">$</span>Z<span class="op">*</span>Xmd[,<span class="dv">3</span>],ZXmd[,<span class="dv">3</span>]  ))</a>
<a class="sourceLine" id="cb141-19" title="19">bigX &lt;-<span class="st"> </span><span class="kw">cbind</span>(<span class="dt">Intercept=</span><span class="dv">1</span>,<span class="dt">Z=</span>dat2<span class="op">$</span>Z,Xmd[,<span class="op">-</span><span class="dv">1</span>],ZXmd[,<span class="op">-</span><span class="dv">1</span>])</a>
<a class="sourceLine" id="cb141-20" title="20"><span class="co">#ate_nbwt4 &lt;- lm.fit(x=bigX,y=dat$Y)</span></a>
<a class="sourceLine" id="cb141-21" title="21">bigXdf &lt;-<span class="st"> </span><span class="kw">data.frame</span>(bigX,<span class="dt">Y=</span>dat2<span class="op">$</span>Y)</a>
<a class="sourceLine" id="cb141-22" title="22">ate_nbwt4 &lt;-<span class="kw">lm</span>(Y<span class="op">~</span>.<span class="op">-</span><span class="dv">1</span>,<span class="dt">data=</span>bigXdf)</a>
<a class="sourceLine" id="cb141-23" title="23">ate_nbwt4se &lt;-<span class="st"> </span><span class="kw">coeftest</span>(ate_nbwt4,<span class="dt">vcov.=</span><span class="kw">vcovHC</span>(ate_nbwt4,<span class="dt">type=</span><span class="st">&quot;HC2&quot;</span>))</a>
<a class="sourceLine" id="cb141-24" title="24"></a>
<a class="sourceLine" id="cb141-25" title="25"></a>
<a class="sourceLine" id="cb141-26" title="26">nbwtates&lt;-<span class="kw">c</span>(<span class="dt">simple_block=</span>ate_nbwt1,</a>
<a class="sourceLine" id="cb141-27" title="27">  <span class="dt">diffmeans=</span>ate_nbwt2<span class="op">$</span>coefficients[[<span class="st">&quot;Z&quot;</span>]],</a>
<a class="sourceLine" id="cb141-28" title="28">  <span class="dt">lmlin=</span>ate_nbwt3<span class="op">$</span>coefficients[[<span class="st">&quot;Z&quot;</span>]],</a>
<a class="sourceLine" id="cb141-29" title="29">  <span class="dt">lmlinbyhand=</span>ate_nbwt4<span class="op">$</span>coefficients[[<span class="st">&quot;Z&quot;</span>]],</a>
<a class="sourceLine" id="cb141-30" title="30">  <span class="dt">interactionBFE=</span>ate_nbwt5<span class="op">$</span>swe.est,</a>
<a class="sourceLine" id="cb141-31" title="31">  <span class="dt">regwts=</span>ate_nbwt6<span class="op">$</span>coefficients[[<span class="st">&quot;Z&quot;</span>]]</a>
<a class="sourceLine" id="cb141-32" title="32">)</a>
<a class="sourceLine" id="cb141-33" title="33"></a>
<a class="sourceLine" id="cb141-34" title="34">nbwtates</a></code></pre></div>
<pre><code>  simple_block      diffmeans          lmlin    lmlinbyhand interactionBFE         regwts 
        -12823         -12823         -12823         -12823         -12823         -12823 </code></pre>
<div class="sourceCode" id="cb143"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb143-1" title="1"><span class="co">## Comparing the Standard Errors</span></a>
<a class="sourceLine" id="cb143-2" title="2"><span class="co">## ate_nbwt1se &lt;- sqrt(sum(datB$nbwt^2 * datB$estvartaub))</span></a>
<a class="sourceLine" id="cb143-3" title="3"><span class="co">##</span></a>
<a class="sourceLine" id="cb143-4" title="4"><span class="co">## nbwtses &lt;- c(simple_block=ate_nbwt1se,</span></a>
<a class="sourceLine" id="cb143-5" title="5"><span class="co">##       diffmeans=ate_nbwt2$std.error,</span></a>
<a class="sourceLine" id="cb143-6" title="6"><span class="co">##       lmlin=ate_nbwt3$std.error[[&quot;Z&quot;]],</span></a>
<a class="sourceLine" id="cb143-7" title="7"><span class="co">##       interaction1=ate_nbwt4se[&quot;Z&quot;,&quot;Std. Error&quot;],</span></a>
<a class="sourceLine" id="cb143-8" title="8"><span class="co">##       interaction2=ate_nbwt5$swe.var^.5,</span></a>
<a class="sourceLine" id="cb143-9" title="9"><span class="co">##       wts=ate_nbwt6$std.error[[&quot;Z&quot;]])</span></a>
<a class="sourceLine" id="cb143-10" title="10"><span class="co">## nbwtses</span></a></code></pre></div>
<p>Weighting by block size allows us to define the average treatment effect in a
way that treats each unit equally. And we have shown six different ways to
estimate this effect. If we want to calculate standard errors for these
estimators, so as to produce confidence intervals, we will, in general, be
leaving statistical power on the table in exchange for an easier to interpret
estimate, an estimator that relates to its underlying target in an unbiased
fashion. Below we show an approach which is optimal from the perspective of
statistical power, precision, or narrow confidence intervals which we call
&#x201C;precision weighted&#x201D; average treatment effects.<a href="references.html#fn14" class="footnote-ref" id="fnref14"><sup>14</sup></a> In some literatures using the least squares
machinery to calculate the weighted means this approach is called Least Squared
Dummy Variables, or &#x201C;fixed effects&#x201D;. However, we show below that these
approaches are all versions of a weighted least squares estimator.</p>
<p>Below we see that we can estimate the precision-weighted ATE in five different
ways: <code>simple_block</code> calculates simple differences of means within blocks and
then takes a weighted average of those differences, using the precision
weights; <code>lm_fixed_effects1</code> uses <code>lm_robust</code> with indicators for block;
<code>lm_fixed_effects2</code> uses <code>lm_robust</code> with the <code>fixed_effects</code> option including
a factor variable recording block membership; <code>direct_wts</code> uses <code>lm_robust</code>
without block-indicators but with precision weights; and <code>demeaned</code> regresses a
block-centered version of the outcome on a block-centered version of the
treatment indicator.</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb144-1" title="1">ate_hbwt1 &lt;-<span class="st"> </span><span class="kw">with</span>(datB, <span class="kw">sum</span>(taub<span class="op">*</span>hbwt01))</a>
<a class="sourceLine" id="cb144-2" title="2">ate_hbwt2 &lt;-<span class="st"> </span><span class="kw">lm_robust</span>(Y<span class="op">~</span>Z<span class="op">+</span>bF,<span class="dt">data=</span>dat2)</a>
<a class="sourceLine" id="cb144-3" title="3">ate_hbwt3 &lt;-<span class="st"> </span><span class="kw">lm_robust</span>(Y<span class="op">~</span>Z,<span class="dt">fixed_effects=</span><span class="op">~</span>bF,<span class="dt">data=</span>dat2)</a>
<a class="sourceLine" id="cb144-4" title="4">ate_hbwt4 &lt;-<span class="st"> </span><span class="kw">lm_robust</span>(Y<span class="op">~</span>Z,<span class="dt">data=</span>dat2,<span class="dt">weights=</span>hbwt3)</a>
<a class="sourceLine" id="cb144-5" title="5">ate_hbwt5 &lt;-<span class="st"> </span><span class="kw">lm_robust</span>(<span class="kw">I</span>(Y<span class="op">-</span><span class="kw">ave</span>(Y,b))<span class="op">~</span><span class="kw">I</span>(Z<span class="op">-</span><span class="kw">ave</span>(Z,b)),<span class="dt">data=</span>dat2)</a>
<a class="sourceLine" id="cb144-6" title="6">hbwtates&lt;-<span class="kw">c</span>(<span class="dt">simple_block=</span>ate_hbwt1,</a>
<a class="sourceLine" id="cb144-7" title="7">        <span class="dt">lm_fixed_effects1=</span>ate_hbwt2<span class="op">$</span>coefficients[[<span class="st">&quot;Z&quot;</span>]],</a>
<a class="sourceLine" id="cb144-8" title="8">        <span class="dt">lm_fixed_effects2=</span>ate_hbwt3<span class="op">$</span>coefficients[[<span class="st">&quot;Z&quot;</span>]],</a>
<a class="sourceLine" id="cb144-9" title="9">        <span class="dt">direct_wts=</span>ate_hbwt4<span class="op">$</span>coefficients[[<span class="st">&quot;Z&quot;</span>]],</a>
<a class="sourceLine" id="cb144-10" title="10">        <span class="dt">demeaned=</span>ate_hbwt5<span class="op">$</span>coefficient[[<span class="dv">2</span>]])</a>
<a class="sourceLine" id="cb144-11" title="11">hbwtates</a></code></pre></div>
<pre><code>     simple_block lm_fixed_effects1 lm_fixed_effects2        direct_wts          demeaned 
           -13981            -13981            -13981            -13981            -13981 </code></pre>
<div class="sourceCode" id="cb146"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb146-1" title="1"><span class="co">## ate_hbwt1se &lt;- sqrt(sum(datB$hbwt01^2 * datB$estvartaub))</span></a>
<a class="sourceLine" id="cb146-2" title="2"><span class="co">##</span></a>
<a class="sourceLine" id="cb146-3" title="3"><span class="co">## hbwtses &lt;- c(simple_block=ate_hbwt1se,</span></a>
<a class="sourceLine" id="cb146-4" title="4"><span class="co">##       diffmeans=ate_hbwt2$std.error[[&quot;Z&quot;]],</span></a>
<a class="sourceLine" id="cb146-5" title="5"><span class="co">##       lmfe=ate_hbwt3$std.error[[&quot;Z&quot;]],</span></a>
<a class="sourceLine" id="cb146-6" title="6"><span class="co">##       wts=ate_hbwt4$std.error[[&quot;Z&quot;]],</span></a>
<a class="sourceLine" id="cb146-7" title="7"><span class="co">##       demean=ate_hbwt5$std.error[[2]])</span></a>
<a class="sourceLine" id="cb146-8" title="8"><span class="co">## hbwtses</span></a>
<a class="sourceLine" id="cb146-9" title="9"><span class="co">##</span></a>
<a class="sourceLine" id="cb146-10" title="10"><span class="co">## nbwtses</span></a></code></pre></div>
<p>Now, we claimed that the block size weighted estimator is unbiased but perhaps
less precise than the precision-weighted estimator. We use <code>DeclareDesign</code> to
to compare the performance of these estimators. We focus here on the use of
least squares to calculate the weighted averages and standard errors but, as we
showed above, one could calculate the estimates easily without using least
squares.</p>
<p>We implement those estimators as functions usable by the <code>diagnose_design</code>
function in the next code block.</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb147-1" title="1"><span class="co"># Define estimators that can be repeated in the simulation below</span></a>
<a class="sourceLine" id="cb147-2" title="2">estnowtHC2 &lt;-<span class="st"> </span><span class="kw">declare_estimator</span>(Y<span class="op">~</span>Z, <span class="dt">inquiry=</span>theestimand, <span class="dt">model=</span>lm_robust, <span class="dt">label=</span><span class="st">&quot;E1: Ignores Blocks, Design SE&quot;</span>)</a>
<a class="sourceLine" id="cb147-3" title="3">estnowtIID &lt;-<span class="st"> </span><span class="kw">declare_estimator</span>(Y<span class="op">~</span>Z, <span class="dt">inquiry=</span>theestimand, <span class="dt">model=</span>lm, <span class="dt">label=</span><span class="st">&quot;E0: Ignores Blocks, IID SE&quot;</span>)</a>
<a class="sourceLine" id="cb147-4" title="4">estnbwt1   &lt;-<span class="st"> </span><span class="kw">declare_estimator</span>(Y<span class="op">~</span>Z, <span class="dt">inquiry=</span>theestimand, <span class="dt">model=</span>difference_in_means, <span class="dt">blocks =</span> b,<span class="dt">label=</span><span class="st">&quot;E2: Diff Means Block Size Weights, Design SE&quot;</span>)</a>
<a class="sourceLine" id="cb147-5" title="5">estnbwt2   &lt;-<span class="st"> </span><span class="kw">declare_estimator</span>(Y<span class="op">~</span>Z, <span class="dt">inquiry=</span>theestimand, <span class="dt">model=</span>lm_lin, <span class="dt">covariates=</span><span class="op">~</span>bF, <span class="dt">label=</span><span class="st">&quot;E3: Treatment Interaction with Block Indicators, Design SE&quot;</span>)</a>
<a class="sourceLine" id="cb147-6" title="6"></a>
<a class="sourceLine" id="cb147-7" title="7">iwe_est_fun &lt;-<span class="st"> </span><span class="cf">function</span>(data) {</a>
<a class="sourceLine" id="cb147-8" title="8">    obj &lt;-<span class="st"> </span><span class="kw">EstimateIWE</span>(<span class="dt">y=</span><span class="st">&quot;Y&quot;</span>, <span class="dt">treatment=</span><span class="st">&quot;Z&quot;</span>, <span class="dt">group=</span><span class="st">&quot;bF&quot;</span>, <span class="dt">controls =</span> <span class="ot">NULL</span>, <span class="dt">data =</span> data)</a>
<a class="sourceLine" id="cb147-9" title="9">    res &lt;-<span class="st"> </span><span class="kw">summary.iwe</span>(obj)[<span class="st">&quot;SWE&quot;</span>,]</a>
<a class="sourceLine" id="cb147-10" title="10">    res<span class="op">$</span>term &lt;-<span class="st"> &quot;Z&quot;</span></a>
<a class="sourceLine" id="cb147-11" title="11">    <span class="kw">return</span>(res)</a>
<a class="sourceLine" id="cb147-12" title="12">}</a>
<a class="sourceLine" id="cb147-13" title="13"></a>
<a class="sourceLine" id="cb147-14" title="14">estnbwt3 &lt;-<span class="st"> </span><span class="kw">declare_estimator</span>(<span class="dt">handler =</span> <span class="kw">tidy_estimator</span>(iwe_est_fun), <span class="dt">inquiry =</span> theestimand, <span class="dt">label =</span> <span class="st">&quot;E4: Treatment Interaction with Block Indicators, Design SE&quot;</span>)</a>
<a class="sourceLine" id="cb147-15" title="15"></a>
<a class="sourceLine" id="cb147-16" title="16">nbwt_est_fun &lt;-<span class="st"> </span><span class="cf">function</span>(data){</a>
<a class="sourceLine" id="cb147-17" title="17">    data<span class="op">$</span>newnbwt &lt;-<span class="st"> </span><span class="kw">with</span>(data,( Z<span class="op">/</span>pib ) <span class="op">+</span><span class="st"> </span>( (<span class="dv">1</span><span class="op">-</span>Z)<span class="op">/</span>(<span class="dv">1</span><span class="op">-</span>pib) ) )</a>
<a class="sourceLine" id="cb147-18" title="18">    obj &lt;-<span class="kw">lm_robust</span>(Y<span class="op">~</span>Z,<span class="dt">data=</span>data,<span class="dt">weights =</span> newnbwt)</a>
<a class="sourceLine" id="cb147-19" title="19">    res &lt;-<span class="st"> </span><span class="kw">tidy</span>(obj) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(term<span class="op">==</span><span class="st">&quot;Z&quot;</span>)</a>
<a class="sourceLine" id="cb147-20" title="20">    <span class="kw">return</span>(res)</a>
<a class="sourceLine" id="cb147-21" title="21">}</a>
<a class="sourceLine" id="cb147-22" title="22"></a>
<a class="sourceLine" id="cb147-23" title="23">hbwt_est_fun &lt;-<span class="st"> </span><span class="cf">function</span>(data){</a>
<a class="sourceLine" id="cb147-24" title="24">    data<span class="op">$</span>newnbwt &lt;-<span class="st"> </span><span class="kw">with</span>(data,( Z<span class="op">/</span>pib ) <span class="op">+</span><span class="st"> </span>( (<span class="dv">1</span><span class="op">-</span>Z)<span class="op">/</span>(<span class="dv">1</span><span class="op">-</span>pib) ) )</a>
<a class="sourceLine" id="cb147-25" title="25">    data<span class="op">$</span>newhbwt &lt;-<span class="st">  </span><span class="kw">with</span>(data, newnbwt <span class="op">*</span><span class="st"> </span>( pib <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>pib) ) )</a>
<a class="sourceLine" id="cb147-26" title="26">    obj &lt;-<span class="kw">lm_robust</span>(Y<span class="op">~</span>Z,<span class="dt">data=</span>data,<span class="dt">weights =</span> newhbwt)</a>
<a class="sourceLine" id="cb147-27" title="27">    res &lt;-<span class="st"> </span><span class="kw">tidy</span>(obj) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(term<span class="op">==</span><span class="st">&quot;Z&quot;</span>)</a>
<a class="sourceLine" id="cb147-28" title="28">    <span class="kw">return</span>(res)</a>
<a class="sourceLine" id="cb147-29" title="29">}</a>
<a class="sourceLine" id="cb147-30" title="30"></a>
<a class="sourceLine" id="cb147-31" title="31">estnbwt4   &lt;-<span class="st"> </span><span class="kw">declare_estimator</span>(<span class="dt">handler =</span> <span class="kw">tidy_estimator</span>(nbwt_est_fun), <span class="dt">inquiry=</span>theestimand, <span class="dt">label=</span><span class="st">&quot;E5: Least Squares with Block Size Weights, Design SE&quot;</span>)</a>
<a class="sourceLine" id="cb147-32" title="32">esthbwt1   &lt;-<span class="st"> </span><span class="kw">declare_estimator</span>(Y<span class="op">~</span>Z<span class="op">+</span>bF, <span class="dt">inquiry=</span>theestimand, <span class="dt">model=</span>lm_robust,<span class="dt">label=</span><span class="st">&quot;E6: Precision Weights via Fixed Effects, Design SE&quot;</span>)</a>
<a class="sourceLine" id="cb147-33" title="33">esthbwt2   &lt;-<span class="st"> </span><span class="kw">declare_estimator</span>(Y<span class="op">~</span>Z, <span class="dt">inquiry=</span>theestimand, <span class="dt">model=</span>lm_robust,<span class="dt">fixed_effects=</span><span class="op">~</span>bF,<span class="dt">label=</span><span class="st">&quot;E7: Precision Weights via Demeaning, Design SE&quot;</span>)</a>
<a class="sourceLine" id="cb147-34" title="34">esthbwt3   &lt;-<span class="st"> </span><span class="kw">declare_estimator</span>(<span class="dt">handler =</span> <span class="kw">tidy_estimator</span>(hbwt_est_fun), <span class="dt">inquiry=</span>theestimand,<span class="dt">label=</span><span class="st">&quot;E8: Direct Precision Weights, Design SE&quot;</span>)</a>
<a class="sourceLine" id="cb147-35" title="35"></a>
<a class="sourceLine" id="cb147-36" title="36">direct_demean_fun &lt;-<span class="st"> </span><span class="cf">function</span>(data){</a>
<a class="sourceLine" id="cb147-37" title="37">    data<span class="op">$</span>Y &lt;-<span class="st"> </span><span class="kw">with</span>(data, Y <span class="op">-</span><span class="st"> </span><span class="kw">ave</span>(Y,b))</a>
<a class="sourceLine" id="cb147-38" title="38">    data<span class="op">$</span>Z &lt;-<span class="st"> </span><span class="kw">with</span>(data, Z <span class="op">-</span><span class="st"> </span><span class="kw">ave</span>(Z,b))</a>
<a class="sourceLine" id="cb147-39" title="39">    obj &lt;-<span class="st"> </span><span class="kw">lm_robust</span>(Y<span class="op">~</span>Z,<span class="dt">data=</span>data)</a>
<a class="sourceLine" id="cb147-40" title="40">    <span class="kw">data.frame</span>(<span class="dt">term =</span> <span class="st">&quot;Z&quot;</span> ,</a>
<a class="sourceLine" id="cb147-41" title="41">           <span class="dt">estimate =</span> obj<span class="op">$</span>coefficients[[<span class="dv">2</span>]],</a>
<a class="sourceLine" id="cb147-42" title="42">           <span class="dt">std.error =</span> obj<span class="op">$</span>std.error[[<span class="dv">2</span>]],</a>
<a class="sourceLine" id="cb147-43" title="43">           <span class="dt">statistic =</span> obj<span class="op">$</span>statistic[[<span class="dv">2</span>]],</a>
<a class="sourceLine" id="cb147-44" title="44">           <span class="dt">p.value=</span>obj<span class="op">$</span>p.value[[<span class="dv">2</span>]],</a>
<a class="sourceLine" id="cb147-45" title="45">           <span class="dt">conf.low=</span>obj<span class="op">$</span>conf.low[[<span class="dv">2</span>]],</a>
<a class="sourceLine" id="cb147-46" title="46">           <span class="dt">conf.high=</span>obj<span class="op">$</span>conf.high[[<span class="dv">2</span>]],</a>
<a class="sourceLine" id="cb147-47" title="47">           <span class="dt">df=</span>obj<span class="op">$</span>df[[<span class="dv">2</span>]],</a>
<a class="sourceLine" id="cb147-48" title="48">           <span class="dt">outcome=</span><span class="st">&quot;Y&quot;</span>)</a>
<a class="sourceLine" id="cb147-49" title="49">}</a>
<a class="sourceLine" id="cb147-50" title="50"></a>
<a class="sourceLine" id="cb147-51" title="51">esthbwt4   &lt;-<span class="st"> </span><span class="kw">declare_estimator</span>(<span class="dt">handler =</span> <span class="kw">tidy_estimator</span>(direct_demean_fun), <span class="dt">inquiry=</span>theestimand ,<span class="dt">label=</span><span class="st">&quot;E9: Direct Demeaning, Design SE&quot;</span>)</a>
<a class="sourceLine" id="cb147-52" title="52"></a>
<a class="sourceLine" id="cb147-53" title="53">theestimators &lt;-<span class="st"> </span><span class="kw">ls</span>(<span class="dt">patt=</span><span class="st">&quot;^est.*?wt&quot;</span>)</a>
<a class="sourceLine" id="cb147-54" title="54">theestimators</a>
<a class="sourceLine" id="cb147-55" title="55"></a>
<a class="sourceLine" id="cb147-56" title="56">checkest &lt;-<span class="st"> </span><span class="kw">sapply</span>(theestimators,<span class="cf">function</span>(x){ <span class="kw">get</span>(x)(<span class="kw">as.data.frame</span>(dat2))[<span class="kw">c</span>(<span class="st">&quot;estimate&quot;</span>,<span class="st">&quot;std.error&quot;</span>)]})</a>
<a class="sourceLine" id="cb147-57" title="57"></a>
<a class="sourceLine" id="cb147-58" title="58">checkest</a>
<a class="sourceLine" id="cb147-59" title="59"></a>
<a class="sourceLine" id="cb147-60" title="60">thedesignPlusEstimators &lt;-<span class="st"> </span>thedesign2 <span class="op">+</span></a>
<a class="sourceLine" id="cb147-61" title="61"><span class="st">    </span>estnowtHC2 <span class="op">+</span><span class="st"> </span>estnowtIID <span class="op">+</span><span class="st"> </span>estnbwt1 <span class="op">+</span><span class="st"> </span>estnbwt2 <span class="op">+</span><span class="st"> </span>estnbwt3 <span class="op">+</span><span class="st"> </span>estnbwt4 <span class="op">+</span></a>
<a class="sourceLine" id="cb147-62" title="62"><span class="st">    </span>esthbwt1 <span class="op">+</span><span class="st"> </span>esthbwt2 <span class="op">+</span><span class="st"> </span>esthbwt3 <span class="op">+</span><span class="st"> </span>esthbwt4</a>
<a class="sourceLine" id="cb147-63" title="63"></a>
<a class="sourceLine" id="cb147-64" title="64"><span class="co">## Verifying that this works with a fixed population</span></a>
<a class="sourceLine" id="cb147-65" title="65"><span class="co">## datv1 &lt;- draw_data(thedesign)</span></a>
<a class="sourceLine" id="cb147-66" title="66"><span class="co">##datv2 &lt;- draw_data(thedesign)</span></a>
<a class="sourceLine" id="cb147-67" title="67"><span class="co">##table(datv1$Z,datv2$Z)</span></a></code></pre></div>
<div class="sourceCode" id="cb148"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb148-1" title="1">sims &lt;-<span class="st"> </span><span class="dv">200</span></a>
<a class="sourceLine" id="cb148-2" title="2"><span class="kw">set.seed</span>(<span class="dv">12345</span>)</a>
<a class="sourceLine" id="cb148-3" title="3">thediagnosis &lt;-<span class="st"> </span><span class="kw">diagnose_design</span>(thedesignPlusEstimators, <span class="dt">sims =</span> sims, <span class="dt">bootstrap_sims =</span> <span class="dv">0</span>)</a></code></pre></div>
<p>We see that the estimator using block-size weights (E2, E3, E4, or E5) all
eliminate bias (within simulation error). The estimators ignoring blocks (E0
and E1), have bias, and in this simulation, the precision weighed estimators
(E6&#x2013;E9) also show high bias &#x2014; with some of them also producing poor coverage
or false positive rates (E7 and E9).</p>
<p>The diagnostic output also shows us the &#x201C;SD Estimate&#x201D; (which is a good estimate of the standard error of the estimate) and the &#x201C;Mean SE&#x201D; (which is the average of the analytic estimates of the standard error). In the case of E2, E3, E4 or E5 the Mean SE is larger than the SD Estimate &#x2014; this is good in that it means that our analytic standard errors will be conservative. However, we also would prefer that our analytic standard errors not be <em>too</em> conservative, for example, E5 looks good but the mean analytic standard error is quite high compared to E4, for example.</p>
<div class="sourceCode" id="cb149"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb149-1" title="1"><span class="co">## See https://haozhu233.github.io/kableExtra/awesome_table_in_html.html</span></a>
<a class="sourceLine" id="cb149-2" title="2"><span class="kw">kable</span>(<span class="kw">reshape_diagnosis</span>(thediagnosis)[,diagcols] ) <span class="co"># %&gt;% kable_styling() %&gt;% scroll_box(width = &quot;100%&quot;, height = &quot;600px&quot;)</span></a></code></pre></div>
<table>
<thead>
<tr>
<th style="text-align:left;">
Estimator
</th>
<th style="text-align:left;">
Term
</th>
<th style="text-align:left;">
Mean Estimand
</th>
<th style="text-align:left;">
Mean Estimate
</th>
<th style="text-align:left;">
Bias
</th>
<th style="text-align:left;">
SD Estimate
</th>
<th style="text-align:left;">
RMSE
</th>
<th style="text-align:left;">
Power
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
E0: Ignores Blocks, IID SE
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:left;">
-12900.57
</td>
<td style="text-align:left;">
-12355.37
</td>
<td style="text-align:left;">
545.20
</td>
<td style="text-align:left;">
106.01
</td>
<td style="text-align:left;">
555.36
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E1: Ignores Blocks, Design SE
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:left;">
-12900.57
</td>
<td style="text-align:left;">
-12355.37
</td>
<td style="text-align:left;">
545.20
</td>
<td style="text-align:left;">
106.01
</td>
<td style="text-align:left;">
555.36
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E2: Diff Means Block Size Weights, Design SE
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:left;">
-12900.57
</td>
<td style="text-align:left;">
-12900.11
</td>
<td style="text-align:left;">
0.46
</td>
<td style="text-align:left;">
115.65
</td>
<td style="text-align:left;">
115.36
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E3: Treatment Interaction with Block Indicators, Design SE
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:left;">
-12900.57
</td>
<td style="text-align:left;">
-12900.11
</td>
<td style="text-align:left;">
0.46
</td>
<td style="text-align:left;">
115.65
</td>
<td style="text-align:left;">
115.36
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E4: Treatment Interaction with Block Indicators, Design SE
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:left;">
-12900.57
</td>
<td style="text-align:left;">
-12900.11
</td>
<td style="text-align:left;">
0.46
</td>
<td style="text-align:left;">
115.65
</td>
<td style="text-align:left;">
115.36
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E5: Least Squares with Block Size Weights, Design SE
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:left;">
-12900.57
</td>
<td style="text-align:left;">
-12900.11
</td>
<td style="text-align:left;">
0.46
</td>
<td style="text-align:left;">
115.65
</td>
<td style="text-align:left;">
115.36
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E6: Precision Weights via Fixed Effects, Design SE
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:left;">
-12900.57
</td>
<td style="text-align:left;">
-14143.05
</td>
<td style="text-align:left;">
-1242.48
</td>
<td style="text-align:left;">
208.64
</td>
<td style="text-align:left;">
1259.79
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E7: Precision Weights via Demeaning, Design SE
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:left;">
-12900.57
</td>
<td style="text-align:left;">
-14143.05
</td>
<td style="text-align:left;">
-1242.48
</td>
<td style="text-align:left;">
208.64
</td>
<td style="text-align:left;">
1259.79
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E8: Direct Precision Weights, Design SE
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:left;">
-12900.57
</td>
<td style="text-align:left;">
-14143.05
</td>
<td style="text-align:left;">
-1242.48
</td>
<td style="text-align:left;">
208.64
</td>
<td style="text-align:left;">
1259.79
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E9: Direct Demeaning, Design SE
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:left;">
-12900.57
</td>
<td style="text-align:left;">
-14143.05
</td>
<td style="text-align:left;">
-1242.48
</td>
<td style="text-align:left;">
208.64
</td>
<td style="text-align:left;">
1259.79
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb150"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb150-1" title="1">simdesigns &lt;-<span class="st"> </span><span class="kw">get_simulations</span>(thediagnosis)</a>
<a class="sourceLine" id="cb150-2" title="2"><span class="co">## simdesigns &lt;- simulate_design(thedesign,sims=sims)</span></a>
<a class="sourceLine" id="cb150-3" title="3">simmeans &lt;-<span class="st"> </span>simdesigns <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(estimator) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarize</span>(<span class="dt">expest=</span><span class="kw">mean</span>(estimate))</a></code></pre></div>
<div class="sourceCode" id="cb151"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb151-1" title="1"><span class="co">## Now compare to better behaved outcomes.</span></a>
<a class="sourceLine" id="cb151-2" title="2">g &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data=</span>simdesigns,<span class="kw">aes</span>(<span class="dt">x=</span>estimate,<span class="dt">color=</span>estimator)) <span class="op">+</span></a>
<a class="sourceLine" id="cb151-3" title="3"><span class="st">    </span><span class="kw">geom_density</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb151-4" title="4"><span class="st">    </span><span class="kw">geom_vline</span>(<span class="dt">xintercept=</span>trueATE1) <span class="op">+</span></a>
<a class="sourceLine" id="cb151-5" title="5"><span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">data=</span>simmeans,<span class="kw">aes</span>(<span class="dt">x=</span>expest,<span class="dt">y=</span><span class="kw">rep</span>(<span class="dv">0</span>,<span class="dv">10</span>)),<span class="dt">shape=</span><span class="dv">17</span>,<span class="dt">size=</span><span class="dv">6</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb151-6" title="6"><span class="st">    </span><span class="kw">theme_bw</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb151-7" title="7"><span class="st">    </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="kw">c</span>(.<span class="dv">9</span>,.<span class="dv">8</span>))</a>
<a class="sourceLine" id="cb151-8" title="8"><span class="kw">print</span>(g)</a></code></pre></div>
<p>Since we wondered whether these biases might be exacerbated by the highly
skewed nature of our outcome data (which is designed to look like
administrative outcomes in its prevalence of zeros and long tails), we
transformed the outcomes to ranks. This less skewed outcome nearly erases the
bias from the block-sizee weighted estimators, and the precision-weighted
approach also performs well. Ignoring the blocked design is still a problem
here &#x2014; E0 and E1 showing high bias.</p>
<div class="sourceCode" id="cb152"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb152-1" title="1">po_functionNorm &lt;-<span class="st"> </span><span class="cf">function</span>(data){</a>
<a class="sourceLine" id="cb152-2" title="2">    data &lt;-<span class="st"> </span>data <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(b) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">Y_Z_0=</span><span class="kw">rank</span>(y0),</a>
<a class="sourceLine" id="cb152-3" title="3">                        <span class="dt">Y_Z_1=</span><span class="kw">rank</span>(y1))</a>
<a class="sourceLine" id="cb152-4" title="4">    <span class="kw">as.data.frame</span>(data)</a>
<a class="sourceLine" id="cb152-5" title="5">}</a>
<a class="sourceLine" id="cb152-6" title="6"></a>
<a class="sourceLine" id="cb152-7" title="7">theysNorm  &lt;-<span class="st"> </span><span class="kw">declare_potential_outcomes</span>(<span class="dt">handler =</span> po_functionNorm)</a>
<a class="sourceLine" id="cb152-8" title="8"></a>
<a class="sourceLine" id="cb152-9" title="9">thedesignNorm &lt;-<span class="st"> </span>thepop2 <span class="op">+</span><span class="st"> </span>theysNorm <span class="op">+</span><span class="st"> </span>theestimand <span class="op">+</span><span class="st"> </span>theassign <span class="op">+</span><span class="st"> </span>theobsident</a>
<a class="sourceLine" id="cb152-10" title="10"></a>
<a class="sourceLine" id="cb152-11" title="11">datNorm &lt;-<span class="st"> </span><span class="kw">draw_data</span>(thedesignNorm)</a>
<a class="sourceLine" id="cb152-12" title="12"></a>
<a class="sourceLine" id="cb152-13" title="13">thedesignPlusEstimatorsNorm &lt;-<span class="st"> </span>thedesignNorm <span class="op">+</span></a>
<a class="sourceLine" id="cb152-14" title="14"><span class="st">             </span>estnowtHC2 <span class="op">+</span><span class="st"> </span>estnowtIID <span class="op">+</span><span class="st"> </span>estnbwt1 <span class="op">+</span><span class="st"> </span>estnbwt2 <span class="op">+</span><span class="st"> </span>estnbwt3 <span class="op">+</span><span class="st"> </span>estnbwt4 <span class="op">+</span></a>
<a class="sourceLine" id="cb152-15" title="15"><span class="st">         </span>esthbwt1 <span class="op">+</span><span class="st"> </span>esthbwt2 <span class="op">+</span><span class="st"> </span>esthbwt3 <span class="op">+</span><span class="st"> </span>esthbwt4</a></code></pre></div>
<div class="sourceCode" id="cb153"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb153-1" title="1">sims &lt;-<span class="st"> </span><span class="dv">200</span></a>
<a class="sourceLine" id="cb153-2" title="2">thediagnosisNorm &lt;-<span class="st"> </span><span class="kw">diagnose_design</span>(thedesignPlusEstimatorsNorm, <span class="dt">sims =</span> sims, <span class="dt">bootstrap_sims =</span> <span class="dv">0</span>)</a></code></pre></div>
<div class="sourceCode" id="cb154"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb154-1" title="1"><span class="kw">kable</span>(<span class="kw">reshape_diagnosis</span>(thediagnosisNorm)[,diagcols] ) <span class="co"># %&gt;% kable_styling() %&gt;% scroll_box(width = &quot;100%&quot;, height = &quot;600px&quot;)</span></a></code></pre></div>
<table>
<thead>
<tr>
<th style="text-align:left;">
Estimator
</th>
<th style="text-align:left;">
Term
</th>
<th style="text-align:left;">
Mean Estimand
</th>
<th style="text-align:left;">
Mean Estimate
</th>
<th style="text-align:left;">
Bias
</th>
<th style="text-align:left;">
SD Estimate
</th>
<th style="text-align:left;">
RMSE
</th>
<th style="text-align:left;">
Power
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
E0: Ignores Blocks, IID SE
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
-127.08
</td>
<td style="text-align:left;">
-127.08
</td>
<td style="text-align:left;">
1.85
</td>
<td style="text-align:left;">
127.10
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E1: Ignores Blocks, Design SE
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
-127.08
</td>
<td style="text-align:left;">
-127.08
</td>
<td style="text-align:left;">
1.85
</td>
<td style="text-align:left;">
127.10
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E2: Diff Means Block Size Weights, Design SE
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
0.11
</td>
<td style="text-align:left;">
0.11
</td>
<td style="text-align:left;">
1.70
</td>
<td style="text-align:left;">
1.70
</td>
<td style="text-align:left;">
0.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E3: Treatment Interaction with Block Indicators, Design SE
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
0.11
</td>
<td style="text-align:left;">
0.11
</td>
<td style="text-align:left;">
1.70
</td>
<td style="text-align:left;">
1.70
</td>
<td style="text-align:left;">
0.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E4: Treatment Interaction with Block Indicators, Design SE
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
0.11
</td>
<td style="text-align:left;">
0.11
</td>
<td style="text-align:left;">
1.70
</td>
<td style="text-align:left;">
1.70
</td>
<td style="text-align:left;">
0.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E5: Least Squares with Block Size Weights, Design SE
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
0.11
</td>
<td style="text-align:left;">
0.11
</td>
<td style="text-align:left;">
1.70
</td>
<td style="text-align:left;">
1.70
</td>
<td style="text-align:left;">
0.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E6: Precision Weights via Fixed Effects, Design SE
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
0.11
</td>
<td style="text-align:left;">
0.11
</td>
<td style="text-align:left;">
1.36
</td>
<td style="text-align:left;">
1.36
</td>
<td style="text-align:left;">
0.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E7: Precision Weights via Demeaning, Design SE
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
0.11
</td>
<td style="text-align:left;">
0.11
</td>
<td style="text-align:left;">
1.36
</td>
<td style="text-align:left;">
1.36
</td>
<td style="text-align:left;">
0.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E8: Direct Precision Weights, Design SE
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
0.11
</td>
<td style="text-align:left;">
0.11
</td>
<td style="text-align:left;">
1.36
</td>
<td style="text-align:left;">
1.36
</td>
<td style="text-align:left;">
0.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E9: Direct Demeaning, Design SE
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
0.11
</td>
<td style="text-align:left;">
0.11
</td>
<td style="text-align:left;">
1.36
</td>
<td style="text-align:left;">
1.36
</td>
<td style="text-align:left;">
0.00
</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb155"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb155-1" title="1">simdesignsNorm &lt;-<span class="st"> </span><span class="kw">get_simulations</span>(thediagnosisNorm)</a>
<a class="sourceLine" id="cb155-2" title="2"><span class="co">## simdesigns &lt;- simulate_design(thedesign,sims=sims)</span></a>
<a class="sourceLine" id="cb155-3" title="3">simmeansNorm &lt;-<span class="st"> </span>simdesignsNorm <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(estimator) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarize</span>(<span class="dt">expest=</span><span class="kw">mean</span>(estimate))</a></code></pre></div>
<div class="sourceCode" id="cb156"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb156-1" title="1">g2 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data=</span>simdesignsNorm,<span class="kw">aes</span>(<span class="dt">x=</span>estimate,<span class="dt">color=</span>estimator)) <span class="op">+</span></a>
<a class="sourceLine" id="cb156-2" title="2"><span class="st">    </span><span class="kw">geom_density</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb156-3" title="3"><span class="st">    </span><span class="kw">geom_vline</span>(<span class="dt">xintercept=</span>trueATE1) <span class="op">+</span></a>
<a class="sourceLine" id="cb156-4" title="4"><span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">data=</span>simmeansNorm,<span class="kw">aes</span>(<span class="dt">x=</span>expest,<span class="dt">y=</span><span class="kw">rep</span>(<span class="dv">0</span>,<span class="dv">10</span>)),<span class="dt">shape=</span><span class="dv">17</span>,<span class="dt">size=</span><span class="dv">6</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb156-5" title="5"><span class="st">    </span><span class="kw">theme_bw</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb156-6" title="6"><span class="st">    </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="kw">c</span>(.<span class="dv">9</span>,.<span class="dv">8</span>))</a>
<a class="sourceLine" id="cb156-7" title="7"><span class="kw">print</span>(g2)</a></code></pre></div>
<p>In a pair-randomized design, we know that bias should not arise from ignoring
the blocking structure but we could double our statistical power by taking the
pairing into account <span class="citation">(Bowers <a href="#ref-bowers2011mem">2011</a>)</span>. This next simulation changes the design
to still have unequal sized blocks, but with all of the blocks having the same
probability of treatment assignment although they vary greatly in size. Here
only two esimators show appreciable bias (E5 and E8). However, ignoring the
blocks leads to overly conservative standard errors.</p>
<div class="sourceCode" id="cb157"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb157-1" title="1">theassignEqual &lt;-<span class="st"> </span><span class="kw">declare_assignment</span>(<span class="dt">Z=</span><span class="kw">block_ra</span>(<span class="dt">blocks =</span> bF))</a>
<a class="sourceLine" id="cb157-2" title="2"></a>
<a class="sourceLine" id="cb157-3" title="3">thedesignNormEqual &lt;-<span class="st"> </span>thepop2 <span class="op">+</span><span class="st"> </span>theysNorm <span class="op">+</span><span class="st"> </span>theestimand <span class="op">+</span><span class="st"> </span>theassignEqual <span class="op">+</span><span class="st"> </span>theobsident</a>
<a class="sourceLine" id="cb157-4" title="4"></a>
<a class="sourceLine" id="cb157-5" title="5">datNormEqual &lt;-<span class="st"> </span><span class="kw">draw_data</span>(thedesignNormEqual)</a>
<a class="sourceLine" id="cb157-6" title="6"></a>
<a class="sourceLine" id="cb157-7" title="7">thedesignPlusEstimatorsNormEqual &lt;-<span class="st"> </span>thedesignNormEqual <span class="op">+</span></a>
<a class="sourceLine" id="cb157-8" title="8"><span class="st">             </span>estnowtHC2 <span class="op">+</span><span class="st"> </span>estnowtIID <span class="op">+</span><span class="st"> </span>estnbwt1 <span class="op">+</span><span class="st"> </span>estnbwt2 <span class="op">+</span><span class="st"> </span>estnbwt3 <span class="op">+</span><span class="st"> </span>estnbwt4 <span class="op">+</span></a>
<a class="sourceLine" id="cb157-9" title="9"><span class="st">         </span>esthbwt1 <span class="op">+</span><span class="st"> </span>esthbwt2 <span class="op">+</span><span class="st"> </span>esthbwt3 <span class="op">+</span><span class="st"> </span>esthbwt4</a></code></pre></div>
<div class="sourceCode" id="cb158"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb158-1" title="1">sims &lt;-<span class="st"> </span><span class="dv">200</span></a>
<a class="sourceLine" id="cb158-2" title="2">thediagnosisNormEqual &lt;-<span class="st"> </span><span class="kw">diagnose_design</span>(thedesignPlusEstimatorsNormEqual, <span class="dt">sims =</span> sims, <span class="dt">bootstrap_sims =</span> <span class="dv">0</span>)</a></code></pre></div>
<div class="sourceCode" id="cb159"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb159-1" title="1"><span class="kw">kable</span>(<span class="kw">reshape_diagnosis</span>(thediagnosisNormEqual)[,diagcols] ) <span class="co"># %&gt;% kable_styling() %&gt;% scroll_box(width = &quot;100%&quot;, height = &quot;600px&quot;)</span></a></code></pre></div>
<table>
<thead>
<tr>
<th style="text-align:left;">
Estimator
</th>
<th style="text-align:left;">
Term
</th>
<th style="text-align:left;">
Mean Estimand
</th>
<th style="text-align:left;">
Mean Estimate
</th>
<th style="text-align:left;">
Bias
</th>
<th style="text-align:left;">
SD Estimate
</th>
<th style="text-align:left;">
RMSE
</th>
<th style="text-align:left;">
Power
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
E0: Ignores Blocks, IID SE
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
-0.26
</td>
<td style="text-align:left;">
-0.26
</td>
<td style="text-align:left;">
4.75
</td>
<td style="text-align:left;">
4.75
</td>
<td style="text-align:left;">
0.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E1: Ignores Blocks, Design SE
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
-0.26
</td>
<td style="text-align:left;">
-0.26
</td>
<td style="text-align:left;">
4.75
</td>
<td style="text-align:left;">
4.75
</td>
<td style="text-align:left;">
0.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E2: Diff Means Block Size Weights, Design SE
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
-0.26
</td>
<td style="text-align:left;">
-0.26
</td>
<td style="text-align:left;">
4.75
</td>
<td style="text-align:left;">
4.75
</td>
<td style="text-align:left;">
0.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E3: Treatment Interaction with Block Indicators, Design SE
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
-0.26
</td>
<td style="text-align:left;">
-0.26
</td>
<td style="text-align:left;">
4.75
</td>
<td style="text-align:left;">
4.75
</td>
<td style="text-align:left;">
0.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E4: Treatment Interaction with Block Indicators, Design SE
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
-0.26
</td>
<td style="text-align:left;">
-0.26
</td>
<td style="text-align:left;">
4.75
</td>
<td style="text-align:left;">
4.75
</td>
<td style="text-align:left;">
0.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E5: Least Squares with Block Size Weights, Design SE
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
77.64
</td>
<td style="text-align:left;">
77.64
</td>
<td style="text-align:left;">
4.10
</td>
<td style="text-align:left;">
77.75
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E6: Precision Weights via Fixed Effects, Design SE
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
-0.26
</td>
<td style="text-align:left;">
-0.26
</td>
<td style="text-align:left;">
4.75
</td>
<td style="text-align:left;">
4.75
</td>
<td style="text-align:left;">
0.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E7: Precision Weights via Demeaning, Design SE
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
-0.26
</td>
<td style="text-align:left;">
-0.26
</td>
<td style="text-align:left;">
4.75
</td>
<td style="text-align:left;">
4.75
</td>
<td style="text-align:left;">
0.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E8: Direct Precision Weights, Design SE
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
127.10
</td>
<td style="text-align:left;">
127.10
</td>
<td style="text-align:left;">
2.72
</td>
<td style="text-align:left;">
127.13
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E9: Direct Demeaning, Design SE
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
-0.26
</td>
<td style="text-align:left;">
-0.26
</td>
<td style="text-align:left;">
4.75
</td>
<td style="text-align:left;">
4.75
</td>
<td style="text-align:left;">
0.00
</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb160"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb160-1" title="1">simdesignsNormEqual &lt;-<span class="st"> </span><span class="kw">get_simulations</span>(thediagnosisNorm)</a>
<a class="sourceLine" id="cb160-2" title="2">simmeansNormEqual &lt;-<span class="st"> </span>simdesignsNormEqual <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(estimator) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarize</span>(<span class="dt">expest=</span><span class="kw">mean</span>(estimate))</a></code></pre></div>
<div class="sourceCode" id="cb161"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb161-1" title="1"><span class="co">## Now compare to better behaved outcomes.</span></a>
<a class="sourceLine" id="cb161-2" title="2">g3 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data=</span>simdesignsNormEqual,<span class="kw">aes</span>(<span class="dt">x=</span>estimate,<span class="dt">color=</span>estimator)) <span class="op">+</span></a>
<a class="sourceLine" id="cb161-3" title="3"><span class="st">    </span><span class="kw">geom_density</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb161-4" title="4"><span class="st">    </span><span class="kw">geom_vline</span>(<span class="dt">xintercept=</span>trueATE1) <span class="op">+</span></a>
<a class="sourceLine" id="cb161-5" title="5"><span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">data=</span>simmeansNormEqual,<span class="kw">aes</span>(<span class="dt">x=</span>expest,<span class="dt">y=</span><span class="kw">rep</span>(<span class="dv">0</span>,<span class="dv">10</span>)),<span class="dt">shape=</span><span class="dv">17</span>,<span class="dt">size=</span><span class="dv">6</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb161-6" title="6"><span class="st">    </span><span class="kw">theme_bw</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb161-7" title="7"><span class="st">    </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="kw">c</span>(.<span class="dv">9</span>,.<span class="dv">8</span>))</a>
<a class="sourceLine" id="cb161-8" title="8"><span class="kw">print</span>(g3)</a></code></pre></div>
<div id="summary-of-approaches-to-the-analysis-of-block-randomized-trials" class="section level4">
<h4><span class="header-section-number">5.4.2.1</span> Summary of Approaches to the Analysis of Block Randomized Trials</h4>
<p>Our team prefers block randomized trials because of their potential to increase
statistical power (and thus provide more bang for the research buck) as well as
their ability to let us focus on subgroup effects when relevant. The approach
of our team to the analysis of blocked experiments has been guided by evidence like that
shown here: we analyze as we randomize to avoid bias and increase statistical
power, and we are careful in our choice of weighting approaches. Different
designs will require different specific decisions &#x2014; sometimes we may be
willing to trade a small amount of bias for a guarantee that our estimates will
be closer to the truth and more precise, on average (i.e.&#xA0;trade mean-squared
error for bias). Other studies will be so large or small that one or another
strategy will become obvious. We use our Analysis Plans to specify these
approaches and simulation studies like those shown here when we are uncertain
about the applicability of statistical rules of thumb to any given design.</p>
</div>
</div>
</div>
<div id="clusterrandanalysis" class="section level2">
<h2><span class="header-section-number">5.5</span> Cluster-randomized trials</h2>
<p>A cluster randomized trial tends to distinguish signal from noise less well
than an experiment where we can assign treatment directly to individuals
because the number of independent pieces of information available to learn
about the treatment effect is closer to the number of clusters (each of which
tends to be assigned to treatment independently of each other) than it is to
the number of dependent observations within a cluster (See EGAP&#x2019;s <a href="https://egap.org/methods-guides/10-things-you-need-know-about-cluster-randomization">10 Things You Need to Know about Cluster
Randomization</a>).</p>
<p>Since we analyze as we randomize, a cluster randomized experiment requires that
we (1) weight the combination of cluster-level average treatment effects by
cluster size if we are trying to estimate the average of the individual level
causal effects <span class="citation">(Middleton and Aronow <a href="#ref-middleton2015unbiased">2015</a>)</span> and (2) change how we calculate
standard errors and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span>-values to account for the fact that uncertainty is
generated at the level of the cluster and not at the level of the individual
<span class="citation">(Hansen and Bowers <a href="#ref-hansen_covariate_2008">2008</a>; Gerber and Green <a href="#ref-gerber_field_2012">2012</a>)</span>. For example, imagine that we had
10 clusters (administrative offices, physicians groups, etc..) with half
assigned to treatment and half assigned to control.</p>
<div class="sourceCode" id="cb162"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb162-1" title="1"><span class="kw">set.seed</span>(<span class="dv">12345</span>)</a>
<a class="sourceLine" id="cb162-2" title="2"><span class="co">## Randomly assign half of the clusters to treatment and half to control</span></a>
<a class="sourceLine" id="cb162-3" title="3">dat3<span class="op">$</span>Zcluster &lt;-<span class="st"> </span><span class="kw">cluster_ra</span>(<span class="dt">cluster=</span>dat3<span class="op">$</span>cluster)</a>
<a class="sourceLine" id="cb162-4" title="4"><span class="co"># dat3$falsestratum &lt;- rep(1,nrow(dat3))</span></a>
<a class="sourceLine" id="cb162-5" title="5"><span class="co"># dat3$iprweight &lt;-  with(dat3,ipr(Zcluster,falsestratum,clusterF))</span></a>
<a class="sourceLine" id="cb162-6" title="6"><span class="kw">with</span>(dat3,<span class="kw">table</span>(Zcluster,cluster))</a></code></pre></div>
<pre><code>        cluster
Zcluster   1   2   3   4   5   6   7   8   9  10
       0   8   0  30  40   0   0   0   0 100 800
       1   0  20   0   0  50  60  70  80   0   0</code></pre>
<p>So, although our data has 1258 observations, we do not have 1258
pieces of independent information about the effect of the treatment because
people were assigned in groups. Rather we have some amount of information in
between 100 and the number of clusters, in this case,
10. For example, here we can see the number of
people within each cluster &#x2014; and notice that all of the people are coded as
either control or treatment because assignment is at the level of the cluster.</p>
<div class="sourceCode" id="cb164"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb164-1" title="1"><span class="co">## Setup the cluster-randomized design</span></a>
<a class="sourceLine" id="cb164-2" title="2"><span class="kw">library</span>(ICC)</a>
<a class="sourceLine" id="cb164-3" title="3">iccres &lt;-<span class="st"> </span><span class="kw">ICCest</span>(<span class="dt">x=</span>clusterF,<span class="dt">y=</span>Y,<span class="dt">data=</span>dat3)</a>
<a class="sourceLine" id="cb164-4" title="4">dat3<span class="op">$</span>varweight &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">/</span>(iccres<span class="op">$</span>vara <span class="op">+</span><span class="st"> </span>(iccres<span class="op">$</span>varw<span class="op">/</span>dat3<span class="op">$</span>nb))</a>
<a class="sourceLine" id="cb164-5" title="5"></a>
<a class="sourceLine" id="cb164-6" title="6">thepop3 &lt;-<span class="st"> </span><span class="kw">declare_population</span>(dat3)</a>
<a class="sourceLine" id="cb164-7" title="7"></a>
<a class="sourceLine" id="cb164-8" title="8">po_functionCluster &lt;-<span class="st"> </span><span class="cf">function</span>(data){</a>
<a class="sourceLine" id="cb164-9" title="9">    data<span class="op">$</span>Y_Zcluster_<span class="dv">0</span> &lt;-<span class="st"> </span>data<span class="op">$</span>y0</a>
<a class="sourceLine" id="cb164-10" title="10">    data<span class="op">$</span>Y_Zcluster_<span class="dv">1</span> &lt;-<span class="st"> </span>data<span class="op">$</span>y1</a>
<a class="sourceLine" id="cb164-11" title="11">    data</a>
<a class="sourceLine" id="cb164-12" title="12">}</a>
<a class="sourceLine" id="cb164-13" title="13"></a>
<a class="sourceLine" id="cb164-14" title="14">theysCluster  &lt;-<span class="st"> </span><span class="kw">declare_potential_outcomes</span>(<span class="dt">handler =</span> po_functionCluster)</a>
<a class="sourceLine" id="cb164-15" title="15"></a>
<a class="sourceLine" id="cb164-16" title="16">theestimandCluster &lt;-<span class="st"> </span><span class="kw">declare_inquiry</span>(<span class="dt">ATE =</span> <span class="kw">mean</span>(Y_Zcluster_<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>Y_Zcluster_<span class="dv">0</span>))</a>
<a class="sourceLine" id="cb164-17" title="17"></a>
<a class="sourceLine" id="cb164-18" title="18">theassignCluster &lt;-<span class="st"> </span><span class="kw">declare_assignment</span>(<span class="dt">Zcluster=</span><span class="kw">cluster_ra</span>(<span class="dt">clusters=</span>cluster))</a>
<a class="sourceLine" id="cb164-19" title="19"></a>
<a class="sourceLine" id="cb164-20" title="20">theobsidentCluster &lt;-<span class="st"> </span><span class="kw">declare_reveal</span>(Y, Zcluster)</a>
<a class="sourceLine" id="cb164-21" title="21"></a>
<a class="sourceLine" id="cb164-22" title="22">thedesignCluster &lt;-<span class="st"> </span>thepop3 <span class="op">+</span><span class="st"> </span>theysCluster <span class="op">+</span><span class="st"> </span>theestimandCluster <span class="op">+</span><span class="st"> </span>theassignCluster <span class="op">+</span><span class="st"> </span>theobsidentCluster</a>
<a class="sourceLine" id="cb164-23" title="23"></a>
<a class="sourceLine" id="cb164-24" title="24">datCluster &lt;-<span class="st"> </span><span class="kw">draw_data</span>(thedesignCluster)</a></code></pre></div>
<p>In everyday practice, with more than about 50 clusters, we produce estimates
and using more or less the same kinds software as we do above but changing the
standard error calculations to use the the <code>CR2</code> cluster-robust standard error
<span class="citation">(Pustejovsky <a href="#ref-pustejovsky2019cr">2019</a>)</span>. For example, here are two approaches to such adjustment.</p>
<div class="sourceCode" id="cb165"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb165-1" title="1">estAndSE4a &lt;-<span class="st"> </span><span class="kw">difference_in_means</span>(Y<span class="op">~</span>Zcluster,<span class="dt">data=</span>datCluster,<span class="dt">clusters=</span>cluster)</a>
<a class="sourceLine" id="cb165-2" title="2">estAndSE4a</a></code></pre></div>
<pre><code>Design:  Clustered 
         Estimate Std. Error t value Pr(&gt;|t|) CI Lower CI Upper   DF
Zcluster   -15597       8336  -1.871   0.1232   -37356     6162 4.76</code></pre>
<div class="sourceCode" id="cb167"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb167-1" title="1">estAndSE4b &lt;-<span class="st"> </span><span class="kw">lm_robust</span>(Y<span class="op">~</span>Zcluster,<span class="dt">data=</span>datCluster,<span class="dt">clusters=</span>cluster,<span class="dt">se_type=</span><span class="st">&quot;CR2&quot;</span>)</a>
<a class="sourceLine" id="cb167-2" title="2">estAndSE4b</a></code></pre></div>
<pre><code>            Estimate Std. Error t value Pr(&gt;|t|) CI Lower CI Upper    DF
(Intercept)    15707       8332   1.885   0.1409    -8542    39955 3.578
Zcluster      -15597       8336  -1.871   0.1232   -37356     6162 4.760</code></pre>
<div id="bias-when-cluster-size-is-correlated-with-potential-outcomes" class="section level3">
<h3><span class="header-section-number">5.5.1</span> Bias when cluster size is correlated with potential outcomes</h3>
<p>When clusters have unequal sizes, we worry about bias in addition to appropriate estimates of precision
<span class="citation">(Middleton and Aronow <a href="#ref-middleton2015unbiased">2015</a>)</span> (see also
<a href="https://declaredesign.org/blog/bias-cluster-randomized-trials.html" class="uri">https://declaredesign.org/blog/bias-cluster-randomized-trials.html</a>). Here we
demonstrate how to reduce the bias, and also how bias can emerge in the
analysis of a cluster randomized trial.</p>
<div class="sourceCode" id="cb169"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb169-1" title="1"><span class="co"># Define estimators that can be repeated in the simulation below</span></a>
<a class="sourceLine" id="cb169-2" title="2">estC0 &lt;-<span class="st"> </span><span class="kw">declare_estimator</span>(Y<span class="op">~</span>Zcluster, <span class="dt">inquiry=</span>theestimand, <span class="dt">model=</span>lm, <span class="dt">label=</span><span class="st">&quot;C0: Ignores Clusters, IID SE&quot;</span>)</a>
<a class="sourceLine" id="cb169-3" title="3">estC1 &lt;-<span class="st"> </span><span class="kw">declare_estimator</span>(Y<span class="op">~</span>Zcluster, <span class="dt">inquiry=</span>theestimand, <span class="dt">model=</span>lm_robust, <span class="dt">label=</span><span class="st">&quot;C1: Ignores Clusters, CR2 SE&quot;</span>)</a>
<a class="sourceLine" id="cb169-4" title="4">estC2 &lt;-<span class="st"> </span><span class="kw">declare_estimator</span>(Y<span class="op">~</span>Zcluster, <span class="dt">inquiry=</span>theestimand, <span class="dt">model=</span>lm_robust,</a>
<a class="sourceLine" id="cb169-5" title="5">               <span class="dt">clusters=</span>cluster, <span class="dt">se_type=</span><span class="st">&quot;stata&quot;</span>,<span class="dt">label=</span><span class="st">&quot;C2: OLS Clusters, Stata RCSE&quot;</span>)</a>
<a class="sourceLine" id="cb169-6" title="6">estC3 &lt;-<span class="st"> </span><span class="kw">declare_estimator</span>(Y<span class="op">~</span>Zcluster, <span class="dt">inquiry=</span>theestimand, <span class="dt">model=</span>difference_in_means,</a>
<a class="sourceLine" id="cb169-7" title="7">                 <span class="dt">clusters =</span> cluster,<span class="dt">label=</span><span class="st">&quot;C3: Diff Means Cluster, CR2 SE&quot;</span>)</a>
<a class="sourceLine" id="cb169-8" title="8">estC4 &lt;-<span class="st"> </span><span class="kw">declare_estimator</span>(Y<span class="op">~</span>Zcluster, <span class="dt">inquiry=</span>theestimand, <span class="dt">model=</span>lm_robust,</a>
<a class="sourceLine" id="cb169-9" title="9">                 <span class="dt">clusters =</span> cluster,<span class="dt">se_type=</span><span class="st">&quot;CR2&quot;</span>,<span class="dt">label=</span><span class="st">&quot;C4: OLS Cluster, CR2 SE&quot;</span>)</a>
<a class="sourceLine" id="cb169-10" title="10">estC5 &lt;-<span class="st"> </span><span class="kw">declare_estimator</span>(Y<span class="op">~</span>Zcluster, <span class="dt">inquiry=</span>theestimand, <span class="dt">model=</span>horvitz_thompson,</a>
<a class="sourceLine" id="cb169-11" title="11">                 <span class="dt">clusters=</span>cluster, <span class="dt">simple=</span><span class="ot">FALSE</span>,<span class="dt">condition_prs=</span>.<span class="dv">5</span>,<span class="dt">label=</span><span class="st">&quot;C5: Horvitz-Thompson Cluster, Young SE&quot;</span>)</a>
<a class="sourceLine" id="cb169-12" title="12">estC6 &lt;-<span class="st"> </span><span class="kw">declare_estimator</span>(Y<span class="op">~</span>Zcluster, <span class="dt">inquiry=</span>theestimand, <span class="dt">model=</span>lm_robust, <span class="dt">weights=</span> nb ,</a>
<a class="sourceLine" id="cb169-13" title="13">               <span class="dt">clusters=</span>cluster, <span class="dt">se_type=</span><span class="st">&quot;CR2&quot;</span>,<span class="dt">label=</span><span class="st">&quot;C6: OLS Clusters with ClusterSize Weights, CR2 RCSE&quot;</span>)</a>
<a class="sourceLine" id="cb169-14" title="14"></a>
<a class="sourceLine" id="cb169-15" title="15">estC7 &lt;-<span class="st"> </span><span class="kw">declare_estimator</span>(Y<span class="op">~</span>Zcluster <span class="op">+</span><span class="st"> </span>nb, <span class="dt">inquiry=</span>theestimand,</a>
<a class="sourceLine" id="cb169-16" title="16">               <span class="dt">model=</span>lm_robust, <span class="dt">weights=</span>varweight,</a>
<a class="sourceLine" id="cb169-17" title="17">               <span class="dt">clusters=</span>cluster, <span class="dt">se_type=</span><span class="st">&quot;CR2&quot;</span>,</a>
<a class="sourceLine" id="cb169-18" title="18">               <span class="dt">label=</span><span class="st">&quot;C7: OLS Clusters with Weights, CR2 RCSE&quot;</span>)</a>
<a class="sourceLine" id="cb169-19" title="19"></a>
<a class="sourceLine" id="cb169-20" title="20">estC8 &lt;-<span class="st"> </span><span class="kw">declare_estimator</span>(Y<span class="op">~</span>Zcluster<span class="op">+</span>nb, <span class="dt">inquiry=</span>theestimand,</a>
<a class="sourceLine" id="cb169-21" title="21">               <span class="dt">model=</span>lm_robust,</a>
<a class="sourceLine" id="cb169-22" title="22">               <span class="dt">clusters=</span>cluster, <span class="dt">se_type=</span><span class="st">&quot;CR2&quot;</span>,</a>
<a class="sourceLine" id="cb169-23" title="23">               <span class="dt">label=</span><span class="st">&quot;C8: OLS Clusters with adj for cluster size, CR2 RCSE&quot;</span>)</a>
<a class="sourceLine" id="cb169-24" title="24"></a>
<a class="sourceLine" id="cb169-25" title="25">estC9 &lt;-<span class="st"> </span><span class="kw">declare_estimator</span>(Y<span class="op">~</span>Zcluster, <span class="dt">inquiry=</span>theestimand,</a>
<a class="sourceLine" id="cb169-26" title="26">               <span class="dt">model=</span>lm_lin,<span class="dt">covariates=</span><span class="op">~</span>nb,</a>
<a class="sourceLine" id="cb169-27" title="27">               <span class="dt">clusters=</span>cluster, <span class="dt">se_type=</span><span class="st">&quot;CR2&quot;</span>,</a>
<a class="sourceLine" id="cb169-28" title="28">               <span class="dt">label=</span><span class="st">&quot;C9: OLS Clusters with adj for cluster size, CR2 RCSE&quot;</span>)</a>
<a class="sourceLine" id="cb169-29" title="29"><span class="co"># estC10 &lt;- declare_estimator(Y~Zcluster, inquiry=theestimand,</span></a>
<a class="sourceLine" id="cb169-30" title="30"><span class="co">#              model=lm_robust, weights= ipr(Zcluster,falsestratum,clusterF),</span></a>
<a class="sourceLine" id="cb169-31" title="31"><span class="co">#              clusters=cluster, se_type=&quot;CR2&quot;,</span></a>
<a class="sourceLine" id="cb169-32" title="32"><span class="co">#              label=&quot;C10: OLS Clusters with IPR Weights, CR2 RCSE&quot;)</span></a>
<a class="sourceLine" id="cb169-33" title="33"></a>
<a class="sourceLine" id="cb169-34" title="34"></a>
<a class="sourceLine" id="cb169-35" title="35">bt &lt;-<span class="st"> </span><span class="kw">balanceTest</span>(Zcluster<span class="op">~</span>Y<span class="op">+</span><span class="kw">cluster</span>(cluster),<span class="dt">data=</span>datCluster)</a>
<a class="sourceLine" id="cb169-36" title="36">bt0 &lt;-<span class="st"> </span><span class="kw">balanceTest</span>(Zcluster<span class="op">~</span>Y,<span class="dt">data=</span>datCluster)</a>
<a class="sourceLine" id="cb169-37" title="37"></a>
<a class="sourceLine" id="cb169-38" title="38">theestimatorsC &lt;-<span class="st"> </span><span class="kw">ls</span>(<span class="dt">patt=</span><span class="st">&quot;^estC[0-9]&quot;</span>)</a>
<a class="sourceLine" id="cb169-39" title="39">theestimatorsC</a>
<a class="sourceLine" id="cb169-40" title="40"></a>
<a class="sourceLine" id="cb169-41" title="41">checkestC &lt;-<span class="st"> </span><span class="kw">sapply</span>(theestimatorsC,<span class="cf">function</span>(x){ <span class="kw">message</span>(x)</a>
<a class="sourceLine" id="cb169-42" title="42">            <span class="kw">get</span>(x)(<span class="kw">as.data.frame</span>(datCluster))[<span class="kw">c</span>(<span class="st">&quot;estimate&quot;</span>,<span class="st">&quot;std.error&quot;</span>)]})</a>
<a class="sourceLine" id="cb169-43" title="43">checkestC</a>
<a class="sourceLine" id="cb169-44" title="44"></a>
<a class="sourceLine" id="cb169-45" title="45">thedesignClusterPlusEstimators &lt;-<span class="st"> </span>thedesignCluster <span class="op">+</span></a>
<a class="sourceLine" id="cb169-46" title="46"><span class="st">    </span>estC0 <span class="op">+</span><span class="st"> </span>estC1 <span class="op">+</span><span class="st"> </span>estC2 <span class="op">+</span><span class="st"> </span>estC3 <span class="op">+</span><span class="st"> </span>estC4 <span class="op">+</span><span class="st"> </span>estC5 <span class="op">+</span><span class="st"> </span>estC6 <span class="op">+</span><span class="st"> </span>estC7 <span class="op">+</span><span class="st"> </span>estC8 <span class="op">+</span><span class="st"> </span>estC9 <span class="co">#+ estC10</span></a></code></pre></div>
<div class="sourceCode" id="cb170"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb170-1" title="1">sims &lt;-<span class="st"> </span><span class="dv">200</span></a>
<a class="sourceLine" id="cb170-2" title="2"><span class="kw">set.seed</span>(<span class="dv">12345</span>)</a>
<a class="sourceLine" id="cb170-3" title="3">thediagnosisCluster &lt;-<span class="st"> </span><span class="kw">diagnose_design</span>(thedesignClusterPlusEstimators, <span class="dt">sims =</span> sims, <span class="dt">bootstrap_sims =</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb170-4" title="4"><span class="kw">reshape_diagnosis</span>(thediagnosisCluster)[, diagcols]</a></code></pre></div>
<pre><code>                                              Estimator     Term Mean Estimand Mean Estimate
1                          C0: Ignores Clusters, IID SE Zcluster     -12900.57     -15166.65
2                          C1: Ignores Clusters, CR2 SE Zcluster     -12900.57     -15166.65
3                          C2: OLS Clusters, Stata RCSE Zcluster     -12900.57     -15166.65
4                        C3: Diff Means Cluster, CR2 SE Zcluster     -12900.57     -15166.65
5                               C4: OLS Cluster, CR2 SE Zcluster     -12900.57     -15166.65
6                C5: Horvitz-Thompson Cluster, Young SE Zcluster     -12900.57     -12710.34
7   C6: OLS Clusters with ClusterSize Weights, CR2 RCSE Zcluster     -12900.57     -12670.05
8               C7: OLS Clusters with Weights, CR2 RCSE Zcluster     -12900.57     -19047.82
9  C8: OLS Clusters with adj for cluster size, CR2 RCSE Zcluster     -12900.57     -19120.43
10 C9: OLS Clusters with adj for cluster size, CR2 RCSE Zcluster     -12900.57      61051.64
       Bias SD Estimate      RMSE Power
1  -2266.08     5916.55   6321.84  1.00
2  -2266.08     5916.55   6321.84  1.00
3  -2266.08     5916.55   6321.84  0.76
4  -2266.08     5916.55   6321.84  0.32
5  -2266.08     5916.55   6321.84  0.32
6    190.23     5595.09   5584.33  0.32
7    230.51     5931.54   5921.18  0.24
8  -6147.26     6717.76   9093.48  0.24
9  -6219.86     6709.44   9136.65  0.26
10 73952.20   124497.09 144537.04  0.06</code></pre>
<p>The results of our simulation using 200 simulations show how certain
approaches can yield very biased estimates and other approaches can reduce the
bias. The C5 and C6 estimators have the lowest bias in this particular example
with very few clusters. We also see the problems with the standard errors &#x2014;
the actual standard errors (in &#x201C;SD Estimate&#x201D;) should be much higher than those
estimated by the approaches which ignore the clustered design (C0 and C1).</p>
<div class="sourceCode" id="cb172"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb172-1" title="1"><span class="co">## See https://haozhu233.github.io/kableExtra/awesome_table_in_html.html</span></a>
<a class="sourceLine" id="cb172-2" title="2"><span class="kw">kable</span>(<span class="kw">reshape_diagnosis</span>(thediagnosisCluster)[,diagcols] ) <span class="co"># %&gt;% kable_styling() %&gt;% scroll_box(width = &quot;100%&quot;, height = &quot;800px&quot;)</span></a></code></pre></div>
<table>
<thead>
<tr>
<th style="text-align:left;">
Estimator
</th>
<th style="text-align:left;">
Term
</th>
<th style="text-align:left;">
Mean Estimand
</th>
<th style="text-align:left;">
Mean Estimate
</th>
<th style="text-align:left;">
Bias
</th>
<th style="text-align:left;">
SD Estimate
</th>
<th style="text-align:left;">
RMSE
</th>
<th style="text-align:left;">
Power
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
C0: Ignores Clusters, IID SE
</td>
<td style="text-align:left;">
Zcluster
</td>
<td style="text-align:left;">
-12900.57
</td>
<td style="text-align:left;">
-15166.65
</td>
<td style="text-align:left;">
-2266.08
</td>
<td style="text-align:left;">
5916.55
</td>
<td style="text-align:left;">
6321.84
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
C1: Ignores Clusters, CR2 SE
</td>
<td style="text-align:left;">
Zcluster
</td>
<td style="text-align:left;">
-12900.57
</td>
<td style="text-align:left;">
-15166.65
</td>
<td style="text-align:left;">
-2266.08
</td>
<td style="text-align:left;">
5916.55
</td>
<td style="text-align:left;">
6321.84
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
C2: OLS Clusters, Stata RCSE
</td>
<td style="text-align:left;">
Zcluster
</td>
<td style="text-align:left;">
-12900.57
</td>
<td style="text-align:left;">
-15166.65
</td>
<td style="text-align:left;">
-2266.08
</td>
<td style="text-align:left;">
5916.55
</td>
<td style="text-align:left;">
6321.84
</td>
<td style="text-align:left;">
0.76
</td>
</tr>
<tr>
<td style="text-align:left;">
C3: Diff Means Cluster, CR2 SE
</td>
<td style="text-align:left;">
Zcluster
</td>
<td style="text-align:left;">
-12900.57
</td>
<td style="text-align:left;">
-15166.65
</td>
<td style="text-align:left;">
-2266.08
</td>
<td style="text-align:left;">
5916.55
</td>
<td style="text-align:left;">
6321.84
</td>
<td style="text-align:left;">
0.32
</td>
</tr>
<tr>
<td style="text-align:left;">
C4: OLS Cluster, CR2 SE
</td>
<td style="text-align:left;">
Zcluster
</td>
<td style="text-align:left;">
-12900.57
</td>
<td style="text-align:left;">
-15166.65
</td>
<td style="text-align:left;">
-2266.08
</td>
<td style="text-align:left;">
5916.55
</td>
<td style="text-align:left;">
6321.84
</td>
<td style="text-align:left;">
0.32
</td>
</tr>
<tr>
<td style="text-align:left;">
C5: Horvitz-Thompson Cluster, Young SE
</td>
<td style="text-align:left;">
Zcluster
</td>
<td style="text-align:left;">
-12900.57
</td>
<td style="text-align:left;">
-12710.34
</td>
<td style="text-align:left;">
190.23
</td>
<td style="text-align:left;">
5595.09
</td>
<td style="text-align:left;">
5584.33
</td>
<td style="text-align:left;">
0.32
</td>
</tr>
<tr>
<td style="text-align:left;">
C6: OLS Clusters with ClusterSize Weights, CR2 RCSE
</td>
<td style="text-align:left;">
Zcluster
</td>
<td style="text-align:left;">
-12900.57
</td>
<td style="text-align:left;">
-12670.05
</td>
<td style="text-align:left;">
230.51
</td>
<td style="text-align:left;">
5931.54
</td>
<td style="text-align:left;">
5921.18
</td>
<td style="text-align:left;">
0.24
</td>
</tr>
<tr>
<td style="text-align:left;">
C7: OLS Clusters with Weights, CR2 RCSE
</td>
<td style="text-align:left;">
Zcluster
</td>
<td style="text-align:left;">
-12900.57
</td>
<td style="text-align:left;">
-19047.82
</td>
<td style="text-align:left;">
-6147.26
</td>
<td style="text-align:left;">
6717.76
</td>
<td style="text-align:left;">
9093.48
</td>
<td style="text-align:left;">
0.24
</td>
</tr>
<tr>
<td style="text-align:left;">
C8: OLS Clusters with adj for cluster size, CR2 RCSE
</td>
<td style="text-align:left;">
Zcluster
</td>
<td style="text-align:left;">
-12900.57
</td>
<td style="text-align:left;">
-19120.43
</td>
<td style="text-align:left;">
-6219.86
</td>
<td style="text-align:left;">
6709.44
</td>
<td style="text-align:left;">
9136.65
</td>
<td style="text-align:left;">
0.26
</td>
</tr>
<tr>
<td style="text-align:left;">
C9: OLS Clusters with adj for cluster size, CR2 RCSE
</td>
<td style="text-align:left;">
Zcluster
</td>
<td style="text-align:left;">
-12900.57
</td>
<td style="text-align:left;">
61051.64
</td>
<td style="text-align:left;">
73952.20
</td>
<td style="text-align:left;">
124497.09
</td>
<td style="text-align:left;">
144537.04
</td>
<td style="text-align:left;">
0.06
</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb173"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb173-1" title="1">simdesigns &lt;-<span class="st"> </span><span class="kw">get_simulations</span>(thediagnosis)</a>
<a class="sourceLine" id="cb173-2" title="2"><span class="co">## simdesigns &lt;- simulate_design(thedesign,sims=sims)</span></a>
<a class="sourceLine" id="cb173-3" title="3">simmeans &lt;-<span class="st"> </span>simdesigns <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(estimator) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarize</span>(<span class="dt">expest=</span><span class="kw">mean</span>(estimate))</a></code></pre></div>
<p>The following plot shows many of the estimators produce results far from the
truth (shown by the vertical black bar), and also shows the diversity in
precision of the estimators.</p>
<div class="sourceCode" id="cb174"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb174-1" title="1"><span class="co">## Now compare to better behaved outcomes.</span></a>
<a class="sourceLine" id="cb174-2" title="2">gDiagClust &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data=</span>simdesigns,<span class="kw">aes</span>(<span class="dt">x=</span>estimate,<span class="dt">color=</span>estimator)) <span class="op">+</span></a>
<a class="sourceLine" id="cb174-3" title="3"><span class="st">    </span><span class="kw">geom_density</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb174-4" title="4"><span class="st">    </span><span class="kw">geom_vline</span>(<span class="dt">xintercept=</span>trueATE1) <span class="op">+</span></a>
<a class="sourceLine" id="cb174-5" title="5"><span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">data=</span>simmeans,<span class="kw">aes</span>(<span class="dt">x=</span>expest,<span class="dt">y=</span><span class="kw">rep</span>(<span class="dv">0</span>,<span class="dv">10</span>)),<span class="dt">shape=</span><span class="dv">17</span>,<span class="dt">size=</span><span class="dv">6</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb174-6" title="6"><span class="st">    </span><span class="kw">theme_bw</span>() <span class="co">#+</span></a>
<a class="sourceLine" id="cb174-7" title="7">    <span class="co">#theme(legend.position = c(.9,.8))</span></a>
<a class="sourceLine" id="cb174-8" title="8"><span class="kw">print</span>(gDiagClust)</a></code></pre></div>
<p><img src="OES_SOP_files/figure-html/clusterresultsplot-1.png" width=".9\textwidth"></p>
</div>
<div id="incorrect-false-positive-rates-from-tests-and-confidence-intervals" class="section level3">
<h3><span class="header-section-number">5.5.2</span> Incorrect false positive rates from tests and confidence intervals</h3>
<p>When we have few clusters, analytic standard errors such as those used by
<code>difference_in_means</code> and <code>lm_robust</code> may lead to incorrect false positive
rates for our hypothesis tests or confidence intervals. We demonstrate how
adjusting for cluster-randomization can help ensure that the false positive
rates of our hypothesis tests is controlled/known, we also discuss the
limitations of these approaches. The next code block compares the false
positive rates of two different approaches to adjusting standard errors in a
cluster randomized trial.</p>
<p>To distinguish between the problems of bias arising from unequal sized clusters and problems of false positive rates or covereage arising from the fact that we have fewer clusters than units, we use a design with equal numbers of units per cluster:</p>
<div class="sourceCode" id="cb175"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb175-1" title="1"><span class="kw">with</span>(dat1,<span class="kw">table</span>(Zcluster,buildingID))</a></code></pre></div>
<pre><code>        buildingID
Zcluster  1  2  3  4  5  6  7  8  9 10
       C 10  0 10 10  0  0  0  0 10 10
       T  0 10  0  0 10 10 10 10  0  0</code></pre>
<p>In this case, with equal sized clusters, a simple outcome, and equal numbers of
clusters in treatment and control, we see that the CR2 standard error controls
the false positive rate (<strong>less than</strong> 5% of the 1000 simulations testing a
true null hypothesis of no effects return a <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span>-value of less than .05) while
the &#x201C;Stata&#x201D; standard error has a slightly too high false positive rate of <code>r fprateStata05</code> at the 5% error level. We also saw above that not controlling
at all yields very poor coverage (see the rows for C0 and C1) &#x2014; and we saw
that the &#x201C;Stata&#x201D; approach has poor coverage relative to the CR2 based
approaches as well, in this case with only 10 clusters.</p>
<div class="sourceCode" id="cb177"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb177-1" title="1">checkFP &lt;-<span class="st"> </span><span class="cf">function</span>(dat, <span class="dt">setype =</span> <span class="st">&quot;CR2&quot;</span>) {</a>
<a class="sourceLine" id="cb177-2" title="2">  <span class="co">## Break any relationship between treatment and outcomes by permuting</span></a>
<a class="sourceLine" id="cb177-3" title="3">  <span class="co">## or shuffling the treatment variable. This means that H0,  the null,</span></a>
<a class="sourceLine" id="cb177-4" title="4">  <span class="co">## of no effects is true.</span></a>
<a class="sourceLine" id="cb177-5" title="5">  dat<span class="op">$</span>newZ &lt;-<span class="st"> </span><span class="kw">cluster_ra</span>(<span class="dt">cluster =</span> dat<span class="op">$</span>buildingID)</a>
<a class="sourceLine" id="cb177-6" title="6">  newest &lt;-<span class="st"> </span><span class="kw">lm_robust</span>(Y <span class="op">~</span><span class="st"> </span>newZ, <span class="dt">dat =</span> dat, <span class="dt">clusters =</span> buildingID, <span class="dt">se_type =</span> setype)</a>
<a class="sourceLine" id="cb177-7" title="7">  <span class="kw">return</span>(<span class="dt">nullp =</span> newest<span class="op">$</span>p.value[<span class="st">&quot;newZ&quot;</span>])</a>
<a class="sourceLine" id="cb177-8" title="8">}</a>
<a class="sourceLine" id="cb177-9" title="9"></a>
<a class="sourceLine" id="cb177-10" title="10">smalldat &lt;-<span class="st"> </span>dat1[, <span class="kw">c</span>(<span class="st">&quot;Y&quot;</span>, <span class="st">&quot;buildingID&quot;</span>)]</a>
<a class="sourceLine" id="cb177-11" title="11"><span class="kw">set.seed</span>(<span class="dv">123</span>)</a>
<a class="sourceLine" id="cb177-12" title="12">fpresCR2 &lt;-<span class="st"> </span><span class="kw">replicate</span>(<span class="dv">1000</span>, <span class="kw">checkFP</span>(<span class="dt">dat =</span> smalldat))</a>
<a class="sourceLine" id="cb177-13" title="13"><span class="kw">set.seed</span>(<span class="dv">123</span>)</a>
<a class="sourceLine" id="cb177-14" title="14">fpresStata &lt;-<span class="st"> </span><span class="kw">replicate</span>(<span class="dv">1000</span>, <span class="kw">checkFP</span>(<span class="dt">dat =</span> smalldat, <span class="dt">setype =</span> <span class="st">&quot;stata&quot;</span>))</a>
<a class="sourceLine" id="cb177-15" title="15">fprateCR205 &lt;-<span class="st"> </span><span class="kw">mean</span>(fpresCR2 <span class="op">&lt;=</span><span class="st"> </span><span class="fl">.05</span>)</a>
<a class="sourceLine" id="cb177-16" title="16">fprateCR205</a></code></pre></div>
<pre><code>[1] 0.045</code></pre>
<div class="sourceCode" id="cb179"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb179-1" title="1">fprateStata05 &lt;-<span class="st"> </span><span class="kw">mean</span>(fpresStata <span class="op">&lt;=</span><span class="st"> </span><span class="fl">.05</span>)</a>
<a class="sourceLine" id="cb179-2" title="2">fprateStata05</a></code></pre></div>
<pre><code>[1] 0.054</code></pre>
<p>The following plot shows that, in this case the Stata standard error tends to
make slightly too many false positive errors (shown by open circles above the
45 degree line) and the CR2 standard error tends control the error rate of the
test (with black dots below the 45 degree line).</p>
<div class="sourceCode" id="cb181"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb181-1" title="1"><span class="kw">plot</span>(<span class="kw">ecdf</span>(fpresCR2),<span class="dt">pch=</span><span class="dv">19</span>)</a>
<a class="sourceLine" id="cb181-2" title="2"><span class="kw">plot</span>(<span class="kw">ecdf</span>(fpresStata),<span class="dt">pch=</span><span class="dv">21</span>,<span class="dt">add=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb181-3" title="3"><span class="kw">abline</span>(<span class="dv">0</span>,<span class="dv">1</span>)</a></code></pre></div>
<p><img src="OES_SOP_files/figure-html/plotfpr-1.png" width=".9\textwidth"></p>
<p>When a simulation like the above shows false positive rate problems with the
CR2 standard error, we then use permutation-based randomization inference
(rather than the asymptotic justified randomization inference of the CR2
standard error).</p>
<p>[TO DO: An example using permutation based inference and its false positive rate].</p>

</div>
</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-lin_agnostic_2013">
<p>Lin, Winston. 2013. &#x201C;Agnostic Notes on Regression Adjustments to Experimental Data: Reexamining Freedman&#x2019;s Critique.&#x201D; <em>The Annals of Applied Statistics</em> 7 (1): 295&#x2013;318.</p>
</div>
<div id="ref-samii_equivalencies_2012">
<p>Samii, Cyrus, and Peter M. Aronow. 2012. &#x201C;On Equivalences Between Design-Based and Regression-Based Estimators for Random Experiments.&#x201D; <em>Statistics and Probability Letters</em> 82: 365&#x2013;70.</p>
</div>
<div id="ref-R-coin">
<p>Hothorn, Torsten, Henric Winell, Kurt Hornik, Mark A. van de Wiel, and Achim Zeileis. 2021. <em>Coin: Conditional Inference Procedures in a Permutation Test Framework</em>. <a href="http://coin.r-forge.r-project.org">http://coin.r-forge.r-project.org</a>.</p>
</div>
<div id="ref-R-ri2">
<p>&#x2014;&#x2014;&#x2014;. 2022b. <em>Ri2: Randomization Inference for Randomized Experiments</em>. <a href="https://CRAN.R-project.org/package=ri2">https://CRAN.R-project.org/package=ri2</a>.</p>
</div>
<div id="ref-freedman2008randomization">
<p>&#x2014;&#x2014;&#x2014;. 2008b. &#x201C;Randomization Does Not Justify Logistic Regression.&#x201D; <em>Statistical Science</em> 23 (2): 237&#x2013;49.</p>
</div>
<div id="ref-angrist2009mostly">
<p>Angrist, Joshua D, and J&#xF6;rn-Steffen Pischke. 2009. <em>Mostly Harmless Econometrics: An Empiricist&#x2019;s Companion</em>. Princeton university press.</p>
</div>
<div id="ref-rosenbaum2008a">
<p>&#x2014;&#x2014;&#x2014;. 2008. &#x201C;Testing hypotheses in order.&#x201D; <em>Biometrika</em> 95: 248&#x2013;52.</p>
</div>
<div id="ref-freedman2008rae">
<p>Freedman, David A. 2008a. &#x201C;On regression adjustments to experimental data.&#x201D; <em>Advances in Applied Mathematics</em> 40 (2): 180&#x2013;93.</p>
</div>
<div id="ref-rosenbaum:2002a">
<p>Rosenbaum, Paul R. 2002. &#x201C;Covariance Adjustment in Randomized Experiments and Observational Studies.&#x201D; <em>Statistical Science</em> 17 (3): 286&#x2013;327.</p>
</div>
<div id="ref-cochran_methods_1954">
<p>Cochran, William G. 1954. &#x201C;Some Methods for Strengthening the Common &#x3C7; 2 Tests.&#x201D; <em>Biometrics</em> 10 (4): 417.</p>
</div>
<div id="ref-mantel_statistical_1959">
<p>Mantel, N, and W Haenszel. 1959. &#x201C;Statistical Aspects of the Analysis of Data from Retrospective Studies of Disease.&#x201D; <em>Journal of the National Cancer Institute</em> 22: 719&#x2013;48.</p>
</div>
<div id="ref-gerber_field_2012">
<p>Gerber, Alan S., and Donald P. Green. 2012. <em>Field Experiments: Design, Analysis, and Interpretation</em>. New York, NY: W. W. Norton &amp; Company.</p>
</div>
<div id="ref-R-estimatr">
<p>Blair, Graeme, Jasper Cooper, Alexander Coppock, Macartan Humphreys, and Luke Sonnet. 2022. <em>Estimatr: Fast Estimators for Design-Based Inference</em>. <a href="https://CRAN.R-project.org/package=estimatr">https://CRAN.R-project.org/package=estimatr</a>.</p>
</div>
<div id="ref-R-bfe">
<p>Gibbons, Charles E. 2018. <em>Bfe: Estimate the Sample-Weighted Effect as in Gibbons et Al. (2018)</em>.</p>
</div>
<div id="ref-bowers2011mem">
<p>Bowers, Jake. 2011. &#x201C;Making Effects Manifest in Randomized Experiments.&#x201D; In <em>Cambridge Handbook of Experimental Political Science</em>, edited by James N. Druckman, Donald P. Green, James H. Kuklinski, and Arthur Lupia. New York, NY: Cambridge University Press.</p>
</div>
<div id="ref-middleton2015unbiased">
<p>Middleton, Joel A, and Peter M Aronow. 2015. &#x201C;Unbiased Estimation of the Average Treatment Effect in Cluster-Randomized Experiments.&#x201D; <em>Statistics, Politics, and Policy</em> 6 (1&#x2013;2): 39&#x2013;75.</p>
</div>
<div id="ref-hansen_covariate_2008">
<p>Hansen, Ben B., and Jake Bowers. 2008. &#x201C;Covariate Balance in Simple, Stratified and Clustered Comparative Studies.&#x201D; <em>Statistical Science</em> 23 (2): 219&#x2013;36.</p>
</div>
<div id="ref-pustejovsky2019cr">
<p>Pustejovsky, James. 2019. <em>ClubSandwich: Cluster-Robust (Sandwich) Variance Estimators with Small-Sample Corrections</em>. <a href="https://CRAN.R-project.org/package=clubSandwich">https://CRAN.R-project.org/package=clubSandwich</a>.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="randomization-and-design.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="poweranalysis.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook/js/app.min.js"></script>
<script src="libs/gitbook/js/lunr.js"></script>
<script src="libs/gitbook/js/plugin-search.js"></script>
<script src="libs/gitbook/js/plugin-sharing.js"></script>
<script src="libs/gitbook/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook/js/plugin-bookdown.js"></script>
<script src="libs/gitbook/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/gsa-oes/sop/edit/master/Book/04-analysischoices.Rmd",
"text": "Edit"
},
"download": ["OES_SOP.pdf", "OES_SOP.epub"],
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "";
    if (src === "" || src === "true") src = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
