<!DOCTYPE html>
<html>

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>OES Standard Operating Procedures for The Design and Statistical Analysis of Experiments</title>
  <meta name="description" content="These are the current standard operating procedures for statistical analysis of the Office of Evaluation Sciences in the GSA">
  <meta name="generator" content="bookdown &lt;!--bookdown:version--&gt; and GitBook 2.6.7">

  <meta property="og:title" content="OES Standard Operating Procedures for The Design and Statistical Analysis of Experiments">
  <meta property="og:type" content="book">
  
  
  <meta property="og:description" content="These are the current standard operating procedures for statistical analysis of the Office of Evaluation Sciences in the GSA">
  <meta name="github-repo" content="gsa-oes/sop">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="OES Standard Operating Procedures for The Design and Statistical Analysis of Experiments">
  
  <meta name="twitter:description" content="These are the current standard operating procedures for statistical analysis of the Office of Evaluation Sciences in the GSA">
  

<meta name="author" content="Jake Bowers, Ryan T. Moore, Miles Williams, and Bill Schultz">


<meta name="date" content="2024-09-26">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="randomization-choices.html">
<link rel="next" href="poweranalysis.html">
<script src="libs/jquery/jquery.min.js"></script>
<link href="libs/gitbook/css/style.css" rel="stylesheet">
<link href="libs/gitbook/css/plugin-bookdown.css" rel="stylesheet">
<link href="libs/gitbook/css/plugin-highlight.css" rel="stylesheet">
<link href="libs/gitbook/css/plugin-search.css" rel="stylesheet">
<link href="libs/gitbook/css/plugin-fontsettings.css" rel="stylesheet">







<script src="libs/clipboard/clipboard.min.js"></script>
<link href="libs/primer-tooltips/build.css" rel="stylesheet">
<link href="libs/klippy/css/klippy.min.css" rel="stylesheet">
<script src="libs/klippy/js/klippy.min.js"></script>
<script src="libs/kePrint/kePrint.js"></script>
<link href="libs/lightable/lightable.css" rel="stylesheet">

<script>
/* ========================================================================
 * Bootstrap: transition.js v3.3.7
 * http://getbootstrap.com/javascript/#transitions
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */


+function ($) {
  'use strict';

  // CSS TRANSITION SUPPORT (Shoutout: http://www.modernizr.com/)
  // ============================================================

  function transitionEnd() {
    var el = document.createElement('bootstrap')

    var transEndEventNames = {
      WebkitTransition : 'webkitTransitionEnd',
      MozTransition    : 'transitionend',
      OTransition      : 'oTransitionEnd otransitionend',
      transition       : 'transitionend'
    }

    for (var name in transEndEventNames) {
      if (el.style[name] !== undefined) {
        return { end: transEndEventNames[name] }
      }
    }

    return false // explicit for ie8 (  ._.)
  }

  // http://blog.alexmaccaw.com/css-transitions
  $.fn.emulateTransitionEnd = function (duration) {
    var called = false
    var $el = this
    $(this).one('bsTransitionEnd', function () { called = true })
    var callback = function () { if (!called) $($el).trigger($.support.transition.end) }
    setTimeout(callback, duration)
    return this
  }

  $(function () {
    $.support.transition = transitionEnd()

    if (!$.support.transition) return

    $.event.special.bsTransitionEnd = {
      bindType: $.support.transition.end,
      delegateType: $.support.transition.end,
      handle: function (e) {
        if ($(e.target).is(this)) return e.handleObj.handler.apply(this, arguments)
      }
    }
  })

}(jQuery);
</script>
<script>
/* ========================================================================
 * Bootstrap: collapse.js v3.3.7
 * http://getbootstrap.com/javascript/#collapse
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */

/* jshint latedef: false */

+function ($) {
  'use strict';

  // COLLAPSE PUBLIC CLASS DEFINITION
  // ================================

  var Collapse = function (element, options) {
    this.$element      = $(element)
    this.options       = $.extend({}, Collapse.DEFAULTS, options)
    this.$trigger      = $('[data-toggle="collapse"][href="#' + element.id + '"],' +
                           '[data-toggle="collapse"][data-target="#' + element.id + '"]')
    this.transitioning = null

    if (this.options.parent) {
      this.$parent = this.getParent()
    } else {
      this.addAriaAndCollapsedClass(this.$element, this.$trigger)
    }

    if (this.options.toggle) this.toggle()
  }

  Collapse.VERSION  = '3.3.7'

  Collapse.TRANSITION_DURATION = 350

  Collapse.DEFAULTS = {
    toggle: true
  }

  Collapse.prototype.dimension = function () {
    var hasWidth = this.$element.hasClass('width')
    return hasWidth ? 'width' : 'height'
  }

  Collapse.prototype.show = function () {
    if (this.transitioning || this.$element.hasClass('in')) return

    var activesData
    var actives = this.$parent && this.$parent.children('.panel').children('.in, .collapsing')

    if (actives && actives.length) {
      activesData = actives.data('bs.collapse')
      if (activesData && activesData.transitioning) return
    }

    var startEvent = $.Event('show.bs.collapse')
    this.$element.trigger(startEvent)
    if (startEvent.isDefaultPrevented()) return

    if (actives && actives.length) {
      Plugin.call(actives, 'hide')
      activesData || actives.data('bs.collapse', null)
    }

    var dimension = this.dimension()

    this.$element
      .removeClass('collapse')
      .addClass('collapsing')[dimension](0)
      .attr('aria-expanded', true)

    this.$trigger
      .removeClass('collapsed')
      .attr('aria-expanded', true)

    this.transitioning = 1

    var complete = function () {
      this.$element
        .removeClass('collapsing')
        .addClass('collapse in')[dimension]('')
      this.transitioning = 0
      this.$element
        .trigger('shown.bs.collapse')
    }

    if (!$.support.transition) return complete.call(this)

    var scrollSize = $.camelCase(['scroll', dimension].join('-'))

    this.$element
      .one('bsTransitionEnd', $.proxy(complete, this))
      .emulateTransitionEnd(Collapse.TRANSITION_DURATION)[dimension](this.$element[0][scrollSize])
  }

  Collapse.prototype.hide = function () {
    if (this.transitioning || !this.$element.hasClass('in')) return

    var startEvent = $.Event('hide.bs.collapse')
    this.$element.trigger(startEvent)
    if (startEvent.isDefaultPrevented()) return

    var dimension = this.dimension()

    this.$element[dimension](this.$element[dimension]())[0].offsetHeight

    this.$element
      .addClass('collapsing')
      .removeClass('collapse in')
      .attr('aria-expanded', false)

    this.$trigger
      .addClass('collapsed')
      .attr('aria-expanded', false)

    this.transitioning = 1

    var complete = function () {
      this.transitioning = 0
      this.$element
        .removeClass('collapsing')
        .addClass('collapse')
        .trigger('hidden.bs.collapse')
    }

    if (!$.support.transition) return complete.call(this)

    this.$element
      [dimension](0)
      .one('bsTransitionEnd', $.proxy(complete, this))
      .emulateTransitionEnd(Collapse.TRANSITION_DURATION)
  }

  Collapse.prototype.toggle = function () {
    this[this.$element.hasClass('in') ? 'hide' : 'show']()
  }

  Collapse.prototype.getParent = function () {
    return $(this.options.parent)
      .find('[data-toggle="collapse"][data-parent="' + this.options.parent + '"]')
      .each($.proxy(function (i, element) {
        var $element = $(element)
        this.addAriaAndCollapsedClass(getTargetFromTrigger($element), $element)
      }, this))
      .end()
  }

  Collapse.prototype.addAriaAndCollapsedClass = function ($element, $trigger) {
    var isOpen = $element.hasClass('in')

    $element.attr('aria-expanded', isOpen)
    $trigger
      .toggleClass('collapsed', !isOpen)
      .attr('aria-expanded', isOpen)
  }

  function getTargetFromTrigger($trigger) {
    var href
    var target = $trigger.attr('data-target')
      || (href = $trigger.attr('href')) && href.replace(/.*(?=#[^\s]+$)/, '') // strip for ie7

    return $(target)
  }


  // COLLAPSE PLUGIN DEFINITION
  // ==========================

  function Plugin(option) {
    return this.each(function () {
      var $this   = $(this)
      var data    = $this.data('bs.collapse')
      var options = $.extend({}, Collapse.DEFAULTS, $this.data(), typeof option == 'object' && option)

      if (!data && options.toggle && /show|hide/.test(option)) options.toggle = false
      if (!data) $this.data('bs.collapse', (data = new Collapse(this, options)))
      if (typeof option == 'string') data[option]()
    })
  }

  var old = $.fn.collapse

  $.fn.collapse             = Plugin
  $.fn.collapse.Constructor = Collapse


  // COLLAPSE NO CONFLICT
  // ====================

  $.fn.collapse.noConflict = function () {
    $.fn.collapse = old
    return this
  }


  // COLLAPSE DATA-API
  // =================

  $(document).on('click.bs.collapse.data-api', '[data-toggle="collapse"]', function (e) {
    var $this   = $(this)

    if (!$this.attr('data-target')) e.preventDefault()

    var $target = getTargetFromTrigger($this)
    var data    = $target.data('bs.collapse')
    var option  = data ? 'toggle' : $this.data()

    Plugin.call($target, option)
  })

}(jQuery);
</script>
<script>
window.initializeCodeFolding = function(show) {

  // handlers for show-all and hide all
  $("#rmd-show-all-code").click(function() {
    $('div.r-code-collapse').each(function() {
      $(this).collapse('show');
    });
  });
  $("#rmd-hide-all-code").click(function() {
    $('div.r-code-collapse').each(function() {
      $(this).collapse('hide');
    });
  });

  // index for unique code element ids
  var currentIndex = 1;

  // select all R code blocks
  var rCodeBlocks = $('pre.sourceCode, pre.r, pre.cpp, pre.sql, pre.stan, pre.stata, pre.python, pre.bash');
  rCodeBlocks.each(function() {

    // create a collapsable div to wrap the code in
    var div = $('<div class="collapse r-code-collapse"></div>');
    if (show)
      div.addClass('in');
    var id = 'rcode-643E0F36' + currentIndex++;
    div.attr('id', id);
    $(this).before(div);
    $(this).detach().appendTo(div);

    // add a show code button right above
    var showCodeText = $('<span>' + (show ? 'Hide' : 'Code') + '</span>');
    var showCodeButton = $('<button type="button" class="btn btn-default btn-xs code-folding-btn pull-right"></button>');
    showCodeButton.append(showCodeText);
    showCodeButton
        .attr('data-toggle', 'collapse')
        .attr('data-target', '#' + id)
        .attr('aria-expanded', show)
        .attr('aria-controls', id);

    var buttonRow = $('<div class="row"></div>');
    var buttonCol = $('<div class="col-md-12"></div>');

    buttonCol.append(showCodeButton);
    buttonRow.append(buttonCol);

    div.before(buttonRow);

    // update state of button on show/hide
    div.on('hidden.bs.collapse', function () {
      showCodeText.text('Code');
    });
    div.on('show.bs.collapse', function () {
      showCodeText.text('Hide');
    });
  });

}
</script>
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
.row { display: flex; }
.collapse { display: none; }
.in { display:block }
</style>
<script>
$(document).ready(function () {
  window.initializeCodeFolding("show" === "hide");
});
</script>
<script>
function unrolltab(evt, tabName) {
  var i, tabcontent, tablinks;
  tabcontent = document.getElementsByClassName("tabcontent");
  for (i = 0; i < tabcontent.length; i++) {
    tabcontent[i].style.display = "none";
  }
  tablinks = document.getElementsByClassName("tablinks");
  for (i = 0; i < tablinks.length; i++) {
    tablinks[i].className = tablinks[i].className.replace(" active", "");
  }
  document.getElementById(tabName).style.display = "block";
  evt.currentTarget.className += " active";
}
</script>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-RCGKRS9FGR"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag("js", new Date());

gtag("config", "G-RCGKRS9FGR");
</script>
<script>gtag("event", "view_item");</script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css">
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@0.16.3/dist/katex.min.css" data-external="1"></head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">The OES SOP</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Overview</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#purposes-of-this-document"><i class="fa fa-check"></i>Purposes of this document</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#nature-and-limitations-of-this-document"><i class="fa fa-check"></i>Nature and limitations of this document</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#we-mostly-focus-on-randomized-field-experiments."><i class="fa fa-check"></i>We (mostly) focus on randomized field experiments.</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#we-mostly-present-examples-using-r"><i class="fa fa-check"></i>We (mostly) present examples using R</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#structure"><i class="fa fa-check"></i>Structure</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#help-us-improve-our-work"><i class="fa fa-check"></i>Help us improve our work!</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#technical-details"><i class="fa fa-check"></i>Technical details</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="using-tests-to-inform-policy.html"><a href="using-tests-to-inform-policy.html"><i class="fa fa-check"></i><b>1</b> Using tests to inform policy</a></li>
<li class="chapter" data-level="2" data-path="key-design-criteria.html"><a href="key-design-criteria.html"><i class="fa fa-check"></i><b>2</b> Key design criteria</a><ul>
<li class="chapter" data-level="2.1" data-path="key-design-criteria.html"><a href="key-design-criteria.html#high-statistical-power"><i class="fa fa-check"></i><b>2.1</b> High statistical power</a></li>
<li class="chapter" data-level="2.2" data-path="key-design-criteria.html"><a href="key-design-criteria.html#controlled-error-rates"><i class="fa fa-check"></i><b>2.2</b> Controlled error rates</a></li>
<li class="chapter" data-level="2.3" data-path="key-design-criteria.html"><a href="key-design-criteria.html#unbiased-estimators"><i class="fa fa-check"></i><b>2.3</b> Unbiased estimators</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="design-based-inference.html"><a href="design-based-inference.html"><i class="fa fa-check"></i><b>3</b> Design based inference</a><ul>
<li class="chapter" data-level="3.1" data-path="design-based-inference.html"><a href="design-based-inference.html#randinfex"><i class="fa fa-check"></i><b>3.1</b> An example using simulated data</a><ul>
<li class="chapter" data-level="3.1.1" data-path="design-based-inference.html"><a href="design-based-inference.html#randomization-based-standard-errors"><i class="fa fa-check"></i><b>3.1.1</b> Randomization-based standard errors</a></li>
<li class="chapter" data-level="3.1.2" data-path="design-based-inference.html"><a href="design-based-inference.html#randomization-based-confidence-intervals"><i class="fa fa-check"></i><b>3.1.2</b> Randomization-based confidence intervals</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="design-based-inference.html"><a href="design-based-inference.html#summary-what-does-a-design-based-approach-mean-for-policy-evaluation"><i class="fa fa-check"></i><b>3.2</b> Summary: What does a design based approach mean for policy evaluation?</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="randomization-choices.html"><a href="randomization-choices.html"><i class="fa fa-check"></i><b>4</b> Randomization choices</a><ul>
<li class="chapter" data-level="4.1" data-path="randomization-choices.html"><a href="randomization-choices.html#coin-flipping-vs-urn-drawing-randomization"><i class="fa fa-check"></i><b>4.1</b> Coin flipping vs urn-drawing randomization</a></li>
<li class="chapter" data-level="4.2" data-path="randomization-choices.html"><a href="randomization-choices.html#randomization-into-2-or-more-groups"><i class="fa fa-check"></i><b>4.2</b> Randomization into 2 or more groups</a></li>
<li class="chapter" data-level="4.3" data-path="randomization-choices.html"><a href="randomization-choices.html#factorial-designs"><i class="fa fa-check"></i><b>4.3</b> Factorial designs</a></li>
<li class="chapter" data-level="4.4" data-path="randomization-choices.html"><a href="randomization-choices.html#block-random-assignment"><i class="fa fa-check"></i><b>4.4</b> Block random assignment</a><ul>
<li class="chapter" data-level="4.4.1" data-path="randomization-choices.html"><a href="randomization-choices.html#the-benefits-of-blocking"><i class="fa fa-check"></i><b>4.4.1</b> The benefits of blocking</a></li>
<li class="chapter" data-level="4.4.2" data-path="randomization-choices.html"><a href="randomization-choices.html#using-a-few-covariates-to-create-blocks"><i class="fa fa-check"></i><b>4.4.2</b> Using a few covariates to create blocks</a></li>
<li class="chapter" data-level="4.4.3" data-path="randomization-choices.html"><a href="randomization-choices.html#blocking-using-many-covariates"><i class="fa fa-check"></i><b>4.4.3</b> Blocking using many covariates</a></li>
<li class="chapter" data-level="4.4.4" data-path="randomization-choices.html"><a href="randomization-choices.html#disadvantages"><i class="fa fa-check"></i><b>4.4.4</b> Disadvantages</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="randomization-choices.html"><a href="randomization-choices.html#cluster-random-assignment"><i class="fa fa-check"></i><b>4.5</b> Cluster random assignment</a></li>
<li class="chapter" data-level="4.6" data-path="randomization-choices.html"><a href="randomization-choices.html#other-randomized-designs"><i class="fa fa-check"></i><b>4.6</b> Other randomized designs</a></li>
<li class="chapter" data-level="4.7" data-path="randomization-choices.html"><a href="randomization-choices.html#as-if-random-assignment"><i class="fa fa-check"></i><b>4.7</b> As-if random assignment</a></li>
<li class="chapter" data-level="4.8" data-path="randomization-choices.html"><a href="randomization-choices.html#assessing-randomization-balance-testing"><i class="fa fa-check"></i><b>4.8</b> Assessing randomization (balance testing)</a><ul>
<li class="chapter" data-level="4.8.1" data-path="randomization-choices.html"><a href="randomization-choices.html#separate-tests-for-each-covariate"><i class="fa fa-check"></i><b>4.8.1</b> Separate tests for each covariate</a></li>
<li class="chapter" data-level="4.8.2" data-path="randomization-choices.html"><a href="randomization-choices.html#omnibus-tests"><i class="fa fa-check"></i><b>4.8.2</b> Omnibus tests</a></li>
<li class="chapter" data-level="4.8.3" data-path="randomization-choices.html"><a href="randomization-choices.html#summary"><i class="fa fa-check"></i><b>4.8.3</b> Summary</a></li>
<li class="chapter" data-level="4.8.4" data-path="randomization-choices.html"><a href="randomization-choices.html#coded-examples"><i class="fa fa-check"></i><b>4.8.4</b> Coded examples</a></li>
<li class="chapter" data-level="4.8.5" data-path="randomization-choices.html"><a href="randomization-choices.html#what-to-do-with-failed-randomization-assessments"><i class="fa fa-check"></i><b>4.8.5</b> What to do with &#x201C;failed&#x201D; randomization assessments?</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="analysis-choices.html"><a href="analysis-choices.html"><i class="fa fa-check"></i><b>5</b> Analysis choices</a><ul>
<li class="chapter" data-level="5.1" data-path="analysis-choices.html"><a href="analysis-choices.html#completely-randomized-trials"><i class="fa fa-check"></i><b>5.1</b> Completely randomized trials</a><ul>
<li class="chapter" data-level="5.1.1" data-path="analysis-choices.html"><a href="analysis-choices.html#two-arms"><i class="fa fa-check"></i><b>5.1.1</b> Two arms</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="analysis-choices.html"><a href="analysis-choices.html#multiple-tests"><i class="fa fa-check"></i><b>5.2</b> Multiple tests</a><ul>
<li class="chapter" data-level="5.2.1" data-path="analysis-choices.html"><a href="analysis-choices.html#multiple-arms"><i class="fa fa-check"></i><b>5.2.1</b> Multiple arms</a></li>
<li class="chapter" data-level="5.2.2" data-path="analysis-choices.html"><a href="analysis-choices.html#multiple-outcomes"><i class="fa fa-check"></i><b>5.2.2</b> Multiple outcomes</a></li>
<li class="chapter" data-level="5.2.3" data-path="analysis-choices.html"><a href="analysis-choices.html#when-is-this-necessary"><i class="fa fa-check"></i><b>5.2.3</b> When is this necessary?</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="analysis-choices.html"><a href="analysis-choices.html#covariance-adjustment-the-use-of-background-information-to-increase-precision"><i class="fa fa-check"></i><b>5.3</b> Covariance adjustment (the use of background information to increase precision)</a><ul>
<li class="chapter" data-level="5.3.1" data-path="analysis-choices.html"><a href="analysis-choices.html#possible-bias-in-the-least-squares-ate-estimator-with-covariates"><i class="fa fa-check"></i><b>5.3.1</b> Possible bias in the least squares ATE estimator with covariates</a></li>
<li class="chapter" data-level="5.3.2" data-path="analysis-choices.html"><a href="analysis-choices.html#illustrating-the-lin-approach-to-covariance-adjustment"><i class="fa fa-check"></i><b>5.3.2</b> Illustrating the Lin Approach to Covariance Adjustment</a></li>
<li class="chapter" data-level="5.3.3" data-path="analysis-choices.html"><a href="analysis-choices.html#the-rosenbaum-approach-to-covariance-adjustment"><i class="fa fa-check"></i><b>5.3.3</b> The Rosenbaum Approach to Covariance Adjustment</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="analysis-choices.html"><a href="analysis-choices.html#how-to-choose-covariates-for-covariance-adjustment"><i class="fa fa-check"></i><b>5.4</b> How to choose covariates for covariance adjustment?</a></li>
<li class="chapter" data-level="5.5" data-path="analysis-choices.html"><a href="analysis-choices.html#blockrandanalysis"><i class="fa fa-check"></i><b>5.5</b> Block-randomized trials</a><ul>
<li class="chapter" data-level="5.5.1" data-path="analysis-choices.html"><a href="analysis-choices.html#testing-binary-outcomes-under-block-randomization-cochran-mantel-haenszel-cmh-test-for-k-x-2-x-2-tables"><i class="fa fa-check"></i><b>5.5.1</b> Testing binary outcomes under block randomization: Cochran-Mantel-Haenszel (CMH) test for K X 2 X 2 tables</a></li>
<li class="chapter" data-level="5.5.2" data-path="analysis-choices.html"><a href="analysis-choices.html#blockrandate"><i class="fa fa-check"></i><b>5.5.2</b> Estimating an overall average treatment effect</a></li>
</ul></li>
<li class="chapter" data-level="5.6" data-path="analysis-choices.html"><a href="analysis-choices.html#clusterrandanalysis"><i class="fa fa-check"></i><b>5.6</b> Cluster-randomized trials</a><ul>
<li class="chapter" data-level="5.6.1" data-path="analysis-choices.html"><a href="analysis-choices.html#bias-when-cluster-size-is-correlated-with-potential-outcomes"><i class="fa fa-check"></i><b>5.6.1</b> Bias when cluster size is correlated with potential outcomes</a></li>
<li class="chapter" data-level="5.6.2" data-path="analysis-choices.html"><a href="analysis-choices.html#incorrect-false-positive-rates-from-tests-and-confidence-intervals"><i class="fa fa-check"></i><b>5.6.2</b> Incorrect false positive rates from tests and confidence intervals</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="poweranalysis.html"><a href="poweranalysis.html"><i class="fa fa-check"></i><b>6</b> Power analysis</a><ul>
<li class="chapter" data-level="6.1" data-path="poweranalysis.html"><a href="poweranalysis.html#an-example-of-the-off-the-shelf-approach"><i class="fa fa-check"></i><b>6.1</b> An example of the off-the-shelf approach</a></li>
<li class="chapter" data-level="6.2" data-path="poweranalysis.html"><a href="poweranalysis.html#an-example-of-the-simulation-approach"><i class="fa fa-check"></i><b>6.2</b> An example of the simulation approach</a></li>
<li class="chapter" data-level="6.3" data-path="poweranalysis.html"><a href="poweranalysis.html#when-to-use-which-approach"><i class="fa fa-check"></i><b>6.3</b> When to use which approach</a></li>
<li class="chapter" data-level="6.4" data-path="poweranalysis.html"><a href="poweranalysis.html#additional-examples-of-the-simulation-approach"><i class="fa fa-check"></i><b>6.4</b> Additional examples of the simulation approach</a><ul>
<li class="chapter" data-level="6.4.1" data-path="poweranalysis.html"><a href="poweranalysis.html#a-two-by-two-design-with-interaction"><i class="fa fa-check"></i><b>6.4.1</b> A two-by-two design with interaction</a></li>
<li class="chapter" data-level="6.4.2" data-path="poweranalysis.html"><a href="poweranalysis.html#covariate-adjustment-with-the-lin-estimator"><i class="fa fa-check"></i><b>6.4.2</b> Covariate adjustment with the Lin estimator</a></li>
<li class="chapter" data-level="6.4.3" data-path="poweranalysis.html"><a href="poweranalysis.html#incorporating-declaredesign-into-oes-power-tools"><i class="fa fa-check"></i><b>6.4.3</b> Incorporating DeclareDesign into OES Power Tools</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="code-example-index.html"><a href="code-example-index.html"><i class="fa fa-check"></i><b>7</b> <span>Code example index</span></a></li>
<li class="chapter" data-level="8" data-path="methods-topic-index.html"><a href="methods-topic-index.html"><i class="fa fa-check"></i><b>8</b> <span>Methods topic index</span></a></li>
<li class="chapter" data-level="9" data-path="appendix.html"><a href="appendix.html"><i class="fa fa-check"></i><b>9</b> <span>Appendix</span></a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://oes.gsa.gov" target="blank">Published by the OES</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">OES Standard Operating Procedures for The Design and Statistical Analysis of Experiments</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="analysis-choices" class="section level1">
<h1><span class="header-section-number">Chapter 5</span> Analysis choices</h1>
<!-- Adds copy code button -->
<script>
  addClassKlippyToPreCode();
  addClassKlippyTo("pre.r, pre.markdown");
  addKlippy('right', 'top', 'auto', '1', 'Copy code', 'Copied!');
</script>
<!-- Used (and iteratively updated) in the {oes_code_tab} snippets below. -->
<!-- set chapter number and reset count -->
<p>We&#x2019;ve organized our discussion of analysis techniques around a study&#x2019;s randomization design. But there are a few general tactics that we use to ensure that we can make transparent, valid, and statistically precise statements about the results from our evaluations. We&#x2019;ll start this chapter by reviewing those.</p>
<p>First, the nature of the data that we expect to see from a given experiment informs our analysis plans. For example, we may make some choices based on the nature of the outcome&#x2014;a binary outcome, a symmetrically distributed continuous outcome, and a heavily skewed continuous outcome each could each call for different analytical approaches.</p>
<p>Second, we tend to ask three different questions in each of our studies, and we answer them with different statistical procedures:</p>
<ol style="list-style-type: decimal">
<li>Can we <em>detect an effect</em> in our experiment? (We use hypothesis tests to answer this question.)</li>
<li>What is our best guess about the <em>size of the effect</em> of the experiment? (We estimate the average treatment effect of our interventions to answer this question.)</li>
<li><em>How precise</em> is our guess? (We report confidence intervals or standard errors to answer this question.)</li>
</ol>
<p>Finally, in the <a href="https://oes.gsa.gov/methodsdetail/#analysis-plans">Analysis Plans</a> that we post online before receiving outcome data for a project, we try to anticipate many common decisions involved in data analysis&#x2014;how we will treat missing data, how we will rescale, recode, and combine columns of raw data, etc. We touch on some of these topics in more detail below, and will cover others further in the future.</p>
<div id="completely-randomized-trials" class="section level2">
<h2><span class="header-section-number">5.1</span> Completely randomized trials</h2>
<div id="two-arms" class="section level3">
<h3><span class="header-section-number">5.1.1</span> Two arms</h3>
<div id="continuous-outcomes" class="section level4">
<h4><span class="header-section-number">5.1.1.1</span> Continuous outcomes</h4>
<p>In a completely randomized trial where outcomes take on many levels (units
like times, counts of events, dollars, percentages, etc.) we generally assess the <strong>weak null hypothesis</strong> of no average treatment effect across units. We may also (or instead) assess the <strong>sharp null hypothesis</strong> of no effect for any unit. What we call the &#x201C;weak null&#x201D; here corresponds to the null evaluated by default in many software packages (like R and Stata) when implementing procedures like a difference-in-means test or a linear regression. Meanwhile, the sharp null is evaluated when relying on design-based randomization inference. Particularly in smaller samples, tests of the sharp null may be better powered <span class="citation">(Reichardt and Gollob <a href="#ref-reichardt1999justifying">1999</a>)</span>. It may also be possible to justify a hypothesis test of the sharp null in some limited situations where justifying other procedures is more difficult <span class="citation">(Rubin <a href="#ref-rubin1986comment">1986</a>)</span>.<a href="references.html#fn14" class="footnote-ref" id="fnref14"><sup>14</sup></a></p>
<div id="estimating-the-average-treatment-effect-and-testing-the-weak-null-of-no-average-effects" class="section level5">
<h5><span class="header-section-number">5.1.1.1.1</span> Estimating the average treatment effect and testing the weak null of no average effects</h5>
<p>We show the kind of code we use for these purposes here. Below, <code>Y</code> is the outcome variable and <code>Z</code> is an indicator of the assignment to treatment.</p>
<div class="tab">
<button class="tablinks" onclick="unrolltab(event, &apos;ch5R1&apos;)">
R code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Stata1&apos;)">
Stata code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Hide1&apos;)">
Hide
</button>
<div id="ch5R1" class="tabcontent">
<p><br></p>
<pre class="text"><code>## This function comes from the estimatr package
estAndSE1 &lt;- difference_in_means(Y ~ Z,data = dat1)
print(estAndSE1)</code></pre>
</div>
<div id="ch5Stata1" class="tabcontent">
<p><br></p>
<pre class="text"><code>** Similarly to the R code, estimate the difference
** in means assuming unequal variance across treatment groups.
** There isn&apos;t a perfect Stata equivalent providing a
** design-based difference in means estimator.
ttest y, by(z) unequal</code></pre>
</div>
<div id="ch5Hide1" class="tabcontent">

</div>
</div>
<pre><code>Design:  Standard 
  Estimate Std. Error t value  Pr(&gt;|t|) CI Lower CI Upper    DF
Z    4.637      1.039   4.465 8.792e-05    2.524     6.75 33.12</code></pre>
<p>Notice that the standard errors that we use are not the default OLS errors:</p>
<div class="tab">
<button class="tablinks" onclick="unrolltab(event, &apos;ch5R2&apos;)">
R code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Stata2&apos;)">
Stata code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Hide2&apos;)">
Hide
</button>
<div id="ch5R2" class="tabcontent">
<p><br></p>
<pre class="text"><code>estAndSE1OLS &lt;- lm(Y~Z,data=dat1)
summary(estAndSE1OLS)$coef</code></pre>
</div>
<div id="ch5Stata2" class="tabcontent">
<p><br></p>
<pre class="text"><code>reg y z</code></pre>
</div>
<div id="ch5Hide2" class="tabcontent">

</div>
</div>
<pre><code>            Estimate Std. Error t value  Pr(&gt;|t|)
(Intercept)    2.132     0.4465   4.775 6.283e-06
Z              4.637     0.8930   5.193 1.123e-06</code></pre>
<p>The standard errors we prefer, HC2, reflect repeated randomization from a fixed experimental pool (chapter 3). Specifically, <span class="citation">Lin (<a href="#ref-lin_agnostic_2013">2013</a>)</span> and <span class="citation">Samii and Aronow (<a href="#ref-samii_equivalencies_2012">2012</a>)</span> show that the standard error estimator of an unbiased average treatment effect within a &#x201C;finite-sample&#x201D; or design based framework is equivalent to the HC2 standard error. In R, these SEs are produced by default by the <code>estimatr</code> package&#x2019;s function <code>difference_in_means()</code> and <code>lm_robust()</code>. They can also be produced, for instance, using the <code>vcovHC()</code> function from the <code>sandwich</code> package or the <code>lmtest</code> package&#x2019;s <code>coeftest()</code> and <code>coefci()</code> functions. In Stata, when using <code>regress</code>, these can be estimated using the <code>vce(hc2)</code> option (they are not the default used by the <code>robust</code> option). Some other commands offer a similar option; check the help file to see.</p>
<p>Our preference for HC2 errors follows from their design-based justification, but most researchers likely encounter them as one of several methods of correcting OLS standard errors for <em>heteroscedasticity</em>. Essentially, this means that the variance of the regression model&#x2019;s error term is not constant across observations. Classical OLS standard errors assume away heteroscedasticity, which may render them meaningfully inaccurate when heteroscedasticity is present. When using OLS to analyze data from a two-arm randomized trial, heteroscedasticity might appear because the variance of the outcome is different in the treatment and control groups. This is common.</p>
</div>
<div id="testing-the-sharp-null-of-no-effects" class="section level5">
<h5><span class="header-section-number">5.1.1.1.2</span> Testing the sharp null of no effects</h5>
<p>We may assess the sharp null of no effects via treatment permutation as a check on the assumptions underlying the calculations and statistical inferences above (i.e., &#x201C;randomization inference&#x201D;). We could use a <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span>-statistic as our test statistic here to parallel the above tests. But we could also use a rank-based test statistic instead if we were concerned about long-tails (i.e., skew) reducing statistical power. In the interests of simplificity, we can even use treatment effect estimates themselves.</p>
<p>The basic procedure is as follows:</p>
<ul>
<li><p>Estimate the treatment effect of interest using the real treatment indicator: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>&#x3C4;</mi><mo>^</mo></mover><mrow><mi>r</mi><mi>e</mi><mi>a</mi><mi>l</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\hat{\tau}_{real}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">re</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>. As we note, you could use some other statistic here instead, such as a t-statistic or a rank-based statistic.</p></li>
<li><p>Randomly reassign treatment <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span> times, each time following the same assignment procedure used originally. Estimate a treatment effect using each of the simulated re-assignments: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>&#x3C4;</mi><mo>^</mo></mover><mrow><mi>s</mi><mi>i</mi><mi>m</mi><mo separator="true">,</mo><mi>r</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\hat{\tau}_{sim,r}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">im</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>. This yields a distribution of treatment effects under the sharp null (the &#x201C;randomization distribution&#x201D;).</p></li>
<li><p>Compare the treatment effect to its randomization distribution to estimate a (two-sided) p-value: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mn>1</mn><mi>R</mi></mfrac><msubsup><mo>&#x2211;</mo><mrow><mi>r</mi><mo>=</mo><mn>1</mn></mrow><mi>R</mi></msubsup><mn mathvariant="script">1</mn><mo stretchy="false">(</mo><mi mathvariant="normal">&#x2223;</mi><msub><mover accent="true"><mi>&#x3C4;</mi><mo>^</mo></mover><mrow><mi>r</mi><mi>e</mi><mi>a</mi><mi>l</mi></mrow></msub><mi mathvariant="normal">&#x2223;</mi><mo>&#x2264;</mo><mi mathvariant="normal">&#x2223;</mi><msub><mover accent="true"><mi>&#x3C4;</mi><mo>^</mo></mover><mrow><mi>s</mi><mi>i</mi><mi>m</mi><mo separator="true">,</mo><mi>r</mi></mrow></msub><mi mathvariant="normal">&#x2223;</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\frac{1}{R}\sum_{r=1}^{R} \mathcal{1}(|\hat{\tau}_{real}| \leq |\hat{\tau}_{sim,r}|)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.3262em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.00773em;">R</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">&#x2211;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.00773em;">R</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mopen">(</span><span class="mord">&#x2223;</span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">re</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">&#x2223;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&#x2264;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord">&#x2223;</span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">im</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord">&#x2223;</span><span class="mclose">)</span></span></span></span></p></li>
</ul>
<p>Below, we show how to implement this approach using two different R packages and several Stata commands. First, lets look at the <code>coin</code> package <span class="citation">(Hothorn et al. <a href="#ref-R-coin">2021</a>)</span> in R and <code>permute</code> in Stata:</p>
<div class="tab">
<button class="tablinks" onclick="unrolltab(event, &apos;ch5R3&apos;)">
R code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Stata3&apos;)">
Stata code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Hide3&apos;)">
Hide
</button>
<div id="ch5R3" class="tabcontent">
<p><br></p>
<pre class="text"><code>## The coin package
set.seed(12345)

# Compare means
test1coinT &lt;- oneway_test(Y~factor(Z),data=dat1,distribution=approximate(nresample=1000))
test1coinT

# Rank test 1
test1coinR&lt;- oneway_test(rankY~factor(Z),data=dat1,distribution=approximate(nresample=1000))
test1coinR

# Rank test 2
test1coinWR &lt;- wilcox_test(Y~factor(Z),data=dat1,distribution=approximate(nresample=1000))
test1coinWR</code></pre>
</div>
<div id="ch5Stata3" class="tabcontent">
<p><br></p>
<pre class="text"><code>** The permute command
set seed 12345

* Compare means
permute z z = _b[z], reps(1000) nodots: reg y z // OR: permtest2 y, by(z) simulate runs(1000)

* Rank test 1
egen ranky = rank(y)
permute z z = _b[z], reps(1000) nodots: reg ranky z

* Rank test 2
permute z z = r(z), reps(1000) nodots: ranksum y, by(z)
* OR: ranksum y, by(z) exact // exact, not approximate</code></pre>
</div>
<div id="ch5Hide3" class="tabcontent">

</div>
</div>
<pre><code>
    Approximative Two-Sample Fisher-Pitman Permutation Test

data:  Y by factor(Z) (0, 1)
Z = -4.6, p-value &lt;0.001
alternative hypothesis: true mu is not equal to 0


    Approximative Two-Sample Fisher-Pitman Permutation Test

data:  rankY by factor(Z) (0, 1)
Z = -4.9, p-value &lt;0.001
alternative hypothesis: true mu is not equal to 0


    Approximative Wilcoxon-Mann-Whitney Test

data:  Y by factor(Z) (0, 1)
Z = -4.9, p-value &lt;0.001
alternative hypothesis: true mu is not equal to 0</code></pre>
<p>Next, the <code>ri2</code> R package <span class="citation">(Coppock <a href="#ref-R-ri2">2022</a><a href="#ref-R-ri2">b</a>)</span> and <code>ritest</code> in Stata:</p>
<div class="tab">
<button class="tablinks" onclick="unrolltab(event, &apos;ch5R4&apos;)">
R code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Stata4&apos;)">
Stata code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Hide4&apos;)">
Hide
</button>
<div id="ch5R4" class="tabcontent">
<p><br></p>
<pre class="text"><code>## The ri2 package
thedesign1 &lt;- randomizr:::declare_ra(N=ndat1,m=sum(dat1$Z))
test1riT &lt;- conduct_ri(Y~Z,declaration=thedesign1,sharp_hypothesis=0,data=dat1,sims=1000)
tidy(test1riT)
test1riR &lt;- conduct_ri(rankY~Z,declaration=thedesign1,sharp_hypothesis=0,data=dat1,sims=1000)
tidy(test1riR)</code></pre>
</div>
<div id="ch5Stata4" class="tabcontent">
<p><br></p>
<pre class="text"><code>** The ritest command
* ssc install ritest
ritest z z = _b[z], nodots reps(1000): reg y z 
ritest z z = r(z), nodots reps(1000): ranksum y, by(z) </code></pre>
</div>
<div id="ch5Hide4" class="tabcontent">

</div>
</div>
<pre><code>Random assignment procedure: Complete random assignment 
Number of units: 100 
Number of treatment arms: 2 
The possible treatment categories are 0 and 1.
The number of possible random assignments is approximately infinite. 
The probabilities of assignment are constant across units: 
prob_0 prob_1 
  0.75   0.25 
  term estimate p.value
1    Z    4.637       0
  term estimate p.value
1    Z     30.8       0</code></pre>
<p>It is also relatively common for OES evaluations to encounter situations where these canned approaches aren&#x2019;t viable. It is useful to be able to program randomization inference manually. We provide templates for how this could be done in the code below, focusing on complete random assignment. This yields similar results to the canned functions above.</p>
<div class="tab">
<button class="tablinks" onclick="unrolltab(event, &apos;ch5R6&apos;)">
R code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Stata6&apos;)">
Stata code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Hide6&apos;)">
Hide
</button>
<div id="ch5R6" class="tabcontent">
<p><br></p>
<pre class="text"><code>## Define a function to re-randomize a single time
## and return the desired test statistic.
ri_draw &lt;- function() {
  
  ## Using randomizr
  dat1$riZ &lt;- complete_ra(N = nrow(dat1), m = sum(dat1$Z))
  
  ## Or base R
  # dat1$riZ &lt;- sample(dat1$Z, length(dat1$Z), replace = F)
  
  ## Return the test statistic of interest.
  ## Simplest is the difference in means itself.
  return( with(dat1, lm(Y ~ riZ))$coefficients[&quot;riZ&quot;] )
  
}

## We&apos;ll use replicate to repeat this many times.
ri_dist &lt;- replicate(n = 1000, expr = ri_draw(), simplify = T)

## A loop would also work.
# i &lt;- 1
# ri_dist &lt;- matrix(NA, 1000, 1)
# for (i in 1:1000) {
#   ri_dist[i] &lt;- ri_draw()
# }

## Get the real test statistic and calculate the p-value.
# How often do different possible treatment assignments,
# under a sharp null, yield test statistics with a magnitude
# at least as large as our real statistic?
real_stat &lt;- with(dat1, lm(Y ~ Z))$coefficients[&quot;Z&quot;]
ri_p_manual &lt;- mean(abs(ri_dist) &gt;= abs(real_stat))

## Compare to test1riT
ri_p_manual</code></pre>
</div>
<div id="ch5Stata6" class="tabcontent">
<p><br></p>
<pre class="text"><code>** Define a program to re-randomize a single time
** and return a desired test statistic.
capture program drop ri_draw
program define ri_draw, rclass

    ** Using randomizr (Stata version)
    capture drop riZ
    qui sum z
    local zsum = r(sum)
    complete_ra riZ, m(`zsum&apos;)
    
    ** Or manually  
        /*
        gen rand = runiform()
        sort rand
        qui sum z
        gen riZ = 1 in 1/r(sum)
        replace riZ = 0 if missing(riZ)
        drop rand
        */
    
    ** Return the test statistic of interest.
    ** Simplest is the difference in means itself.
    qui reg y riZ
    return scalar riZ = _b[riZ]
    
end

** We&apos;ll use simulate to repeat this many times.
** Nested within preserve/restore to return to our data after.
preserve

    ** Get the real test statistic
    qui reg y z
    local real_stat = _b[z]
    
    ** Perform the simulation itself
    simulate ///
    riZ = r(riZ), ///
    reps(1000): ///
    ri_draw
    
    ** Calculate the p-value.
    * How often do different possible treatment assignments,
    * under a sharp null, yield test statistics with a magnitude
    * at least as large as our real statistic?
    gen equal_or_greater = abs(riZ) &gt;= abs(`real_stat&apos;)
    qui sum equal_or_greater
    local ri_p_manual = r(mean)
    
    ** Compare to output from permute or ritest above
    di `ri_p_manual&apos;

restore</code></pre>
</div>
<div id="ch5Hide6" class="tabcontent">

</div>
</div>
<pre><code>[1] 0</code></pre>
</div>
</div>
<div id="binary-outcomes" class="section level4">
<h4><span class="header-section-number">5.1.1.2</span> Binary outcomes</h4>
<p>We tend to focus on differences in percentage points when we are working with binary outcomes, usually estimated via OLS linear regression. A statement like &#x201C;the effect was a 5 percentage point increase&#x201D; has made communication with partners easier than a discussion in terms of log odds or odds ratios. In addition to difficulties in interpretation and communication, we also avoid logistic regression coefficients because of a problem noticed by <span class="citation">Freedman (<a href="#ref-freedman2008randomization">2008</a><a href="#ref-freedman2008randomization">b</a>)</span> in the case of covariance adjustment or more complicated research designs.</p>
<div id="estimating-the-average-treatment-effect-and-testing-the-weak-null-of-no-average-effects-1" class="section level5">
<h5><span class="header-section-number">5.1.1.2.1</span> Estimating the average treatment effect and testing the weak null of no average effects</h5>
<p>We can estimate effects and produce standard errors for differences of proportions using the same process as above. The average treatment effect estimate here represents the difference in the proportions of positive responses (i.e., <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">Y=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>) between treatment conditions. The standard error is still valid because it is calculated using a procedure justified by the study&#x2019;s design.</p>
<div class="tab">
<button class="tablinks" onclick="unrolltab(event, &apos;ch5R7&apos;)">
R code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Stata7&apos;)">
Stata code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Hide7&apos;)">
Hide
</button>
<div id="ch5R7" class="tabcontent">
<p><br></p>
<pre class="text"><code>## Make some binary outcomes
dat1$u &lt;- runif(ndat1)
dat1$v &lt;- runif(ndat1)
dat1$y0bin &lt;- ifelse(dat1$u&gt;.5, 1, 0) # control potential outcome
dat1$y1bin &lt;- ifelse((dat1$u+dat1$v) &gt;.75, 1, 0) # treated potential outcomes
dat1$Ybin &lt;- with(dat1, Z*y1bin + (1-Z)*y0bin)
truePropDiff &lt;- mean(dat1$y1bin) - mean(dat1$y0bin)

## Estimate and view the difference in proportions
estAndSE2 &lt;- difference_in_means(Ybin~Z,data=dat1)
estAndSE2</code></pre>
</div>
<div id="ch5Stata7" class="tabcontent">
<p><br></p>
<pre class="text"><code>** Make some binary outcomes
gen u = runiform()
gen v = runiform()
gen uv = u + v
gen y0bin = cond(u &gt; 0.5, 1, 0) // control potential outcome
gen y1bin = cond(uv &gt; 0.75, 1, 0) // treated potential outcome
gen ybin = (z * y1bin) + ((1 - z) * y0bin)
qui sum y1bin, meanonly
local y1mean = r(mean)
qui sum y0bin, meanonly
global truePropDiff = `y1mean&apos; - r(mean)

** Estimate and view the difference in proportions
ttest ybin, by(z) unequal</code></pre>
</div>
<div id="ch5Hide7" class="tabcontent">

</div>
</div>
<pre><code>Design:  Standard 
  Estimate Std. Error t value Pr(&gt;|t|) CI Lower CI Upper    DF
Z   0.1067     0.1112   0.959    0.343  -0.1177    0.331 42.84</code></pre>
<p>When we have an experiment that includes a treatment and control group with binary outcomes, and when we are estimating the ATE, the standard error from a difference in proportions test is similar to the design based feasible standard error for an average treatment effect (and therefore similar to HC2 errors). In contrast, classical OLS standard errors with a binary outcome&#x2014;sometimes called a <em>linear probability model</em>&#x2014;will be at least slightly incorrect due to inherent heteroscecdasticity <span class="citation">(Angrist and Pischke <a href="#ref-angrist2009mostly">2009</a>)</span>.</p>
<p>To see this in more detail, consider that difference-in-proportion standard errors are estimated with the following equation:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mover accent="true"><mrow><mi>S</mi><mi>E</mi></mrow><mo stretchy="true">^</mo></mover><mrow><mi>p</mi><mi>r</mi><mi>o</mi><mi>p</mi></mrow></msub><mo>=</mo><msqrt><mrow><mfrac><mrow><msub><mi>p</mi><mn>1</mn></msub><mo stretchy="false">(</mo><mn>1</mn><mo>&#x2212;</mo><msub><mi>p</mi><mn>1</mn></msub><mo stretchy="false">)</mo></mrow><msub><mi>n</mi><mn>1</mn></msub></mfrac><mo>+</mo><mfrac><mrow><msub><mi>p</mi><mn>2</mn></msub><mo stretchy="false">(</mo><mn>1</mn><mo>&#x2212;</mo><msub><mi>p</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow><msub><mi>n</mi><mn>2</mn></msub></mfrac></mrow></msqrt></mrow><annotation encoding="application/x-tex">\widehat{SE}_{prop} = \sqrt{\frac{p_{1}(1-p_{1})}{n_{1}}+\frac{p_{2}(1-p_{2})}{n_{2}}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9833em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">SE</span></span></span><span class="svg-align" style="top:-3.6833em;"><span class="pstrut" style="height:3em;"></span><span style="height:0.3em;"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="0.3em" viewbox="0 0 2364 300" preserveaspectratio="none"><path d="M1181 0h2l1171 176c6 0 10 5 10 11l-2 23c-1 6-5 10
-11 10h-1L1182 67 15 220h-1c-6 0-10-4-11-10l-2-23c-1-6 4-11 10-11z"/></svg></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">ro</span><span class="mord mathnormal mtight">p</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.04em;vertical-align:-1.1106em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.9294em;"><span class="svg-align" style="top:-5em;"><span class="pstrut" style="height:5em;"></span><span class="mord" style="padding-left:1em;"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-3.8894em;"><span class="pstrut" style="height:5em;"></span><span class="hide-tail" style="min-width:1.02em;height:3.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="3.08em" viewbox="0 0 400000 3240" preserveaspectratio="xMinYMin slice"><path d="M473,2793
c339.3,-1799.3,509.3,-2700,510,-2702 l0 -0
c3.3,-7.3,9.3,-11,18,-11 H400000v40H1017.7
s-90.5,478,-276.2,1466c-185.7,988,-279.5,1483,-281.5,1485c-2,6,-10,9,-24,9
c-8,0,-12,-0.7,-12,-2c0,-1.3,-5.3,-32,-16,-92c-50.7,-293.3,-119.7,-693.3,-207,-1200
c0,-1.3,-5.3,8.7,-16,30c-10.7,21.3,-21.3,42.7,-32,64s-16,33,-16,33s-26,-26,-26,-26
s76,-153,76,-153s77,-151,77,-151c0.7,0.7,35.7,202,105,604c67.3,400.7,102,602.7,104,
606zM1001 80h400000v40H1017.7z"/></svg></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:1.1106em;"><span></span></span></span></span></span></span></span></span></span></p>
<p>where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">n_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is the size of the group assigned treatment, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">n_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is the size of the group assigned control, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">p_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is the proportion of &#x201C;successes&#x201D; in the group assigned treatment, and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">p_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>iss the proportion of &#x201C;successes&#x201D; in the group assigned control. The fractions above represent the variance of the proportion in each group.</p>
<p>It&#x2019;s easy to compare this with the feasible standard error equation from chapter 3:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mover accent="true"><mrow><mi>S</mi><mi>E</mi></mrow><mo stretchy="true">^</mo></mover><mrow><mi>f</mi><mi>e</mi><mi>a</mi><mi>s</mi><mi>i</mi><mi>b</mi><mi>l</mi><mi>e</mi></mrow></msub><mo>=</mo><msqrt><mrow><mfrac><mrow><mrow><mi mathvariant="normal">V</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">r</mi></mrow><mo stretchy="false">(</mo><msub><mi>Y</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><msub><mi>n</mi><mn>1</mn></msub></mfrac><mo>+</mo><mfrac><mrow><mrow><mi mathvariant="normal">V</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">r</mi></mrow><mo stretchy="false">(</mo><msub><mi>Y</mi><mi>c</mi></msub><mo stretchy="false">)</mo></mrow><msub><mi>n</mi><mn>2</mn></msub></mfrac></mrow></msqrt></mrow><annotation encoding="application/x-tex">\widehat{SE}_{feasible} = \sqrt{\frac{\mathrm{Var}(Y_{t})}{n_1}+\frac{\mathrm{Var}(Y_{c})}{n_2}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9833em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">SE</span></span></span><span class="svg-align" style="top:-3.6833em;"><span class="pstrut" style="height:3em;"></span><span style="height:0.3em;"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="0.3em" viewbox="0 0 2364 300" preserveaspectratio="none"><path d="M1181 0h2l1171 176c6 0 10 5 10 11l-2 23c-1 6-5 10
-11 10h-1L1182 67 15 220h-1c-6 0-10-4-11-10l-2-23c-1-6 4-11 10-11z"/></svg></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">ib</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.04em;vertical-align:-1.1106em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.9294em;"><span class="svg-align" style="top:-5em;"><span class="pstrut" style="height:5em;"></span><span class="mord" style="padding-left:1em;"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">Var</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">Var</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-3.8894em;"><span class="pstrut" style="height:5em;"></span><span class="hide-tail" style="min-width:1.02em;height:3.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="3.08em" viewbox="0 0 400000 3240" preserveaspectratio="xMinYMin slice"><path d="M473,2793
c339.3,-1799.3,509.3,-2700,510,-2702 l0 -0
c3.3,-7.3,9.3,-11,18,-11 H400000v40H1017.7
s-90.5,478,-276.2,1466c-185.7,988,-279.5,1483,-281.5,1485c-2,6,-10,9,-24,9
c-8,0,-12,-0.7,-12,-2c0,-1.3,-5.3,-32,-16,-92c-50.7,-293.3,-119.7,-693.3,-207,-1200
c0,-1.3,-5.3,8.7,-16,30c-10.7,21.3,-21.3,42.7,-32,64s-16,33,-16,33s-26,-26,-26,-26
s76,-153,76,-153s77,-151,77,-151c0.7,0.7,35.7,202,105,604c67.3,400.7,102,602.7,104,
606zM1001 80h400000v40H1017.7z"/></svg></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:1.1106em;"><span></span></span></span></span></span></span></span></span></span></p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">Y_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is the vector of observed outcomes under control, and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">Y_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is the vector of observed outcomes under treatment. This equation indicates that we use the observed variances in each treatment group to estimate the feasible design based standard error for an average treatment effect. The code below compares the various standard error estimators discussed here (we refer to the design based SEs as Neyman SEs).</p>
<div class="tab">
<button class="tablinks" onclick="unrolltab(event, &apos;ch5R8&apos;)">
R code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Stata8&apos;)">
Stata code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Hide8&apos;)">
Hide
</button>
<div id="ch5R8" class="tabcontent">
<p><br></p>
<pre class="text"><code>nt &lt;- sum(dat1$Z)
nc &lt;- sum(1-dat1$Z)

## Find SE for difference of proportions.
p1 &lt;- mean(dat1$Ybin[dat1$Z==1])
p0 &lt;- mean(dat1$Ybin[dat1$Z==0])
frac1 &lt;- (p1*(1-p1))/nt
frac0 &lt;- (p0*(1-p0))/nc
se_prop &lt;- round(sqrt(frac1 + frac0), 4)

## Find Neyman SE
varc_s &lt;- var(dat1$Ybin[dat1$Z==0])
vart_s &lt;- var(dat1$Ybin[dat1$Z==1])
se_neyman &lt;- round(sqrt((vart_s/nt) + (varc_s/nc)), 4)

## Find OLS SE
simpOLS &lt;- lm(Ybin~Z,dat1)
se_ols &lt;- round(coef(summary(simpOLS))[&quot;Z&quot;, &quot;Std. Error&quot;], 2)

## Find Neyman SE (which are the HC2 SEs)
se_neyman2 &lt;- coeftest(simpOLS,vcov = vcovHC(simpOLS,type=&quot;HC2&quot;))[2,2]
se_neyman3 &lt;- estAndSE2$std.error

## Show SEs
se_compare &lt;- as.data.frame(cbind(se_prop, se_neyman, se_neyman2, se_neyman3, se_ols))
rownames(se_compare) &lt;- &quot;SE(ATE)&quot;
colnames(se_compare) &lt;- c(&quot;diff in prop&quot;, &quot;neyman1&quot;,&quot;neyman2&quot;,&quot;neyman3&quot;, &quot;ols&quot;)
print(se_compare)</code></pre>
</div>
<div id="ch5Stata8" class="tabcontent">
<p><br></p>
<pre class="text"><code>qui sum z
global nt = r(sum)
tempvar oneminus
gen `oneminus&apos; = 1 - z
qui sum `oneminus&apos;
global nc = r(sum)

** Find SE for difference of proportions.
qui ttest ybin, by(z)
local p1 = r(mu_2)
local p0 = r(mu_2)
local se1 = (`p1&apos; * (1 - `p1&apos;))/$nt
local se0 = (`p0&apos; * (1 - `p0&apos;))/$nc
global se_prop = round(sqrt(`se1&apos; + `se0&apos;), 0.0001)
local se_list $se_prop // Initialize a running list; used in the matrix below

** Find Neyman SE
qui sum ybin if z == 0
local varc_s = r(sd) * r(sd)
qui sum ybin if z == 1
local vart_s = r(sd) * r(sd)
global se_neyman = round(sqrt((`vart_s&apos;/$nt) + (`varc_s&apos;/$nc)), 0.0001)
local se_list `se_list&apos; $se_neyman

** Find OLS SE
qui reg ybin z
global se_ols = round(_se[z], 0.0001) // See also: r(table) (return list) or e(V) (ereturn list)
local se_list `se_list&apos; $se_ols

** Find Neyman SE (which are the HC2 SEs)
qui reg ybin z, vce(hc2)
global se_neyman2 = round(_se[z], 0.0001) 
qui ttest ybin, by(z) unequal // See: return list
global se_neyman3 = round(r(se), 0.0001)
local se_list `se_list&apos; $se_neyman2 $se_neyman3

** Show SEs
matrix se_compare = J(1, 5, .)
matrix colnames se_compare = &quot;diff in prop&quot; &quot;neyman1&quot; &quot;ols&quot; &quot;neyman2&quot; &quot;neyman3&quot;
local i = 0
foreach l of local se_list {
    local ++i
    matrix se_compare[1, `i&apos;] = `l&apos;
}
matrix list se_compare</code></pre>
</div>
<div id="ch5Hide8" class="tabcontent">

</div>
</div>
<pre><code>        diff in prop neyman1 neyman2 neyman3  ols
SE(ATE)       0.1094  0.1112  0.1112  0.1112 0.11</code></pre>
</div>
<div id="testing-the-sharp-null-of-no-effects-1" class="section level5">
<h5><span class="header-section-number">5.1.1.2.2</span> Testing the sharp null of no effects</h5>
<p>With a binary treatment and a binary outcome, we could test hypothesis that outcomes are totally independent of treatment assignment using what is called <em>Fisher&#x2019;s exact test</em>. We can also use the permutation-based approaches above to avoid relying on asymptotic (large-sample) assumptions. Below we show how Fisher&#x2019;s exact test, the Exact Cochran-Mantel-Haenszel test, and the Exact <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>&#x3C7;</mi></mrow><annotation encoding="application/x-tex">\chi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">&#x3C7;</span></span></span></span>-squared test produce the same answers.</p>
<div class="tab">
<button class="tablinks" onclick="unrolltab(event, &apos;ch5R9&apos;)">
R code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Stata9&apos;)">
Stata code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Hide9&apos;)">
Hide
</button>
<div id="ch5R9" class="tabcontent">
<p><br></p>
<pre class="text"><code>test2fisher &lt;- fisher.test(x=dat1$Z,y=dat1$Ybin)
print(test2fisher)
test2chisq &lt;- chisq_test(factor(Ybin)~factor(Z),data=dat1,distribution=exact())
print(test2chisq)
test2cmh &lt;- cmh_test(factor(Ybin)~factor(Z),data=dat1,distribution=exact())
print(test2cmh)</code></pre>
</div>
<div id="ch5Stata9" class="tabcontent">
<p><br></p>
<pre class="text"><code>tabulate z ybin, exact
tabulate z ybin, chi2
* search emh
emh z ybin</code></pre>
</div>
<div id="ch5Hide9" class="tabcontent">

</div>
</div>
<pre><code>
    Fisher&apos;s Exact Test for Count Data

data:  dat1$Z and dat1$Ybin
p-value = 0.5
alternative hypothesis: true odds ratio is not equal to 1
95 percent confidence interval:
 0.5586 4.7680
sample estimates:
odds ratio 
     1.574 


    Exact Pearson Chi-Squared Test

data:  factor(Ybin) by factor(Z) (0, 1)
chi-squared = 0.89, p-value = 0.5


    Exact Generalized Cochran-Mantel-Haenszel Test

data:  factor(Ybin) by factor(Z) (0, 1)
chi-squared = 0.88, p-value = 0.5</code></pre>
<p>A difference-in-proportions test can also be performed directly (rather than relying on OLS to approximate this). In that case, the null hypothesis is tested while using a binomial distribution (rather than a Normal distribution) to approximate the underlying randomization distribution. In reasonably-sized samples, both approximations perform well.</p>
<div class="tab">
<button class="tablinks" onclick="unrolltab(event, &apos;ch5R10&apos;)">
R code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Stata10&apos;)">
Stata code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Hide10&apos;)">
Hide
</button>
<div id="ch5R10" class="tabcontent">
<p><br></p>
<pre class="text"><code>mat &lt;- with(dat1,table(Z,Ybin))
matpt &lt;- prop.test(mat[,2:1])
matpt</code></pre>
</div>
<div id="ch5Stata10" class="tabcontent">
<p><br></p>
<pre class="text"><code>prtest ybin, by(z)</code></pre>
</div>
<div id="ch5Hide10" class="tabcontent">

</div>
</div>
<pre><code>
    2-sample test for equality of proportions with continuity correction

data:  mat[, 2:1]
X-squared = 0.5, df = 1, p-value = 0.5
alternative hypothesis: two.sided
95 percent confidence interval:
 -0.3477  0.1344
sample estimates:
prop 1 prop 2 
0.5733 0.6800 </code></pre>
</div>
</div>
</div>
</div>
<div id="multiple-tests" class="section level2">
<h2><span class="header-section-number">5.2</span> Multiple tests</h2>
<div id="multiple-arms" class="section level3">
<h3><span class="header-section-number">5.2.1</span> Multiple arms</h3>
<p>Multiple treatment arms can be analyzed as above, except that we now have
more than one comparison between a treated group and a control group. Such studies raise both substantive and statistical questions about multiple
testing (or &#x201C;multiple comparisons&#x201D;). For example, the <code>difference_in_means</code>
function asks which average treatment effect it should estimate, and it
only presents one comparison at a time. We <em>could</em> compare the treatment <code>T2</code>
with the baseline outcome of <code>T1</code>. But we <em>could also</em> compare both of <code>T2</code> and <code>T3</code> with <code>T1</code> at the same time, as in the second set of results (<code>lm_robust</code> implements the same standard errors as <code>difference_in_means</code>, but allows for more flexible model specification).</p>
<div class="tab">
<button class="tablinks" onclick="unrolltab(event, &apos;ch5R11&apos;)">
R code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Stata11&apos;)">
Stata code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Hide11&apos;)">
Hide
</button>
<div id="ch5R11" class="tabcontent">
<p><br></p>
<pre class="text"><code>## Comparing only conditions 1 and 2
estAndSE3 &lt;- difference_in_means(Y~Z4arms,data=dat1,condition1=&quot;T1&quot;,condition2=&quot;T2&quot;)
print(estAndSE3)

## Compare each other arm to T1
estAndSE3multarms &lt;- lm_robust(Y~Z4arms,data=dat1)
print(estAndSE3multarms)</code></pre>
</div>
<div id="ch5Stata11" class="tabcontent">
<p><br></p>
<pre class="text"><code>** Comparing only conditions 1 and 2
ttest y if inlist(z4arms, &quot;T1&quot;, &quot;T2&quot;), by(z4arms) unequal

** Compare each other arm to T1
encode z4arms, gen(z4num)
reg y ib1.z4num, vce(hc2) // Set 1 as the reference category</code></pre>
</div>
<div id="ch5Hide11" class="tabcontent">

</div>
</div>
<pre><code>Design:  Standard 
         Estimate Std. Error t value Pr(&gt;|t|) CI Lower CI Upper    DF
Z4armsT2   0.7329      1.298  0.5647   0.5749   -1.877    3.343 47.67
            Estimate Std. Error t value Pr(&gt;|t|) CI Lower CI Upper DF
(Intercept)   2.5541     0.8786  2.9070 0.004532   0.8101    4.298 96
Z4armsT2      0.7329     1.2979  0.5647 0.573593  -1.8433    3.309 96
Z4armsT3      0.1798     1.1582  0.1552 0.876956  -2.1192    2.479 96
Z4armsT4      2.0372     1.2353  1.6491 0.102393  -0.4149    4.489 96</code></pre>
<p>In this case, we could make <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mo stretchy="false">(</mo><mn>4</mn><mo>&#xD7;</mo><mn>4</mn><mo stretchy="false">)</mo><mo>&#x2212;</mo><mn>4</mn><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mn>2</mn><mo stretchy="false">)</mo><mo>=</mo><mn>6</mn></mrow><annotation encoding="application/x-tex">((4 \times 4)-4)/2)=6</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">((</span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#xD7;</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">4</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">4</span><span class="mclose">)</span><span class="mord">/2</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">6</span></span></span></span> different possible comparisons between pairs of treatment groups. Consider that if there were really no effect of any treatment, and if we chose to reject the null across treatments at the standard significance threshold of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>&#x3B1;</mi><mo>=</mo><mi mathvariant="normal">.</mi><mn>05</mn></mrow><annotation encoding="application/x-tex">\alpha=.05</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">&#x3B1;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">.05</span></span></span></span>, we would incorrectly claim that there was at least one effect <em>more than 5% of the time</em>. <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>&#x2212;</mo><mo stretchy="false">(</mo><mn>1</mn><mo>&#x2212;</mo><mi mathvariant="normal">.</mi><mn>05</mn><msup><mo stretchy="false">)</mo><mn>6</mn></msup><mo>=</mo><mi mathvariant="normal">.</mi><mn>27</mn></mrow><annotation encoding="application/x-tex">1 - ( 1 - .05)^6 = .27</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord">.05</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">6</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">.27</span></span></span></span>, or 27% of the time, we would make a false positive error, claiming an effect existed when it did not.</p>
<p>Two points are worth emphasizing. First, the &#x201C;family-wise error rate&#x201D; (FWER) will differ from the individual error rate of any single test. In short, performing multiple tests to draw a conclusion <em>about a single underlying hypothesis</em> increases our chances of incorrectly rejecting a true null at least once. Suppose that we calculated two p-values and compared each to the conventional significance level <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>&#x3B1;</mi><mo>=</mo><mn>0.05</mn></mrow><annotation encoding="application/x-tex">\alpha = 0.05</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">&#x3B1;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.05</span></span></span></span>. The probability of retaining (failing to reject) both hypotheses is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>1</mn><mo>&#x2212;</mo><mi>&#x3B1;</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>=</mo><mi mathvariant="normal">.</mi><mn>9025</mn></mrow><annotation encoding="application/x-tex">(1-\alpha)^2 = .9025</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">&#x3B1;</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">.9025</span></span></span></span> and the probability of rejecting at least one of these hypotheses is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>&#x2212;</mo><mo stretchy="false">(</mo><mn>1</mn><mo>&#x2212;</mo><mi>&#x3B1;</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>=</mo><mi mathvariant="normal">.</mi><mn>0975</mn></mrow><annotation encoding="application/x-tex">1-(1-\alpha)^2 = .0975</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">&#x3B1;</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">.0975</span></span></span></span>&#x2014;almost double our intended significance threshold of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>&#x3B1;</mi><mo>=</mo><mn>0.05</mn></mrow><annotation encoding="application/x-tex">\alpha = 0.05</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">&#x3B1;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.05</span></span></span></span> across tests.</p>
<p>Second, multiple tests will often be correlated, and optimal corrections for multiple testing incorporate information about these relationships. Importantly, accounting for this correlation <em>will penalize multiple testing less</em> than an adjustment procedure developed under an assumption that tests are uncorrelated. When we say that tests are &#x201C;correlated,&#x201D; we mean that there is some relationship between the test statistics (e.g., a student&#x2019;s t-statistic, or a <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>&#x3C7;</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\chi^{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0085em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">&#x3C7;</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span> statistic) used to perform statistical inference. In other words, the test statistics are jointly distributed&#x2014;when one test statistic is higher, the other will tend to be higher as well.<a href="references.html#fn15" class="footnote-ref" id="fnref15"><sup>15</sup></a></p>
<p>Our default procedure for evaluating multi-arm trials is as follows:</p>
<ul>
<li><p>First, decide on an omnibus <strong>confirmatory</strong> comparison for the entire evaluation: say, control/status quo <em>versus</em> receiving any version of the treatment. Such a test would likely have more statistical power than a test that evaluates each arm separately, and would also have a correctly controlled false positive rate. This would then serve as the primary finding we report.</p></li>
<li><p>Second, perform the rest of the comparisons as <strong>exploratory</strong> analyses without multiple testing adjustment&#x2014;i.e., as analyses that may inform future projects and suggest where we might be seeing more or less of an effect, but which cannot serve as a foundation for policy conclusions on their own.</p></li>
<li><p>Alternatively, if we do want to make multiple confirmatory comparisons, we need to adjust their collective false positive rate.<a href="references.html#fn16" class="footnote-ref" id="fnref16"><sup>16</sup></a> The most appropriate method varies. Options include: canned procedures like Holm-Bonferroni adjustment (which do not account for correlations between tests); the Tukey HSD procedure for pairwise comparisons of multiple treatment arms; simulations to calculate a significance threshold that properly controls the collective error rate;<a href="references.html#fn17" class="footnote-ref" id="fnref17"><sup>17</sup></a> or performing the tests in a specific, theory-informed order to protect the familywise error rate <span class="citation">(Rosenbaum <a href="#ref-rosenbaum2008a">2008</a>)</span>.</p></li>
</ul>
<div id="adjusting-for-multiple-comparisons" class="section level4">
<h4><span class="header-section-number">5.2.1.1</span> Adjusting for multiple comparisons</h4>
<p>We review some of the adjustment options listed above in more detail, with coded examples.</p>
<p>First, if we want to rely on relatively simple procedures that only require the p-values themselves (i.e., not the underlying data), we might hold the familywise error rate at <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>&#x3B1;</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">&#x3B1;</span></span></span></span> through either a single step correction (e.g.&#xA0;<a href="https://en.wikipedia.org/wiki/Bonferroni_correction">Bonferroni</a>) or a stepwise correction (such as <a href="https://en.wikipedia.org/wiki/Holm%E2%80%93Bonferroni_method">Holm-Bonferroni</a>). We could also use a procedure that controls the false discovery rate instead (e.g., the <a href="https://en.wikipedia.org/wiki/False_discovery_rate#Benjamini.E2.80.93Hochberg_procedure">Benjamini-Hochberg correction</a>). These adjustments are derived assuming the included tests are uncorrelated. It is still valid to apply them to correlated tests, they simply may be too conservative (i.e., they may be suboptimal in terms of power). Our default practice when dealing with multiple uncorrelated tests is to apply the Holm-Bonferroni correction. For more, see EGAP&#x2019;s <a href="https://egap.org/resource/10-things-to-know-about-multiple-comparisons/">10 Things you need to know about multiple comparisons</a>.</p>
<div class="tab">
<button class="tablinks" onclick="unrolltab(event, &apos;ch5R12&apos;)">
R code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Stata12&apos;)">
Stata code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Hide12&apos;)">
Hide
</button>
<div id="ch5R12" class="tabcontent">
<p><br></p>
<pre class="text"><code>## Get p-values but exclude intercept
pvals &lt;- summary(estAndSE3multarms)$coef[2:4,4]

## Illustrate different corrections (or lack thereof).
## Many of these corrections can be applied either as
## p-value adjustments, or by constructing alternative
## significance thresholds. We focus on p-value adjustments:

# None
round(p.adjust(pvals, &quot;none&quot;), 3)

# Bonferroni
round(p.adjust(pvals, &quot;bonferroni&quot;), 3)

# Holm
round(p.adjust(pvals, &quot;holm&quot;), 3)

# Hochberg
round(p.adjust(pvals, &quot;hochberg&quot;), 3) # FDR instead of FWER</code></pre>
</div>
<div id="ch5Stata12" class="tabcontent">
<p><br></p>
<pre class="text"><code>** Get p-values but exclude intercept
* See also: search parmest
matrix pvals = r(table)[&quot;pvalue&quot;, 2..4] // save in a matrix
matrix pvalst = pvals&apos; // transpose
svmat pvalst, names(col) // add matrix as data in memory

** Illustrate different corrections (or lack thereof).
** Many of these corrections can be applied either as
** p-value adjustments, or by constructing alternative
** significance thresholds. We focus on p-value adjustments:

* None
replace pvalue = round(pvalue, 0.0001)
list pvalue if !missing(pvalue)

* Bonferroni
* ssc install qqvalue
qqvalue pvalue if !missing(pvalue), method(bonferroni) qvalue(adj_p_bonf)
replace adj_p_bonf = round(adj_p_bonf, 0.0001)
list adj_p_bonf if !missing(pvalue)

* Holm
qqvalue pvalue if !missing(pvalue), method(holm) qvalue(adj_p_holm)
replace adj_p_holm = round(adj_p_holm, 0.0001)
list adj_p_holm if !missing(pvalue)

* Hochberg
qqvalue pvalue if !missing(pvalue), method(hochberg) qvalue(adj_p_hoch)
replace adj_p_hoch = round(adj_p_hoch, 0.0001)
list adj_p_hoch if !missing(pvalue) // FDR instead of FWER</code></pre>
</div>
<div id="ch5Hide12" class="tabcontent">

</div>
</div>
<pre><code>[1] &quot;None&quot;
Z4armsT2 Z4armsT3 Z4armsT4 
   0.574    0.877    0.102 
[1] &quot;Bonferroni&quot;
Z4armsT2 Z4armsT3 Z4armsT4 
   1.000    1.000    0.307 
[1] &quot;Holm&quot;
Z4armsT2 Z4armsT3 Z4armsT4 
   1.000    1.000    0.307 
[1] &quot;Hochberg&quot;
Z4armsT2 Z4armsT3 Z4armsT4 
   0.877    0.877    0.307 </code></pre>
<p>Notice that simply adjusting <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span>-values from this linear model ignores the fact that we may be interested in other pairwise comparisons, such as the difference in effects between receiving <code>T3</code> vs <code>T4</code>. And as already emphasized, we could be leaving meaningful statistical power &#x201C;on the table&#x201D; by applying procedures that ignore correlations between our test statistics.</p>
<p>A different option when dealing with multiple comparisons is to implement a <a href="https://en.wikipedia.org/wiki/Tukey%27s_range_test">Tukey Honestly Signficant Differences (HSD) test</a>. The Tukey HSD test (sometimes called a Tukey range test or just a
Tukey test) calculates multiple-comparison-adjusted <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span>-values and simultaneous confidence intervals <em>for all pairwise comparisons</em> in a model, while taking into account possible correlations between test statistics. It is similar to a two-sample t-test, but with built in adjustment for multiple comparisons. The test statistic for any comparison between two equally-sized groups <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span> is:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>t</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mfrac><mrow><mover accent="true"><msub><mi>y</mi><mi>i</mi></msub><mo>&#x2C9;</mo></mover><mo>&#x2212;</mo><mover accent="true"><msub><mi>y</mi><mi>j</mi></msub><mo>&#x2C9;</mo></mover></mrow><mrow><mi>s</mi><msqrt><mfrac><mn>2</mn><mi>n</mi></mfrac></msqrt></mrow></mfrac></mrow><annotation encoding="application/x-tex">t_{ij} = \frac{\bar{y_i}-\bar{y_j}}{s\sqrt{\frac{2}{n}}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9012em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.9903em;vertical-align:-1.73em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.2603em;"><span style="top:-2.11em;"><span class="pstrut" style="height:3.2351em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.2351em;"><span class="svg-align" style="top:-3.8em;"><span class="pstrut" style="height:3.8em;"></span><span class="mord" style="padding-left:1em;"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-3.1951em;"><span class="pstrut" style="height:3.8em;"></span><span class="hide-tail" style="min-width:1.02em;height:1.88em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.88em" viewbox="0 0 400000 1944" preserveaspectratio="xMinYMin slice"><path d="M983 90
l0 -0
c4,-6.7,10,-10,18,-10 H400000v40
H1013.1s-83.4,268,-264.1,840c-180.7,572,-277,876.3,-289,913c-4.7,4.7,-12.7,7,-24,7
s-12,0,-12,0c-1.3,-3.3,-3.7,-11.7,-7,-25c-35.3,-125.3,-106.7,-373.3,-214,-744
c-10,12,-21,25,-33,39s-32,39,-32,39c-6,-5.3,-15,-14,-27,-26s25,-30,25,-30
c26.7,-32.7,52,-63,76,-91s52,-60,52,-60s208,722,208,722
c56,-175.3,126.3,-397.3,211,-666c84.7,-268.7,153.8,-488.2,207.5,-658.5
c53.7,-170.3,84.5,-266.8,92.5,-289.5z
M1001 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.6049em;"><span></span></span></span></span></span></span></span><span style="top:-3.4651em;"><span class="pstrut" style="height:3.2351em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.9121em;"><span class="pstrut" style="height:3.2351em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">&#x2C9;</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">&#x2C9;</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:1.73em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><msub><mi>y</mi><mi>i</mi></msub><mo>&#x2C9;</mo></mover></mrow><annotation encoding="application/x-tex">\bar{y_i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7622em;vertical-align:-0.1944em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">&#x2C9;</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><msub><mi>y</mi><mi>j</mi></msub><mo>&#x2C9;</mo></mover></mrow><annotation encoding="application/x-tex">\bar{y_j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8539em;vertical-align:-0.2861em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">&#x2C9;</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span> are the means in groups <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> and
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span>, respectively. <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">s</span></span></span></span> is the pooled standard deviation of the outcome, and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> is the common sample size. A critical value is then chosen for <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">t_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9012em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> given the desired significance level, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>&#x3B1;</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">&#x3B1;</span></span></span></span>, the number of groups being compared, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span>, and the degrees of freedom, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>&#x2212;</mo><mi>k</mi></mrow><annotation encoding="application/x-tex">n-k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span>. We&#x2019;ll represent this critical value with <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mrow><mi>&#x3B1;</mi><mo separator="true">,</mo><mi>k</mi><mo separator="true">,</mo><mi>n</mi></mrow></msub></mrow><annotation encoding="application/x-tex">t_{\alpha,k,n}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9012em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.0037em;">&#x3B1;</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>.</p>
<p>The confidence interval for any difference between equally-sized groups is then:<a href="references.html#fn18" class="footnote-ref" id="fnref18"><sup>18</sup></a></p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo fence="true">[</mo><mover accent="true"><msub><mi>y</mi><mi>i</mi></msub><mo>&#x2C9;</mo></mover><mo>&#x2212;</mo><mover accent="true"><msub><mi>y</mi><mi>j</mi></msub><mo>&#x2C9;</mo></mover><mo>&#x2212;</mo><msub><mi>t</mi><mrow><mi>&#x3B1;</mi><mo separator="true">,</mo><mi>k</mi><mo separator="true">,</mo><mi>n</mi></mrow></msub><mi>s</mi><msqrt><mfrac><mn>2</mn><mi>n</mi></mfrac></msqrt><mspace width="0.5691em"></mspace><mo separator="true">,</mo><mspace width="0.5691em"></mspace><mover accent="true"><msub><mi>y</mi><mi>i</mi></msub><mo>&#x2C9;</mo></mover><mo>&#x2212;</mo><mover accent="true"><msub><mi>y</mi><mi>j</mi></msub><mo>&#x2C9;</mo></mover><mo>+</mo><msub><mi>t</mi><mrow><mi>&#x3B1;</mi><mo separator="true">,</mo><mi>k</mi><mo separator="true">,</mo><mi>n</mi></mrow></msub><mi>s</mi><msqrt><mfrac><mn>2</mn><mi>n</mi></mfrac></msqrt><mo fence="true">]</mo></mrow><annotation encoding="application/x-tex">\left[\bar{y_i}-\bar{y_j}-t_{\alpha,k,n}s\sqrt{\frac{2}{n}}\hspace{2mm},\hspace{2mm} \bar{y_i}-\bar{y_j}+t_{\alpha,k,n}s\sqrt{\frac{2}{n}}\right]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">[</span></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">&#x2C9;</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">&#x2C9;</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.0037em;">&#x3B1;</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord mathnormal">s</span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6516em;"><span class="svg-align" style="top:-4.4em;"><span class="pstrut" style="height:4.4em;"></span><span class="mord" style="padding-left:1em;"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">n</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-3.6116em;"><span class="pstrut" style="height:4.4em;"></span><span class="hide-tail" style="min-width:1.02em;height:2.48em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="2.48em" viewbox="0 0 400000 2592" preserveaspectratio="xMinYMin slice"><path d="M424,2478
c-1.3,-0.7,-38.5,-172,-111.5,-514c-73,-342,-109.8,-513.3,-110.5,-514
c0,-2,-10.7,14.3,-32,49c-4.7,7.3,-9.8,15.7,-15.5,25c-5.7,9.3,-9.8,16,-12.5,20
s-5,7,-5,7c-4,-3.3,-8.3,-7.7,-13,-13s-13,-13,-13,-13s76,-122,76,-122s77,-121,77,-121
s209,968,209,968c0,-2,84.7,-361.7,254,-1079c169.3,-717.3,254.7,-1077.7,256,-1081
l0 -0c4,-6.7,10,-10,18,-10 H400000
v40H1014.6
s-87.3,378.7,-272.6,1166c-185.3,787.3,-279.3,1182.3,-282,1185
c-2,6,-10,9,-24,9
c-8,0,-12,-0.7,-12,-2z M1001 80
h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.7884em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.5691em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.5691em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">&#x2C9;</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">&#x2C9;</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.0037em;">&#x3B1;</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord mathnormal">s</span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6516em;"><span class="svg-align" style="top:-4.4em;"><span class="pstrut" style="height:4.4em;"></span><span class="mord" style="padding-left:1em;"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">n</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-3.6116em;"><span class="pstrut" style="height:4.4em;"></span><span class="hide-tail" style="min-width:1.02em;height:2.48em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="2.48em" viewbox="0 0 400000 2592" preserveaspectratio="xMinYMin slice"><path d="M424,2478
c-1.3,-0.7,-38.5,-172,-111.5,-514c-73,-342,-109.8,-513.3,-110.5,-514
c0,-2,-10.7,14.3,-32,49c-4.7,7.3,-9.8,15.7,-15.5,25c-5.7,9.3,-9.8,16,-12.5,20
s-5,7,-5,7c-4,-3.3,-8.3,-7.7,-13,-13s-13,-13,-13,-13s76,-122,76,-122s77,-121,77,-121
s209,968,209,968c0,-2,84.7,-361.7,254,-1079c169.3,-717.3,254.7,-1077.7,256,-1081
l0 -0c4,-6.7,10,-10,18,-10 H400000
v40H1014.6
s-87.3,378.7,-272.6,1166c-185.3,787.3,-279.3,1182.3,-282,1185
c-2,6,-10,9,-24,9
c-8,0,-12,-0.7,-12,-2z M1001 80
h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.7884em;"><span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size4">]</span></span></span></span></span></span></span></p>
<p>We present an R implementation of the Tukey HSD test using the <code>glht()</code> function from the <code>multcomp</code> package, which offers more flexiblity than the
<code>TukeyHSD</code> in the base <code>stats</code> package (at the price of a slightly more complicated syntax). We also illustrate a few options in Stata. But to perform this post-hoc test, we first need to fit an applicable model.</p>
<div class="tab">
<button class="tablinks" onclick="unrolltab(event, &apos;ch5R13&apos;)">
R code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Stata13&apos;)">
Stata code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Hide13&apos;)">
Hide
</button>
<div id="ch5R13" class="tabcontent">
<p><br></p>
<pre class="text"><code>## We can use aov() or lm()
dat1$Z4factor &lt;- as.factor(dat1$Z4arms)
aovmod &lt;- aov(Y~Z4factor, dat1)
##lmmod &lt;- lm(Y~Z4arms, dat1)</code></pre>
</div>
<div id="ch5Stata13" class="tabcontent">
<p><br></p>
<pre class="text"><code>anova y z4num</code></pre>
</div>
<div id="ch5Hide13" class="tabcontent">

</div>
</div>
<p>In R, using the <code>glht()</code> function&#x2019;s <code>linfcnt</code> argument, we tell the function to conduct a Tukey test of all pairwise comparisons for our treatment indicator, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Z</mi></mrow><annotation encoding="application/x-tex">Z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span></span></span></span>. In Stata, we can do this using the <code>tukeyhsd</code> command or <code>pwcompare</code> commands.</p>
<div class="tab">
<button class="tablinks" onclick="unrolltab(event, &apos;ch5R14&apos;)">
R code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Stata14&apos;)">
Stata code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Hide14&apos;)">
Hide
</button>
<div id="ch5R14" class="tabcontent">
<p><br></p>
<pre class="text"><code>tukey_mc &lt;- glht(aovmod, linfct = mcp(Z4factor = &quot;Tukey&quot;))
summary(tukey_mc)</code></pre>
</div>
<div id="ch5Stata14" class="tabcontent">
<p><br></p>
<pre class="text"><code>* search tukeyhsd
* search qsturng
tukeyhsd z4num
* Or: pwcompare z4arms, mcompare(tukey) effects</code></pre>
</div>
<div id="ch5Hide14" class="tabcontent">

</div>
</div>
<pre><code>
     Simultaneous Tests for General Linear Hypotheses

Multiple Comparisons of Means: Tukey Contrasts


Fit: aov(formula = Y ~ Z4factor, data = dat1)

Linear Hypotheses:
             Estimate Std. Error t value Pr(&gt;|t|)
T2 - T1 == 0    0.733      1.226    0.60     0.93
T3 - T1 == 0    0.180      1.226    0.15     1.00
T4 - T1 == 0    2.037      1.226    1.66     0.35
T3 - T2 == 0   -0.553      1.226   -0.45     0.97
T4 - T2 == 0    1.304      1.226    1.06     0.71
T4 - T3 == 0    1.857      1.226    1.51     0.43
(Adjusted p values reported -- single-step method)</code></pre>
<p>Focusing on the R results, we can then plot the 95% family wise confidence intervals for these comparisons.</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb116-1" title="1"><span class="co">## Save dfault ploting parameters</span></a>
<a class="sourceLine" id="cb116-2" title="2">op &lt;-<span class="st"> </span><span class="kw">par</span>()</a>
<a class="sourceLine" id="cb116-3" title="3"><span class="co">## Add space to left-hand outer margin</span></a>
<a class="sourceLine" id="cb116-4" title="4"><span class="kw">par</span>(<span class="dt">oma =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">0</span>, <span class="dv">0</span>))</a>
<a class="sourceLine" id="cb116-5" title="5"><span class="kw">plot</span>(tukey_mc)</a></code></pre></div>
<p><img src="OES_SOP_files/figure-html/tukeyplot-1.png" width=".9\textwidth"></p>
<p>We can also obtain simultaneous confidence intervals at other levels of statistical significance using the <code>confint()</code> function.</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb117-1" title="1"><span class="co">## Generate and plot 90% confidence intervals</span></a>
<a class="sourceLine" id="cb117-2" title="2">tukey_mc_90ci &lt;-<span class="st"> </span><span class="kw">confint</span>(tukey_mc, <span class="dt">level =</span> <span class="fl">.90</span>)</a>
<a class="sourceLine" id="cb117-3" title="3"><span class="kw">plot</span>(tukey_mc_90ci)</a></code></pre></div>
<p><img src="OES_SOP_files/figure-html/plot_tukey_ci-1.png" width=".9\textwidth"></p>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb118-1" title="1"><span class="co">## Restore plotting defaults, now</span></a>
<a class="sourceLine" id="cb118-2" title="2"><span class="kw">par</span>(op)</a></code></pre></div>
<p>See also, in R: <code>pairwise.prop.test</code> for binary outcomes.</p>
<p>Finally, when test statistics are correlated but a Tukey-styled test is not desirable, we could instead employ randomization inference. To do this, we would start by simulating the distribution of p-values observed for each test across many random permutations of treatment (estimating the &#x201C;randomization distribution&#x201D; of our correlated test statistics under the sharp null). After that, we would use the distribution of p-values to calculate an <em>alternative significance threshold</em>. By comparing our real p-values to this simulated threshold, we could evaluate statistical significance while properly controling the FWER. We provide examples below for R and Stata. See step 7 on <a href="https://egap.org/resource/10-things-to-know-about-multiple-comparisons/">this page</a> for an alternative R code example.</p>
<p>In the code below, we first define a function to randomly re-assign treatment and estimate a p-value for each regression coefficient (based on HC2 errors). We repeatedly call this function 1000 times and save the resulting distribution of p-values. We then define two more functions (<code>find_threshold1</code> and <code>find_threshold2</code>) that illustrate different methods of calculating an appropriate significance threshold using those p-values (the first may be a little slower, but it walks through the logic in more detail). We also use this simulation to illustrate the advantages of an omnibus approach where we simply perform our confirmatory test using an alternative indicator for receipt of one of the treatment arms.</p>
<p>Both calculation approaches yield similar significance thresholds. And the collective false positive rate when making multiple comparisons is noticably higher than when making a single, omnibus comparison.</p>
<div class="tab">
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Re40&apos;)">
R code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Statae40&apos;)">
Stata code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Hidee40&apos;)">
Hide
</button>
<div id="ch5Re40" class="tabcontent">
<p><br></p>
<pre class="text"><code>## Function to permute treatment and generate
## p-values / null rejection for each of the
## three comparisons (i.e., arm 1 vs each of the other 3)
draw_multiple_arms &lt;- function() {
  
  ## Generate a new simulated treatment variable
  ## (same approach as in chapter 4 to produce the original)
  dat1$Z4arms_mt &lt;- complete_ra(nrow(dat1), m_each=rep(nrow(dat1)/4,4))
  
  ## Generate a binary indicator for being either T2 or T3.
  dat1$treat_any_mt &lt;- ifelse(dat1$Z4arms_mt == &quot;T1&quot;, 0, 1)
  
  ## Regress the outcome on treatment dummies.
  mod_each &lt;- lm_robust(Y ~ as.factor(Z4arms_mt), data = dat1)
  
  ## Regress the outcome on the &quot;any treatment&quot; dummy
  mod_any &lt;- lm_robust(Y ~ treat_any_mt, data = dat1)

  ## Is there at least one null rejection
  ## for the treatment dummies in mod_each?
  each &lt;- sum(mod_each$p.value[2:4] &lt;= 0.05) &gt; 0

  ## Is there a null rejection in mod_any?
  any &lt;- mod_any$p.value[2] &lt;= 0.05
  
  ## Prepare output (the p-values are used for
  ## a simulation-based FWER adjustment below)
  out &lt;- c(each, any, mod_each$p.value[2:4])
  names(out) &lt;- c(&quot;unadjusted&quot;, &quot;any&quot;, &quot;pT2&quot;, &quot;pT3&quot;, &quot;pT4&quot;)
  
  return(out)
  
}

## Calculate the output of that function 1000 times
multiple_arms &lt;- 
  
  ## Default output will be a list
  replicate(
    n = 1000,
    draw_multiple_arms(),
    simplify = F
    ) %&gt;%
  
  ## Stack the results from each draw as a df instead
  purrr::reduce(bind_rows)

## A function to use the p-values produced by the above to
## calculate a simulated significance threshold
## that controls the FWER rate.
## METHOD 1: try many possible thresholds,
## and find the largest one that sets the FWER to
## at least X% (default = 5). Slower, but
## makes the logic of this procedure clearer.
## P-values is a df/matrix where each column is
## the p-value for a different test, and each row
## is a set of p-values from a different iteration.
find_threshold1 &lt;- function(
  p_values, # Df of p-values (columns = tests, rows = iterations)
  from = 0.001, # Lowest possible threshold to try
  to = 0.999, # Highest to try
  by = 0.001, # Increments to try
  sig_level = 0.05 # Desired max FWER (FW significance level)
  ) {
  
  ## Generate the sequence of thresholds to test
  test_thresholds &lt;- seq(from, to, by)
  
  ## Create a df for each test_threshold:
  ## threshold and resulting FWER.
  candidates &lt;-
    
    lapply(
      
      ## To each test threshold...
      test_thresholds,
      
      ## ... Apply the following function
      ## (.x is the test threshold):
      function(.x) {
        
        ## Convert each p-value to a null rejection indicator
        significant &lt;- p_values &lt;= .x
        
        ## By row: at least one rejection in this family of tests?
        at_least_one &lt;- rowSums(significant) &gt;= 1
        
        ## From this, we can get a FWER
        type_I_rate &lt;- mean(at_least_one)
        
        ## Prepare output
        out &lt;- c(.x, type_I_rate)
        names(out) &lt;- c(&quot;threshold&quot;, &quot;fwer&quot;)
        
        return(out)
        
      }
      
    ) %&gt;%
    
    purrr::reduce(bind_rows)
  
  ## Keep only candidate thresholds with less than or
  ## equal to the target set above (default 5%).
  candidates &lt;- candidates[ candidates$fwer &lt;= sig_level, ]
  
  ## Find the largest threshold satisfying that criterion.
  candidates &lt;- candidates[ order(-candidates$threshold), ]
  
  return(candidates$threshold[1])
  
}

## Apply this function to calculate the adjusted
## significance threshold
sim_alpha1 &lt;- find_threshold1(multiple_arms[, 3:5])

## Method 2: A less intuitive shortcut that runs faster
find_threshold2 &lt;- function(p_values) {
  
  ## Get the minimum p-value in each family of tests
  min_p_infamily &lt;- apply(p_values, 1, min)
  
  ## The 5th percentile of these is (approx.)
  ## the simulated threshold we want.
  p5 &lt;- quantile(min_p_infamily, 0.05)
  
  return(p5)
  
}

## Apply this function to calculate the adjusted
## significance threshold
sim_alpha2 &lt;- as.numeric(find_threshold2(multiple_arms[, 3:5]))

## Compare the three simulation approaches:
print(&quot;sim_alpha1&quot;)
sim_alpha1
print(&quot;sim_alpha2&quot;)
sim_alpha2

## Notice: the false positive rate is too high
## across replications without accounting for
## multiple tests, but is closer to the right value
## when relying on the simpler &quot;omnibus&quot; indicator
## for receipt of some treatment.
print(&quot;False positive rate: separate tests&quot;)
mean(multiple_arms$unadjusted)
print(&quot;False positive rate: omnibus test&quot;)
mean(multiple_arms$any)</code></pre>
</div>
<div id="ch5Statae40" class="tabcontent">
<p><br></p>
<pre class="text"><code>** Program to permute treatment and generate
** p-values / null rejection for each of the
** three comparisons (i.e., arm 1 vs each of the other 3)
capture program drop draw_multiple_arms
program define draw_multiple_arms, rclass

    ** Generate a new simulated treatment variable
    ** (same approach as in chapter 4 to produce the original)
    capture drop z4arms_mt
    qui count
    local count_list = r(N)/4
    local count_list : di _dup(4) &quot;`count_list&apos; &quot; 
    qui complete_ra z4arms_mt, m_each(`count_list&apos;)

    ** Generate a binary indicator for being either T2 or T3
    capture drop treat_any_mt
    qui gen treat_any_mt = cond(z4arms_mt == 1, 0, 1)
    
    ** Regress the outcome on treatment dummies.
    ** Any of the p-values statistically significant?
    qui reg y i.z4arms_mt, vce(hc2)
    local each = (r(table)[4,2] &lt;= 0.05) | (r(table)[4,3] &lt;= 0.05) | (r(table)[4,4] &lt;= 0.05)
    return scalar each = `each&apos;
    return scalar pT2 = r(table)[4,2]
    return scalar pT3 = r(table)[4,3]
    return scalar pT4 = r(table)[4,4]
    
    ** Regress the outcome on the &quot;any treatment&quot; dummy
    qui reg y treat_any_mt, vce(hc2)
    local any = (r(table)[4,1] &lt;= 0.05)
    return scalar any = `any&apos;

end

** Program to avoid some typing when specifying what we want from simulate
capture program drop simlist
program define simlist
    local rscalars : r(scalars)
    global sim_targets &quot;&quot; // must be a global
    foreach item of local rscalars {
      global sim_targets &quot;$sim_targets `item&apos; = r(`item&apos;)&quot;
    }
end

** Calculate the output of that function 1000 times
draw_multiple_arms
simlist
simulate $sim_targets, reps(1000) nodots: draw_multiple_arms

** A program to use the p-values produced by the above to
** calculate a simulated significance threshold
** that controls the FWER rate.
** METHOD 1: try many possible thresholds,
** and find the largest one that sets the FWER to
** at least X% (default = 5). Slower, but
** makes the logic of this procedure clearer.
** P-values is a varlist of vars storing p-values
** from different tests (rows are different iterations,
** columns are assumed to represent different tests)
capture program drop find_threshold1
program define find_threshold1, rclass

    syntax, pvalues(varlist) /// P-value varnames
    [ to_val(real 0.005) /// Lowest possible threshold to try
    from_val(real 0.15) /// Highest to try (starts here)
    by_val(real 0.001) /// Increments to try
    sig_level(real 0.05) ] // Desired FWER (FW significance level)

    ** Make list of candidate thresholds
    numlist &quot;`from_val&apos;(-`by_val&apos;)`to_val&apos;&quot;
    local candidate_thresholds `r(numlist)&apos;
    
    ** Minimum p-value across tests
    tempvar minimum_p_value
    qui egen `minimum_p_value&apos; = rowmin(`pvalues&apos;)
    
    ** Loop through candidate thresholds
    foreach l of local candidate_thresholds {
    
        ** Indicator for at least one test in each randomization being significant
        ** under the candidate threshold in question. If the minimum
        ** is not significant, none of them will be.
        tempvar at_least_one
        qui gen `at_least_one&apos; = `minimum_p_value&apos; &lt;= `l&apos;
        
        ** Get the mean, representing the family-wise type I error rate
        ** for this threshold. It will be stored internally in r().
        qui sum `at_least_one&apos;, meanonly
        
        ** Evaluate if we&apos;re at the target FW type I error rate yet.
        ** If we are, save the threshold and stop the loop.
        if (`r(mean)&apos; &lt;= `sig_level&apos;) {
            
            return scalar alpha_fwer = `l&apos;
            continue, break
            
        }
    
    }

end

** Apply this program to calculate the adjusted
** significance threshold
find_threshold1, pvalues(pT3 pT2 pT4)
global sim_alpha1 = r(alpha_fwer)

** Method 2: A less intuitive shortcut that runs faster
capture program drop find_threshold2
program define find_threshold2, rclass

    syntax, pvalues(varlist)
    
    ** Get the minimum p-value in each family of tests
    capture drop minp
    egen minp = rowmin(`pvalues&apos;)
    qui sum minp, d

    ** The 5th percentile of these is (approx.)
    ** the simulated threshold we want.
    local alpha_fwer = round(`r(p5)&apos;, 0.0001)
    return scalar alpha_fwer = `alpha_fwer&apos;

end

** Apply this program to calculate the adjusted
** significance threshold
find_threshold2, pvalues(pT3 pT2 pT4)
global sim_alpha2 = r(alpha_fwer)

** Compare the two simulation approaches:
macro list sim_alpha1
macro list sim_alpha2

** Notice: the false positive rate is too high
** across replications without accounting for
** multiple tests, but is closer to the right value
** when relying on the simpler &quot;omnibus&quot; indicator
** for receipt of some treatment.
qui sum each, meanonly
di r(mean)
qui sum any, meanonly
di r(mean)</code></pre>
</div>
<div id="ch5Hidee40" class="tabcontent">

</div>
</div>
<pre><code>[1] &quot;sim_alpha1&quot;
[1] 0.019
[1] &quot;sim_alpha2&quot;
[1] 0.01935
[1] &quot;False positive rate: separate tests&quot;
[1] 0.133
[1] &quot;False positive rate: omnibus test&quot;
[1] 0.058</code></pre>
</div>
</div>
<div id="multiple-outcomes" class="section level3">
<h3><span class="header-section-number">5.2.2</span> Multiple outcomes</h3>
<p>Our studies also often involve more than one outcome measure. Assessing the effects of even a simple two-arm treatment across 10 different outcomes can raise the same kinds of questions that come up in the context of multi-arm trials. Classic adjustments such as the Bonferroni and Holm procedures (which ignore correlations between test statistics), testing hypotheses in a pre-specified order <span class="citation">(Rosenbaum <a href="#ref-rosenbaum2008a">2008</a>)</span>, and randomization inference simulations could all be appropriate adjustments to apply when dealing with multiple outcomes (whereas the Tukey HSD procedure is specifically for multiple comparisons).</p>
<p>Additionally, as we did with multiple comparisons, we can perform omnibus tests for an overall treatment effect across multiple outcomes. One method we&#x2019;ll highlight is creating a &#x201C;stacked&#x201D; regression model, where each observation has a separate row in the dataset for each outcome measure <span class="citation">(Oberfichtner and Tauchmann <a href="#ref-oberfichtner2021stacked">2021</a>)</span>.<a href="references.html#fn19" class="footnote-ref" id="fnref19"><sup>19</sup></a> A modified version of the original model with unit-clustered errors can then be fit to the stacked dataset, evaluating joint significance across outcomes using a Wald test (see chapter 4 for a summary of Wald tests). This approach usually yields the same or similar results to fitting separate tests for each outcome in a &#x201C;seemingly unrelated estimation&#x201D; (SUE) framework <span class="citation">(Weesie <a href="#ref-weesie2000seemlingly">2000</a>)</span>. Which method is more convenient depends on the situation. We focus on stacked regression, but see <code>suest</code> in Stata or <code>systemfit</code> in R for guidance on implementing SUE.</p>
<p>The code below illustrates the stacked regression method using two simulated outcomes drawn from a multivariate normal distribution. First, we need to prepare the data.</p>
<div class="tab">
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Re41&apos;)">
R code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Statae41&apos;)">
Stata code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Hidee41&apos;)">
Hide
</button>
<div id="ch5Re41" class="tabcontent">
<p><br></p>
<pre class="text"><code>## Jointly draw correlated outcomes from a multivariate normal
mu &lt;- c(1, 3)
sigma &lt;- rbind( c(1, 0.2), c(0.2, 3) )
dat1[, c(&quot;y_mo_1&quot;, &quot;y_mo_2&quot;)] &lt;- as.data.frame(mvrnorm(n = nrow(dat1), mu = mu, Sigma = sigma))

## Transform outcomes stored as separate variables into
## separate observations instead.
dat1stack &lt;- pivot_longer(dat1, cols = c(&quot;y_mo_1&quot;, &quot;y_mo_2&quot;), names_to = &quot;outcome&quot;, values_to = &quot;stacky&quot;)

## Review
head(dat1stack[, c(&quot;id&quot;, &quot;outcome&quot;, &quot;stacky&quot;)])</code></pre>
</div>
<div id="ch5Statae41" class="tabcontent">
<p><br></p>
<pre class="text"><code>** Jointly draw correlated outcomes from a multivariate normal
matrix sigma = (1, 0.2 \ .2, 3)
drawnorm y_mo_1 y_mo_2, cov(sigma)

** Transform outcomes stored as separate variables into
** separate observations instead.
tempfile return_to
save `return_to&apos;, replace
keep id y_mo_1 y_mo_2 z2armequal
reshape long y_mo_, i(id) j(outcome)

** Review
list in 1/6</code></pre>
</div>
<div id="ch5Hidee41" class="tabcontent">

</div>
</div>
<pre><code># A tibble: 6 &#xD7; 3
     id outcome stacky
  &lt;int&gt; &lt;chr&gt;    &lt;dbl&gt;
1     1 y_mo_1   0.667
2     1 y_mo_2   2.80 
3     2 y_mo_1  -0.332
4     2 y_mo_2   2.32 
5     3 y_mo_1   0.445
6     3 y_mo_2   1.43 </code></pre>
<p>Next, as above, we define a function to repeatedly permute treatment, estimate an omnibus p-value for an effect across outcomes using a stacked regression, and compare this to the collective false positive rate we observe when evaluating the tests separately. We perform the simulation by permuting treatment just to illustrate the collective false positive rate in a case where we know the null of no effect is true.</p>
<div class="tab">
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Re42&apos;)">
R code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Statae42&apos;)">
Stata code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Hidee42&apos;)">
Hide
</button>
<div id="ch5Re42" class="tabcontent">
<p><br></p>
<pre class="text"><code>## As before, define a function to repeatedly
## permute treatment and estimate p-value
draw_multiple_outcomes &lt;- function() {
  
  ## Generate a new simulated treatment variable
  dat1$Z2armEqual_mo &lt;- complete_ra(nrow(dat1))
  
  ## Merge into the stacked data
  stack_merge &lt;- merge(dat1stack, dat1[, c(&quot;id&quot;, &quot;Z2armEqual_mo&quot;)], by = &quot;id&quot;)
  stack_merge$out1 &lt;- ifelse(stack_merge$outcome == &quot;y_mo_1&quot;, 1, 0)
  
  ## Fit a stacked regression model (unrestricted)
  mod_stack &lt;- lm(
    stacky ~ Z2armEqual_mo * out1,
    data = stack_merge
    )

  ## Fit restricted model for the Wald test
  mod_restr &lt;- lm(
    stacky ~ out1,
    data = stack_merge
    )
  
  ## Variance-covariance matrix of unrestricted model
  vcov &lt;- vcovCL(mod_stack, type = &quot;HC2&quot;, cluster = stack_merge$id)
  
  ## Wald test: joint significance of treatment effect 
  ## and difference across outcomes. Could also use
  ## linearHypothesis from car with the following constraints:
  ## c(&quot;Z2armEqual_mo&quot;, &quot;Z2armEqual_mo:out1&quot;) or
  ## c(&quot;Z2armEqual_mo&quot;, &quot;&quot;Z2armEqual_mo + Z2armEqual_mo:out1&quot;)
  waldp &lt;- waldtest(mod_stack, mod_restr, vcov = vcov)$`Pr(&gt;F)`[2]

  ## Model each outcome separately
  pO1 &lt;- summary(lm_robust(y_mo_1 ~ Z2armEqual_mo, data = dat1))$coefficients[2,4]
  pO2 &lt;- summary(lm_robust(y_mo_2 ~ Z2armEqual_mo, data = dat1))$coefficients[2,4]
  
  ## Prepare output
  out &lt;- c(waldp, pO1, pO2)
  names(out) &lt;- c(&quot;waldp&quot;, &quot;p01&quot;, &quot;p02&quot;)
  
  return(out)
  
}

## Calculate the output of that function 1000 times
multiple_outcomes &lt;- 
  
  ## Default output will be a list
  replicate(
    n = 1000,
    draw_multiple_outcomes(),
    simplify = F
    ) %&gt;%
  
  ## Stack the results from each draw as a df instead
  purrr::reduce(bind_rows)

## False positive rate: stacked
print(&quot;False positive rate: stacked&quot;)
mean(multiple_outcomes$waldp &lt;= 0.05)

## False positive rate: separate
print(&quot;False positive rate: separate tests&quot;)
mean(rowSums(multiple_outcomes[,c(2:3)] &lt;= 0.05) &gt; 0)</code></pre>
</div>
<div id="ch5Statae42" class="tabcontent">
<p><br></p>
<pre class="text"><code>** As before, define a function to repeatedly
** permute treatment and estimate p-value
capture program drop draw_multiple_outcomes
program define draw_multiple_outcomes, rclass

    ** Generate a new simulated treatment variable
    capture drop z2armequal_mo
    preserve
        qui keep id
        qui duplicates drop
        qui count
        local count_list = r(N)/2
        local count_list : di _dup(2) &quot;`count_list&apos; &quot; 
        qui complete_ra z2armequal_mo, m_each(`count_list&apos;)
        tempfile newtreat
        save `newtreat&apos;, replace
    restore
    
    ** Merge into the stacked data
    qui merge m:1 id using `newtreat&apos;
    assert _merge == 3
    qui drop _merge
    
    ** Fit a stacked regression model
    qui reg y_mo_ z2armequal_mo##i.outcome, vce(cluster id)
    
    ** Wald test: joint significance of treatment effect 
    ** and difference across outcomes. In this case we just specify
    ** restrictions/tests directly instead of fitting separate models.
    qui test ((1.z2armequal_mo#2.outcome+1.z2armequal_mo) = 0) (1.z2armequal_mo = 0)
    local waldp = r(p) &lt;= 0.05
    return scalar waldp = `waldp&apos;

    ** Model each outcome separately
    preserve
        qui keep if outcome == 1
        qui reg y_mo_ z2armequal_mo, vce(hc2)
        local p1 = r(table)[4,1]
    restore
    preserve
        qui keep if outcome == 2
        qui reg y_mo_ z2armequal_mo, vce(hc2)
        local p2 = r(table)[4,1]
    restore
    local each = (`p1&apos; &lt;= 0.05) | (`p2&apos; &lt;= 0.05)
    return scalar each = `each&apos;

end

** Calculate the output of that function 1000 times
draw_multiple_outcomes
simlist
simulate $sim_targets, reps(1000) nodots: draw_multiple_outcomes

** False positive rate: stacked
qui sum waldp, meanonly
di r(mean)

** False positive rate: separate
qui sum each, meanonly
di r(mean)

** Return to primary data
use `return_to&apos;, clear</code></pre>
</div>
<div id="ch5Hidee42" class="tabcontent">

</div>
</div>
<pre><code>[1] &quot;False positive rate: stacked&quot;
[1] 0.056
[1] &quot;False positive rate: separate tests&quot;
[1] 0.104</code></pre>
</div>
<div id="when-is-this-necessary" class="section level3">
<h3><span class="header-section-number">5.2.3</span> When is this necessary?</h3>
<p>So far, we&#x2019;ve focused on the mechanics of performing different kinds of adjustments for multiple testing (different outcomes, multiple comparisons, multiple model specifications we are agnostic about, etc.). But we&#x2019;ve avoided a more fundamental question: how do we determine when adjustment is necessary in the first place? Failing to apply a multiple testing correction when it is needed yields overconfident inferences. But adjusting for multiple testing when it is not needed yields overly conservative inferences. Both miscalculations work against our ability to correctly control error rates, one of our key design criteria (chapter 2).</p>
<p>This is an area where our thinking at OES has evolved over time. To see the logic for our current approach, consider the two hypothetical examples below.</p>
<p>In <strong>Example 1</strong>, we want to evaluate whether outreach increases enrollment in a public benefit program. Past research doesn&#x2019;t clarify which available outreach method is most effective, so we design a four-arm trial with a control group and three different intervention groups (texts, emails, and phone calls). We decide that if we see statistically significant evidence for the effectiveness of any treatment arm, this is sufficient to <strong>reject the joint null hypothesis</strong> of no effect across outreach methods, corresponding to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>H</mi><mrow><mn>0</mn><mo separator="true">,</mo><mi>j</mi><mi>o</mi><mi>i</mi><mi>n</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">H_{0, joint}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0813em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">in</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> below, where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&#x2229;</mo></mrow><annotation encoding="application/x-tex">\cap</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5556em;"></span><span class="mord">&#x2229;</span></span></span></span> means &#x201C;and.&#x201D; Our primary concern is whether <em>at least one intervention</em> works.</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>H</mi><mrow><mn>0</mn><mo separator="true">,</mo><mi>t</mi><mi>e</mi><mi>x</mi><mi>t</mi></mrow></msub><mo>:</mo><msub><mi>&#x3C4;</mi><mrow><mi>t</mi><mi>e</mi><mi>x</mi><mi>t</mi></mrow></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">H_{0, text} : \tau_{text} = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0813em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">x</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">x</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span></span>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>H</mi><mrow><mn>0</mn><mo separator="true">,</mo><mi>e</mi><mi>m</mi><mi>a</mi><mi>i</mi><mi>l</mi></mrow></msub><mo>:</mo><msub><mi>&#x3C4;</mi><mrow><mi>e</mi><mi>m</mi><mi>a</mi><mi>i</mi><mi>l</mi></mrow></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">H_{0, email} : \tau_{email} = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0813em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">mai</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">mai</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span></span>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>H</mi><mrow><mn>0</mn><mo separator="true">,</mo><mi>p</mi><mi>h</mi><mi>o</mi><mi>n</mi><mi>e</mi></mrow></msub><mo>:</mo><msub><mi>&#x3C4;</mi><mrow><mi>p</mi><mi>h</mi><mi>o</mi><mi>n</mi><mi>e</mi></mrow></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">H_{0, phone} : \tau_{phone} = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0813em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span></span></p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>H</mi><mrow><mn>0</mn><mo separator="true">,</mo><mi>j</mi><mi>o</mi><mi>i</mi><mi>n</mi><mi>t</mi></mrow></msub><mo>=</mo><msub><mi>H</mi><mrow><mn>0</mn><mo separator="true">,</mo><mi>t</mi><mi>e</mi><mi>x</mi><mi>t</mi></mrow></msub><mo>&#x2229;</mo><msub><mi>H</mi><mrow><mn>0</mn><mo separator="true">,</mo><mi>e</mi><mi>m</mi><mi>a</mi><mi>i</mi><mi>l</mi></mrow></msub><mo>&#x2229;</mo><msub><mi>H</mi><mrow><mn>0</mn><mo separator="true">,</mo><mi>p</mi><mi>h</mi><mi>o</mi><mi>n</mi><mi>e</mi></mrow></msub></mrow><annotation encoding="application/x-tex">H_{0, joint} = H_{0, text} \cap H_{0, email} \cap H_{0, phone}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0813em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">in</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0813em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">x</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2229;</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0813em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">mai</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2229;</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0813em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p>In contrast, in <strong>Example 2</strong>, we are evaluating two separate interventions to process benefit applications more quickly. This is a three-arm trial with a control group and two intervention groups, but the interventions are unrelated. We can justify each intervention separately, and there is no joint null we are interested in. Instead, we simply want to <strong>reject the constituent null hypotheses</strong> of no effect for each intervention, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>H</mi><mrow><mn>0</mn><mo separator="true">,</mo><mi>i</mi><mi>n</mi><mi>t</mi><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">H_{0, int1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0813em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">in</span><span class="mord mathnormal mtight">t</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>H</mi><mrow><mn>0</mn><mo separator="true">,</mo><mi>i</mi><mi>n</mi><mi>t</mi><mn>2</mn></mrow></msub></mrow><annotation encoding="application/x-tex">H_{0, int2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0813em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">in</span><span class="mord mathnormal mtight">t</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>.</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>H</mi><mrow><mn>0</mn><mo separator="true">,</mo><mi>i</mi><mi>n</mi><mi>t</mi><mn>1</mn></mrow></msub><mo>:</mo><msub><mi>&#x3C4;</mi><mrow><mi>i</mi><mi>n</mi><mi>t</mi><mn>1</mn></mrow></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">H_{0, int1} : \tau_{int1} = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0813em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">in</span><span class="mord mathnormal mtight">t</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">in</span><span class="mord mathnormal mtight">t</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span></span></p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>H</mi><mrow><mn>0</mn><mo separator="true">,</mo><mi>i</mi><mi>n</mi><mi>t</mi><mn>2</mn></mrow></msub><mo>:</mo><msub><mi>&#x3C4;</mi><mrow><mi>i</mi><mi>n</mi><mi>t</mi><mn>2</mn></mrow></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">H_{0, int2} : \tau_{int2} = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0813em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">in</span><span class="mord mathnormal mtight">t</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">in</span><span class="mord mathnormal mtight">t</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span></span>
In Example 1, the joint null of no effect across outreach methods is the <em>intersection</em> of three constituent null hypotheses. Rejecting this null implies accepting the <em>union</em> of their alternative hypotheses (where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&#x222A;</mo></mrow><annotation encoding="application/x-tex">\cup</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5556em;"></span><span class="mord">&#x222A;</span></span></span></span> means &#x201C;or,&#x201D; and we have <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>H</mi><mrow><mi>A</mi><mo separator="true">,</mo><mi>m</mi><mi>e</mi><mi>t</mi><mi>h</mi><mi>o</mi><mi>d</mi></mrow></msub><mo>:</mo><msub><mi>&#x3C4;</mi><mrow><mi>m</mi><mi>e</mi><mi>t</mi><mi>h</mi><mi>o</mi><mi>d</mi></mrow></msub><mo mathvariant="normal">&#x2260;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">H_{A, method} : \tau_{method} \neq 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0813em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel"><span class="mrel"><span class="mord vbox"><span class="thinbox"><span class="rlap"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="inner"><span class="mord"><span class="mrel">&#xE020;</span></span></span><span class="fix"></span></span></span></span></span><span class="mrel">=</span></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span>):</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>H</mi><mrow><mi>A</mi><mo separator="true">,</mo><mi>j</mi><mi>o</mi><mi>i</mi><mi>n</mi><mi>t</mi></mrow></msub><mo>=</mo><msub><mi>H</mi><mrow><mi>A</mi><mo separator="true">,</mo><mi>t</mi><mi>e</mi><mi>x</mi><mi>t</mi></mrow></msub><mo>&#x222A;</mo><msub><mi>H</mi><mrow><mi>A</mi><mo separator="true">,</mo><mi>e</mi><mi>m</mi><mi>a</mi><mi>i</mi><mi>l</mi></mrow></msub><mo>&#x222A;</mo><msub><mi>H</mi><mrow><mi>A</mi><mo separator="true">,</mo><mi>p</mi><mi>h</mi><mi>o</mi><mi>n</mi><mi>e</mi></mrow></msub></mrow><annotation encoding="application/x-tex">H_{A, joint} = H_{A, text} \cup H_{A, email} \cup H_{A, phone}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0813em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">in</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0813em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">x</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x222A;</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0813em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">mai</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x222A;</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0813em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span></span>
Rejecting any one of the constituent null hypotheses is grounds to reject <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>H</mi><mrow><mn>0</mn><mo separator="true">,</mo><mi>j</mi><mi>o</mi><mi>i</mi><mi>n</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">H_{0, joint}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0813em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">in</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>. This is sometimes called a <strong>union-intersection</strong> test <span class="citation">(Rubin <a href="#ref-rubin2024inconsistent">2024</a>)</span>. To maintain appropriate error rate control, we apply multiple testing adjustment whenever we base a conclusion on a union-intersection test. These are the situations where we are most concerned about being mislead by inflated error rates: where we are drawing one underlying conclusion based on the results of multiple tests.</p>
<p>In contrast, in Example 2, the interventions are justified separately, and the truth of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>H</mi><mrow><mn>0</mn><mo separator="true">,</mo><mi>i</mi><mi>n</mi><mi>t</mi><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">H_{0, int1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0813em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">in</span><span class="mord mathnormal mtight">t</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> has no bearing on the truth of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>H</mi><mrow><mn>0</mn><mo separator="true">,</mo><mi>i</mi><mi>n</mi><mi>t</mi><mn>2</mn></mrow></msub></mrow><annotation encoding="application/x-tex">H_{0, int2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0813em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">in</span><span class="mord mathnormal mtight">t</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>. In this case, we have determined that it is not useful to only know that at least one of the two modifications decreased application processing times (i.e., rejecting the intersection of their nulls is not informative)&#x2014;we need to know whether each modification on its own was sufficient. Therefore, we would not adjust for multiple testing. The FWER is inflated, but we are not drawing a joint conclusion. Moreover, the Type I error rates for the separate tests remain uninflated <span class="citation">(Rubin <a href="#ref-rubin2024inconsistent">2024</a>)</span>. Returning to the three simulated p-values from the multiple arms adjustment example code, we can see that the estimated false positive rate under a true null is approximately correct when each test is considered alone.</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb128-1" title="1"><span class="kw">colMeans</span>(multiple_arms[,<span class="kw">c</span>(<span class="dv">3</span><span class="op">:</span><span class="dv">5</span>)] <span class="op">&lt;=</span><span class="st"> </span><span class="fl">0.05</span>)</a></code></pre></div>
<pre><code>  pT2   pT3   pT4 
0.052 0.058 0.055 </code></pre>
<p>Lastly, consider the reverse of example 1: we wish to determine whether there is sufficient evidence that all three outreach methods work. This is sometimes called an <strong>intersection-union</strong> test. We would again not adjust for multiple testing when performing an intersection-union test. The risk of seeing at least one false positive is not compelling if our conclusion depends on seeing supportive results for all three outreach methods, rather than only one.</p>
<p>In sum, at OES we prefer to adjust for multiple testing when drawing conclusions based on union-intersection tests, but not in other cases. Put more simply, are we drawing a conclusion after looking for statistical significance in at least one of several tests? If so, we adjust for multiple testing. But otherwise we often elect not to. Researchers sometimes seek to define &#x201C;families&#x201D; of related tests to help determine where multiple testing adjustments are or are not needed. By the logic outlined above, two tests might be thought of as in the same &#x201C;family&#x201D; if they contribute to the same joint null hypothesis, as defined above for union-intersection tests <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>H</mi><mrow><mn>0</mn><mo separator="true">,</mo><mi>j</mi><mi>o</mi><mi>i</mi><mi>n</mi><mi>t</mi></mrow></msub><mo>:</mo><msub><mi>H</mi><mrow><mn>0</mn><mo separator="true">,</mo><mn>1</mn></mrow></msub><mo>&#x2229;</mo><msub><mi>H</mi><mrow><mn>0</mn><mo separator="true">,</mo><mn>2</mn></mrow></msub><mo>&#x2229;</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(H_{0, joint} : H_{0, 1} \cap H_{0, 2} \cap ... )</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0813em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">in</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0813em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span><span class="mpunct mtight">,</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2229;</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0813em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span><span class="mpunct mtight">,</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2229;</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">...</span><span class="mclose">)</span></span></span></span>.</p>
<p>Determining which case above best represents any given evaluation is <a href="https://lakens.github.io/statistical_inferences/02-errorcontrol.html#why-you-dont-need-to-adjust-your-alpha-level-for-all-tests-youll-do-in-your-lifetime">a question of theory and policy relevance</a> as much as it is a statistical question. It may depend on what we hope to learn from an evaluation, and what kinds of conclusions would be most useful for our partners. It helps to carefully lay out and justify the claims we wish to make or evaluate as a part of pre-registering our analysis plans.</p>
</div>
</div>
<div id="covariance-adjustment-the-use-of-background-information-to-increase-precision" class="section level2">
<h2><span class="header-section-number">5.3</span> Covariance adjustment (the use of background information to increase precision)</h2>
<p>When we have additional information about experimental units (covariates), we can use this to increase the the statistical power of our tests. When possible, we use this information during the design phase to randomize interventions within blocks. But we also often pre-specify covariance adjustment as a part of our analyses.</p>
<p>Researchers typically do this by regressing the outcome on a treatment indicator and a set of linear, additive terms for each covariate (like <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">X_{i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> in equation 3 below). This estimator of the average treatment effect is <em>consistent</em> (bias decreases as <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>&#x2192;</mo><mi mathvariant="normal">&#x221E;</mi></mrow><annotation encoding="application/x-tex">n \rightarrow \infty</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&#x2192;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord">&#x221E;</span></span></span></span>, i.e.&#xA0;asymptotically), but it can be biased in finite samples. The risk of appreciable bias is greater in small samples (see below). The unadjusted difference in means, in constrast, is unbiased, but as <span class="citation">Lin (<a href="#ref-lin_agnostic_2013">2013</a>)</span> points out, this is not reassuring if, for instance, treatment and control groups are noticeably imbalanced despite randomization. Standard linear covariance adjustment can be less efficient than an unadjusted difference in means <span class="citation">(Freedman <a href="#ref-freedman2008rae">2008</a><a href="#ref-freedman2008rae">a</a>)</span>.<a href="references.html#fn20" class="footnote-ref" id="fnref20"><sup>20</sup></a></p>
<p>In contrast, an approach to covariance adjustment that we call the <strong>Lin estimator</strong> or <strong>Lin adjustment</strong> performs better&#x2014;at worst, it will be no less asymptotically efficient than an unadjusted difference in means <span class="citation">(Lin <a href="#ref-lin_agnostic_2013">2013</a>)</span>. We explain how it is implemented below. Like linear covariance adjustment, the Lin estimator is also generally only consistent and not unbiased. But it will be unbiased if it correctly models the true conditional expectation of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi></mrow><annotation encoding="application/x-tex">Y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span></span></span></span> given treatment and the covariates <span class="citation">(Negi and Wooldridge <a href="#ref-negi2021revisiting">2021</a>; Lin <a href="#ref-lin_agnostic_2013">2013</a>)</span>.<a href="references.html#fn21" class="footnote-ref" id="fnref21"><sup>21</sup></a> This condition is met when the model is &#x201C;saturated&#x201D; with controls for every combination of covariate values, such as when using the Lin estimator to account for a set of dummies representing block fixed effects <span class="citation">(Miratrix, Sekhon, and Yu <a href="#ref-miratrix2013adjusting">2013</a>)</span>.<a href="references.html#fn22" class="footnote-ref" id="fnref22"><sup>22</sup></a></p>
<p>The precision-loss attributable to standard linear covariance adjustment estimator can be quite small in large samples. Yet, because it is frequently costless to use the Lin estimator in large samples, it is our default recommendation (see <a href="https://declaredesign.org/blog/2018-09-11-controlling-pretreatment-covariates.html">this page</a> as well). That said, it is not uncommon for us to encounter situations where linear covariate adjustment is still preferred, either on practical or statistical grounds. A few examples:</p>
<ul>
<li><p>The randomization design has only two arms, and the probability of receiving treatment is approximately 0.5</p></li>
<li><p>We do not expect the covariates we observe to be associated with meaningful treatment effect heterogeneity</p></li>
<li><p>The number of parameters in a model is large enough, relative to the sample size, that the loss of degrees of freedom from using Lin adjustment may be substantial (the number of terms added is the number of controls multipled by the number of treatments); Lin adjustment is more efficient <em>asymptotically</em></p></li>
</ul>
<p>We expand on some of these issues in the subsections below, with more detail on how Lin estimation works. We also provide a simulated example illustrating hypothetical power differences between standard covariate adjustment and Lin adjustment in Chapter 6.</p>
<div id="possible-bias-in-the-least-squares-ate-estimator-with-covariates" class="section level3">
<h3><span class="header-section-number">5.3.1</span> Possible bias in the least squares ATE estimator with covariates</h3>
<p>When we estimate the average treatment effect using least squares we tend to say that we &#x201C;regress&#x201D; some outcome for each unit <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">Y_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, on (often binary) treatment assignment, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Z</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">Z_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Z</mi><mi>i</mi></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">Z_i=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> if a unit is assigned to treatment and 0 if assigned to control. And we write a linear model relating <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Z</mi></mrow><annotation encoding="application/x-tex">Z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi></mrow><annotation encoding="application/x-tex">Y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span></span></span></span> as below, where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>&#x3B2;</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">\beta_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">&#x3B2;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> represents the difference in means of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi></mrow><annotation encoding="application/x-tex">Y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span></span></span></span> between units with <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Z</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">Z=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Z</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">Z=0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span>:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.16em" columnspacing="1em"><mtr><mtd class="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><msub><mi>Y</mi><mi>i</mi></msub><mo>=</mo><msub><mi>&#x3B2;</mi><mn>0</mn></msub><mo>+</mo><msub><mi>&#x3B2;</mi><mn>1</mn></msub><msub><mi>Z</mi><mi>i</mi></msub><mo>+</mo><msub><mi>e</mi><mi>i</mi></msub></mrow></mstyle></mtd><mtd class="mtr-glue"></mtd><mtd class="mml-eqn-num"></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{equation}
Y_i = \beta_0 + \beta_1 Z_i + e_i
\end{equation}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2em;vertical-align:-0.35em;"></span><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.85em;"><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">&#x3B2;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">&#x3B2;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.35em;"><span></span></span></span></span></span></span></span><span class="tag"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.85em;"><span style="top:-2.85em;"><span class="pstrut" style="height:2.84em;"></span><span class="eqn-num"></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.35em;"><span></span></span></span></span></span></span></span></span></p>
<p>This is a common practice because we know that the formula to estimate <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>&#x3B2;</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">\beta_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">&#x3B2;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> in Equation (1) is the same as the difference-in-means when comparing <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi></mrow><annotation encoding="application/x-tex">Y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span></span></span></span> across the treatment and control groups:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.16em" columnspacing="1em"><mtr><mtd class="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><msub><mover accent="true"><mi>&#x3B2;</mi><mo>^</mo></mover><mn>1</mn></msub><mo>=</mo><msub><mover accent="true"><mi>Y</mi><mo stretchy="true">&#x203E;</mo></mover><mrow><mi>Z</mi><mo>=</mo><mn>1</mn></mrow></msub><mo>&#x2212;</mo><msub><mover accent="true"><mi>Y</mi><mo stretchy="true">&#x203E;</mo></mover><mrow><mi>Z</mi><mo>=</mo><mn>0</mn></mrow></msub><mo>=</mo><mfrac><mrow><mrow><mi mathvariant="normal">C</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">v</mi></mrow><mo stretchy="false">(</mo><mi>Y</mi><mo separator="true">,</mo><mi>Z</mi><mo stretchy="false">)</mo></mrow><mrow><mrow><mi mathvariant="normal">V</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">r</mi></mrow><mo stretchy="false">(</mo><mi>Z</mi><mo stretchy="false">)</mo></mrow></mfrac><mi mathvariant="normal">.</mi></mrow></mstyle></mtd><mtd class="mtr-glue"></mtd><mtd class="mml-eqn-num"></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{equation}
\hat{\beta}_1 = \overline{Y}_{Z=1} - \overline{Y}_{Z=0} = \frac{\mathrm{Cov}(Y,Z)}{\mathrm{Var}(Z)}.
\end{equation}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.363em;vertical-align:-0.9315em;"></span><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.4315em;"><span style="top:-3.4315em;"><span class="pstrut" style="height:3.427em;"></span><span class="mord"><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9579em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.05278em;">&#x3B2;</span></span><span style="top:-3.2634em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1667em;"><span class="mord">^</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8833em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span></span></span><span style="top:-3.8033em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">Z</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8833em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span></span></span><span style="top:-3.8033em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">Z</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">Var</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">Cov</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mclose">)</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord">.</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.9315em;"><span></span></span></span></span></span></span></span><span class="tag"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.4315em;"><span style="top:-3.4315em;"><span class="pstrut" style="height:3.427em;"></span><span class="eqn-num"></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.9315em;"><span></span></span></span></span></span></span></span></span>
This last term, expressed with covariances and variances, is the expression for the slope coefficient in a bivariate OLS regression model. This estimator of the average treatment effect has no systematic error (i.e., it is unbiased), so we can write <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>E</mi><mi>R</mi></msub><mo stretchy="false">(</mo><msub><mover accent="true"><mi>&#x3B2;</mi><mo>^</mo></mover><mn>1</mn></msub><mo stretchy="false">)</mo><mo>=</mo><msub><mi>&#x3B2;</mi><mn>1</mn></msub><mo>&#x2261;</mo><mtext>ATE</mtext></mrow><annotation encoding="application/x-tex">E_R(\hat{\beta}_1)=\beta_1 \equiv \text{ATE}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2079em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.00773em;">R</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9579em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.05278em;">&#x3B2;</span></span><span style="top:-3.2634em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1667em;"><span class="mord">^</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">&#x3B2;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&#x2261;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord text"><span class="mord">ATE</span></span></span></span></span>, where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>E</mi><mi>R</mi></msub><mo stretchy="false">(</mo><msub><mover accent="true"><mi>&#x3B2;</mi><mo>^</mo></mover><mn>1</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">E_R(\hat{\beta}_1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2079em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.00773em;">R</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9579em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.05278em;">&#x3B2;</span></span><span style="top:-3.2634em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1667em;"><span class="mord">^</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> refers to the expectation of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>&#x3B2;</mi><mo>^</mo></mover><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">\hat{\beta}_{1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1523em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9579em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.05278em;">&#x3B2;</span></span><span style="top:-3.2634em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1667em;"><span class="mord">^</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> across randomizations consistent with the experimental design.</p>
<p>Sometimes we have an additional (pre-treatment) covariate, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">X_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, commonly included in the analysis as follows:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.16em" columnspacing="1em"><mtr><mtd class="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><msub><mi>Y</mi><mi>i</mi></msub><mo>=</mo><msub><mi>&#x3B2;</mi><mn>0</mn></msub><mo>+</mo><msub><mi>&#x3B2;</mi><mn>1</mn></msub><msub><mi>Z</mi><mi>i</mi></msub><mo>+</mo><msub><mi>&#x3B2;</mi><mn>2</mn></msub><msub><mi>X</mi><mi>i</mi></msub><mo>+</mo><msub><mi>e</mi><mi>i</mi></msub></mrow></mstyle></mtd><mtd class="mtr-glue"></mtd><mtd class="mml-eqn-num"></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{equation}
Y_i = \beta_0 + \beta_1 Z_i + \beta_2 X_i + e_i
\end{equation}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2em;vertical-align:-0.35em;"></span><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.85em;"><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">&#x3B2;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">&#x3B2;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">&#x3B2;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.35em;"><span></span></span></span></span></span></span></span><span class="tag"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.85em;"><span style="top:-2.85em;"><span class="pstrut" style="height:2.84em;"></span><span class="eqn-num"></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.35em;"><span></span></span></span></span></span></span></span></span></p>
<p>What is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>&#x3B2;</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">\beta_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">&#x3B2;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> in this case? The matrix representation here is: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>&#x3B2;</mi><msup><mi>X</mi><mi>T</mi></msup><mi>&#x3B2;</mi><mi>X</mi><msup><mo stretchy="false">)</mo><mrow><mo>&#x2212;</mo><mn>1</mn></mrow></msup><mi>&#x3B2;</mi><msup><mi>X</mi><mi>T</mi></msup><mi>&#x3B2;</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">(\beta X^{T}\beta X)^{-1}\beta X^{T}\beta y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0913em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05278em;">&#x3B2;</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.07847em;">&#x3B2;X</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">&#x2212;</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.05278em;">&#x3B2;</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.05278em;">&#x3B2;</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span>. But it will be more useful to examine the scalar formula:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mover accent="true"><mi>&#x3B2;</mi><mo>^</mo></mover><mn>1</mn></msub><mo>=</mo><mfrac><mrow><mrow><mi mathvariant="normal">V</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">r</mi></mrow><mo stretchy="false">(</mo><mi>X</mi><mo stretchy="false">)</mo><mrow><mi mathvariant="normal">C</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">v</mi></mrow><mo stretchy="false">(</mo><mi>Z</mi><mo separator="true">,</mo><mi>Y</mi><mo stretchy="false">)</mo><mo>&#x2212;</mo><mrow><mi mathvariant="normal">C</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">v</mi></mrow><mo stretchy="false">(</mo><mi>X</mi><mo separator="true">,</mo><mi>Z</mi><mo stretchy="false">)</mo><mrow><mi mathvariant="normal">C</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">v</mi></mrow><mo stretchy="false">(</mo><mi>X</mi><mo separator="true">,</mo><mi>Y</mi><mo stretchy="false">)</mo></mrow><mrow><mrow><mi mathvariant="normal">V</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">r</mi></mrow><mo stretchy="false">(</mo><mi>Z</mi><mo stretchy="false">)</mo><mrow><mi mathvariant="normal">V</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">r</mi></mrow><mo stretchy="false">(</mo><mi>X</mi><mo stretchy="false">)</mo><mo>&#x2212;</mo><mrow><mi mathvariant="normal">C</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">v</mi></mrow><mo stretchy="false">(</mo><mi>Z</mi><mo separator="true">,</mo><mi>X</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">\hat{\beta}_1 = \frac{\mathrm{Var}(X)\mathrm{Cov}(Z,Y) - \mathrm{Cov}(X,Z)\mathrm{Cov}(X,Y)}{\mathrm{Var}(Z)\mathrm{Var}(X) - \mathrm{Cov}(Z,X)^2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1523em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9579em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.05278em;">&#x3B2;</span></span><span style="top:-3.2634em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1667em;"><span class="mord">^</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.363em;vertical-align:-0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">Var</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mclose">)</span><span class="mord"><span class="mord mathrm">Var</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">Cov</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">Var</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mclose">)</span><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">Cov</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">Cov</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mclose">)</span><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">Cov</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>In large experiments <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">C</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">v</mi></mrow><mo stretchy="false">(</mo><mi>X</mi><mo separator="true">,</mo><mi>Z</mi><mo stretchy="false">)</mo><mo>&#x2248;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\mathrm{Cov}(X,Z) \approx 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">Cov</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&#x2248;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span> because <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Z</mi></mrow><annotation encoding="application/x-tex">Z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span></span></span></span> is randomly
assigned and is thus independent of background variables like <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span>. However in any given finite sized experiment <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">C</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">v</mi></mrow><mo stretchy="false">(</mo><mi>X</mi><mo separator="true">,</mo><mi>Z</mi><mo stretchy="false">)</mo><mo mathvariant="normal">&#x2260;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\mathrm{Cov}(X,Z) \ne 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">Cov</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel"><span class="mrel"><span class="mord vbox"><span class="thinbox"><span class="rlap"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="inner"><span class="mord"><span class="mrel">&#xE020;</span></span></span><span class="fix"></span></span></span></span></span><span class="mrel">=</span></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span>, so this does not reduce to an unbiased estimator as it does in the bivariate case. Thus, <span class="citation">Freedman (<a href="#ref-freedman2008rae">2008</a><a href="#ref-freedman2008rae">a</a>)</span> showed that there is a risk of bias in using the equation above to estimate the average treatment effect. In contrast, the unadjusted difference in means will be unbiased.</p>
<p>As discussed above, this kind of covariance adjustment will also sometimes counterproductively decrease asmyptotic efficiency relative to an unadjusted difference in means, or may simply fail to improve efficiency as much as we hope. To resolve that issue, <span class="citation">Lin (<a href="#ref-lin_agnostic_2013">2013</a>)</span> suggests the following least squares approach&#x2014;regressing the outcome on binary treatment assignment <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Z</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">Z_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> and its interaction with mean-centered covariates:<a href="references.html#fn23" class="footnote-ref" id="fnref23"><sup>23</sup></a></p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.16em" columnspacing="1em"><mtr><mtd class="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><msub><mi>Y</mi><mi>i</mi></msub><mo>=</mo><msub><mi>&#x3B2;</mi><mn>0</mn></msub><mo>+</mo><msub><mi>&#x3B2;</mi><mn>1</mn></msub><msub><mi>Z</mi><mi>i</mi></msub><mo>+</mo><msub><mi>&#x3B2;</mi><mn>2</mn></msub><mo stretchy="false">(</mo><msub><mi>X</mi><mi>i</mi></msub><mo>&#x2212;</mo><mover accent="true"><mi>X</mi><mo>&#x2C9;</mo></mover><mo stretchy="false">)</mo><mo>+</mo><msub><mi>&#x3B2;</mi><mn>3</mn></msub><msub><mi>Z</mi><mi>i</mi></msub><mo stretchy="false">(</mo><msub><mi>X</mi><mi>i</mi></msub><mo>&#x2212;</mo><mover accent="true"><mi>X</mi><mo>&#x2C9;</mo></mover><mo stretchy="false">)</mo><mo>+</mo><msub><mi>e</mi><mi>i</mi></msub></mrow></mstyle></mtd><mtd class="mtr-glue"></mtd><mtd class="mml-eqn-num"></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{equation}
Y_i = \beta_0 + \beta_1 Z_i + \beta_2 ( X_i - \bar{X} ) + \beta_3 Z_i (X_i - \bar{X}) +  e_i
\end{equation}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2em;vertical-align:-0.35em;"></span><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.85em;"><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">&#x3B2;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">&#x3B2;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">&#x3B2;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8201em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span><span style="top:-3.2523em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1667em;"><span class="mord">&#x2C9;</span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">&#x3B2;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8201em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span><span style="top:-3.2523em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1667em;"><span class="mord">&#x2C9;</span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.35em;"><span></span></span></span></span></span></span></span><span class="tag"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.85em;"><span style="top:-2.85em;"><span class="pstrut" style="height:2.84em;"></span><span class="eqn-num"></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.35em;"><span></span></span></span></span></span></span></span></span></p>
<p>When implementing this covariance adjustment strategy, remember that every covariate, <em>including binary indicators used to estimate fixed effects or to control for values of categorical covariates</em>, should be mean-centered and interacted with treatment.</p>
<p>For instance, imagine a design with two treatment arms (treatment vs control) and three covariates. Linear adjustment for these covariates would involve fitting an OLS regression with <em>four</em> slope coefficients (one for the treatment group, and one for each covariate). Lin adjustment for these covariates would instead involve fitting a regression with <em>seven</em> slope coefficients (one for the treatment group, one for each mean-centered covariate, and one for each interaction of treatment with a mean-centered covariate).<a href="references.html#fn24" class="footnote-ref" id="fnref24"><sup>24</sup></a></p>
<p>See the <a href="https://alexandercoppock.com/Green-Lab-SOP/Green_Lab_SOP.html#using-covariates-in-analysis">Green-Lin-Coppock SOP</a> for more examples of this approach to covariance adjustment. While both <span class="citation">Lin (<a href="#ref-lin_agnostic_2013">2013</a>)</span> and <span class="citation">Freedman (<a href="#ref-freedman2008rae">2008</a><a href="#ref-freedman2008rae">a</a>)</span> focus on a design based framework, <span class="citation">Negi and Wooldridge (<a href="#ref-negi2021revisiting">2021</a>)</span> discuss the Lin estimator (&#x201C;full regression adjustment&#x201D;) in a more traditional sampling based framework.</p>
</div>
<div id="illustrating-the-lin-approach-to-covariance-adjustment" class="section level3">
<h3><span class="header-section-number">5.3.2</span> Illustrating the Lin Approach to Covariance Adjustment</h3>
<p>Here, we show how typical covariance adjustment can lead to bias or inefficiency in estimation of the average treatment effect, increasing the overall RMSE (root mean squared error, which is influenced by both bias and variance)&#x2014;and how using the Lin procedure (or increasing sample size) can reduce the RMSE. In this case, we compare an experiment with 20 units to an experiement with 100 units, in each case with half of the units assigned to treatment by complete random assignment.</p>
<p>We&#x2019;ll use the <a href="https://declaredesign.org/">DeclareDesign</a> package in the R code to make this process of writing a simulation to assess bias easier.<a href="references.html#fn25" class="footnote-ref" id="fnref25"><sup>25</sup></a> Much of the R code that follows is providing instructions to the <code>diagnose_design</code> command, which repeats the design of the experiment many times, each time estimating an average treatment effect, and comparing the mean of those estimate to the truth (labeled &#x201C;Mean Estimand&#x201D; below). We also provide code illustrating how you could accomplish something similar in Stata using manually defined programs and the <code>simulate</code> command.</p>
<p>The true potential outcomes in these example data (<code>y1</code> and <code>y0</code>) were generated using one covariate, called <code>cov2</code>, with no treatment effect. In what follows, we compare the performance of (1) the simple estimator using OLS to (2) estimators that use Lin&#x2019;s procedure involving just the correct covariate, and also to (3) estimators that use incorrect covariates (since we rarely know exactly the covariates that help generate any given behavioral outcome).</p>
<p>We&#x2019;ll break this code up into sections to help with legibility. First, in R, we prepare <code>design</code> objects (a class used by <code>DeclareDesign</code>) for the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>=</mo><mn>20</mn></mrow><annotation encoding="application/x-tex">n=20</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">20</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>=</mo><mn>100</mn></mrow><annotation encoding="application/x-tex">n=100</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">100</span></span></span></span> designs. Meanwhile, in Stata, we write a program to randomly generate a sample dataset; this program will then be iterated below. In both the R and Stata simulations, we follow a design-based philosophy in which randomness in our estimates across simulations comes only from variation in treatment assignment.</p>
<div class="tab">
<button class="tablinks" onclick="unrolltab(event, &apos;ch5R15&apos;)">
R code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Stata15&apos;)">
Stata code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Hide15&apos;)">
Hide
</button>
<div id="ch5R15" class="tabcontent">
<p><br></p>
<pre class="text"><code>## Keep a dataframe of select variables
wrkdat1 &lt;- dat1 %&gt;% dplyr::select(id,y1,y0,contains(&quot;cov&quot;))

## Declare this as our larger population
## (an experimental sample of 100 units)
popbigdat1 &lt;- declare_population(wrkdat1)

## A dataset to represent a smaller experiment,
## or a cluster randomized experiment with few clusters
## (an experimental sample of 20 units)
set.seed(12345)
smalldat1 &lt;- dat1 %&gt;% dplyr::select(id,y1,y0,contains(&quot;cov&quot;)) %&gt;% sample_n(20)

## Now declare the different inputs for DeclareDesign
## (declare the smaller population, and assign treatment in each)
popsmalldat1 &lt;- declare_population(smalldat1)
assignsmalldat1 &lt;- declare_assignment(Znew=complete_ra(N,prob=0.5))
assignbigdat1 &lt;- declare_assignment(Znew=complete_ra(N,prob=0.5))

## No additional treatment effects
## (potential outcomes)
po_functionNull &lt;- function(data){
    data$Y_Znew_0 &lt;- data$y0
    data$Y_Znew_1 &lt;- data$y1
    data
}

## A few additional declare design settings
ysdat1  &lt;- declare_potential_outcomes(handler = po_functionNull)
theestimanddat1 &lt;- declare_inquiry(ATE = mean(Y_Znew_1 - Y_Znew_0))
theobsidentdat1 &lt;- declare_reveal(Y, Znew)

## The smaller sample design
thedesignsmalldat1 &lt;- popsmalldat1 + assignsmalldat1 + ysdat1 + theestimanddat1 + theobsidentdat1

## The larger sample design
thedesignbigdat1 &lt;- popbigdat1 + assignbigdat1 + ysdat1 + theestimanddat1 + theobsidentdat1</code></pre>
</div>
<div id="ch5Stata15" class="tabcontent">
<p><br></p>
<pre class="text"><code>** Preserve the running dataset used so far.
save main.dta, replace

** Keep a dataframe of select variables.
keep id y1 y0 cov*

** A dataset to represent a smaller experiment,
** or a cluster randomized experiment with few clusters
** (an experimental sample of 20 units).
** Only done for illustration here. In practice, we&apos;ll use the data
** generated in the R code for the sake of comparison.
set seed 12345
gen rand = runiform()
sort rand
keep in 1/20
drop rand

** Define a program to load one of these datasets
** and then randomly re-assign treatment.
capture program drop sample_from
program define sample_from, rclass

    syntax[ , smaller ///
        propsimtreat(real 0.5) ]
    
    * Which dataset to use?
    if &quot;`smaller&apos;&quot; != &quot;&quot; import delimited using &quot;smalldat1.csv&quot;, clear
    else import delimited using &quot;popbigdat1.csv&quot;, clear
    
    * Make sure propsimtreat is a proportion
    if `propsimtreat&apos; &gt; 1 | `propsimtreat&apos; &lt; 0 {
        di as error &quot;Check input: propsimtreat&quot;
        exit
    }
    
    * Re-assign (simulated) treatment in this draw of the data
    complete_ra znew, prob(`propsimtreat&apos;)
    
    * No additional treatment effects
    * (assigning new potential outcomes)
    gen y_znew_0 = y0
    gen y_znew_1 = y1
    
    * Save the true ATE
    gen true_effect = y_znew_1 - y_znew_0
    qui sum true_effect, meanonly
    return scalar ATE = r(mean)
    
    * Get the revealed outcome
    gen ynew = (znew * y_znew_1) + ((1 - znew) * y_znew_0)

end</code></pre>
</div>
<div id="ch5Hide15" class="tabcontent">

</div>
</div>
<p>Next, in R, we&#x2019;ll prepare a list of estimators (i.e., models) we want to compare. These include different numbers of (potentially incorrect) covariates, with and without Lin (2013) adjustment. Similarly, in Stata, we&#x2019;ll write another program that generates a single dataset and then applies the same list of estimators to it, saving key results from each.</p>
<div class="tab">
<button class="tablinks" onclick="unrolltab(event, &apos;ch5R16&apos;)">
R code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Stata16&apos;)">
Stata code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Hide16&apos;)">
Hide
</button>
<div id="ch5R16" class="tabcontent">
<p><br></p>
<pre class="text"><code>## Declare a selection of different estimation strategies
estCov0 &lt;- declare_estimator(Y~Znew, inquiry=theestimanddat1, .method=lm_robust, label=&quot;CovAdj0: Lm, No Covariates&quot;)
estCov1 &lt;- declare_estimator(Y~Znew+cov2, inquiry=theestimanddat1, .method=lm_robust, label=&quot;CovAdj1: Lm, Correct Covariate&quot;)
estCov2 &lt;- declare_estimator(Y~Znew+cov1+cov2+cov3+cov4+cov5+cov6+cov7+cov8, inquiry=theestimanddat1, .method=lm_robust, label=&quot;CovAdj2: Lm, Mixed Covariates&quot;)
estCov3 &lt;- declare_estimator(Y~Znew+cov1+cov3+cov4+cov5+cov6, inquiry=theestimanddat1, .method=lm_robust, label=&quot;CovAdj3: Lm, Wrong Covariates&quot;)
estCov4 &lt;- declare_estimator(Y~Znew,covariates=~cov1+cov2+cov3+cov4+cov5+cov6+cov7+cov8, inquiry=theestimanddat1, .method=lm_lin, label=&quot;CovAdj4: Lin, Mixed Covariates&quot;)
estCov5 &lt;- declare_estimator(Y~Znew,covariates=~cov2, inquiry=theestimanddat1, .method=lm_lin, label=&quot;CovAdj5: Lin, Correct Covariate&quot;)

## List them all together
all_estimators &lt;- estCov0 + estCov1 + estCov2 + estCov3 + estCov4 + estCov5</code></pre>
</div>
<div id="ch5Stata16" class="tabcontent">
<p><br></p>
<pre class="text"><code>** Define a program to apply various estimation strategies
** to a dataset drawn using the program defined above.
capture program drop apply_estimators
program define apply_estimators, rclass

    ** Same arguments as above
    syntax[, smaller ///
        propsimtreat(real 0.5) ]
        
    ** Call the program above
    sample_from, `smaller&apos; propsimtreat(`propsimtreat&apos;)
    return scalar ATE = r(ATE)

    ** CovAdj0: Lm, No Covariates
    qui reg ynew znew, vce(hc2)
    return scalar CovAdj0_est = _b[znew]
    return scalar CovAdj0_p = r(table)[&quot;pvalue&quot;, &quot;znew&quot;]
    
    ** CovAdj1: Lm, Correct Covariate
    qui reg ynew znew cov2, vce(hc2)
    return scalar CovAdj1_est = _b[znew]
    return scalar CovAdj1_p = r(table)[&quot;pvalue&quot;, &quot;znew&quot;]
    
    ** CovAdj2: Lm, Mixed Covariates
    qui reg ynew znew cov1-cov8, vce(hc2)
    return scalar CovAdj2_est = _b[znew]
    return scalar CovAdj2_p = r(table)[&quot;pvalue&quot;, &quot;znew&quot;]
    
    ** CovAdj3: Lm, Wrong Covariates
    qui reg ynew znew cov1 cov3-cov6, vce(hc2)
    return scalar CovAdj3_est = _b[znew]
    return scalar CovAdj3_p = r(table)[&quot;pvalue&quot;, &quot;znew&quot;]
    
    ** CovAdj4: Lin, Mixed Covariates
    qui reg ynew znew cov1-cov8 // to make a sample indicator
    gen samp = e(sample) // ensure correct obs are used in mean-centering
    foreach var of varlist cov1-cov8 {
        qui sum `var&apos; if samp == 1, meanonly
        qui gen mc_`var&apos; = `var&apos; - `r(mean)&apos; if samp == 1
    }
    qui reg ynew i.znew##c.(mc_*), vce(hc2)
    return scalar CovAdj4_est = _b[1.znew]
    return scalar CovAdj4_p = r(table)[&quot;pvalue&quot;, &quot;1.znew&quot;]
    drop mc_* samp
    
    ** CovAdj5: Lin, Correct Covariate
    qui reg ynew znew cov2
    gen samp = e(sample)
    foreach var of varlist cov2 {
        qui sum `var&apos; if samp == 1, meanonly
        qui gen mc_`var&apos; = `var&apos; - `r(mean)&apos; if samp == 1
    }
    qui reg ynew i.znew##c.(mc_*), vce(hc2)
    return scalar CovAdj5_est = _b[1.znew]
    return scalar CovAdj5_p = r(table)[&quot;pvalue&quot;, &quot;1.znew&quot;]
    drop mc_* samp

end</code></pre>
</div>
<div id="ch5Hide16" class="tabcontent">

</div>
</div>
<p>After this, as a last step in R, we&#x2019;ll add those estimators to our <code>design</code> class objects.</p>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb134-1" title="1"><span class="co">## Smaller sample</span></a>
<a class="sourceLine" id="cb134-2" title="2">thedesignsmalldat1PlusEstimators &lt;-<span class="st"> </span>thedesignsmalldat1 <span class="op">+</span><span class="st"> </span>all_estimators</a>
<a class="sourceLine" id="cb134-3" title="3"></a>
<a class="sourceLine" id="cb134-4" title="4"><span class="co">## Larger sample</span></a>
<a class="sourceLine" id="cb134-5" title="5">thedesignbigdat1PlusEstimators &lt;-<span class="st"> </span>thedesignbigdat1 <span class="op">+</span><span class="st"> </span>all_estimators</a></code></pre></div>
<p>Now, let&#x2019;s simulate each design 200 times and evaluate their performance. First, the smaller sample:</p>
<div class="tab">
<button class="tablinks" onclick="unrolltab(event, &apos;ch5R17&apos;)">
R code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Stata17&apos;)">
Stata code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Hide17&apos;)">
Hide
</button>
<div id="ch5R17" class="tabcontent">
<p><br></p>
<pre class="text"><code>## Summarize characteristics of the smaller-sample designs
sims &lt;- 200
set.seed(12345)
thediagnosisCovAdj1 &lt;- diagnose_design(
  thedesignsmalldat1PlusEstimators,
  sims = sims,
  bootstrap_sims = 0
  )</code></pre>
</div>
<div id="ch5Stata17" class="tabcontent">
<p><br></p>
<pre class="text"><code>** Call the program once just to make a list of scalars to save
apply_estimators, smaller
local rscalars: r(scalars) // Save all scalars in r() to a local
local to_store &quot;&quot; // Update them in a loop to work properly in simulate
foreach item of local rscalars {
  local to_store &quot;`to_store&apos; `item&apos; = r(`item&apos;)&quot;
}

** Summarize characteristics of the smaller-sample designs
set seed 12345
simulate ///
`to_store&apos;, ///
reps(200): ///
apply_estimators, smaller

** Create summary matrix
qui des, short // saves number of columns to r()
matrix diagnosands = J((r(k) - 1)/2, 6, .)
matrix rownames diagnosands = &quot;Lm, No Covariates&quot; &quot;Lm, Correct Covariate&quot; &quot;Lm, Mixed Covariates&quot; &quot;Lm, Wrong Covariates&quot; &quot;Lin, Mixed Covariates&quot; &quot;Lin, Correct Covariate&quot;
matrix colnames diagnosands = &quot;Mean estimand&quot; &quot;Mean estimate&quot; &quot;Bias&quot; &quot;SD Estimate&quot; &quot;RMSE&quot; &quot;Power&quot;

** Calculate quantities to include
** (https://declaredesign.org/r/declaredesign/reference/declare_diagnosands.html)
local row = 0
forvalues i = 0/5 {
    
    local ++row
    
    * Estimand
    qui sum ATE, meanonly
    matrix diagnosands[`row&apos;, 1] = r(mean)
    
    * Estimate
    qui sum CovAdj`i&apos;_est, meanonly
    matrix diagnosands[`row&apos;, 2] = r(mean)
    
    * Bias
    qui gen biascalc = CovAdj`i&apos;_est - ATE
    qui sum biascalc, meanonly
    matrix diagnosands[`row&apos;, 3] = r(mean)
    drop biascalc
    
    * SD estimate (based on population variance, no n-1 in the variance denom.)
    qui sum CovAdj`i&apos;_est
    qui gen sdcalc = (CovAdj`i&apos;_est - r(mean))^2
    qui sum sdcalc
    matrix diagnosands[`row&apos;, 4] = sqrt(r(sum)/r(N))
    drop sdcalc
    
    * RMSE
    gen atediff = (CovAdj`i&apos;_est - ATE)^2
    qui sum atediff, meanonly
    matrix diagnosands[`row&apos;, 5] = sqrt(r(mean))
    drop atediff
    
    * Power
    gen rejectnull = CovAdj`i&apos;_p &lt;= 0.05
    qui sum rejectnull, meanonly
    matrix diagnosands[`row&apos;, 6] = r(mean)
    drop rejectnull
    
}

* View the results
matrix list diagnosands</code></pre>
</div>
<div id="ch5Hide17" class="tabcontent">

</div>
</div>
<p>Second, the larger sample:</p>
<div class="tab">
<button class="tablinks" onclick="unrolltab(event, &apos;ch5R18&apos;)">
R code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Stata18&apos;)">
Stata code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Hide18&apos;)">
Hide
</button>
<div id="ch5R18" class="tabcontent">
<p><br></p>
<pre class="text"><code>## Summarize characteristics of the larger-sample designs
set.seed(12345)
thediagnosisCovAdj2 &lt;- diagnose_design(
  thedesignbigdat1PlusEstimators,
  sims = sims,
  bootstrap_sims = 0
  )</code></pre>
</div>
<div id="ch5Stata18" class="tabcontent">
<p><br></p>
<pre class="text"><code>** Summarize characteristics of the large-sample designs
apply_estimators
local rscalars : r(scalars)
local to_store &quot;&quot;
foreach item of local rscalars {
  local to_store &quot;`to_store&apos; `item&apos; = r(`item&apos;)&quot;
}
simulate ///
`to_store&apos;, ///
reps(200): ///
apply_estimators

** Create summary matrix
qui des, short // get number of columns in r()
matrix diagnosands = J((r(k) - 1)/2, 6, .)
matrix rownames diagnosands = &quot;Lm, No Covariates&quot; &quot;Lm, Correct Covariate&quot; &quot;Lm, Mixed Covariates&quot; &quot;Lm, Wrong Covariates&quot; &quot;Lin, Mixed Covariates&quot; &quot;Lin, Correct Covariate&quot;
matrix colnames diagnosands = &quot;Mean estimand&quot; &quot;Mean estimate&quot; &quot;Bias&quot; &quot;SD Estimate&quot; &quot;RMSE&quot; &quot;Power&quot;

** Calculate quantities to include
local row = 0
forvalues i = 0/5 {
    
    local ++row
    
    * Estimand
    qui sum ATE, meanonly
    matrix diagnosands[`row&apos;, 1] = r(mean)
    
    * Estimate
    qui sum CovAdj`i&apos;_est, meanonly
    matrix diagnosands[`row&apos;, 2] = r(mean)
    
    * Bias
    qui gen biascalc = CovAdj`i&apos;_est - ATE
    qui sum biascalc, meanonly
    matrix diagnosands[`row&apos;, 3] = r(mean)
    drop biascalc
    
    * SD estimate (based on population variance, no n-1 in the variance denom.)
    qui sum CovAdj`i&apos;_est
    qui gen sdcalc = (CovAdj`i&apos;_est - r(mean))^2
    qui sum sdcalc
    matrix diagnosands[`row&apos;, 4] = sqrt(r(sum)/r(N))
    drop sdcalc
    
    * RMSE
    gen atediff = (CovAdj`i&apos;_est - ATE)^2
    qui sum atediff, meanonly
    matrix diagnosands[`row&apos;, 5] = sqrt(r(mean))
    drop atediff
    
    * Power
    gen rejectnull = CovAdj`i&apos;_p &lt;= 0.05
    qui sum rejectnull, meanonly
    matrix diagnosands[`row&apos;, 6] = r(mean)
    drop rejectnull
    
}

* View the results
matrix list diagnosands</code></pre>
</div>
<div id="ch5Hide18" class="tabcontent">

</div>
</div>
<p>From the small sample simulation (N=20), we can see that &#x201C;CovAdj1: Lm, Correct Covariate&#x201D; shows more bias compared than the estimator using no covariates at all. The Lin approach using only the correct covariate reduces the bias in this case, but does not erase it. Though it is unbiased, the unadjusted estimator has fairly low power where as the Lin approach with the correct covariate &#x201C;CovAdj5: Lin, Correct Covariate&#x201D; has excellent power to detect the 1 SD effect built into this experiment. One interesting result here is that the Lin approach is worst (in terms of RMSE) when a mixture of correct and incorrect covariates are added to the linear model following the interaction-and-centering based approach. This illustrates a point mentioned above: as the number of parameters becomes large relative to the sample size (e.g., in small samples, or in moderate sized samples with a complex model), the efficiency costs from reducing the degrees of of freedom may not be worth the asymptotic efficiency advantages of Lin adjustment, particularly when we do not know if the covariates are actually prognostic.</p>
<table>
<thead>
<tr>
<th style="text-align:left;">
Estimator
</th>
<th style="text-align:left;">
Term
</th>
<th style="text-align:left;">
Mean Estimand
</th>
<th style="text-align:left;">
Mean Estimate
</th>
<th style="text-align:left;">
Bias
</th>
<th style="text-align:left;">
SD Estimate
</th>
<th style="text-align:left;">
RMSE
</th>
<th style="text-align:left;">
Power
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
CovAdj0: Lm, No Covariates
</td>
<td style="text-align:left;">
Znew
</td>
<td style="text-align:left;">
5.03
</td>
<td style="text-align:left;">
4.93
</td>
<td style="text-align:left;">
-0.10
</td>
<td style="text-align:left;">
1.89
</td>
<td style="text-align:left;">
1.89
</td>
<td style="text-align:left;">
0.64
</td>
</tr>
<tr>
<td style="text-align:left;">
CovAdj1: Lm, Correct Covariate
</td>
<td style="text-align:left;">
Znew
</td>
<td style="text-align:left;">
5.03
</td>
<td style="text-align:left;">
5.32
</td>
<td style="text-align:left;">
0.29
</td>
<td style="text-align:left;">
1.22
</td>
<td style="text-align:left;">
1.25
</td>
<td style="text-align:left;">
0.97
</td>
</tr>
<tr>
<td style="text-align:left;">
CovAdj2: Lm, Mixed Covariates
</td>
<td style="text-align:left;">
Znew
</td>
<td style="text-align:left;">
5.03
</td>
<td style="text-align:left;">
5.12
</td>
<td style="text-align:left;">
0.09
</td>
<td style="text-align:left;">
1.36
</td>
<td style="text-align:left;">
1.36
</td>
<td style="text-align:left;">
0.94
</td>
</tr>
<tr>
<td style="text-align:left;">
CovAdj3: Lm, Wrong Covariates
</td>
<td style="text-align:left;">
Znew
</td>
<td style="text-align:left;">
5.03
</td>
<td style="text-align:left;">
5.07
</td>
<td style="text-align:left;">
0.04
</td>
<td style="text-align:left;">
1.78
</td>
<td style="text-align:left;">
1.78
</td>
<td style="text-align:left;">
0.80
</td>
</tr>
<tr>
<td style="text-align:left;">
CovAdj4: Lin, Mixed Covariates
</td>
<td style="text-align:left;">
Znew
</td>
<td style="text-align:left;">
5.03
</td>
<td style="text-align:left;">
5.10
</td>
<td style="text-align:left;">
0.07
</td>
<td style="text-align:left;">
2.47
</td>
<td style="text-align:left;">
2.46
</td>
<td style="text-align:left;">
0.42
</td>
</tr>
<tr>
<td style="text-align:left;">
CovAdj5: Lin, Correct Covariate
</td>
<td style="text-align:left;">
Znew
</td>
<td style="text-align:left;">
5.03
</td>
<td style="text-align:left;">
5.17
</td>
<td style="text-align:left;">
0.14
</td>
<td style="text-align:left;">
1.13
</td>
<td style="text-align:left;">
1.13
</td>
<td style="text-align:left;">
0.97
</td>
</tr>
</tbody>
</table>
<p>The experiment with <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>=</mo><mn>100</mn></mrow><annotation encoding="application/x-tex">N=100</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">100</span></span></span></span> shows much smaller bias than the other experiment above. Since all estimators allow us to detect the 1 SD effect (Power=1), we can look to the RMSE column to weigh the overall performance of these estimators. Bias is lower in general, and the unadjusted approach is the least precise (SD Estimate), followed by linear covariance adjustment for the wrong covariates. In this example, the rest of the estimators all perform similarly (illustrating a point above: treatment assignment here is balanced, so the precision benefits of Lin adjustment should be lower).</p>
<table>
<thead>
<tr>
<th style="text-align:left;">
Estimator
</th>
<th style="text-align:left;">
Term
</th>
<th style="text-align:left;">
Mean Estimand
</th>
<th style="text-align:left;">
Mean Estimate
</th>
<th style="text-align:left;">
Bias
</th>
<th style="text-align:left;">
SD Estimate
</th>
<th style="text-align:left;">
RMSE
</th>
<th style="text-align:left;">
Power
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
CovAdj0: Lm, No Covariates
</td>
<td style="text-align:left;">
Znew
</td>
<td style="text-align:left;">
5.45
</td>
<td style="text-align:left;">
5.39
</td>
<td style="text-align:left;">
-0.06
</td>
<td style="text-align:left;">
0.73
</td>
<td style="text-align:left;">
0.73
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
CovAdj1: Lm, Correct Covariate
</td>
<td style="text-align:left;">
Znew
</td>
<td style="text-align:left;">
5.45
</td>
<td style="text-align:left;">
5.44
</td>
<td style="text-align:left;">
-0.02
</td>
<td style="text-align:left;">
0.46
</td>
<td style="text-align:left;">
0.46
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
CovAdj2: Lm, Mixed Covariates
</td>
<td style="text-align:left;">
Znew
</td>
<td style="text-align:left;">
5.45
</td>
<td style="text-align:left;">
5.46
</td>
<td style="text-align:left;">
0.01
</td>
<td style="text-align:left;">
0.47
</td>
<td style="text-align:left;">
0.46
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
CovAdj3: Lm, Wrong Covariates
</td>
<td style="text-align:left;">
Znew
</td>
<td style="text-align:left;">
5.45
</td>
<td style="text-align:left;">
5.43
</td>
<td style="text-align:left;">
-0.02
</td>
<td style="text-align:left;">
0.60
</td>
<td style="text-align:left;">
0.60
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
CovAdj4: Lin, Mixed Covariates
</td>
<td style="text-align:left;">
Znew
</td>
<td style="text-align:left;">
5.45
</td>
<td style="text-align:left;">
5.45
</td>
<td style="text-align:left;">
-0.01
</td>
<td style="text-align:left;">
0.47
</td>
<td style="text-align:left;">
0.47
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
CovAdj5: Lin, Correct Covariate
</td>
<td style="text-align:left;">
Znew
</td>
<td style="text-align:left;">
5.45
</td>
<td style="text-align:left;">
5.42
</td>
<td style="text-align:left;">
-0.03
</td>
<td style="text-align:left;">
0.46
</td>
<td style="text-align:left;">
0.46
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
</tbody>
</table>
<p>The Lin approach works well when covariates are few and sample sizes
are larger, but these simulations show where the approach is weaker: when there are many covariates relative to the number of observations, some of which may not actually be correlated with the outcome. In this case, the estimator involving both correct and irrelevant covariates included 18 terms. Fitting a model with 18 terms using a small sample, e.g.&#xA0;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>=</mo><mn>20</mn></mrow><annotation encoding="application/x-tex">N=20</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">20</span></span></span></span>, allows nearly any observation to exert undue influence, increases the risk of serious multicollinearity, and leads to overfitting problems in general.</p>
<p>Our team does not often run into such an extreme version of this problem because our studies have tended to involve many thousands of units and relatively few covariates. However, when we do encounter situations where the number of covariates (or fixed effects) we&#x2019;d like to account for is large relative to the sample size, we consider a few alternative approaches: (1) omitting some covariates; (2) standard linear covariate adjustment; (3) collapsing the covariates into fewer dimensions (e.g., using principal component analysis); or (4) working with a residualized version of the outcome, as described below.</p>
</div>
<div id="the-rosenbaum-approach-to-covariance-adjustment" class="section level3">
<h3><span class="header-section-number">5.3.3</span> The Rosenbaum Approach to Covariance Adjustment</h3>
<p><span class="citation">Rosenbaum (<a href="#ref-rosenbaum:2002a">2002</a>)</span> suggests an alternative approach in which the outcomes are regressed on covariates, ignoring treatment assignment, and then the residuals from that first regression are used as the outcome in a second regression to estimate an average treatment effect. Again, we evaluate this approach through simulation.</p>
<p>First, code we use to generate Rosenbaum (2002) estimators:</p>
<div class="tab">
<button class="tablinks" onclick="unrolltab(event, &apos;ch5R19&apos;)">
R code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Stata19&apos;)">
Stata code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Hide19&apos;)">
Hide
</button>
<div id="ch5R19" class="tabcontent">
<p><br></p>
<pre class="text"><code>## The argument covs is a character vector of names of covariates.
## The function below generates a separate estimation command 
## that performs Rosenbaum (2002) adjustment for the specified
## covariates, given a sample of data. This new function can
## then by used as an estimator in simulations below. This code
## takes advantage of the concept of &quot;function factories.&quot;
## See, e.g.: https://adv-r.hadley.nz/function-factories.html.
make_est_fun&lt;-function(covs){
  
  force(covs)
  
  ## Generate a formula from the character vector of covariates
  covfmla &lt;- reformulate(covs,response=&quot;Y&quot;)
  
  ## What the new function to-be-generated will do,
  ## given the model generated above:
  function(data){
    data$e_y &lt;- residuals(lm(covfmla,data=data))
    obj &lt;- lm_robust(e_y~Znew,data=data)
    res &lt;- tidy(obj) %&gt;% filter(term==&quot;Znew&quot;)
    return(res)
    }
  
  }

## Make Rosenbaum (2002) estimators for different groups of covariates
est_fun_correct &lt;- make_est_fun(&quot;cov2&quot;)
est_fun_mixed&lt;- make_est_fun(c(&quot;cov1&quot;,&quot;cov2&quot;,&quot;cov3&quot;,&quot;cov4&quot;,&quot;cov5&quot;,&quot;cov6&quot;,&quot;cov7&quot;,&quot;cov8&quot;))
est_fun_incorrect &lt;- make_est_fun(c(&quot;cov1&quot;,&quot;cov3&quot;,&quot;cov4&quot;,&quot;cov5&quot;,&quot;cov6&quot;))

## Declare additional estimators, to add to the designs above
estCov6 &lt;- declare_estimator(handler = label_estimator(est_fun_correct), inquiry=theestimanddat1, label=&quot;CovAdj6: Resid, Correct&quot;)
estCov7 &lt;- declare_estimator(handler = label_estimator(est_fun_mixed), inquiry=theestimanddat1, label=&quot;CovAdj7: Resid, Mixed&quot;)
estCov8 &lt;- declare_estimator(handler = label_estimator(est_fun_incorrect), inquiry=theestimanddat1, label=&quot;CovAdj8: Resid, Incorrect&quot;)

## Add the additional estimators
thedesignsmalldat1PlusRoseEstimators &lt;- thedesignsmalldat1 + all_estimators + estCov6 + estCov7 + estCov8
thedesignbigdat1PlusRoseEstimators &lt;- thedesignbigdat1 + all_estimators + estCov6 + estCov7 + estCov8</code></pre>
</div>
<div id="ch5Stata19" class="tabcontent">
<p><br></p>
<pre class="text"><code>** Define a program to perform Rosenbaum estimation
* (with all variables specified in a varlist as in regress).
capture program drop rosenbaum_est
program define rosenbaum_est, rclass

    * Assumed structure of varlist: outcome treatment list_of_covariates.
    syntax varlist
    * Alternative 1: syntax, outcome(varname) treatment(varname) covar(varlist)
    * Alternative 2: syntax varlist, outcome(varname) treatment(varname)
    
    * Pull out first var of varlist as outcome
    tokenize `varlist&apos;
    local outcome `1&apos;
    macro shift
    
    * Pull out second var of varlist as treatment
    local treat_cov `*&apos;
    tokenize `treat_cov&apos;
    local treatment `1&apos;
    macro shift
    
    * The rest are treated as covariates
    local covar `*&apos;
    
    * Estimation
    reg `outcome&apos; `covar&apos;
    tempvar yhat
    predict `yhat&apos;, xb
    tempvar resid
    gen `resid&apos; = `outcome&apos; - `yhat&apos;
    reg `resid&apos; `treatment&apos;, vce(hc2)
    
    * Output
    return scalar out_est = _b[`treatment&apos;]
    return scalar out_p = r(table)[&quot;pvalue&quot;, &quot;`treatment&apos;&quot;]

end

** Program to apply this estimator to the generated data:
capture program drop apply_estimators_2
program define apply_estimators_2, rclass

    syntax[, smaller ///
        propsimtreat(real 0.5) ]
        
    ** Call the sample generation / random assignment program
    sample_from, `smaller&apos; propsimtreat(`propsimtreat&apos;)
    return scalar ATE = r(ATE)

    ** CovAdj6: Resid, Correct
    qui rosenbaum_est ynew znew cov2
    return scalar CovAdj6_est = r(out_est)
    return scalar CovAdj6_p = r(out_p)
    
    ** CovAdj7: Resid, Mixed
    qui rosenbaum_est ynew znew cov1-cov8
    return scalar CovAdj7_est = r(out_est)
    return scalar CovAdj7_p = r(out_p)
    
    ** CovAdj8: Resid, Incorrect
    qui rosenbaum_est ynew znew cov1 cov3-cov6
    return scalar CovAdj8_est = r(out_est)
    return scalar CovAdj8_p = r(out_p)

end</code></pre>
</div>
<div id="ch5Hide19" class="tabcontent">

</div>
</div>
<p>Second, we evaluate a design that applies those estimators to our smaller sample:</p>
<div class="tab">
<button class="tablinks" onclick="unrolltab(event, &apos;ch5R20&apos;)">
R code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Stata20&apos;)">
Stata code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Hide20&apos;)">
Hide
</button>
<div id="ch5R20" class="tabcontent">
<p><br></p>
<pre class="text"><code>set.seed(12345)
thediagnosisCovAdj3 &lt;- diagnose_design(
  thedesignsmalldat1PlusRoseEstimators,
  sims = sims,
  bootstrap_sims = 0
  )</code></pre>
</div>
<div id="ch5Stata20" class="tabcontent">
<p><br></p>
<pre class="text"><code>** Summarize characteristics of the smaller-sample designs
apply_estimators_2, smaller // Looking only at the rosenbaum estimators now
local rscalars : r(scalars)
local to_store &quot;&quot;
foreach item of local rscalars {
  local to_store &quot;`to_store&apos; `item&apos; = r(`item&apos;)&quot;
}
simulate ///
`to_store&apos;, ///
reps(200): ///
apply_estimators_2, smaller

** Create summary matrix
qui des, short
matrix diagnosands = J((`r(k)&apos; - 1)/2, 6, .)
matrix rownames diagnosands = &quot;Resid, Correct&quot; &quot;Resid, Mixed&quot; &quot;Resid, Incorrect&quot;
matrix colnames diagnosands = &quot;Mean estimand&quot; &quot;Mean estimate&quot; &quot;Bias&quot; &quot;SD Estimate&quot; &quot;RMSE&quot; &quot;Power&quot;

** Calculate quantities to include
local row = 0
forvalues i = 6/8 {
    
    local ++row
    
    * Estimand
    qui sum ATE, meanonly
    matrix diagnosands[`row&apos;, 1] = r(mean)
    
    * Estimate
    qui sum CovAdj`i&apos;_est, meanonly
    matrix diagnosands[`row&apos;, 2] = r(mean)
    
    * Bias
    qui gen biascalc = CovAdj`i&apos;_est - ATE
    qui sum biascalc, meanonly
    matrix diagnosands[`row&apos;, 3] = r(mean)
    drop biascalc
    
    * SD estimate (based on population variance, no n-1 in the variance denom.)
    qui sum CovAdj`i&apos;_est
    qui gen sdcalc = (CovAdj`i&apos;_est - r(mean))^2
    qui sum sdcalc
    matrix diagnosands[`row&apos;, 4] = sqrt(r(sum)/r(N))
    drop sdcalc
    
    * RMSE
    gen atediff = (CovAdj`i&apos;_est - ATE)^2
    qui sum atediff, meanonly
    matrix diagnosands[`row&apos;, 5] = sqrt(r(mean))
    drop atediff
    
    * Power
    gen rejectnull = CovAdj`i&apos;_p &lt;= 0.05
    qui sum rejectnull, meanonly
    matrix diagnosands[`row&apos;, 6] = r(mean)
    drop rejectnull
    
}

* View the results
matrix list diagnosands</code></pre>
</div>
<div id="ch5Hide20" class="tabcontent">

</div>
</div>
<p>Finally, we evaluate a design that applies those estimators (alongside the others above) to our larger sample:</p>
<div class="tab">
<button class="tablinks" onclick="unrolltab(event, &apos;ch5R21&apos;)">
R code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Stata21&apos;)">
Stata code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Hide21&apos;)">
Hide
</button>
<div id="ch5R21" class="tabcontent">
<p><br></p>
<pre class="text"><code>set.seed(12345)
thediagnosisCovAdj4 &lt;- diagnose_design(
  thedesignbigdat1PlusRoseEstimators,
  sims = sims,
  bootstrap_sims = 0
  )</code></pre>
</div>
<div id="ch5Stata21" class="tabcontent">
<p><br></p>
<pre class="text"><code>** Summarize characteristics of the larger-sample designs
apply_estimators_2 // Looking only at the rosenbaum estimators now
local rscalars : r(scalars)
local to_store &quot;&quot;
foreach item of local rscalars {
  local to_store &quot;`to_store&apos; `item&apos; = r(`item&apos;)&quot;
}
di &quot;`to_store&apos;&quot;
simulate ///
`to_store&apos;, ///
reps(200): ///
apply_estimators_2

** Create summary matrix
qui des, short
matrix diagnosands = J((`r(k)&apos; - 1)/2, 6, .)
matrix rownames diagnosands = &quot;Resid, Correct&quot; &quot;Resid, Mixed&quot; &quot;Resid, Incorrect&quot;
matrix colnames diagnosands = &quot;Mean estimand&quot; &quot;Mean estimate&quot; &quot;Bias&quot; &quot;SD Estimate&quot; &quot;RMSE&quot; &quot;Power&quot;

** Calculate quantities to include
local row = 0
forvalues i = 6/8 {
    
    local ++row
    
    * Estimand
    qui sum ATE, meanonly
    matrix diagnosands[`row&apos;, 1] = r(mean)
    
    * Estimate
    qui sum CovAdj`i&apos;_est, meanonly
    matrix diagnosands[`row&apos;, 2] = r(mean)
    
    * Bias
    qui gen biascalc = CovAdj`i&apos;_est - ATE
    qui sum biascalc, meanonly
    matrix diagnosands[`row&apos;, 3] = r(mean)
    drop biascalc
    
    * SD estimate (based on population variance, no n-1 in the variance denom.)
    qui sum CovAdj`i&apos;_est
    qui gen sdcalc = (CovAdj`i&apos;_est - r(mean))^2
    qui sum sdcalc
    matrix diagnosands[`row&apos;, 4] = sqrt(r(sum)/r(N))
    drop sdcalc
    
    * RMSE
    gen atediff = (CovAdj`i&apos;_est - ATE)^2
    qui sum atediff, meanonly
    matrix diagnosands[`row&apos;, 5] = sqrt(r(mean))
    drop atediff
    
    * Power
    gen rejectnull = CovAdj`i&apos;_p &lt;= 0.05
    qui sum rejectnull, meanonly
    matrix diagnosands[`row&apos;, 6] = r(mean)
    drop rejectnull
    
}

* View the results
matrix list diagnosands

* Return to main data from before the covariance adjustment simulations
use main.dta, clear
erase main.dta</code></pre>
</div>
<div id="ch5Hide21" class="tabcontent">

</div>
</div>
<p>With a small sample (N=20), the Rosenbaum-style approach yields very little
bias and quite high power using the correct covariate (&#x201C;CovAdj6: Resid,
Correct&#x201D;), but performs poorly in terms of bias and precision with incorrect
covariates.</p>
<table>
<thead>
<tr>
<th style="text-align:left;">
</th>
<th style="text-align:left;">
Estimator
</th>
<th style="text-align:left;">
Term
</th>
<th style="text-align:left;">
Mean Estimand
</th>
<th style="text-align:left;">
Mean Estimate
</th>
<th style="text-align:left;">
Bias
</th>
<th style="text-align:left;">
SD Estimate
</th>
<th style="text-align:left;">
RMSE
</th>
<th style="text-align:left;">
Power
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
7
</td>
<td style="text-align:left;">
CovAdj6: Resid, Correct
</td>
<td style="text-align:left;">
Znew
</td>
<td style="text-align:left;">
5.03
</td>
<td style="text-align:left;">
5.04
</td>
<td style="text-align:left;">
0.01
</td>
<td style="text-align:left;">
1.15
</td>
<td style="text-align:left;">
1.14
</td>
<td style="text-align:left;">
0.99
</td>
</tr>
<tr>
<td style="text-align:left;">
8
</td>
<td style="text-align:left;">
CovAdj7: Resid, Mixed
</td>
<td style="text-align:left;">
Znew
</td>
<td style="text-align:left;">
5.03
</td>
<td style="text-align:left;">
3.01
</td>
<td style="text-align:left;">
-2.01
</td>
<td style="text-align:left;">
1.06
</td>
<td style="text-align:left;">
2.28
</td>
<td style="text-align:left;">
0.84
</td>
</tr>
<tr>
<td style="text-align:left;">
9
</td>
<td style="text-align:left;">
CovAdj8: Resid, Incorrect
</td>
<td style="text-align:left;">
Znew
</td>
<td style="text-align:left;">
5.03
</td>
<td style="text-align:left;">
3.77
</td>
<td style="text-align:left;">
-1.25
</td>
<td style="text-align:left;">
1.38
</td>
<td style="text-align:left;">
1.86
</td>
<td style="text-align:left;">
0.76
</td>
</tr>
</tbody>
</table>
<p>With a larger experiment, the bias goes down, but coverage is still relatively worse when incorrect covariates are included. We speculate that performance might improve if we fit covariance adjustment models that produce residuals separately for the treated and control groups.</p>
<table>
<thead>
<tr>
<th style="text-align:left;">
</th>
<th style="text-align:left;">
Estimator
</th>
<th style="text-align:left;">
Term
</th>
<th style="text-align:left;">
Mean Estimand
</th>
<th style="text-align:left;">
Mean Estimate
</th>
<th style="text-align:left;">
Bias
</th>
<th style="text-align:left;">
SD Estimate
</th>
<th style="text-align:left;">
RMSE
</th>
<th style="text-align:left;">
Power
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
7
</td>
<td style="text-align:left;">
CovAdj6: Resid, Correct
</td>
<td style="text-align:left;">
Znew
</td>
<td style="text-align:left;">
5.45
</td>
<td style="text-align:left;">
5.38
</td>
<td style="text-align:left;">
-0.07
</td>
<td style="text-align:left;">
0.47
</td>
<td style="text-align:left;">
0.47
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
8
</td>
<td style="text-align:left;">
CovAdj7: Resid, Mixed
</td>
<td style="text-align:left;">
Znew
</td>
<td style="text-align:left;">
5.45
</td>
<td style="text-align:left;">
5.03
</td>
<td style="text-align:left;">
-0.42
</td>
<td style="text-align:left;">
0.48
</td>
<td style="text-align:left;">
0.64
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
9
</td>
<td style="text-align:left;">
CovAdj8: Resid, Incorrect
</td>
<td style="text-align:left;">
Znew
</td>
<td style="text-align:left;">
5.45
</td>
<td style="text-align:left;">
5.16
</td>
<td style="text-align:left;">
-0.30
</td>
<td style="text-align:left;">
0.60
</td>
<td style="text-align:left;">
0.67
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="how-to-choose-covariates-for-covariance-adjustment" class="section level2">
<h2><span class="header-section-number">5.4</span> How to choose covariates for covariance adjustment?</h2>
<p>Our analysis plans commonly specify a few covariates based on what we know about the mechanisms and context of the study. In general, if we have a measurement of the outcome <em>before the treatment was assigned</em> &#x2014; the baseline outcome &#x2014; we try to use it as a part of a blocking or covariance adjustment strategy.</p>
<p>When we have access to many covariates, we may sometimes use simple machine learning methods to select variables that strongly predict the outcome, such as a lasso model. In particular, we tend to prefer the <em>adaptive lasso</em> rather than a simple lasso because it has better theoretical properties <span class="citation">(Zou <a href="#ref-zou2006adaptive">2006</a>)</span>, but also because the adaptive lasso tends to produce sparser results &#x2014; and the bias from covariance adjustment can sometimes be significance if we include too many non-prognostic covariates.</p>
</div>
<div id="blockrandanalysis" class="section level2">
<h2><span class="header-section-number">5.5</span> Block-randomized trials</h2>
<p>We design block-randomized trials by splitting units into groups based on predefined characteristics &#x2014; covariates that cannot be changed by the experimental treatment &#x2014; and then randomly assigning treatment within each
group. We use this procedure when we want to increase our ability to detect
signal from noise. It assumes that the noise, or random variation in the outcome measure, is associated with the variables that we use to assign blocks. For example, if we imagine that patterns of energy use will tend to differ according to size of family, we may create blocks or strata of different family sizes and randomly assign an energy saving intervention separately within those blocks.</p>
<p>We also design block-randomized experiments when we want to assess effects within and across subgroups (for example, if we want to ensure that we have enough statistical power to detect a <em>difference in effects</em> between veterans and non-veterans). If we have complete random assignment, it is likely that the proportion of veterans assigned treatment will not be exactly same as the proportion of non-veterans receiving treatment. However, if we stratify or block the group on military status, and randomly assign treatment and control within each group, we can then ensure that equal proportions (or numbers) or veterans and non-veterans receive the treatment and control.</p>
<p>Most of the general ideas that we demonstrated in the context of completely randomized trials have direct analogues in the case of block randomized trials. The only additional question that arises with block randomized trials is about how to weight the contributions of each individual block when calculating an overall average treatment effect or testing an overall hypothesis about treatment effects. We begin with the simple case of testing the sharp null of no effects when we have a binary outcome &#x2014; in the case of a Cochran-Mantel-Haenszel test the weighting of different blocks is handled automatically.</p>
<div id="testing-binary-outcomes-under-block-randomization-cochran-mantel-haenszel-cmh-test-for-k-x-2-x-2-tables" class="section level3">
<h3><span class="header-section-number">5.5.1</span> Testing binary outcomes under block randomization: Cochran-Mantel-Haenszel (CMH) test for K X 2 X 2 tables</h3>
<p>For block-randomized trials with a binary outcome, we might use the CMH test to evaluate the null of no effect.<a href="references.html#fn26" class="footnote-ref" id="fnref26"><sup>26</sup></a> This is one way of keeping the outcomes for each strata separate rather than pooling them together &#x2014; under blocking, we are effectively repeating the same experiment separately within each stratum. The CMH test tells us if the odds ratios across strata support an association between the outcome and treatment <span class="citation">(Cochran <a href="#ref-cochran_methods_1954">1954</a>; Mantel and Haenszel <a href="#ref-mantel_statistical_1959">1959</a>)</span>.</p>
<p>To set up the CMH test, we need <em>k</em> sets of 2x2 contingency tables. Suppose
the table below represents outcomes from stratum <em>i</em> where A, B, C, and D are
counts of observations:</p>
<table>
<thead>
<tr class="header">
<th>Assignment</th>
<th>Response</th>
<th>No response</th>
<th>Total</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Treatment</td>
<td>A</td>
<td>B</td>
<td>A+B</td>
</tr>
<tr class="even">
<td>Control</td>
<td>C</td>
<td>D</td>
<td>C+D</td>
</tr>
<tr class="odd">
<td>Total</td>
<td>A+C</td>
<td>B+D</td>
<td>A+B+C+D = T</td>
</tr>
</tbody>
</table>
<p>The CMH test statistic takes the sum of the deviations between observed and expected outcomes within each stratum (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>O</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">O_{i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>E</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">E_{i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, respectively), squares this sum, and compares it to the sum of the variance within each strata:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>C</mi><mi>M</mi><mi>H</mi><mo>=</mo><mfrac><mrow><mo fence="false" stretchy="true" minsize="1.2em" maxsize="1.2em">[</mo><munderover><mo>&#x2211;</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>k</mi></munderover><mo stretchy="false">(</mo><msub><mi>O</mi><mi>i</mi></msub><mo>&#x2212;</mo><msub><mi>E</mi><mi>i</mi></msub><mo stretchy="false">)</mo><msup><mo fence="false" stretchy="true" minsize="1.2em" maxsize="1.2em">]</mo><mn>2</mn></msup></mrow><mrow><munderover><mo>&#x2211;</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>k</mi></munderover><mrow><mrow><mi mathvariant="normal">V</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">r</mi></mrow><mo stretchy="false">[</mo><msub><mi>O</mi><mi>i</mi></msub><mo stretchy="false">]</mo></mrow></mrow></mfrac></mrow><annotation encoding="application/x-tex">CMH = \frac{\big[\sum_{i=1}^{k} (O_{i} -
E_{i})\big]^{2}}{\sum_{i=1}^{k}{\mathrm{\mathrm{Var}}[O_{i}]}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">CM</span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.9727em;vertical-align:-1.1787em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.794em;"><span style="top:-2.175em;"><span class="pstrut" style="height:3.054em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">&#x2211;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.989em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">Var</span></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span><span style="top:-3.284em;"><span class="pstrut" style="height:3.054em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.794em;"><span class="pstrut" style="height:3.054em;"></span><span class="mord"><span class="mord"><span class="delimsizing size1">[</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">&#x2211;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.989em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord"><span class="delimsizing size1">]</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.054em;"><span style="top:-3.3029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:1.1787em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>where <span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>O</mi><mi>i</mi></msub><mo>=</mo><mfrac><mrow><mo stretchy="false">(</mo><msub><mi>A</mi><mi>i</mi></msub><mo>+</mo><msub><mi>B</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><msub><mi>A</mi><mi>i</mi></msub><mo>+</mo><msub><mi>C</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><msub><mi>T</mi><mi>i</mi></msub></mfrac></mrow><annotation encoding="application/x-tex">O_{i} = \frac{(A_i+B_i)(A_i+C_i)}{T_i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.263em;vertical-align:-0.836em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>and <span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mrow><mi mathvariant="normal">V</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">r</mi></mrow><mo stretchy="false">[</mo><msub><mi>O</mi><mi>i</mi></msub><mo stretchy="false">]</mo><mo>=</mo><mfrac><mrow><mo stretchy="false">(</mo><msub><mi>A</mi><mi>i</mi></msub><mo>+</mo><msub><mi>B</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><msub><mi>A</mi><mi>i</mi></msub><mo>+</mo><msub><mi>C</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><msub><mi>B</mi><mi>i</mi></msub><mo>+</mo><msub><mi>D</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><msub><mi>C</mi><mi>i</mi></msub><mo>+</mo><msub><mi>D</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><mrow><msup><msub><mi>T</mi><mi>i</mi></msub><mn>2</mn></msup><mo stretchy="false">(</mo><msub><mi>T</mi><mi>i</mi></msub><mo>&#x2212;</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">\mathrm{Var}[O_{i}] =
\frac{(A_i+B_i)(A_i+C_i)(B_i+D_i)(C_i+D_i)}{{T_i}^2(T_i-1)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathrm">Var</span></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4543em;vertical-align:-1.0273em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.2227em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8873em;"><span style="top:-3.1362em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:1.0273em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>In large-enough samples, if there are no associations between treatment and
outcomes across strata, we would expect to see an odds ratio equal to 1. Across randomizations of large-enough samples, this test statistic follows an asymptotic <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>&#x3C7;</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\chi^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0085em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">&#x3C7;</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span> distribution with degrees of freedom = 1.</p>
<p>For a standard two-arm trial, the odds ratio for a given stratum would be:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>O</mi><mi>R</mi><mo>=</mo><mfrac><mrow><mi>A</mi><mi mathvariant="normal">/</mi><mi>B</mi></mrow><mrow><mi>C</mi><mi mathvariant="normal">/</mi><mi>D</mi></mrow></mfrac><mo>=</mo><mfrac><mrow><mi>A</mi><mi>D</mi></mrow><mrow><mi>B</mi><mi>C</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">OR = \frac{A/B}{C/D} = \frac{AD}{BC}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">OR</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.363em;vertical-align:-0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0463em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3603em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">BC</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>Across strata, could then find an overall common odds ratio as follows:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.16em" columnspacing="1em"><mtr><mtd class="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>O</mi><msub><mi>R</mi><mrow><mi>C</mi><mi>M</mi><mi>H</mi></mrow></msub><mo>=</mo><mfrac><mrow><munderover><mo>&#x2211;</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>k</mi></munderover><mo stretchy="false">(</mo><msub><mi>A</mi><mi>i</mi></msub><msub><mi>D</mi><mi>i</mi></msub><mi mathvariant="normal">/</mi><msub><mi>T</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><mrow><munderover><mo>&#x2211;</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>k</mi></munderover><mrow><msub><mi>B</mi><mi>i</mi></msub><msub><mi>C</mi><mi>i</mi></msub></mrow><msub><mi>T</mi><mi>i</mi></msub></mrow></mfrac></mrow></mstyle></mtd><mtd class="mtr-glue"></mtd><mtd class="mml-eqn-num"></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{equation}
 OR_{CMH} = \frac{\sum_{i=1}^{k} (A_{i}D_{i}/T_{i})}{\sum_{i=1}^{k}{B_{i}C_{i}}{T_{i}}}
\end{equation}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.8574em;vertical-align:-1.1787em;"></span><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6787em;"><span style="top:-3.6787em;"><span class="pstrut" style="height:3.6787em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">CM</span><span class="mord mathnormal mtight" style="margin-right:0.08125em;">H</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6787em;"><span style="top:-2.121em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">&#x2211;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.989em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.6897em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">&#x2211;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.989em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">/</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:1.1787em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:1.1787em;"><span></span></span></span></span></span></span></span><span class="tag"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6787em;"><span style="top:-3.6787em;"><span class="pstrut" style="height:3.6787em;"></span><span class="eqn-num"></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:1.1787em;"><span></span></span></span></span></span></span></span></span>
If this common odds ratio is substantially greater than 1, then we should suspect that there is an association between the outcome and treatment across strata, and the CMH test statistic would be large. If <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><msub><mi>R</mi><mrow><mi>C</mi><mi>M</mi><mi>H</mi></mrow></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">OR_{CMH} = 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">CM</span><span class="mord mathnormal mtight" style="margin-right:0.08125em;">H</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>, this would instead support the null hypothesis that there is no association between treatment and the outcome, and the CMH test statistic would be small.</p>
<p>We could also use the CMH test to compare odds ratios between experiments, rather than comparing against the null that the common odds ratio = 1.</p>
</div>
<div id="blockrandate" class="section level3">
<h3><span class="header-section-number">5.5.2</span> Estimating an overall average treatment effect</h3>
<p>Regardless of how treatment is assigned, our team nearly always reports a single estimate of the average treatment effect. To review, we define the overall ATE (the theoretical estimand) as a simple average of the individual treatment effects. For two treatments, we might write this individual-level causal effect as <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>&#x3C4;</mi><mi>i</mi></msub><mo>=</mo><msub><mi>y</mi><mrow><mi>i</mi><mo separator="true">,</mo><mn>0</mn></mrow></msub><mo>&#x2212;</mo><msub><mi>y</mi><mrow><mi>i</mi><mo separator="true">,</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">\tau_i = y_{i,0} - y_{i,1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>. We&#x2019;d therefore express the overall (true) ATE across our sample as as <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>&#x3C4;</mi><mo>&#x2C9;</mo></mover><mo>=</mo><mo stretchy="false">(</mo><mn>1</mn><mi mathvariant="normal">/</mi><mi>n</mi><mo stretchy="false">)</mo><msubsup><mo>&#x2211;</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></msubsup><msub><mi>&#x3C4;</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\bar{\tau}=(1/n) \sum_{i=1}^n \tau_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5678em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">&#x2C9;</span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.104em;vertical-align:-0.2997em;"></span><span class="mopen">(</span><span class="mord">1/</span><span class="mord mathnormal">n</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">&#x2211;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>. Unfortunately, this quantity is unobservable.</p>
<p>In blocked designs, we have randomly assigned the intervention within each block independently. As we note above, this (1) increases precision and (2) supports more credible subgroup analysis. How might we &#x201C;analyze as we have randomized&#x201D; to learn about <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>&#x3C4;</mi><mo>&#x2C9;</mo></mover></mrow><annotation encoding="application/x-tex">\bar{\tau}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5678em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">&#x2C9;</span></span></span></span></span></span></span></span></span></span> using observable data? Our approach is to think about this in terms of block-level treatment effects. See <span class="citation">Gerber and Green (<a href="#ref-gerber_field_2012">2012</a>)</span> for more context.</p>
<p>Say, for example, that the unobserved ATE within a given block, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">b</span></span></span></span>, was <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mtext>ATE</mtext><mi>b</mi></msub><mo>=</mo><msub><mover accent="true"><mi>&#x3C4;</mi><mo>&#x2C9;</mo></mover><mi>b</mi></msub><mo>=</mo><mo stretchy="false">(</mo><mn>1</mn><mi mathvariant="normal">/</mi><msub><mi>n</mi><mi>b</mi></msub><mo stretchy="false">)</mo><msubsup><mo>&#x2211;</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><msub><mi>n</mi><mi>b</mi></msub></msubsup><msub><mi>&#x3C4;</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\text{ATE}_{b}=\bar{\tau}_b=(1/n_b)\sum_{i=1}^{n_b} \tau_{i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord text"><span class="mord">ATE</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7178em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">&#x2C9;</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.104em;vertical-align:-0.2997em;"></span><span class="mopen">(</span><span class="mord">1/</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">&#x2211;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>. Here, we are averaging the individual level treatment effects (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>&#x3C4;</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\tau_{i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>) across all <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mi>b</mi></msub></mrow><annotation encoding="application/x-tex">n_b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> people in block <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">b</span></span></span></span>. Now, imagine that we had an experiment with blocks of different sizes (and perhaps with different proportions of units assigned to treatment &#x2014; e.g., certain blocks may be more expensive places in which to run an experiment). We can learn about <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>&#x3C4;</mi><mo>&#x2C9;</mo></mover></mrow><annotation encoding="application/x-tex">\bar{\tau}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5678em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">&#x2C9;</span></span></span></span></span></span></span></span></span></span> by first reframing it as the block-size weighted average of the true within-block treatment effects:<a href="references.html#fn27" class="footnote-ref" id="fnref27"><sup>27</sup></a> <span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mover accent="true"><mi>&#x3C4;</mi><mo>&#x2C9;</mo></mover><mo>=</mo><msub><mover accent="true"><mi>&#x3C4;</mi><mo>&#x2C9;</mo></mover><mtext>nbwt</mtext></msub><mo>=</mo><mo stretchy="false">(</mo><mn>1</mn><mi mathvariant="normal">/</mi><mi>B</mi><mo stretchy="false">)</mo><munderover><mo>&#x2211;</mo><mrow><mi>b</mi><mo>=</mo><mn>1</mn></mrow><mi>B</mi></munderover><mo stretchy="false">(</mo><msub><mi>n</mi><mi>b</mi></msub><mi mathvariant="normal">/</mi><mi>n</mi><mo stretchy="false">)</mo><msub><mover accent="true"><mi>&#x3C4;</mi><mo>&#x2C9;</mo></mover><mi>b</mi></msub></mrow><annotation encoding="application/x-tex">\bar{\tau} = \bar{\tau}_{\text{nbwt}} = (1/B) \sum_{b=1}^B (n_b/n) \bar{\tau}_b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5678em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">&#x2C9;</span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7178em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">&#x2C9;</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">nbwt</span></span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.1304em;vertical-align:-1.3021em;"></span><span class="mopen">(</span><span class="mord">1/</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8479em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">&#x2211;</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:1.3021em;"><span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">/</span><span class="mord mathnormal">n</span><span class="mclose">)</span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">&#x2C9;</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p>We can then estimate <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>&#x3C4;</mi><mo>&#x2C9;</mo></mover><mtext>nbwt</mtext></msub></mrow><annotation encoding="application/x-tex">\bar{\tau}_{\text{nbwt}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7178em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">&#x2C9;</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">nbwt</span></span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> based on its observable analogue, just as we have with a completely randomized experiment. Blocks are essentially their own randomized experiments, so we can estimate each <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>&#x3C4;</mi><mo>&#x2C9;</mo></mover><mi>b</mi></msub></mrow><annotation encoding="application/x-tex">\bar{\tau}_b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7178em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">&#x2C9;</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> using the following unbiased estimator, where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>&#x2208;</mo><mi>t</mi></mrow><annotation encoding="application/x-tex">i \in t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6986em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&#x2208;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span> means &#x201C;for <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> in the treatment group&#x201D; and where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>m</mi><mi>b</mi></msub></mrow><annotation encoding="application/x-tex">m_b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is the number of units assigned to treatment in block <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">b</span></span></span></span>: <span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mover accent="true"><mi>&#x3C4;</mi><mo>^</mo></mover><mi>b</mi></msub><mo>=</mo><munder><mo>&#x2211;</mo><mrow><mi>i</mi><mo>&#x2208;</mo><mi>t</mi></mrow></munder><msub><mi>Y</mi><mrow><mi>i</mi><mi>b</mi></mrow></msub><mi mathvariant="normal">/</mi><msub><mi>m</mi><mi>b</mi></msub><mo>&#x2212;</mo><munder><mo>&#x2211;</mo><mrow><mi>i</mi><mo>&#x2208;</mo><mi>c</mi></mrow></munder><msub><mi>Y</mi><mrow><mi>i</mi><mi>b</mi></mrow></msub><mi mathvariant="normal">/</mi><mo stretchy="false">(</mo><msub><mi>n</mi><mi>b</mi></msub><mo>&#x2212;</mo><msub><mi>m</mi><mi>b</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\hat{\tau}_b=\sum_{i \in t} Y_{ib}/m_b - \sum_{i \in c} Y_{ib}/(n_b - m_b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.355em;vertical-align:-1.305em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">&#x2208;</span><span class="mord mathnormal mtight">t</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">&#x2211;</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:1.305em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ib</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">/</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:2.355em;vertical-align:-1.305em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">&#x2208;</span><span class="mord mathnormal mtight">c</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">&#x2211;</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:1.305em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ib</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">/</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p>We would then plug the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>&#x3C4;</mi><mo>^</mo></mover><mi>b</mi></msub></mrow><annotation encoding="application/x-tex">\hat{\tau}_b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> estimates into the expression for <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>&#x3C4;</mi><mo>&#x2C9;</mo></mover><mtext>nbwt</mtext></msub></mrow><annotation encoding="application/x-tex">\bar{\tau}_{\text{nbwt}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7178em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">&#x2C9;</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">nbwt</span></span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> above, yielding <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mover accent="true"><mi>&#x3C4;</mi><mo>&#x2C9;</mo></mover><mo>^</mo></mover><mtext>nbwt</mtext></msub></mrow><annotation encoding="application/x-tex">\hat{\bar{\tau}}_{\text{nbwt}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9812em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8312em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">&#x2C9;</span></span></span></span></span></span></span></span><span style="top:-3.1368em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">nbwt</span></span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>. Note that many people do not use this unbiased estimator, in part because its precision is worse that those of another, slightly biased estimator. We illustrate both methods below, the block-size weighted estimator and what we call the &#x201C;precision-weighted&#x201D; estimator. We also offer some reflections on when a biased estimator that tends to produce answers closer to the truth might be preferred over an unbiased estimator where any given estimate may be farther from the truth.</p>
<p>The precision-weighted estimator is based on <em>harmonic-weights</em>. We have also tended to call it a &#x201C;precision-weighted average.&#x201D; The weights combine block size, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mi>b</mi></msub></mrow><annotation encoding="application/x-tex">n_b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, and the proportion of the block assigned to treatment, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>b</mi></msub><mo>=</mo><mo stretchy="false">(</mo><mn>1</mn><mi mathvariant="normal">/</mi><msub><mi>n</mi><mi>b</mi></msub><mo stretchy="false">)</mo><msubsup><mo>&#x2211;</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><msub><mi>n</mi><mi>b</mi></msub></msubsup><msub><mi>Z</mi><mrow><mi>i</mi><mi>b</mi></mrow></msub></mrow><annotation encoding="application/x-tex">p_b = (1/n_b) \sum_{i=1}^{n_b} Z_{ib}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.104em;vertical-align:-0.2997em;"></span><span class="mopen">(</span><span class="mord">1/</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">&#x2211;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ib</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, for a binary treatment, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Z</mi><mrow><mi>i</mi><mi>b</mi></mrow></msub></mrow><annotation encoding="application/x-tex">Z_{ib}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ib</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>. The harmonic weight for each block is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>h</mi><mi>b</mi></msub><mo>=</mo><msub><mi>n</mi><mi>b</mi></msub><msub><mi>p</mi><mi>b</mi></msub><mo stretchy="false">(</mo><mn>1</mn><mo>&#x2212;</mo><msub><mi>p</mi><mi>b</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">h_b = n_b p_b (1 - p_b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>, and the theoretical estimand is then: <span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mover accent="true"><mi>&#x3C4;</mi><mo>&#x2C9;</mo></mover><mtext>hbwt</mtext></msub><mo>=</mo><mo stretchy="false">(</mo><mn>1</mn><mi mathvariant="normal">/</mi><mi>B</mi><mo stretchy="false">)</mo><munderover><mo>&#x2211;</mo><mrow><mi>b</mi><mo>=</mo><mn>1</mn></mrow><mi>B</mi></munderover><mo stretchy="false">(</mo><mn>1</mn><mi mathvariant="normal">/</mi><msub><mi>h</mi><mi>b</mi></msub><mo stretchy="false">)</mo><msub><mover accent="true"><mi>&#x3C4;</mi><mo>&#x2C9;</mo></mover><mi>b</mi></msub></mrow><annotation encoding="application/x-tex">\bar{\tau}_{\text{hbwt}}= (1/B) \sum_{b=1}^B (1/h_b) \bar{\tau}_b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7178em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">&#x2C9;</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">hbwt</span></span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.1304em;vertical-align:-1.3021em;"></span><span class="mopen">(</span><span class="mord">1/</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8479em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">&#x2211;</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:1.3021em;"><span></span></span></span></span></span><span class="mopen">(</span><span class="mord">1/</span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">&#x2C9;</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p>This approach may <em>sound</em> unfamiliar. But using precision weights to average a set of within-block treatment effect estimates is equivalent to the more common practice of regression adjustment for linear, additive blocked fixed effects (and we show an example of this in our code below).</p>
<p>Two points are worth emphasizing. First, by weighting blocks proportionally to their contributions to overall sample size, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>&#x3C4;</mi><mo>&#x2C9;</mo></mover><mtext>nbwt</mtext></msub></mrow><annotation encoding="application/x-tex">\bar{\tau}_{\text{nbwt}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7178em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">&#x2C9;</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">nbwt</span></span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> effectively treats all units equally in terms of their contributions to the ATE. In contrast, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>&#x3C4;</mi><mo>&#x2C9;</mo></mover><mtext>hbwt</mtext></msub></mrow><annotation encoding="application/x-tex">\bar{\tau}_{\text{hbwt}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7178em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">&#x2C9;</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">hbwt</span></span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> weights treatment effects from blocks (and therefore the individuals within them) relatively less if the within-block treatment probability is closer to 0.5.<a href="references.html#fn28" class="footnote-ref" id="fnref28"><sup>28</sup></a></p>
<p>Second, the expression for <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>h</mi><mi>b</mi></msub></mrow><annotation encoding="application/x-tex">h_b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> above shows that the precision-weighted approach will give no weight to units in blocks where the probability of treatment is 0 or 1 (i.e., all units are eiter treated or untreated, due perhaps to treatment administration issues). What may not be obvious yet is that the unbiased, block-size weighted approach suffers from the same problem. Treatment probabilities may not factor into <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mi>b</mi></msub><mi mathvariant="normal">/</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">n_b/n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">/</span><span class="mord mathnormal">n</span></span></span></span>, but these are block-level weights that we can&#x2019;t apply without a within-block treatment effect estimate (which we cannot calculate in the absence of within-block variation in treatment). The unit level expression for these unbiased weights <em>is</em> a function of the within-block treated proportion <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>p</mi><mrow><mi>i</mi><mi>b</mi></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(p_{ib})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ib</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>n</mi><mi>b</mi><mi>w</mi><msub><mi>t</mi><mi>i</mi></msub><mo>=</mo><msub><mi>Z</mi><mi>i</mi></msub><mi mathvariant="normal">/</mi><msub><mi>p</mi><mrow><mi>i</mi><mi>b</mi></mrow></msub><mo>+</mo><mo stretchy="false">(</mo><mn>1</mn><mo>&#x2212;</mo><msub><mi>Z</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mo stretchy="false">(</mo><mn>1</mn><mo>&#x2212;</mo><msub><mi>p</mi><mrow><mi>i</mi><mi>b</mi></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">nbwt_{i} = Z_{i}/p_{ib} + (1-Z_{i})/(1 - p_{ib})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord mathnormal">nb</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">/</span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ib</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord">/</span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ib</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p>For reference, an expression for unit-level precision-weights is:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>h</mi><mi>b</mi><mi>w</mi><msub><mi>t</mi><mi>i</mi></msub><mo>=</mo><mi>n</mi><mi>b</mi><mi>w</mi><msub><mi>t</mi><mi>i</mi></msub><mo>&#xD7;</mo><msub><mi>p</mi><mrow><mi>i</mi><mi>b</mi></mrow></msub><mo>&#xD7;</mo><mo stretchy="false">(</mo><mn>1</mn><mo>&#x2212;</mo><msub><mi>p</mi><mrow><mi>i</mi><mi>b</mi></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">hbwt_{i} = nbwt_{i} \times p_{ib} \times (1 - p_{ib})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord mathnormal">hb</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord mathnormal">nb</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#xD7;</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ib</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#xD7;</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ib</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p>Let&#x2019;s review various approaches to applying these estimators. We&#x2019;ll demonstrate (1) that ignoring the blocks when estimating treatment effects can produce problems in both estimation and testing, and (2) that the block-size weighted approaches are unbiased but possibly less precise than the precision weighted approaches.</p>
<div class="tab">
<button class="tablinks" onclick="unrolltab(event, &apos;ch5R22&apos;)">
R code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Stata22&apos;)">
Stata code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Hide22&apos;)">
Hide
</button>
<div id="ch5R22" class="tabcontent">
<p><br></p>
<pre class="text"><code>## Create block sizes and create block weights
B &lt;- 10 # Number of blocks
dat &lt;- data.frame(b=rep(1:B,c(8,20,30,40,50,60,70,80,100,800)))
dat$bF &lt;- factor(dat$b)

## x1 is a covariate that strongly predicts the outcome without treatment
set.seed(2201)
dat &lt;- group_by(dat,b) %&gt;%
  mutate(
    nb=n(),
    x1=rpois(n = nb,lambda=runif(1,min=1,max=2000))
    )

## The treatment effect varies by block size (sqrt(nb) because nb has such a large range.)
dat &lt;- group_by(dat,b) %&gt;% 
  mutate(
    y0=sd(x1)*x1+rchisq(n=nb,df=1),
    y0=y0*(y0&gt;quantile(y0,.05)),
    tauib = -(sd(y0))*sqrt(nb) + rnorm(n(),mean=0,sd=sd(y0)),
    y1=y0+tauib,
    y1=y1*(y1&gt;0)
    )
blockpredpower &lt;- summary(lm(y0~bF,data=dat))$r.squared</code></pre>
</div>
<div id="ch5Stata22" class="tabcontent">
<p><br></p>
<pre class="text"><code>** Data simulation provided for illustration.
** In practice, will use data generated by the R code,
** for the sake of comparison.

** Create block sizes and create block weights
clear
local sizes 8 20 30 40 50 60 70 80 100 800 // Block sample sizes
set obs 10 // Number of blocks
qui gen bf = . // Categorical block var
qui gen nb = . // Number in block
local i = 0
foreach size of local sizes {
    local ++i
    replace nb = `size&apos; if _n == `i&apos;
    replace bf = `i&apos; if _n == `i&apos;
}
gen lambda = runiform(1, 2000) // For poisson generation below
expand nb
sort bf

** x1 is a covariate that strongly predicts the outcome without treatment
set seed 2201
gen x1 = rpoisson(lambda)

** The treatment effect varies by block size (sqrt(nb) because nb has such a large range.)
bysort bf: egen sd_x1 = sd(x1) 
gen y0 = (sd_x1 * x1) + rchi2(1)
bysort bf: egen p5 = pctile(y0), p(5)
replace y0 = 0 if y0 &lt;= p5
bysort bf: egen sd_y0 = sd(y0)
gen tauib = -(sd_y0)*sqrt(nb) + rnormal(0, sd_y0)
gen y1 = y0 + tauib
replace y1 = 0 if y1 &lt;= 0
qui reg y0 i.bf
di round(e(r2), 0.0001)
drop sd_y0 sd_x1 p5</code></pre>
</div>
<div id="ch5Hide22" class="tabcontent">

</div>
</div>
<p>To make the differences between these estimation approaches more vivid,
we&#x2019;ve create a dataset with blocks of widely varying sizes. Half of the blocks have half of the units assigned to treatment and the other half have 10% of the units assigned to treatment (i.e., varying assignment proabilities across blocks). Notice also that the baseline outcomes are strongly predicted by the blocks (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>R</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">R^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span> around <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.87</mn></mrow><annotation encoding="application/x-tex">0.87</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.87</span></span></span></span>).</p>
<p>We&#x2019;ll use <code>DeclareDesign</code> (in R) to assess bias, coverage and power (or precision) of several different approaches to applying each estimator. We&#x2019;ll also provide a parallel Stata example. The next code block sets up the simulation and also demonstrates different approaches to estimating an ATE (as usual, we can only do this because we are using simulation to compare these different statistical techniques in a setting where we know the true data generating process).</p>
<div class="tab">
<button class="tablinks" onclick="unrolltab(event, &apos;ch5R23&apos;)">
R code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Stata23&apos;)">
Stata code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Hide23&apos;)">
Hide
</button>
<div id="ch5R23" class="tabcontent">
<p><br></p>
<pre class="text"><code>## Using the Declare Design Machinery to ensure that 
## the data here and the simulations below match

## Declare the population
thepop &lt;- declare_population(dat)

## Represent the potential outcomes with a function
po_function &lt;- function(data){
    data$Y_Z_0 &lt;- data$y0
    data$Y_Z_1 &lt;- data$y1
    data
}

## Use this function to declare the potential outcomes
theys &lt;- declare_potential_outcomes(handler = po_function)

## Declare the desired inquiry
theestimand &lt;- declare_inquiry(ATE = mean(Y_Z_1 - Y_Z_0))

## Declare treatment assignment
numtreated &lt;- sort(unique(dat$nb))/rep(c(2,10),B/2)
theassign &lt;- declare_assignment(Z = block_ra(blocks = bF, block_m = numtreated))

## Declare revealed data
theobsident &lt;- declare_reveal(Y, Z)

## Combine these design elements together
thedesign &lt;- thepop + theys + theestimand + theassign + theobsident

# Draw data matching this design
set.seed(2201)
dat2 &lt;- draw_data(thedesign)

## Now add individual-level weights to the data
## (under complete_ra within blocks, these will
## be the same across re-randomizations; OK to
## not recalculate within the simulation).
dat2 &lt;- dat2 %&gt;% 
  group_by(b) %&gt;% 
  mutate(
    nb = n(), # Size of block
    pib = mean(Z), # Prob. of treatment assignment
    nTb = sum(Z), # Number treated
    nCb = nb - nTb, # Number control
    nbwt = (Z/pib) + ((1-Z)/(1-pib)), # Unbiased regression weight
    hbwt = nbwt * (pib * (1 - pib)) # Precision regression weight
    )

## Declare a new population, and generate another design
thepop2 &lt;- declare_population(dat2)
thedesign2 &lt;- thepop2 + theys + theestimand + theassign + theobsident

## Create the block level dataset, with block level weights.
datB &lt;- group_by(dat2,b) %&gt;%
  summarize(
    taub = mean(Y[Z==1]) - mean(Y[Z==0]), # Effect (variance below)
    truetaub = mean(y1) - mean(y0), # True effect
    nb = n(), # Number in block
    nTb = sum(Z), # Number treated
    nCb = nb - nTb, # Number control
    estvartaub = (nb/(nb-1)) * (var(Y[Z==1])/nTb) + (var(Y[Z==0])/nCb),
    pb = mean(Z), # Proportion treated
    nbwt = unique(nb/nrow(dat2)), # Block-size weight
    pbwt = pb * ( 1 - pb),
    hbwt2 = nbwt * pbwt, # Precision weights
    hbwt3 = pbwt * nb,
    hbwt = (2*(nCb * nTb)/(nTb + nCb))
    )
datB$greenlabrule &lt;- 20*datB$hbwt3/sum(datB$hbwt3)

## All of these expressions of the harmonic mean weight are the same
datB$hbwt01 &lt;- datB$hbwt/sum(datB$hbwt)
datB$hbwt02 &lt;- datB$hbwt2/sum(datB$hbwt2)
datB$hbwt03 &lt;- datB$hbwt3/sum(datB$hbwt3)
stopifnot(all.equal(datB$hbwt01, datB$hbwt02))
stopifnot(all.equal(datB$hbwt01, datB$hbwt03))

## What is the &quot;true&quot; ATE?
trueATE1 &lt;- with(dat2, mean(y1) - mean(y0))
trueATE2 &lt;- with(datB, sum(truetaub*nbwt))
stopifnot(all.equal(trueATE1, trueATE2))
## We could define the following as an estimand, too.
## trueATE3 &lt;- with(datB, sum(truetaub*hbwt01))
## c(trueATE1,trueATE2,trueATE3)

## We can get the same answer using R&apos;s weighted.mean command
trueATE2b &lt;- weighted.mean(datB$truetaub, w=datB$nbwt)
stopifnot(all.equal(trueATE2b, trueATE2))</code></pre>
</div>
<div id="ch5Stata23" class="tabcontent">
<p><br></p>
<pre class="text"><code>** Define a program to load base dataset and randomly re-assign treatment
capture program drop sample_from
program define sample_from, rclass
    
    * Load simulated data from R
    import delimited using &quot;blocksimdat.csv&quot;, clear
    
    * Get # treated for each block
    levelsof nb, local(nblevels)
    local numtreat
    local i = 0
    foreach l of local nblevels {
        
        local ++i // block indices (1, 2, 3,... 10)
        
        * even block indices (2nd, 4th, etc.) get 10% treated
        if mod(`i&apos;,2) == 0 {
            local temp = `l&apos;/10 
            local numtreat `numtreat&apos; `temp&apos;
        }
        
        * odd get 50% treated
        else {
            local temp = `l&apos;/2
            local numtreat `numtreat&apos; `temp&apos;
        }
        
    }
    
    * Re-assign (simulated) treatment in this draw of the data
    capture drop __0*
    block_ra znew, block_var(bf) block_m(`numtreat&apos;) replace
    
    * No additional treatment effects
    * (assigning new potential outcomes)
    gen y_znew_0 = y0
    gen y_znew_1 = y1

    * Get true ATE in r()
    gen true_effect = y_znew_1 - y_znew_0
    sum true_effect, meanonly
    return scalar ATE = r(mean)
    
    * Revealed outcome
    gen ynew = (znew * y_znew_1) + ((1 - znew) * y_znew_0)
    
    * Now add individual-level weights to the data
    * (under complete_ra within blocks, these will
    * be the same across re-randomizations).
    bysort bf: egen pib = mean(znew) // Prob. of treatment assignment
    bysort bf: egen nTb = total(znew) // Number treated
    gen nCb = nb - nTb // Number control
    gen nbwt = (znew/pib) + ((1-znew)/(1-pib)) // Unbiased regression weight
    gen hbwt = nbwt * (pib * (1 - pib)) // Precision regression weight

end

** Draw data using this program once and save the true ATE
set seed 2201
sample_from
global trueATE1 = round(r(ATE), 0.01)

** For illustration: how to prepare block-level data as in the R code.
** In practice, we&apos;ll use data from the R code for comparison.

** Prepare to create a block level dataset, with block level weights.
bysort bf znew: egen treatmean = mean(ynew) if znew == 1 // Treat and control means
bysort bf znew: egen controlmean = mean(ynew) if znew == 0
bysort bf znew: egen treatsd = sd(ynew) if znew == 1 // Treat and control SD
bysort bf znew: egen controlsd = sd(ynew) if znew == 0
qui count
gen total_n = r(N)

** Collapse to block-level
collapse ///
(mean) treatmean controlmean treatsd controlsd y1 y0 pb = znew ///
(first) nb nTb nCb total_n, ///
by(bf)

** Additional variable preparation
gen taub = treatmean - controlmean // Observed effect (variance below)
gen truetaub = y1 - y0 // True effect
gen treatvar = treatsd * treatsd
gen controlvar = controlsd * controlsd
gen estvartaub = (nb/(nb-1)) * (treatvar/nTb) + (controlvar/nCb)
gen nbwt = nb / total_n // Block size weight
gen pbwt = pb * (1 - pb) // pb is proportion treated
gen hbwt2 = nbwt * pbwt // Precision weights
gen hbwt3 = pbwt * nb
gen hbwt = (2*(nCb * nTb)/(nTb + nCb))
qui sum hbwt3
gen greenlabrule = 20 * hbwt3 / r(sum)

** All of these expressions of the harmonic mean weight are the same
qui sum hbwt
gen double hbwt01 = round(hbwt / r(sum), 0.000001) // Precision issues
qui sum hbwt2
gen double hbwt02 = round(hbwt2 / r(sum), 0.000001)
qui sum hbwt3
gen double hbwt03 = round(hbwt3 / r(sum), 0.000001)
assert hbwt01 == hbwt02
assert hbwt01 == hbwt03

** What is the &quot;true&quot; ATE?
gen truetaubweighted = truetaub * nbwt
qui sum truetaubweighted
global trueATE2 = round(r(sum), 0.01)
assert $trueATE1 == $trueATE2 // After rounding
** We could define the following as an estimand, too.
* gen truetaubweighted2 = truetaub * hbwt01
* qui sum truetaubweighted2
* global trueATE3 = round(r(sum), 0.01)</code></pre>
</div>
<div id="ch5Hide23" class="tabcontent">

</div>
</div>
<p>We can now review the design:</p>
<pre><code>         blocknumber
treatment   1   2   3   4   5   6   7   8   9  10
        0   4  18  15  36  25  54  35  72  50 720
        1   4   2  15   4  25   6  35   8  50  80</code></pre>
<p>With those simulations prepared, we&#x2019;ll start by comparing multiple approaches to getting an unbiased block-size-weighted average treatment effect estimate, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>&#x3C4;</mi><mo>&#x2C9;</mo></mover><mtext>nbwt</mtext></msub></mrow><annotation encoding="application/x-tex">\bar{\tau}_{\text{nbwt}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7178em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">&#x3C4;</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">&#x2C9;</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">nbwt</span></span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>. Notice that we do not use linear, additive fixed effects adjustment in any of these.<a href="references.html#fn29" class="footnote-ref" id="fnref29"><sup>29</sup></a> Two of these approaches do include fixed effects dummies, but they are mean-centered and interacted with treatment assignment &#x2014; in other words, we include the fixed effects via <span class="citation">Lin (<a href="#ref-lin_agnostic_2013">2013</a>)</span> adjustment.<a href="references.html#fn30" class="footnote-ref" id="fnref30"><sup>30</sup></a></p>
<ol style="list-style-type: decimal">
<li><code>simple_block</code> refers to calculating mean differences within blocks and then taking the block-size weighted average of them</li>
<li><code>diffmeans</code> uses the <code>difference_in_means</code> function from the <code>estimatr</code>
package <span class="citation">(Blair et al. <a href="#ref-R-estimatr">2022</a>)</span></li>
<li><code>lmlin</code> applies Lin covariance adjustment <em>via</em> block indicators, using the <code>lm_lin</code> function</li>
<li><code>lmlinbyhand</code> verifies that function using matrix operations; see <a href="https://alexandercoppock.com/Green-Lab-SOP/Green_Lab_SOP.html#taking-block-randomization-into-account-in-ses-and-cis">this entry</a> from the Green lab&#x2019;s SOP.</li>
<li><code>regwts</code> uses the basic OLS function from R <code>lm</code> with appropriate weights.</li>
</ol>
<p>Let&#x2019;s compare the estimates themselves using a single dataset before running our simulation:</p>
<div class="tab">
<button class="tablinks" onclick="unrolltab(event, &apos;ch5R24&apos;)">
R code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Stata24&apos;)">
Stata code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Hide24&apos;)">
Hide
</button>
<div id="ch5R24" class="tabcontent">
<p><br></p>
<pre class="text"><code>## simple_block
ate_nbwt1 &lt;- with(datB,sum(taub*nbwt))

## diffmeans
ate_nbwt2 &lt;- difference_in_means(Y~Z,blocks=b,data=dat2)

## lmlin
ate_nbwt3 &lt;- lm_lin(Y~Z,covariates=~bF,data=dat2)

## regwts
ate_nbwt5 &lt;- lm_robust(Y~Z,data=dat2,weights=nbwt)
ate_nbwt5a &lt;- lm(Y~Z,data=dat2,weights=nbwt)
ate_nbwt5ase &lt;- coeftest(ate_nbwt5a,vcov=vcovHC(ate_nbwt5a,type=&quot;HC2&quot;))

## lmlinbyhand
X &lt;- model.matrix(~bF-1,data=dat2)
barX &lt;- colMeans(X)
Xmd &lt;- sweep(X,2,barX)
stopifnot(all.equal((X[,3]-mean(X[,3])), Xmd[,3]))
ZXmd &lt;- sweep(Xmd,1,dat2$Z,FUN=&quot;*&quot;)
stopifnot(all.equal(dat2$Z*Xmd[,3],ZXmd[,3]))
bigX &lt;- cbind(Intercept=1,Z=dat2$Z,Xmd[,-1],ZXmd[,-1])
bigXdf &lt;- data.frame(bigX,Y=dat2$Y)
ate_nbwt4 &lt;-lm(Y~.-1,data=bigXdf)
ate_nbwt4se &lt;- coeftest(ate_nbwt4,vcov.=vcovHC(ate_nbwt4,type=&quot;HC2&quot;))

## List all
nbwtates&lt;-c(
  simple_block=ate_nbwt1,
  diffmeans=ate_nbwt2$coefficients[[&quot;Z&quot;]],
  lmlin=ate_nbwt3$coefficients[[&quot;Z&quot;]],
  lmlinbyhand=ate_nbwt4$coefficients[[&quot;Z&quot;]],
  regwts=ate_nbwt5$coefficients[[&quot;Z&quot;]]
  )

nbwtates</code></pre>
</div>
<div id="ch5Stata24" class="tabcontent">
<p><br></p>
<pre class="text"><code>** Load block-level data from the R code
import delimited using &quot;datB.csv&quot;, clear

** simple_block
gen taubweighted = taub * nbwt
qui sum taubweighted
global ate_nbwt1 = r(sum)
tempvar calc_se
gen `calc_se&apos; = nbwt^2 * estvartaub
qui sum `calc_se&apos;
global ate_nbwt1se = sqrt(r(sum))

** design-based diffmeans estimator (return to observation level data)
* See the DeclareDesign package mathematical notes.
import delimited using &quot;blocksimdat2.csv&quot;, clear // dat2 in the R code
rename (y z ntb ncb) (ynew znew nTb nCb) // Adjust names to match illustrative code above
egen blockmean = mean(ynew), by(bf znew)
egen blocksd = sd(ynew), by(bf znew)
bysort bf (znew): gen diffmean = blockmean[_N] - blockmean[1] // with sorting, treat - control
bysort bf (znew): gen variance = ((blocksd[_N]^2)/nTb[_N]) + ((blocksd[1]^2)/nCb[1])
qui sum diffmean, meanonly
global ate_nbwt2 = r(mean)
qui count
gen forblockedse = (nb/r(N))^2 * variance
bysort bf: replace forblockedse = . if _n != 1
qui sum forblockedse
global ate_nbwt2se = sqrt(r(sum))

** lmlinbyhand
tabulate bf, gen(block_)
drop block_1
qui reg ynew znew i.bf
gen samp = e(sample) // Ensure correct sample used
foreach var of varlist block_* {
    qui sum `var&apos; if samp == 1, meanonly
    gen mc_`var&apos; = `var&apos; - `r(mean)&apos;
}
qui reg ynew i.znew##c.(mc_block_*), vce(hc2)
global ate_nbwt3 = _b[1.znew]
global ate_nbwt3se = _se[1.znew]

** regwts
qui reg ynew znew [aw = nbwt], vce(hc2)
global ate_nbwt5 = _b[znew]
global ate_nbwt5se = _se[znew]

** List all
di &quot;simple_block = $ate_nbwt1&quot;
di &quot;diffmeans = $ate_nbwt2&quot;
di &quot;lmlinbyhand = $ate_nbwt3&quot;
di &quot;regwts = $ate_nbwt5&quot;</code></pre>
</div>
<div id="ch5Hide24" class="tabcontent">

</div>
</div>
<pre><code>simple_block    diffmeans        lmlin  lmlinbyhand       regwts 
      -12823       -12823       -12823       -12823       -12823 </code></pre>
<p>Let&#x2019;s also quickly review their standard errors:</p>
<div class="tab">
<button class="tablinks" onclick="unrolltab(event, &apos;ch5R25&apos;)">
R code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Stata25&apos;)">
Stata code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Hide25&apos;)">
Hide
</button>
<div id="ch5R25" class="tabcontent">
<p><br></p>
<pre class="text"><code>## Comparing the Standard Errors
ate_nbwt1se &lt;- sqrt(sum(datB$nbwt^2 * datB$estvartaub))
nbwtses &lt;- c(
  simple_block=ate_nbwt1se,
  diffmeans=ate_nbwt2$std.error,
    lmlin=ate_nbwt3$std.error[[&quot;Z&quot;]],
    lmlinbyhand=ate_nbwt4se[&quot;Z&quot;,&quot;Std. Error&quot;],
    regwts=ate_nbwt5$std.error[[&quot;Z&quot;]]
  )

nbwtses</code></pre>
</div>
<div id="ch5Stata25" class="tabcontent">
<p><br></p>
<pre class="text"><code>** Comparing the Standard Errors
di &quot;simple_block = $ate_nbwt1se&quot;
di &quot;diffmeans = $ate_nbwt2se&quot;
di &quot;lmlinbyhand = $ate_nbwt3se&quot;
di &quot;regwts = $ate_nbwt5se&quot;</code></pre>
</div>
<div id="ch5Hide25" class="tabcontent">

</div>
</div>
<pre><code>simple_block  diffmeans.Z        lmlin  lmlinbyhand       regwts 
       182.0        181.3        181.3        181.3        441.0 </code></pre>
<p>As noted above, weighting by block size allows us to define the average treatment effect in a way that treats each unit equally. And we have just illustrated six different ways to estimate this effect. If we want to calculate standard errors for these estimators (e.g., to produce confidence intervals), we will, in general, be leaving statistical power on the table in exchange for an easier to interpret estimate, and an estimator that relates to its underlying target in an unbiased manner.</p>
<p>Next, we show an approach to blocking adjustment that is optimal from the perspective of statistical power, or narrow confidence intervals. As discussed above, we call this the &#x201C;precision-weighted&#x201D; average treatment effect.<a href="references.html#fn31" class="footnote-ref" id="fnref31"><sup>31</sup></a> In some literatures, it&#x2019;s typical to use OLS regression machinery to calculate an ATE that is weighted to account for blocking &#x2014; i.e., a &#x201C;Least Squared Dummy Variables&#x201D; (LSDV) approach to including block fixed effects in a regression. We show here that this is simply another version of the precision-weighted ATE estimator.</p>
<ol style="list-style-type: decimal">
<li><code>simple_block</code> calculates a simple differences of means within blocks and
then takes a weighted average of those differences, using precision
weights</li>
<li><code>lm_fixed_effects1</code> uses <code>lm_robust</code> with binary indicators for blocks</li>
<li><code>lm_fixed_effects2</code> uses <code>lm_robust</code> with the <code>fixed_effects</code> option including a factor variable recording block membership</li>
<li><code>direct_wts</code> uses <code>lm_robust</code> without block-indicators but with precision weights</li>
<li><code>demeaned</code> regresses a block-centered version of the outcome on a block-centered version of the treatment indicator (i.e., including block fixed effects through a <em>within estimator</em>).</li>
</ol>
<p>Let&#x2019;s compare the estimates themselves using a single dataset first:</p>
<div class="tab">
<button class="tablinks" onclick="unrolltab(event, &apos;ch5R26&apos;)">
R code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Stata26&apos;)">
Stata code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Hide26&apos;)">
Hide
</button>
<div id="ch5R26" class="tabcontent">
<p><br></p>
<pre class="text"><code>## simple_block
ate_hbwt1 &lt;- with(datB, sum(taub*hbwt01))

## lm_fixed_effects1
ate_hbwt2 &lt;- lm_robust(Y~Z+bF,data=dat2)

## lm_fixed_effects2
ate_hbwt3 &lt;- lm_robust(Y~Z,fixed_effects=~bF,data=dat2)

## direct_wts
ate_hbwt4 &lt;- lm_robust(Y~Z,data=dat2,weights=hbwt)

## demeaned
ate_hbwt5 &lt;- lm_robust(I(Y-ave(Y,b))~I(Z-ave(Z,b)),data=dat2)

## List all
hbwtates &lt;- c(
  simple_block=ate_hbwt1,
    lm_fixed_effects1=ate_hbwt2$coefficients[[&quot;Z&quot;]],
    lm_fixed_effects2=ate_hbwt3$coefficients[[&quot;Z&quot;]],
    direct_wts=ate_hbwt4$coefficients[[&quot;Z&quot;]],
    demeaned=ate_hbwt5$coefficient[[2]]
  )

hbwtates</code></pre>
</div>
<div id="ch5Stata26" class="tabcontent">
<p><br></p>
<pre class="text"><code>** simple_block (return to block level data)
import delimited using &quot;datB.csv&quot;, clear
capture drop taubweighted_prec
gen taubweighted_prec = taub * hbwt01
qui sum taubweighted_prec
global ate_hbwt1 = r(sum)
capture drop __0*
tempvar calc_se2
gen `calc_se2&apos; = hbwt01^2 * estvartaub
qui sum `calc_se2&apos;
global ate_hbwt1se = sqrt(r(sum))

** lm_fixed_effects1 (return to observation level data)
import delimited using &quot;blocksimdat2.csv&quot;, clear // dat2 in the R code
rename (y z ntb ncb) (ynew znew nTb nCb) // Adjust names to match illustrative code above
qui reg ynew znew i.bf, vce(hc2)
global ate_hbwt2 = _b[znew]
global ate_hbwt2se = _se[znew]

** lm_fixed_effects2 (SEs differ from R variant of this)
qui areg ynew znew, absorb(bf) vce(hc2)
global ate_hbwt3 = _b[znew]
global ate_hbwt3se = _se[znew]

** direct_wts
qui reg ynew znew [aw = hbwt], vce(hc2)
global ate_hbwt4 = _b[znew]
global ate_hbwt4se = _se[znew]

** demeaned
bysort bf: egen meanz = mean(znew)
bysort bf: egen meany = mean(ynew)
gen demeany = ynew - meany
gen demeanz = znew - meanz
qui reg demeany demeanz, vce(hc2)
global ate_hbwt5 = _b[demeanz]
global ate_hbwt5se = _se[demeanz]

** List all
di &quot;simple_block = $ate_hbwt1&quot;
di &quot;lm_fixed_effects1 = $ate_hbwt2&quot;
di &quot;lm_fixed_effects2 = $ate_hbwt3&quot;
di &quot;direct_wts = $ate_hbwt4&quot;
di &quot;demeaned = $ate_hbwt5&quot;</code></pre>
</div>
<div id="ch5Hide26" class="tabcontent">

</div>
</div>
<pre><code>     simple_block lm_fixed_effects1 lm_fixed_effects2        direct_wts          demeaned 
           -13981            -13981            -13981            -13981            -13981 </code></pre>
<p>Let&#x2019;s also quickly review their standard errors:</p>
<div class="tab">
<button class="tablinks" onclick="unrolltab(event, &apos;ch5R27&apos;)">
R code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Stata27&apos;)">
Stata code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Hide27&apos;)">
Hide
</button>
<div id="ch5R27" class="tabcontent">
<p><br></p>
<pre class="text"><code>## Comparing the Standard Errors
ate_hbwt1se &lt;- sqrt(sum(datB$hbwt01^2 * datB$estvartaub))
hbwtses &lt;- c(
  simple_block=ate_hbwt1se,
  lm_fixed_effects1=ate_hbwt2$std.error[[&quot;Z&quot;]],
    lm_fixed_effects2=ate_hbwt3$std.error[[&quot;Z&quot;]],
    direct_wts=ate_hbwt4$std.error[[&quot;Z&quot;]],
    demeaned=ate_hbwt5$std.error[[2]]
  )

hbwtses</code></pre>
</div>
<div id="ch5Stata27" class="tabcontent">
<p><br></p>
<pre class="text"><code>** Comparing the Standard Errors
di &quot;simple_block = $ate_hbwt1se&quot;
di &quot;lm_fixed_effects1 = $ate_hbwt2se&quot;
di &quot;lm_fixed_effects2 = $ate_hbwt3se&quot;
di &quot;direct_wts = $ate_hbwt4se&quot;
di &quot;demeaned = $ate_hbwt5se&quot;</code></pre>
</div>
<div id="ch5Hide27" class="tabcontent">

</div>
</div>
<pre><code>     simple_block lm_fixed_effects1 lm_fixed_effects2        direct_wts          demeaned 
            328.7             716.6             716.6             788.3             705.4 </code></pre>
<p>We claimed that the block size weighted estimator is unbiased but perhaps less precise than the precision-weighted estimator. The evidence from this one draw of data does not bear that prediction out. But this isn&#x2019;t a very rigorous comparison.</p>
<p>To provide a better comparison, in R, we&#x2019;ll use <code>DeclareDesign</code> to evaluate the performance of these estimators. We implement them as functions passed to the <code>diagnose_design</code> function in the next code block. In Stata, we use the same approach as above, passing manually-written programs to <code>simulate</code>.</p>
<div class="tab">
<button class="tablinks" onclick="unrolltab(event, &apos;ch5R28&apos;)">
R code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Stata28&apos;)">
Stata code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Hide28&apos;)">
Hide
</button>
<div id="ch5R28" class="tabcontent">
<p><br></p>
<pre class="text"><code>## Define estimator functions employed in the simulation below

# Two options that don&apos;t account for blocking
estnowtHC2 &lt;- declare_estimator(Y~Z, inquiry=theestimand, .method=lm_robust, label=&quot;E1: Ignores Blocks, Design (HC2) SE&quot;)
estnowtIID &lt;- declare_estimator(Y~Z, inquiry=theestimand, .method=lm, label=&quot;E0: Ignores Blocks, OLS SE&quot;)

# Two options applying block-size weights
estnbwt1 &lt;- declare_estimator(Y~Z, inquiry=theestimand, .method=difference_in_means, blocks=b, label=&quot;E2: Diff Means Block Size Weights, Design SE&quot;)
estnbwt2 &lt;- declare_estimator(Y~Z, inquiry=theestimand, .method=lm_lin, covariates=~bF, label=&quot;E3: Treatment Interaction with Block Indicators, Design SE&quot;)

# Another block-size-weighted option (via regression weights)
nbwt_est_fun &lt;- function(data){
    data$newnbwt &lt;- with(data, (Z/pib) + ((1-Z)/(1-pib)))
    obj &lt;- lm_robust(Y~Z,data=data, weights=newnbwt)
    res &lt;- tidy(obj) %&gt;% filter(term==&quot;Z&quot;)
    return(res)
}
estnbwt3 &lt;- declare_estimator(handler=label_estimator(nbwt_est_fun), inquiry=theestimand, label=&quot;E4: Least Squares with Block Size Weights, Design SE&quot;)

# Two precision-weighted options
esthbwt1 &lt;- declare_estimator(Y~Z+bF, inquiry=theestimand, .method=lm_robust, label=&quot;E5: Precision Weights via Fixed Effects, Design SE&quot;)
esthbwt2 &lt;- declare_estimator(Y~Z, inquiry=theestimand, .method=lm_robust, fixed_effects=~bF, label=&quot;E6: Precision Weights via Demeaning, Design SE&quot;)

# Another precision-weighted option (regression weights)
hbwt_est_fun &lt;- function(data){
    data$newnbwt &lt;- with(data, (Z/pib) + ((1-Z)/(1-pib)))
    data$newhbwt &lt;- with(data, newnbwt * (pib * (1 - pib)))
    obj &lt;- lm_robust(Y~Z,data=data, weights=newhbwt)
    res &lt;- tidy(obj) %&gt;% filter(term==&quot;Z&quot;)
    return(res)
}
esthbwt3 &lt;- declare_estimator(handler=label_estimator(hbwt_est_fun), inquiry=theestimand, label=&quot;E7: Direct Precision Weights, Design SE&quot;)

# A final precision-weighted option (demeaning)
direct_demean_fun &lt;- function(data){
    data$Y &lt;- with(data, Y - ave(Y,b))
    data$Z &lt;- with(data, Z - ave(Z,b))
    obj &lt;- lm_robust(Y~Z, data=data)
    data.frame(term = &quot;Z&quot; ,
           estimate = obj$coefficients[[2]],
           std.error = obj$std.error[[2]],
           statistic = obj$statistic[[2]],
           p.value=obj$p.value[[2]],
           conf.low=obj$conf.low[[2]],
           conf.high=obj$conf.high[[2]],
           df=obj$df[[2]],
           outcome=&quot;Y&quot;)
}
esthbwt4 &lt;- declare_estimator(handler=label_estimator(direct_demean_fun), inquiry=theestimand, label=&quot;E8: Direct Demeaning, Design SE&quot;)

## Vector of all the estimator function names just created
## (via regular expression)
theestimators &lt;- ls(patt=&quot;^est.*?wt&quot;)
theestimators

## Get results for each estimator
checkest &lt;- sapply(
  theestimators,
  function(x){
    get(x)(as.data.frame(dat2))[c(&quot;estimate&quot;,&quot;std.error&quot;)]
    }
  )

## Combine all of these design objects
thedesignPlusEstimators &lt;- thedesign2 +
    estnowtHC2 + estnowtIID + estnbwt1 + estnbwt2 + estnbwt3 + 
    esthbwt1 + esthbwt2 + esthbwt3 + esthbwt4

## Update the default diagnosands for this simulation
diagnosands &lt;- declare_diagnosands(
   mean_estimand = mean(estimand),
   mean_estimate = mean(estimate),
   bias = mean(estimate - estimand),
   sd_estimate = sqrt(pop.var(estimate)),
   mean_se = mean(std.error),
   rmse = sqrt(mean((estimate - estimand) ^ 2)),
   power = mean(p.value &lt;= 0.05),
   coverage = mean(estimand &lt;= conf.high &amp; estimand &gt;= conf.low)
   )

## Perform the simulation
sims &lt;- 200
set.seed(12345)
thediagnosis &lt;- diagnose_design(thedesignPlusEstimators, sims=sims, bootstrap_sims = 0, diagnosands = diagnosands)</code></pre>
</div>
<div id="ch5Stata28" class="tabcontent">
<p><br></p>
<pre class="text"><code>** Define a program to apply various estimation strategies
** to a dataset drawn via sample_from.
capture program drop apply_estimators
program define apply_estimators, rclass
        
    ** Call the data generation program defined above
    sample_from
    return scalar ATE = r(ATE)
    
    ** E0: Ignores Blocks, OLS SE
    qui reg ynew znew
    return scalar estnowtIID_est = _b[znew]
    return scalar estnowtIID_se = _se[znew]
    return scalar estnowtIID_p = r(table)[&quot;pvalue&quot;, &quot;znew&quot;]
    
    ** E1: Ignores Blocks, Design (HC2) SE
    qui reg ynew znew, vce(hc2)
    return scalar estnowtHC2_est = _b[znew]
    return scalar estnowtHC2_se = _se[znew]
    return scalar estnowtHC2_p = r(table)[&quot;pvalue&quot;, &quot;znew&quot;]
    
    ** E2: Design-based difference in means, Design SE
    egen blockmean = mean(ynew), by(bf znew)
    egen blocksd = sd(ynew), by(bf znew)
    bysort bf (znew): gen diffmean = blockmean[_N] - blockmean[1] // with sorting, treat - control
    bysort bf (znew): gen variance = ((blocksd[_N]^2)/nTb[_N]) + ((blocksd[1]^2)/nTb[1])
    qui sum diffmean, meanonly
    local est = r(mean)
    return scalar estnbwt1_est = `est&apos;
    qui count
    local N = r(N)
    gen forblockedse = (nb/`N&apos;)^2 * variance
    bysort bf: replace forblockedse = . if _n != 1
    qui sum forblockedse
    local se = sqrt(r(sum))
    return scalar estnbwt1_se = `se&apos;
    qui levelsof bf, local(b)
    local J: word count `b&apos;
    local df = `N&apos; - (2*`J&apos;)
    return scalar estnbwt1_p = (2 * ttail(`df&apos;, abs(`est&apos;/`se&apos;)))
    
    ** E3: Treatment Interaction with Block Indicators, Design SE
    qui tabulate bf, gen(block_)
    drop block_1
    qui reg ynew znew i.bf
    gen samp = e(sample)
    foreach var of varlist block_* {
        qui sum `var&apos; if samp == 1, meanonly
        gen mc_`var&apos; = `var&apos; - r(mean)
    }
    qui reg ynew i.znew##c.(mc_block_*), vce(hc2)
    return scalar estnbwt2_est = _b[1.znew]
    return scalar estnbwt2_se = _se[1.znew]
    return scalar estnbwt2_p = r(table)[&quot;pvalue&quot;, &quot;1.znew&quot;]
    
    ** E4: Least Squares with Block Size Weights, Design SE
    qui reg ynew znew [aw = nbwt], vce(hc2)
    return scalar estnbwt4_est = _b[znew]
    return scalar estnbwt4_se = _se[znew]
    return scalar estnbwt4_p = r(table)[&quot;pvalue&quot;, &quot;znew&quot;]

    ** E5: Precision Weights via Fixed Effects, Design SE
    qui reg ynew znew i.bf, vce(hc2)
    return scalar esthbwt1_est = _b[znew]
    return scalar esthbwt1_se = _se[znew]
    return scalar esthbwt1_p = r(table)[&quot;pvalue&quot;, &quot;znew&quot;]
    
    ** E6: Precision Weights via Demeaning, Design SE
    qui areg ynew znew, absorb(bf) vce(hc2)
    return scalar esthbwt2_est = _b[znew]
    return scalar esthbwt2_se = _se[znew]
    return scalar esthbwt2_p = r(table)[&quot;pvalue&quot;, &quot;znew&quot;]
    
    ** E7: Direct Precision Weights, Design SE
    qui reg ynew znew [aw = hbwt], vce(hc2)
    return scalar esthbwt3_est = _b[znew]
    return scalar esthbwt3_se = _se[znew]
    return scalar esthbwt3_p = r(table)[&quot;pvalue&quot;, &quot;znew&quot;]
    
    ** E8: Direct Demeaning, Design SE
    bysort bf: egen meanz = mean(znew)
    bysort bf: egen meany = mean(ynew)
    gen demeany = ynew - meany
    gen demeanz = znew - meanz
    qui reg demeany demeanz, vce(hc2)
    return scalar esthbwt4_est = _b[demeanz]
    return scalar esthbwt4_se = _se[demeanz]
    return scalar esthbwt4_p = r(table)[&quot;pvalue&quot;, &quot;demeanz&quot;]
    
end

** Perform the simulation
apply_estimators
local rscalars : r(scalars)
local to_store &quot;&quot;
foreach item of local rscalars {
  local to_store &quot;`to_store&apos; `item&apos; = r(`item&apos;)&quot;
}
simulate ///
`to_store&apos;, ///
reps(200): ///
apply_estimators

** Create summary matrix
qui des, short
di (`r(k)&apos; - 1)/3
matrix diagnosands = J((`r(k)&apos; - 1)/3, 6, .)
matrix rownames diagnosands = &quot;E0: Ignores Blocks, OLS SE&quot; &quot;E1: Ignores Blocks, Design (HC2) SE&quot; &quot;E2: Diff Means BW, Design SE&quot; &quot;E3: Lin BW, Design SE&quot; &quot;E4: Direct BW, Design SE&quot; &quot;E5: FE PW, Design SE&quot; &quot;E6: Demean PW, Design SE&quot; &quot;E7: Direct PW, Design SE&quot; &quot;E8: Direct Demeaning, Design SE&quot;
matrix colnames diagnosands = &quot;Mean estimand&quot; &quot;Mean estimate&quot; &quot;Bias&quot; &quot;SD Estimate&quot; &quot;MeanSE&quot; &quot;Coverage&quot;

** Get variable name roots to loop through
local roots estnowtIID estnowtHC2 estnbwt1 estnbwt2 estnbwt4 esthbwt1 esthbwt2 esthbwt3 esthbwt4
 
** Calculate quantities to include
local row = 0
foreach l of local roots {
    
    local ++row
    
    * Estimand
    qui sum ATE, meanonly
    matrix diagnosands[`row&apos;, 1] = `r(mean)&apos;
    
    * Estimate
    qui sum `l&apos;_est, meanonly
    matrix diagnosands[`row&apos;, 2] = `r(mean)&apos;
    
    * Bias
    qui gen biascalc = `l&apos;_est - ATE
    qui sum biascalc, meanonly
    matrix diagnosands[`row&apos;, 3] = r(mean)
    drop biascalc
    
    * SD estimate (based on population variance, no n-1 in the variance denom.)
    qui sum `l&apos;_est
    qui gen sdcalc = (`l&apos;_est - r(mean))^2
    qui sum sdcalc
    matrix diagnosands[`row&apos;, 4] = sqrt(r(sum)/r(N))
    drop sdcalc
    
    * Mean SE
    qui sum `l&apos;_se
    matrix diagnosands[`row&apos;, 5] = `r(mean)&apos;
    
    * Coverage (z-stat CIs to limit estimates stored above)
    qui gen conflow = `l&apos;_est - (1.96 * `l&apos;_se)
    qui gen confhigh = `l&apos;_est + (1.96 * `l&apos;_se)
    qui gen inrange = ATE &lt;= confhigh &amp; ATE &gt;= conflow
    qui sum inrange
    matrix diagnosands[`row&apos;, 6] = r(mean)
    drop conf* inrange
    
}

* View the results
matrix list diagnosands</code></pre>
</div>
<div id="ch5Hide28" class="tabcontent">

</div>
</div>
<p>We can see in the diagnostic output below that the estimators using block-size weights (E2, E3, E4, or E5) all eliminate bias (within simulation error).<a href="references.html#fn32" class="footnote-ref" id="fnref32"><sup>32</sup></a> The estimators ignoring blocks (E0 and E1), are biased, and in this particular simulation the precision weighed estimators (E6&#x2013;E9) are also highly biased &#x2014; with some of them also producing poor &#x201C;coverage&#x201D; or false positive rates (E7 and E9). This output also shows us the &#x201C;SD Estimate&#x201D; (an estimate of the true standard error) and the &#x201C;Mean SE&#x201D; (which is the average of the analytic estimates of the standard error). In the case of E2, E3, E4 or E5 the Mean SE is larger than the SD Estimate &#x2014; this is good in that it means that our analytic standard errors will be conservative rather than overly liberal. However, we also would prefer that our analytic standard errors not be <em>too</em> conservative.</p>
<table>
<thead>
<tr>
<th style="text-align:left;">
Estimator
</th>
<th style="text-align:left;">
Mean Estimand
</th>
<th style="text-align:left;">
Mean Estimate
</th>
<th style="text-align:left;">
Bias
</th>
<th style="text-align:left;">
SD Estimate
</th>
<th style="text-align:left;">
Mean Se
</th>
<th style="text-align:left;">
Coverage
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
E0: Ignores Blocks, OLS SE
</td>
<td style="text-align:left;">
-12900.57
</td>
<td style="text-align:left;">
-12355.37
</td>
<td style="text-align:left;">
545.20
</td>
<td style="text-align:left;">
105.75
</td>
<td style="text-align:left;">
714.11
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E1: Ignores Blocks, Design (HC2) SE
</td>
<td style="text-align:left;">
-12900.57
</td>
<td style="text-align:left;">
-12355.37
</td>
<td style="text-align:left;">
545.20
</td>
<td style="text-align:left;">
105.75
</td>
<td style="text-align:left;">
352.66
</td>
<td style="text-align:left;">
0.94
</td>
</tr>
<tr>
<td style="text-align:left;">
E2: Diff Means Block Size Weights, Design SE
</td>
<td style="text-align:left;">
-12900.57
</td>
<td style="text-align:left;">
-12900.11
</td>
<td style="text-align:left;">
0.46
</td>
<td style="text-align:left;">
115.36
</td>
<td style="text-align:left;">
165.80
</td>
<td style="text-align:left;">
0.99
</td>
</tr>
<tr>
<td style="text-align:left;">
E3: Treatment Interaction with Block Indicators, Design SE
</td>
<td style="text-align:left;">
-12900.57
</td>
<td style="text-align:left;">
-12900.11
</td>
<td style="text-align:left;">
0.46
</td>
<td style="text-align:left;">
115.36
</td>
<td style="text-align:left;">
165.80
</td>
<td style="text-align:left;">
0.99
</td>
</tr>
<tr>
<td style="text-align:left;">
E4: Least Squares with Block Size Weights, Design SE
</td>
<td style="text-align:left;">
-12900.57
</td>
<td style="text-align:left;">
-12900.11
</td>
<td style="text-align:left;">
0.46
</td>
<td style="text-align:left;">
115.36
</td>
<td style="text-align:left;">
444.82
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E5: Precision Weights via Fixed Effects, Design SE
</td>
<td style="text-align:left;">
-12900.57
</td>
<td style="text-align:left;">
-14143.05
</td>
<td style="text-align:left;">
-1242.48
</td>
<td style="text-align:left;">
208.11
</td>
<td style="text-align:left;">
713.30
</td>
<td style="text-align:left;">
0.74
</td>
</tr>
<tr>
<td style="text-align:left;">
E6: Precision Weights via Demeaning, Design SE
</td>
<td style="text-align:left;">
-12900.57
</td>
<td style="text-align:left;">
-14143.05
</td>
<td style="text-align:left;">
-1242.48
</td>
<td style="text-align:left;">
208.11
</td>
<td style="text-align:left;">
713.30
</td>
<td style="text-align:left;">
0.74
</td>
</tr>
<tr>
<td style="text-align:left;">
E7: Direct Precision Weights, Design SE
</td>
<td style="text-align:left;">
-12900.57
</td>
<td style="text-align:left;">
-14143.05
</td>
<td style="text-align:left;">
-1242.48
</td>
<td style="text-align:left;">
208.11
</td>
<td style="text-align:left;">
791.40
</td>
<td style="text-align:left;">
0.94
</td>
</tr>
<tr>
<td style="text-align:left;">
E8: Direct Demeaning, Design SE
</td>
<td style="text-align:left;">
-12900.57
</td>
<td style="text-align:left;">
-14143.05
</td>
<td style="text-align:left;">
-1242.48
</td>
<td style="text-align:left;">
208.11
</td>
<td style="text-align:left;">
702.44
</td>
<td style="text-align:left;">
0.73
</td>
</tr>
</tbody>
</table>
<p>Why is the performance of the precision-weighted approach so poor so far, even just in terms of precision? Well, the simulated outcome data used in this example is highly skewed by design. All else equal, the precision-weighted approach makes a reasonable choice to allow some bias in return for reduced variance. But it&#x2019;s performance can suffer dramatically in the presence of common problems in administrative data like skewed outcomes or zero-inflation (i.e., many 0s). With skewed or zero-inflated outcomes, the block-size weighted approach may be safer.</p>
<p>One solution we could apply to allow more confident use of the precision-weighted approach is rank-transforming the outcome measure. We apply this change in the code chunk below. This transformation nearly erases the bias from the block-size weighted estimators, and the precision-weighted approaches now perform closer to our expectations (they produce identical effect estiates after rounding here, with a slightly lower standard error). Ignoring the blocking design is still a problem&#x2014;E0 and E1 continue to show substantial bias. Moreover, notice here and above that although using regression weights to apply these blocking adjustments (rather than, e.g., an appropriate fixed effects specification) produces the right estimates, it may do so at the cost of more conservative standard error estimates.</p>
<div class="tab">
<button class="tablinks" onclick="unrolltab(event, &apos;ch5R29&apos;)">
R code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Stata29&apos;)">
Stata code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Hide29&apos;)">
Hide
</button>
<div id="ch5R29" class="tabcontent">
<p><br></p>
<pre class="text"><code>## Define a function to rank-transform the potential outcomes
po_functionNorm &lt;- function(data){
    data &lt;- data %&gt;%
      group_by(b) %&gt;%
      mutate(
        Y_Z_0=rank(y0),
        Y_Z_1=rank(y1)
        )
    return(as.data.frame(data))
}

## Redefine relevant DeclareDesign objects
theysNorm &lt;- declare_potential_outcomes(handler = po_functionNorm)
thedesignNorm &lt;- thepop2 + theysNorm + theestimand + theassign + theobsident
datNorm &lt;- draw_data(thedesignNorm)
thedesignPlusEstimatorsNorm &lt;- thedesignNorm +
  estnowtHC2 + estnowtIID + estnbwt1 +
  estnbwt2 + estnbwt3 + esthbwt1 + 
  esthbwt2 + esthbwt3 + esthbwt4

## Perform a new simulation
sims &lt;- 200
thediagnosisNorm &lt;- diagnose_design(thedesignPlusEstimatorsNorm, sims = sims, bootstrap_sims = 0, diagnosands = diagnosands)</code></pre>
</div>
<div id="ch5Stata29" class="tabcontent">
<p><br></p>
<pre class="text"><code>** Perform this simulation again with rank-transformed potential outcomes

** Redefine sampling program to consider ranked potential outcomes
capture program drop sample_from
program define sample_from, rclass
    
    * Load simulated data from R
    import delimited using &quot;blocksimdat.csv&quot;, clear
    
    * Get # treated for each block
    levelsof nb, local(nblevels)
    local numtreat
    local i = 0
    foreach l of local nblevels {
        
        local ++i // block indices (1, 2, 3,... 10)
        
        * even block indices (2nd, 4th, etc.) get 10% treated
        if mod(`i&apos;,2) == 0 {
            local temp = `l&apos;/10 
            local numtreat `numtreat&apos; `temp&apos;
        }
        
        * odd get 50% treated
        else {
            local temp = `l&apos;/2
            local numtreat `numtreat&apos; `temp&apos;
        }
        
    }
    
    * Re-assign (simulated) treatment in this draw of the data
    capture drop __0*
    block_ra znew, block_var(bf) block_m(`numtreat&apos;) replace
    
    * No additional treatment effects, but rank POs
    egen y_znew_0 = rank(y0), unique // Different than how ties are handled in R.
    egen y_znew_1 = rank(y1), unique // R rank command averages by default.
    
    * Get true ATE in r()
    gen true_effect = y_znew_1 - y_znew_0
    sum true_effect, meanonly
    return scalar ATE = r(mean)
    
    * Revealed outcome
    gen ynew = (znew * y_znew_1) + ((1 - znew) * y_znew_0)
    
    * Now add individual-level weights to the data
    * (under complete_ra within blocks, these will
    * be the same across re-randomizations).
    bysort bf: egen pib = mean(znew) // Prob. of treatment assignment
    bysort bf: egen nTb = total(znew) // Number treated
    gen nCb = nb - nTb // Number control
    gen nbwt = (znew/pib) + ((1-znew)/(1-pib)) // Unbiased regression weight
    gen hbwt = nbwt * (pib * (1 - pib)) // Precision regression weight

end

** Estimators program above can then be re-used
apply_estimators
local rscalars : r(scalars)
local to_store &quot;&quot;
foreach item of local rscalars {
  local to_store &quot;`to_store&apos; `item&apos; = r(`item&apos;)&quot;
}
simulate ///
`to_store&apos;, ///
reps(200): ///
apply_estimators

** Create summary matrix
qui des, short
di (`r(k)&apos; - 1)/3
matrix diagnosands = J((`r(k)&apos; - 1)/3, 6, .)
matrix rownames diagnosands = &quot;E0: Ignores Blocks, OLS SE&quot; &quot;E1: Ignores Blocks, Design (HC2) SE&quot; &quot;E2: Diff Means BW, Design SE&quot; &quot;E3: Lin BW, Design SE&quot; &quot;E5: Direct BW, Design SE&quot; &quot;E6: FE PW, Design SE&quot; &quot;E7: Demean PW, Design SE&quot; &quot;E8: Direct PW, Design SE&quot; &quot;E9: Direct Demeaning, Design SE&quot;
matrix colnames diagnosands = &quot;Mean estimand&quot; &quot;Mean estimate&quot; &quot;Bias&quot; &quot;SD Estimate&quot; &quot;MeanSE&quot; &quot;Coverage&quot;

** Get variable name roots to loop through
local roots estnowtIID estnowtHC2 estnbwt1 estnbwt2 estnbwt4 esthbwt1 esthbwt2 esthbwt3 esthbwt4
 
** Calculate quantities to include
local row = 0
foreach l of local roots {
    
    local ++row
    
    * Estimand
    qui sum ATE, meanonly
    matrix diagnosands[`row&apos;, 1] = `r(mean)&apos;
    
    * Estimate
    qui sum `l&apos;_est, meanonly
    matrix diagnosands[`row&apos;, 2] = `r(mean)&apos;
    
    * Bias
    qui gen biascalc = `l&apos;_est - ATE
    qui sum biascalc, meanonly
    matrix diagnosands[`row&apos;, 3] = r(mean)
    drop biascalc
    
    * SD estimate (based on population variance, no n-1 in the variance denom.)
    qui sum `l&apos;_est
    qui gen sdcalc = (`l&apos;_est - r(mean))^2
    qui sum sdcalc
    matrix diagnosands[`row&apos;, 4] = sqrt(r(sum)/r(N))
    drop sdcalc
    
    * Mean SE
    qui sum `l&apos;_se
    matrix diagnosands[`row&apos;, 5] = `r(mean)&apos;
    
    * Coverage (z-stat CIs to limit estimates stored above)
    qui gen conflow = `l&apos;_est - (1.96 * `l&apos;_se)
    qui gen confhigh = `l&apos;_est + (1.96 * `l&apos;_se)
    qui gen inrange = ATE &lt;= confhigh &amp; ATE &gt;= conflow
    qui sum inrange
    matrix diagnosands[`row&apos;, 6] = r(mean)
    drop conf* inrange
    
}

* View the results
matrix list diagnosands</code></pre>
</div>
<div id="ch5Hide29" class="tabcontent">

</div>
</div>
<table>
<thead>
<tr>
<th style="text-align:left;">
Estimator
</th>
<th style="text-align:left;">
Mean Estimand
</th>
<th style="text-align:left;">
Mean Estimate
</th>
<th style="text-align:left;">
Bias
</th>
<th style="text-align:left;">
SD Estimate
</th>
<th style="text-align:left;">
Mean Se
</th>
<th style="text-align:left;">
Coverage
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
E0: Ignores Blocks, OLS SE
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
-127.08
</td>
<td style="text-align:left;">
-127.08
</td>
<td style="text-align:left;">
1.84
</td>
<td style="text-align:left;">
17.81
</td>
<td style="text-align:left;">
0.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E1: Ignores Blocks, Design (HC2) SE
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
-127.08
</td>
<td style="text-align:left;">
-127.08
</td>
<td style="text-align:left;">
1.84
</td>
<td style="text-align:left;">
14.05
</td>
<td style="text-align:left;">
0.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E2: Diff Means Block Size Weights, Design SE
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
0.11
</td>
<td style="text-align:left;">
0.11
</td>
<td style="text-align:left;">
1.69
</td>
<td style="text-align:left;">
5.49
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E3: Treatment Interaction with Block Indicators, Design SE
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
0.11
</td>
<td style="text-align:left;">
0.11
</td>
<td style="text-align:left;">
1.69
</td>
<td style="text-align:left;">
5.49
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E4: Least Squares with Block Size Weights, Design SE
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
0.11
</td>
<td style="text-align:left;">
0.11
</td>
<td style="text-align:left;">
1.69
</td>
<td style="text-align:left;">
15.66
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E5: Precision Weights via Fixed Effects, Design SE
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
0.11
</td>
<td style="text-align:left;">
0.11
</td>
<td style="text-align:left;">
1.35
</td>
<td style="text-align:left;">
4.09
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E6: Precision Weights via Demeaning, Design SE
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
0.11
</td>
<td style="text-align:left;">
0.11
</td>
<td style="text-align:left;">
1.35
</td>
<td style="text-align:left;">
4.09
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E7: Direct Precision Weights, Design SE
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
0.11
</td>
<td style="text-align:left;">
0.11
</td>
<td style="text-align:left;">
1.35
</td>
<td style="text-align:left;">
15.28
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E8: Direct Demeaning, Design SE
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
0.11
</td>
<td style="text-align:left;">
0.11
</td>
<td style="text-align:left;">
1.35
</td>
<td style="text-align:left;">
4.09
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
</tbody>
</table>
<p>Lastly, note that when the probability of treatment is the same in each block (e.g., with a pair-randomized design), ignoring the blocking structure during estimation should not lead to meaningful bias. But we can still improve precision by taking blocking into account <span class="citation">(Bowers <a href="#ref-bowers2011mem">2011</a>)</span>. This final simulation changes the design to still have unequal sized blocks, but now with a uniform probability of treatment assignment in each block (instead of a mix of 10% and 50%). Here, only two estimators show appreciable bias (E4 and E7). However, ignoring the blocks during estimation leads to overly conservative standard errors.</p>
<div class="tab">
<button class="tablinks" onclick="unrolltab(event, &apos;ch5R36&apos;)">
R code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Stata36&apos;)">
Stata code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Hide36&apos;)">
Hide
</button>
<div id="ch5R36" class="tabcontent">
<p><br></p>
<pre class="text"><code>## Re-define relevant declare design objects
theassignEqual &lt;- declare_assignment(Z=block_ra(blocks = bF))
thedesignNormEqual &lt;- thepop2 + theysNorm + theestimand + 
  theassignEqual + theobsident
datNormEqual &lt;- draw_data(thedesignNormEqual)
thedesignPlusEstimatorsNormEqual &lt;- thedesignNormEqual +
  estnowtHC2 + estnowtIID + estnbwt1 + 
  estnbwt2 + estnbwt3 + esthbwt1 + 
  esthbwt2 + esthbwt3 + esthbwt4

## Perform a new simulation
sims &lt;- 200
set.seed(12345)
thediagnosisNormEqual &lt;- diagnose_design(thedesignPlusEstimatorsNormEqual, sims = sims, bootstrap_sims = 0, diagnosands = diagnosands)</code></pre>
</div>
<div id="ch5Stata36" class="tabcontent">
<p><br></p>
<pre class="text"><code>** Perform this simulation again with equal assignment probabilities.

** Redefine sampling program once more.
capture program drop sample_from
program define sample_from, rclass
    
    * Load simulated data from R
    import delimited using &quot;blocksimdat.csv&quot;, clear

    * Re-assign (simulated) treatment in this draw of the data.
    capture drop __0*
    block_ra znew, block_var(bf) replace
    
    * No additional treatment effects, but rank POs
    egen y_znew_0 = rank(y0), unique // Different than how ties are handled in R.
    egen y_znew_1 = rank(y1), unique // R rank command averages by default.
    
    * Get true ATE in r()
    gen true_effect = y_znew_1 - y_znew_0
    sum true_effect, meanonly
    return scalar ATE = r(mean)
    
    * Revealed outcome
    gen ynew = (znew * y_znew_1) + ((1 - znew) * y_znew_0)
    
    * Now add individual-level weights to the data
    * (under complete_ra within blocks, these will
    * be the same across re-randomizations).
    bysort bf: egen pib = mean(znew) // Prob. of treatment assignment
    bysort bf: egen nTb = total(znew) // Number treated
    gen nCb = nb - nTb // Number control
    gen nbwt = (znew/pib) + ((1-znew)/(1-pib)) // Unbiased regression weight
    gen hbwt = nbwt * (pib * (1 - pib)) // Precision regression weight

end

** Estimators program above can then be re-used
apply_estimators
local rscalars : r(scalars)
local to_store &quot;&quot;
foreach item of local rscalars {
  local to_store &quot;`to_store&apos; `item&apos; = r(`item&apos;)&quot;
}
simulate ///
`to_store&apos;, ///
reps(200): ///
apply_estimators

** Create summary matrix
qui des, short
di (`r(k)&apos; - 1)/3
matrix diagnosands = J((`r(k)&apos; - 1)/3, 6, .)
matrix rownames diagnosands = &quot;E0: Ignores Blocks, OLS SE&quot; &quot;E1: Ignores Blocks, Design (HC2) SE&quot; &quot;E2: Diff Means BW, Design SE&quot; &quot;E3: Lin BW, Design SE&quot; &quot;E5: Direct BW, Design SE&quot; &quot;E6: FE PW, Design SE&quot; &quot;E7: Demean PW, Design SE&quot; &quot;E8: Direct PW, Design SE&quot; &quot;E9: Direct Demeaning, Design SE&quot;
matrix colnames diagnosands = &quot;Mean estimand&quot; &quot;Mean estimate&quot; &quot;Bias&quot; &quot;SD Estimate&quot; &quot;MeanSE&quot; &quot;Coverage&quot;

** Get variable name roots to loop through
local roots estnowtIID estnowtHC2 estnbwt1 estnbwt2 estnbwt4 esthbwt1 esthbwt2 esthbwt3 esthbwt4
 
** Calculate quantities to include
local row = 0
foreach l of local roots {
    
    local ++row
    
    * Estimand
    qui sum ATE, meanonly
    matrix diagnosands[`row&apos;, 1] = `r(mean)&apos;
    
    * Estimate
    qui sum `l&apos;_est, meanonly
    matrix diagnosands[`row&apos;, 2] = `r(mean)&apos;
    
    * Bias
    qui gen biascalc = `l&apos;_est - ATE
    qui sum biascalc, meanonly
    matrix diagnosands[`row&apos;, 3] = r(mean)
    drop biascalc
    
    * SD estimate (based on population variance, no n-1 in the variance denom.)
    qui sum `l&apos;_est
    qui gen sdcalc = (`l&apos;_est - r(mean))^2
    qui sum sdcalc
    matrix diagnosands[`row&apos;, 4] = sqrt(r(sum)/r(N))
    drop sdcalc
    
    * Mean SE
    qui sum `l&apos;_se
    matrix diagnosands[`row&apos;, 5] = `r(mean)&apos;
    
    * Coverage (z-stat CIs to limit estimates stored above)
    qui gen conflow = `l&apos;_est - (1.96 * `l&apos;_se)
    qui gen confhigh = `l&apos;_est + (1.96 * `l&apos;_se)
    qui gen inrange = ATE &lt;= confhigh &amp; ATE &gt;= conflow
    qui sum inrange
    matrix diagnosands[`row&apos;, 6] = r(mean)
    drop conf* inrange
    
}

* View the results
matrix list diagnosands</code></pre>
</div>
<div id="ch5Hide36" class="tabcontent">

</div>
</div>
<table>
<thead>
<tr>
<th style="text-align:left;">
Estimator
</th>
<th style="text-align:left;">
Mean Estimand
</th>
<th style="text-align:left;">
Mean Estimate
</th>
<th style="text-align:left;">
Bias
</th>
<th style="text-align:left;">
SD Estimate
</th>
<th style="text-align:left;">
Mean Se
</th>
<th style="text-align:left;">
Coverage
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
E0: Ignores Blocks, OLS SE
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
-0.34
</td>
<td style="text-align:left;">
-0.34
</td>
<td style="text-align:left;">
4.74
</td>
<td style="text-align:left;">
12.40
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E1: Ignores Blocks, Design (HC2) SE
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
-0.34
</td>
<td style="text-align:left;">
-0.34
</td>
<td style="text-align:left;">
4.74
</td>
<td style="text-align:left;">
12.40
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E2: Diff Means Block Size Weights, Design SE
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
-0.34
</td>
<td style="text-align:left;">
-0.34
</td>
<td style="text-align:left;">
4.74
</td>
<td style="text-align:left;">
7.36
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E3: Treatment Interaction with Block Indicators, Design SE
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
-0.34
</td>
<td style="text-align:left;">
-0.34
</td>
<td style="text-align:left;">
4.74
</td>
<td style="text-align:left;">
7.36
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E4: Least Squares with Block Size Weights, Design SE
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
77.57
</td>
<td style="text-align:left;">
77.57
</td>
<td style="text-align:left;">
4.09
</td>
<td style="text-align:left;">
11.89
</td>
<td style="text-align:left;">
0.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E5: Precision Weights via Fixed Effects, Design SE
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
-0.34
</td>
<td style="text-align:left;">
-0.34
</td>
<td style="text-align:left;">
4.74
</td>
<td style="text-align:left;">
7.36
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E6: Precision Weights via Demeaning, Design SE
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
-0.34
</td>
<td style="text-align:left;">
-0.34
</td>
<td style="text-align:left;">
4.74
</td>
<td style="text-align:left;">
7.36
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E7: Direct Precision Weights, Design SE
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
127.05
</td>
<td style="text-align:left;">
127.05
</td>
<td style="text-align:left;">
2.71
</td>
<td style="text-align:left;">
10.95
</td>
<td style="text-align:left;">
0.00
</td>
</tr>
<tr>
<td style="text-align:left;">
E8: Direct Demeaning, Design SE
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
-0.34
</td>
<td style="text-align:left;">
-0.34
</td>
<td style="text-align:left;">
4.74
</td>
<td style="text-align:left;">
7.36
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
</tbody>
</table>
<div id="summary-of-approaches-to-the-analysis-of-block-randomized-trials" class="section level4">
<h4><span class="header-section-number">5.5.2.1</span> Summary of Approaches to the Analysis of Block Randomized Trials</h4>
<p>Our team often prefers block randomized trials because of their potential to increase statistical power, help us avoid bias, and help us better highlight subgroup effects. We generally prefer to &#x201C;analyze as we randomize.&#x201D; But this can mean a number of things with blocked designs, and different designs will require different analytical decisions. Sometimes we may be willing to trade a small amount of bias to make our estimates more precise. Other studies will be so large or small that one or another estimation strategy will be obviously superior. We use our Analysis Plans to explain our choices, and generally rely on simulation studies when we are uncertain about the applicability of statistical rules of thumb to any given design.</p>
</div>
</div>
</div>
<div id="clusterrandanalysis" class="section level2">
<h2><span class="header-section-number">5.6</span> Cluster-randomized trials</h2>
<p>In a cluster randomized trial, treatment is assigned at the level of larger groups of units, called &#x201C;clusters,&#x201D; instead of at the individual level.<a href="references.html#fn33" class="footnote-ref" id="fnref33"><sup>33</sup></a> These studies tend to distinguish signal from noise less effectively than an experiment where we assign treatment directly to individuals &#x2014; i.e., they have less precision. The number of independent pieces of information available to learn about the treatment effect will generally be closer to the number of clusters (each of which tends to be assigned to treatment independently of each other) than the number of dependent observations within a cluster (See EGAP&#x2019;s <a href="https://egap.org/resource/10-things-to-know-about-cluster-randomization/">10 Things You Need to Know about Cluster Randomization</a>).<a href="references.html#fn34" class="footnote-ref" id="fnref34"><sup>34</sup></a></p>
<p>Since we analyze as we randomize, a cluster randomized experiment may require that we (1) weight cluster-level average treatment effects by cluster size if we are trying to estimate the average of the individual level causal effects <span class="citation">(Middleton and Aronow <a href="#ref-middleton2015unbiased">2015</a>)</span>. They also require that we (2) change how we calculate standard errors and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span>-values to account for the fact that uncertainty is generated at the level of the cluster and not at the level of the individual <span class="citation">(Hansen and Bowers <a href="#ref-hansen_covariate_2008">2008</a>; Gerber and Green <a href="#ref-gerber_field_2012">2012</a>)</span>. For example, imagine that we had 10 clusters (administrative offices, physicians groups, etc.) with half assigned to treatment and half assigned to control.</p>
<div class="tab">
<button class="tablinks" onclick="unrolltab(event, &apos;ch5R30&apos;)">
R code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Stata30&apos;)">
Stata code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Hide30&apos;)">
Hide
</button>
<div id="ch5R30" class="tabcontent">
<p><br></p>
<pre class="text"><code>## Create a copy of dat2 to use for our clustering examples
dat3 &lt;- dat2
dat3$cluster &lt;- dat3$b
dat3$clusterF &lt;- factor(dat3$cluster)
ndat3 &lt;- nrow(dat3)

## Randomly assign half of the clusters to treatment and half to control
set.seed(12345)
dat3$Zcluster &lt;- cluster_ra(cluster=dat3$cluster)
with(dat3,table(Zcluster,cluster))</code></pre>
</div>
<div id="ch5Stata30" class="tabcontent">
<p><br></p>
<pre class="text"><code>** Modify dat2 to use for our clustering examples
import delimited using &quot;blocksimdat2.csv&quot;, clear // dat2 in the R code
gen cluster = b

** Randomly assign half of the clusters to treatment and half to control
set seed 12345
cluster_ra zcluster, cluster_var(cluster)
table zcluster cluster</code></pre>
</div>
<div id="ch5Hide30" class="tabcontent">

</div>
</div>
<pre><code>        cluster
Zcluster   1   2   3   4   5   6   7   8   9  10
       0   8   0  30  40   0   0   0   0 100 800
       1   0  20   0   0  50  60  70  80   0   0</code></pre>
<p>Although our example data has 1258 observations, we do not have 1258 pieces of independent information about the effect of the treatment because people were assigned in groups. Rather we have some amount of information in between 1258 and the number of clusters (in this case,
10). We can see above that the number of
people within each cluster &#x2014; and notice that all of the people are coded as
either control or treatment because assignment is at the level of the cluster.</p>
<p>Before continuing, in R, let&#x2019;s set up some <code>DeclareDesign</code> elements for a simulation of clustered experimental designs. We&#x2019;ll do some comparable preparation in Stata.</p>
<div class="tab">
<button class="tablinks" onclick="unrolltab(event, &apos;ch5R31&apos;)">
R code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Stata31&apos;)">
Stata code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Hide31&apos;)">
Hide
</button>
<div id="ch5R31" class="tabcontent">
<p><br></p>
<pre class="text"><code>## Get weights for one estimation strategy used below
library(ICC)
iccres &lt;- ICCest(x=clusterF,y=Y,data=dat3)
dat3$varweight &lt;- 1/(iccres$vara + (iccres$varw/dat3$nb))

## Define various DeclareDesign elements
thepop3 &lt;- declare_population(dat3)
po_functionCluster &lt;- function(data){
    data$Y_Zcluster_0 &lt;- data$y0
    data$Y_Zcluster_1 &lt;- data$y1
    data
}
theysCluster  &lt;- declare_potential_outcomes(handler = po_functionCluster)
theestimandCluster &lt;- declare_inquiry(ATE = mean(Y_Zcluster_1 - Y_Zcluster_0))
theassignCluster &lt;- declare_assignment(Zcluster=cluster_ra(clusters=cluster))
theobsidentCluster &lt;- declare_reveal(Y, Zcluster)
thedesignCluster &lt;- thepop3 + theysCluster + theestimandCluster + 
  theassignCluster + theobsidentCluster
datCluster &lt;- draw_data(thedesignCluster)</code></pre>
</div>
<div id="ch5Stata31" class="tabcontent">
<p><br></p>
<pre class="text"><code>** Update the sampling program for a basic clustered design
capture program drop sample_from
program define sample_from, rclass
    
    * Load baseline data
    import delimited using &quot;blocksimdat2.csv&quot;, clear // dat2 in the R code
    gen cluster = b
    
    * Re-assign (simulated) treatment in this draw of the data
    cluster_ra zcluster, cluster_var(cluster)
    
    * No additional treatment effects
    gen y_zcluster_0 = y0
    gen y_zcluster_1 = y1
    
    * Get true ATE in r()
    gen true_effect = y_zcluster_1 - y_zcluster_0
    sum true_effect, meanonly
    return scalar ATE = r(mean)
    
    * Revealed outcome
    gen ynew = (zcluster * y_zcluster_1) + ((1 - zcluster) * y_zcluster_0)
    
    ** Get weights for one estimation strategy used below
    qui loneway ynew cluster
    gen varweight = 1 / ( r(sd_b)^2 + ( r(sd_w)^2 / nb ) ) 

end</code></pre>
</div>
<div id="ch5Hide31" class="tabcontent">

</div>
</div>
<p>In everyday practice, with more than about 50 (equally-sized) clusters, we often produce estimates using more or less the same kinds estimators as those above, but changing our standard error calculations to instead rely on <code>CR2</code> cluster-robust standard error <span class="citation">(Pustejovsky <a href="#ref-pustejovsky2019cr">2019</a>)</span>. We show two approaches to such adjustment.</p>
<p>First, the design-based <code>difference_in_means()</code> function in R:<a href="references.html#fn35" class="footnote-ref" id="fnref35"><sup>35</sup></a></p>
<div class="sourceCode" id="cb173"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb173-1" title="1"><span class="co">## CR2 via difference in means</span></a>
<a class="sourceLine" id="cb173-2" title="2">estAndSE4a &lt;-<span class="st"> </span><span class="kw">difference_in_means</span>(Y<span class="op">~</span>Zcluster, <span class="dt">data=</span>datCluster, <span class="dt">clusters=</span>cluster)</a>
<a class="sourceLine" id="cb173-3" title="3">estAndSE4a</a></code></pre></div>
<pre><code>Design:  Clustered 
         Estimate Std. Error t value Pr(&gt;|t|) CI Lower CI Upper   DF
Zcluster   -15597       8336  -1.871   0.1232   -37356     6162 4.76</code></pre>
<p>Second, via linear regression with an appropriate error adjustment:</p>
<div class="tab">
<button class="tablinks" onclick="unrolltab(event, &apos;ch5R32&apos;)">
R code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Stata32&apos;)">
Stata code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Hide32&apos;)">
Hide
</button>
<div id="ch5R32" class="tabcontent">
<p><br></p>
<pre class="text"><code>## CR2 via linear regression
estAndSE4b &lt;- lm_robust(Y~Zcluster, data=datCluster, clusters=cluster, se_type=&quot;CR2&quot;)
estAndSE4b</code></pre>
</div>
<div id="ch5Stata32" class="tabcontent">
<p><br></p>
<pre class="text"><code>** Get the treatment assignment used in the R code
import delimited using &quot;datCluster.csv&quot;, clear

** Stata&apos;s default clustered errors
reg y zcluster, vce(cluster cluster)
local CR1 = _se[zcluster]

** CR2 errors via reg_sandwich
* ssc install reg_sandwich
reg_sandwich y zcluster, cluster(cluster)
local CR2 = _se[zcluster]

** Notice: Stata&apos;s default is CR1, not CR2
macro list _CR1 _CR2
assert `CR1&apos; != `CR2&apos;</code></pre>
</div>
<div id="ch5Hide32" class="tabcontent">

</div>
</div>
<pre><code>            Estimate Std. Error t value Pr(&gt;|t|) CI Lower CI Upper    DF
(Intercept)    15707       8332   1.885   0.1409    -8542    39955 3.578
Zcluster      -15597       8336  -1.871   0.1232   -37356     6162 4.760</code></pre>
<div id="bias-when-cluster-size-is-correlated-with-potential-outcomes" class="section level3">
<h3><span class="header-section-number">5.6.1</span> Bias when cluster size is correlated with potential outcomes</h3>
<p>When clusters have unequal sizes, in addition to adjusting our standard error calculations, we might worry about bias as well <span class="citation">(Middleton and Aronow <a href="#ref-middleton2015unbiased">2015</a>)</span> (see also this <a href="https://declaredesign.org/blog/bias-cluster-randomized-trials.html">Declare Design blog post</a>). Here, we demonstrate how bias could emerge in the analysis of a cluster randomized trial, as well as how to reduce that bias.</p>
<div class="tab">
<button class="tablinks" onclick="unrolltab(event, &apos;ch5R33&apos;)">
R code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Stata33&apos;)">
Stata code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Hide33&apos;)">
Hide
</button>
<div id="ch5R33" class="tabcontent">
<p><br></p>
<pre class="text"><code>## Define estimators that can be repeated in the simulation below

## No adjustment for clustering
estC0 &lt;- declare_estimator(Y~Zcluster, inquiry=theestimand, .method=lm, label=&quot;C0: Ignores Clusters, IID SE&quot;)

## HC2 SEs
estC1 &lt;- declare_estimator(Y~Zcluster, inquiry=theestimand, .method=lm_robust, label=&quot;C1: Ignores Clusters, HC22 SE&quot;)

## Clustered SEs (CR1; Stata default)
estC2 &lt;- declare_estimator(Y~Zcluster, inquiry=theestimand, .method=lm_robust, clusters=cluster, se_type=&quot;stata&quot;, label=&quot;C2: OLS, CR1 SE (Stata)&quot;)

## CR2 SEs (difference in means)
estC3 &lt;- declare_estimator(Y~Zcluster, inquiry=theestimand, .method=difference_in_means, clusters = cluster, label=&quot;C3: Diff Means, CR2 SE&quot;)

## CR2 SEs (linear regression)
estC4 &lt;- declare_estimator(Y~Zcluster, inquiry=theestimand, .method=lm_robust, clusters = cluster, se_type=&quot;CR2&quot;, label=&quot;C4: OLS, CR2 SE&quot;)

## Horvitz-Thompson estimator with clustering
estC5 &lt;- declare_estimator(Y~Zcluster, inquiry=theestimand, .method=horvitz_thompson, clusters=cluster, simple=FALSE, condition_prs=.5, label=&quot;C5: Horvitz-Thompson Cluster, Young SE&quot;)

## Linear regression, CR2 errors, weight by cluster size
estC6 &lt;- declare_estimator(Y~Zcluster, inquiry=theestimand,
.method=lm_robust, weights = nb, clusters=cluster, se_type=&quot;CR2&quot;, label=&quot;C6: OLS with Cluster Size Weights, CR2 SE&quot;)

## Linear regression, CR2 errors, control for cluster size, variance weights
estC7 &lt;- declare_estimator(Y~Zcluster+nb, inquiry=theestimand,
.method=lm_robust, weights=varweight, clusters=cluster, se_type=&quot;CR2&quot;, label=&quot;C7: OLS Clusters with Weights, CR2 RCSE&quot;)

## Linear regression, CR2 errors, control for cluster size
estC8 &lt;- declare_estimator(Y~Zcluster+nb, inquiry=theestimand, .method=lm_robust, clusters=cluster, se_type=&quot;CR2&quot;,
label=&quot;C8: OLS Clusters with adj for cluster size, CR2 RCSE&quot;)

## Linear regression, CR2 errors, lin estimation for cluster size
estC9 &lt;- declare_estimator(Y~Zcluster, inquiry=theestimand,
.method=lm_lin, covariates=~nb, clusters=cluster, se_type=&quot;CR2&quot;,
label=&quot;C9: OLS Clusters with adj for cluster size, CR2 RCSE&quot;)

## Add all these estimators to the design
thedesignClusterPlusEstimators &lt;- thedesignCluster +
    estC0 + estC1 + estC2 + 
  estC3 + estC4 + estC5 + 
  estC6 + estC7 + estC8 + 
  estC9

## Simulate the performance of these estimators
sims &lt;- 200
set.seed(12345)
thediagnosisCluster &lt;- diagnose_design(thedesignClusterPlusEstimators, sims = sims, bootstrap_sims = 0)</code></pre>
</div>
<div id="ch5Stata33" class="tabcontent">
<p><br></p>
<pre class="text"><code>** Define estimators that can be repeated in the simulation below
capture program drop apply_estimators
program define apply_estimators, rclass

    syntax[ , datCluster]
    
    if &quot;`datCluster&apos;&quot; == &quot;&quot; {
        ** Call the data generation program defined above
        sample_from
        return scalar ATE = r(ATE)
    }
    
    else {
        ** Get the treatment assignment used in the R code
        import delimited using &quot;datCluster.csv&quot;, clear
        rename y ynew
    }
    
    ** C0: Ignores Clusters, IID SE
    qui reg ynew zcluster
    return scalar estC0_est = _b[zcluster]
    return scalar estC0_se = _se[zcluster]
    return scalar estC0_p = r(table)[&quot;pvalue&quot;, &quot;zcluster&quot;]
    
    ** C1: Ignores Clusters, HC2 SE
    qui reg ynew zcluster, vce(hc2)
    return scalar estC1_est = _b[zcluster]
    return scalar estC1_se = _se[zcluster]
    return scalar estC1_p = r(table)[&quot;pvalue&quot;, &quot;zcluster&quot;]
    
    ** C2: OLS, CR1 SE (Stata)
    qui reg ynew zcluster, vce(cluster cluster)
    return scalar estC2_est = _b[zcluster]
    return scalar estC2_se = _se[zcluster]
    return scalar estC2_p = r(table)[&quot;pvalue&quot;, &quot;zcluster&quot;]

    ** C3: OLS, CR2 SE
    qui reg_sandwich ynew zcluster, cluster(cluster)
    return scalar estC3_est = _b[zcluster]
    return scalar estC3_se = _se[zcluster]
    local p = (2 * ttail(e(dfs)[1,1], abs(_b[zcluster]/_se[zcluster])))
    return scalar estC3_p = `p&apos;

    ** C6: OLS with Cluster Size Weights, CR2 SE
    qui reg_sandwich ynew zcluster [pw = nb], cluster(cluster)
    return scalar estC6_est = _b[zcluster]
    return scalar estC6_se = _se[zcluster]
    local p = (2 * ttail(e(dfs)[1,1], abs(_b[zcluster]/_se[zcluster])))
    return scalar estC6_p = `p&apos;
    
    ** C7: OLS with Cluster Control and Var. Weights, CR2 SE
    qui reg_sandwich ynew zcluster nb [pw = varweight], cluster(cluster)
    return scalar estC7_est = _b[zcluster]
    return scalar estC7_se = _se[zcluster]
    local p = (2 * ttail(e(dfs)[1,1], abs(_b[zcluster]/_se[zcluster])))
    return scalar estC7_p = `p&apos;
    
    ** C8: OLS Clusters with adj for cluster size, CR2 RCSE
    qui reg_sandwich ynew zcluster nb, cluster(cluster)
    return scalar estC8_est = _b[zcluster]
    return scalar estC8_se = _se[zcluster]
    local p = (2 * ttail(e(dfs)[1,1], abs(_b[zcluster]/_se[zcluster])))
    return scalar estC8_p = `p&apos;
    
    ** C9: OLS Clusters with adj for cluster size, CR2 RCSE
    qui reg ynew zcluster nb
    gen sample = e(sample)
    qui sum nb if sample == 1
    gen mc_nb = nb - r(mean) if sample == 1
    gen interaction = zcluster * mc_nb
    qui reg_sandwich ynew zcluster mc_nb interaction, cluster(cluster)
    return scalar estC9_est = _b[zcluster]
    return scalar estC9_se = _se[zcluster]
    local p = (2 * ttail(e(dfs)[1,1], abs(_b[zcluster]/_se[zcluster])))
    return scalar estC9_p = `p&apos;
    
end

** Simulate the performance of these estimators
apply_estimators
local rscalars : r(scalars)
local to_store &quot;&quot;
foreach item of local rscalars {
  local to_store &quot;`to_store&apos; `item&apos; = r(`item&apos;)&quot;
}
simulate ///
`to_store&apos;, ///
reps(200): ///
apply_estimators

** Create summary matrix
qui des, short
di (`r(k)&apos; - 1)/3
matrix diagnosands = J((`r(k)&apos; - 1)/3, 6, .)
matrix rownames diagnosands = &quot;C0: IID SE&quot; &quot;C1: HC2 SE&quot; &quot;C2: CR1 SE&quot; &quot;C3: CR2 SE&quot; &quot;C6: Cluster Size Weights&quot; &quot;C7: Var Weights&quot; &quot;C8: Cluster size control&quot; &quot;C9: Lin cluster size adjust&quot;
matrix colnames diagnosands = &quot;Mean estimand&quot; &quot;Mean estimate&quot; &quot;Bias&quot; &quot;SD Estimate&quot; &quot;Power&quot; &quot;Coverage&quot;

** Get variable name roots to loop through
local roots estC0 estC1 estC2 estC3 estC6 estC7 estC8 estC9
 
** Calculate quantities to include
local row = 0
foreach l of local roots {
    
    local ++row
    
    * Estimand
    qui sum ATE, meanonly
    matrix diagnosands[`row&apos;, 1] = `r(mean)&apos;
    
    * Estimate
    qui sum `l&apos;_est, meanonly
    matrix diagnosands[`row&apos;, 2] = `r(mean)&apos;
    
    * Bias
    qui gen biascalc = `l&apos;_est - ATE
    qui sum biascalc, meanonly
    matrix diagnosands[`row&apos;, 3] = r(mean)
    drop biascalc
    
    * SD estimate (based on population variance, no n-1 in the variance denom.)
    qui sum `l&apos;_est
    qui gen sdcalc = (`l&apos;_est - r(mean))^2
    qui sum sdcalc
    matrix diagnosands[`row&apos;, 4] = sqrt(r(sum)/r(N))
    drop sdcalc
    
    * Power
    gen rejectnull = `l&apos;_p &lt;= 0.05
    qui sum rejectnull, meanonly
    matrix diagnosands[`row&apos;, 5] = r(mean)
    drop rejectnull
    
    * Coverage (z-stat CIs to limit estimates stored above)
    qui gen conflow = `l&apos;_est - (1.96 * `l&apos;_se)
    qui gen confhigh = `l&apos;_est + (1.96 * `l&apos;_se)
    qui gen inrange = ATE &lt;= confhigh &amp; ATE &gt;= conflow
    qui sum inrange
    matrix diagnosands[`row&apos;, 6] = r(mean)
    drop conf* inrange
    
}

* View the results
matrix list diagnosands</code></pre>
</div>
<div id="ch5Hide33" class="tabcontent">

</div>
</div>
<p>The results of our simulation show how certain approaches can yield very biased estimates, while other approaches can reduce the bias. With variaion in cluster size, the C5 and C6 estimators have the lowest bias in this particular example (with very few clusters). We also see evidence of problems with some of these standard errors &#x2014; the actual standard errors (in &#x201C;SD Estimate&#x201D;) should be much higher than those estimated by the approaches ignoring the clustered design (C0 and C1).</p>
<table>
<thead>
<tr>
<th style="text-align:left;">
Estimator
</th>
<th style="text-align:left;">
Mean Estimand
</th>
<th style="text-align:left;">
Mean Estimate
</th>
<th style="text-align:left;">
Bias
</th>
<th style="text-align:left;">
SD Estimate
</th>
<th style="text-align:left;">
Power
</th>
<th style="text-align:left;">
Coverage
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
C0: Ignores Clusters, IID SE
</td>
<td style="text-align:left;">
-12900.57
</td>
<td style="text-align:left;">
-15166.65
</td>
<td style="text-align:left;">
-2266.08
</td>
<td style="text-align:left;">
5916.55
</td>
<td style="text-align:left;">
1.00
</td>
<td style="text-align:left;">
0.22
</td>
</tr>
<tr>
<td style="text-align:left;">
C1: Ignores Clusters, HC22 SE
</td>
<td style="text-align:left;">
-12900.57
</td>
<td style="text-align:left;">
-15166.65
</td>
<td style="text-align:left;">
-2266.08
</td>
<td style="text-align:left;">
5916.55
</td>
<td style="text-align:left;">
1.00
</td>
<td style="text-align:left;">
0.20
</td>
</tr>
<tr>
<td style="text-align:left;">
C2: OLS, CR1 SE (Stata)
</td>
<td style="text-align:left;">
-12900.57
</td>
<td style="text-align:left;">
-15166.65
</td>
<td style="text-align:left;">
-2266.08
</td>
<td style="text-align:left;">
5916.55
</td>
<td style="text-align:left;">
0.76
</td>
<td style="text-align:left;">
0.85
</td>
</tr>
<tr>
<td style="text-align:left;">
C3: Diff Means, CR2 SE
</td>
<td style="text-align:left;">
-12900.57
</td>
<td style="text-align:left;">
-15166.65
</td>
<td style="text-align:left;">
-2266.08
</td>
<td style="text-align:left;">
5916.55
</td>
<td style="text-align:left;">
0.32
</td>
<td style="text-align:left;">
0.94
</td>
</tr>
<tr>
<td style="text-align:left;">
C4: OLS, CR2 SE
</td>
<td style="text-align:left;">
-12900.57
</td>
<td style="text-align:left;">
-15166.65
</td>
<td style="text-align:left;">
-2266.08
</td>
<td style="text-align:left;">
5916.55
</td>
<td style="text-align:left;">
0.32
</td>
<td style="text-align:left;">
0.94
</td>
</tr>
<tr>
<td style="text-align:left;">
C5: Horvitz-Thompson Cluster, Young SE
</td>
<td style="text-align:left;">
-12900.57
</td>
<td style="text-align:left;">
-12710.34
</td>
<td style="text-align:left;">
190.23
</td>
<td style="text-align:left;">
5595.09
</td>
<td style="text-align:left;">
0.32
</td>
<td style="text-align:left;">
0.86
</td>
</tr>
<tr>
<td style="text-align:left;">
C6: OLS with Cluster Size Weights, CR2 SE
</td>
<td style="text-align:left;">
-12900.57
</td>
<td style="text-align:left;">
-12670.05
</td>
<td style="text-align:left;">
230.51
</td>
<td style="text-align:left;">
5931.54
</td>
<td style="text-align:left;">
0.24
</td>
<td style="text-align:left;">
0.92
</td>
</tr>
<tr>
<td style="text-align:left;">
C7: OLS Clusters with Weights, CR2 RCSE
</td>
<td style="text-align:left;">
-12900.57
</td>
<td style="text-align:left;">
-19047.82
</td>
<td style="text-align:left;">
-6147.26
</td>
<td style="text-align:left;">
6717.76
</td>
<td style="text-align:left;">
0.24
</td>
<td style="text-align:left;">
0.92
</td>
</tr>
<tr>
<td style="text-align:left;">
C8: OLS Clusters with adj for cluster size, CR2 RCSE
</td>
<td style="text-align:left;">
-12900.57
</td>
<td style="text-align:left;">
-19120.43
</td>
<td style="text-align:left;">
-6219.86
</td>
<td style="text-align:left;">
6709.44
</td>
<td style="text-align:left;">
0.26
</td>
<td style="text-align:left;">
0.92
</td>
</tr>
<tr>
<td style="text-align:left;">
C9: OLS Clusters with adj for cluster size, CR2 RCSE
</td>
<td style="text-align:left;">
-12900.57
</td>
<td style="text-align:left;">
61051.64
</td>
<td style="text-align:left;">
73952.20
</td>
<td style="text-align:left;">
124497.09
</td>
<td style="text-align:left;">
0.06
</td>
<td style="text-align:left;">
0.96
</td>
</tr>
</tbody>
</table>
</div>
<div id="incorrect-false-positive-rates-from-tests-and-confidence-intervals" class="section level3">
<h3><span class="header-section-number">5.6.2</span> Incorrect false positive rates from tests and confidence intervals</h3>
<p>When we have few clusters, analytic standard errors could lead to incorrect false positive rates for our hypothesis tests or confidence intervals, even after we adjust our standard errors for clustering (e.g., using the default adjustment in Stata, CR1). The CR2 errors OES prefers tend to perform slightly better in settings with fewer clusters <span class="citation">(Pustejovsky <a href="#ref-pustejovsky2019cr">2019</a>)</span>. We demonstrate below using CR2 errors rather than CR1 can sometimes help ensure that the false positive rates of our hypothesis tests is controlled correctly.</p>
<p>To distinguish between (1) the problems of bias arising from unequal sized clusters and (2) problems of false positive rates or poor covereage arising from the presence of few clusters, we use a design with equal numbers of units per cluster:</p>
<pre><code>        buildingID
Zcluster  1  2  3  4  5  6  7  8  9 10
       C 10  0 10 10  0  0  0  0 10 10
       T  0 10  0  0 10 10 10 10  0  0</code></pre>
<div class="tab">
<button class="tablinks" onclick="unrolltab(event, &apos;ch5R35&apos;)">
R code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Stata35&apos;)">
Stata code
</button>
<button class="tablinks" onclick="unrolltab(event, &apos;ch5Hide35&apos;)">
Hide
</button>
<div id="ch5R35" class="tabcontent">
<p><br></p>
<pre class="text"><code>## Break any relationship between treatment and outcomes by permuting
## or shuffling the treatment variable. This means that H0, the null,
## of no effects is true.
checkFP &lt;- function(dat, setype=&quot;CR2&quot;){
    dat$newZ &lt;-  cluster_ra(cluster=dat$buildingID)
    newest &lt;- lm_robust(Y~newZ, dat=dat, clusters=buildingID, se_type=setype)
    return(nullp = newest$p.value[&quot;newZ&quot;])
}

## Construct a separate dataset for this example
smalldat &lt;- dat1[, c(&quot;Y&quot;,&quot;buildingID&quot;)]

## Apply the function above 1000 times (CR2)
set.seed(123)
fpresCR2 &lt;- replicate(1000, checkFP(dat=smalldat))

## Apply the function above 1000 times (CR1, Stata)
set.seed(123)
fpresStata &lt;- replicate(1000, checkFP(dat=smalldat, setype=&quot;stata&quot;))

## Summarize the results
fprateCR205 &lt;- mean(fpresCR2 &lt;= .05)
paste0(&quot;fprateCR205 = &quot;, fprateCR205)
fprateStata05 &lt;- mean(fpresStata &lt;= .05)
paste0(&quot;fprateStata05 = &quot;, fprateStata05)</code></pre>
</div>
<div id="ch5Stata35" class="tabcontent">
<p><br></p>
<pre class="text"><code>** Return to data from Chapter 4
import delimited using &quot;dat1_with_designs.csv&quot;, clear

** Break any relationship between treatment and outcomes by permuting
** or shuffling the treatment variable. This means that H0, the null,
** of no effects is true.
capture program drop checkFP
program define checkFP, rclass

    ** Specify if you want CR2, rather than CR1 (Stata)
    syntax[, se_CR2]
    capture drop newZ
    cluster_ra newZ, cluster_var(buildingid)
    if &quot;`se_CR2&apos;&quot; == &quot;&quot; {
        reg_sandwich y newZ, cluster(buildingid)
        local p = (2 * ttail(e(dfs)[1,1], abs(_b[newZ]/_se[newZ])))
        return scalar nullp = `p&apos;
    }
    else {
        reg y newZ, vce(cluster buildingid)
        local p = (2 * ttail(e(df_r), abs(_b[newZ]/_se[newZ])))
        return scalar nullp = `p&apos;
    }

end

** Apply the function above 1000 times (CR2)
preserve
    set seed 123
    simulate ///
    nullp = r(nullp), ///
    reps(1000) nodots: ///
    checkFP, se_CR2
    
    qui gen reject = nullp &lt;= 0.05
    qui sum reject
    di &quot;fprateCR205 `r(mean)&apos;&quot;
restore

** Apply the function above 1000 times (Stata)
preserve
    set seed 123
    simulate ///
    nullp = r(nullp), ///
    reps(1000) nodots: ///
    checkFP
    
    qui gen reject = nullp &lt;= 0.05
    qui sum reject
    di &quot;fprateStata05 `r(mean)&apos;&quot;
restore</code></pre>
</div>
<div id="ch5Hide35" class="tabcontent">

</div>
</div>
<pre><code>[1] &quot;fprateCR205 = 0.045&quot;
[1] &quot;fprateStata05 = 0.054&quot;</code></pre>
<p>In this case, with 10 equal sized clusters, a simple outcome, and equal numbers of clusters in treatment and control, we see that the CR2 standard error controls the false positive rate (<em>less than</em> 5% of the 1000 simulations testing a true null hypothesis of no effect return a <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span>-value of less than .05) while the default &#x201C;Stata&#x201D; (CR1) standard error has a slightly too high false positive rate of 0.054 at the 5% error level.</p>
<p>If a simulation like the one above shows false positive rate problems with the CR2 standard error as well, we may prefer to rely on permutation-based randomization inference. For more discussion of issues with standard error calculation in the presence of few clusters, and examples of some other possible approaches to testing with few clusters, see <span class="citation">Esarey and Menger (<a href="#ref-esarey2019practical">2019</a>)</span>.</p>

</div>
</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-reichardt1999justifying">
<p>Reichardt, Charles S, and Harry F Gollob. 1999. &#x201C;Justifying the Use and Increasing the Power of at Test for a Randomized Experiment with a Convenience Sample.&#x201D; <em>Psychological Methods</em> 4 (1): 117.</p>
</div>
<div id="ref-rubin1986comment">
<p>Rubin, Donald B. 1986. &#x201C;Comment: Which Ifs Have Causal Answers.&#x201D; <em>Journal of the American Statistical Association</em> 81 (396): 961&#x2013;62.</p>
</div>
<div id="ref-lin_agnostic_2013">
<p>Lin, Winston. 2013. &#x201C;Agnostic Notes on Regression Adjustments to Experimental Data: Reexamining Freedman&#x2019;s Critique.&#x201D; <em>The Annals of Applied Statistics</em> 7 (1): 295&#x2013;318.</p>
</div>
<div id="ref-samii_equivalencies_2012">
<p>Samii, Cyrus, and Peter M. Aronow. 2012. &#x201C;On Equivalences Between Design-Based and Regression-Based Estimators for Random Experiments.&#x201D; <em>Statistics and Probability Letters</em> 82: 365&#x2013;70.</p>
</div>
<div id="ref-R-coin">
<p>Hothorn, Torsten, Henric Winell, Kurt Hornik, Mark A. van de Wiel, and Achim Zeileis. 2021. <em>Coin: Conditional Inference Procedures in a Permutation Test Framework</em>. <a href="http://coin.r-forge.r-project.org">http://coin.r-forge.r-project.org</a>.</p>
</div>
<div id="ref-R-ri2">
<p>&#x2014;&#x2014;&#x2014;. 2022b. <em>Ri2: Randomization Inference for Randomized Experiments</em>. <a href="https://CRAN.R-project.org/package=ri2">https://CRAN.R-project.org/package=ri2</a>.</p>
</div>
<div id="ref-freedman2008randomization">
<p>&#x2014;&#x2014;&#x2014;. 2008b. &#x201C;Randomization Does Not Justify Logistic Regression.&#x201D; <em>Statistical Science</em> 23 (2): 237&#x2013;49.</p>
</div>
<div id="ref-angrist2009mostly">
<p>Angrist, Joshua D, and J&#xF6;rn-Steffen Pischke. 2009. <em>Mostly Harmless Econometrics: An Empiricist&#x2019;s Companion</em>. Princeton university press.</p>
</div>
<div id="ref-rosenbaum2008a">
<p>Rosenbaum, Paul R. 2008. &#x201C;Testing hypotheses in order.&#x201D; <em>Biometrika</em> 95: 248&#x2013;52.</p>
</div>
<div id="ref-oberfichtner2021stacked">
<p>Oberfichtner, Michael, and Harald Tauchmann. 2021. &#x201C;Stacked Linear Regression Analysis to Facilitate Testing of Hypotheses Across Ols Regressions.&#x201D; <em>The Stata Journal</em> 21 (2): 411&#x2013;29.</p>
</div>
<div id="ref-weesie2000seemlingly">
<p>Weesie, Jeroen. 2000. &#x201C;Seemlingly Unrelated Estimation and the Cluster-Adjusted Sandwich Estimator.&#x201D; <em>Stata Technical Bulletin</em> 9 (52).</p>
</div>
<div id="ref-rubin2024inconsistent">
<p>Rubin, Mark. 2024. &#x201C;Inconsistent Multiple Testing Corrections: The Fallacy of Using Family-Based Error Rates to Make Inferences About Individual Hypotheses.&#x201D; <em>Methods in Psychology</em>, 100140.</p>
</div>
<div id="ref-freedman2008rae">
<p>Freedman, David A. 2008a. &#x201C;On regression adjustments to experimental data.&#x201D; <em>Advances in Applied Mathematics</em> 40 (2): 180&#x2013;93.</p>
</div>
<div id="ref-negi2021revisiting">
<p>Negi, Akanksha, and Jeffrey M Wooldridge. 2021. &#x201C;Revisiting Regression Adjustment in Experiments with Heterogeneous Treatment Effects.&#x201D; <em>Econometric Reviews</em> 40 (5): 504&#x2013;34.</p>
</div>
<div id="ref-miratrix2013adjusting">
<p>Miratrix, Luke W, Jasjeet S Sekhon, and Bin Yu. 2013. &#x201C;Adjusting Treatment Effect Estimates by Post-Stratification in Randomized Experiments.&#x201D; <em>Journal of the Royal Statistical Society Series B: Statistical Methodology</em> 75 (2): 369&#x2013;96.</p>
</div>
<div id="ref-rosenbaum:2002a">
<p>&#x2014;&#x2014;&#x2014;. 2002. &#x201C;Covariance Adjustment in Randomized Experiments and Observational Studies.&#x201D; <em>Statistical Science</em> 17 (3): 286&#x2013;327.</p>
</div>
<div id="ref-zou2006adaptive">
<p>Zou, Hui. 2006. &#x201C;The Adaptive Lasso and Its Oracle Properties.&#x201D; <em>Journal of the American Statistical Association</em> 101 (476): 1418&#x2013;29.</p>
</div>
<div id="ref-cochran_methods_1954">
<p>Cochran, William G. 1954. &#x201C;Some Methods for Strengthening the Common &#x3C7; 2 Tests.&#x201D; <em>Biometrics</em> 10 (4): 417.</p>
</div>
<div id="ref-mantel_statistical_1959">
<p>Mantel, N, and W Haenszel. 1959. &#x201C;Statistical Aspects of the Analysis of Data from Retrospective Studies of Disease.&#x201D; <em>Journal of the National Cancer Institute</em> 22: 719&#x2013;48.</p>
</div>
<div id="ref-gerber_field_2012">
<p>Gerber, Alan S., and Donald P. Green. 2012. <em>Field Experiments: Design, Analysis, and Interpretation</em>. New York, NY: W. W. Norton &amp; Company.</p>
</div>
<div id="ref-R-estimatr">
<p>Blair, Graeme, Jasper Cooper, Alexander Coppock, Macartan Humphreys, and Luke Sonnet. 2022. <em>Estimatr: Fast Estimators for Design-Based Inference</em>. <a href="https://CRAN.R-project.org/package=estimatr">https://CRAN.R-project.org/package=estimatr</a>.</p>
</div>
<div id="ref-bowers2011mem">
<p>Bowers, Jake. 2011. &#x201C;Making Effects Manifest in Randomized Experiments.&#x201D; In <em>Cambridge Handbook of Experimental Political Science</em>, edited by James N. Druckman, Donald P. Green, James H. Kuklinski, and Arthur Lupia. New York, NY: Cambridge University Press.</p>
</div>
<div id="ref-middleton2015unbiased">
<p>Middleton, Joel A, and Peter M Aronow. 2015. &#x201C;Unbiased Estimation of the Average Treatment Effect in Cluster-Randomized Experiments.&#x201D; <em>Statistics, Politics, and Policy</em> 6 (1&#x2013;2): 39&#x2013;75.</p>
</div>
<div id="ref-hansen_covariate_2008">
<p>Hansen, Ben B., and Jake Bowers. 2008. &#x201C;Covariate Balance in Simple, Stratified and Clustered Comparative Studies.&#x201D; <em>Statistical Science</em> 23 (2): 219&#x2013;36.</p>
</div>
<div id="ref-pustejovsky2019cr">
<p>Pustejovsky, James. 2019. <em>ClubSandwich: Cluster-Robust (Sandwich) Variance Estimators with Small-Sample Corrections</em>. <a href="https://CRAN.R-project.org/package=clubSandwich">https://CRAN.R-project.org/package=clubSandwich</a>.</p>
</div>
<div id="ref-esarey2019practical">
<p>Esarey, Justin, and Andrew Menger. 2019. &#x201C;Practical and Effective Approaches to Dealing with Clustered Data.&#x201D; <em>Political Science Research and Methods</em> 7 (3): 541&#x2013;59.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="randomization-choices.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="poweranalysis.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook/js/app.min.js"></script>
<script src="libs/gitbook/js/lunr.js"></script>
<script src="libs/gitbook/js/plugin-search.js"></script>
<script src="libs/gitbook/js/plugin-sharing.js"></script>
<script src="libs/gitbook/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook/js/plugin-bookdown.js"></script>
<script src="libs/gitbook/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/gsa-oes/sop/edit/master/Book/05-analysischoices.Rmd",
"text": "Edit"
},
"download": ["OES_SOP.pdf", "OES_SOP.epub"],
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "";
    if (src === "" || src === "true") src = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
